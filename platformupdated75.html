<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="منصة متقدمة لإدارة الروابط مع تحليلات ونطاقات مخصصة وميزات متطورة">
    <meta name="keywords" content="تقصير الروابط, إدارة الروابط, تحليلات, تسويق رقمي">
    <title>Turkify Pro - منصة متقدمة لإدارة الروابط</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Poppins:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <style>
    :root {
            --primary-purple: #4A154B;
            --secondary-red: #EF5A5F;
            --accent-teal: #2EC4B6;
            --light-gray: #f8f9fa;
            --dark-gray: #343a40;
            --gradient-start: #6a11cb;
            --gradient-end: #2575fc;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Tajawal', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--light-gray) 0%, #eef2f5 100%);
            min-height: 100vh;
            -webkit-display: flex;
-ms-display: flex;
display: flex;
            flex-direction: column;
            color: #333;
            line-height: 1.8;
        }
        
        .navbar {
            background: linear-gradient(90deg, var(--primary-purple) 0%, #5d1d63 100%);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 0.8rem 0;
            z-index: 3000;
        }
        
        .logo {
            font-weight: 700;
            color: white;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo span {
            color: var(--secondary-red);
        }
        
        .logo-icon {
            background: var(--secondary-red);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .navbar-toggler {
            border: none;
            outline: none;
            box-shadow: none;
        }
        
        .nav-link {
            padding: 0.5rem 1rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
        }
        
        .nav-link:hover {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }
        
        .navbar-collapse {
            justify-content: flex-end;
        }
        
        .card {
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            border: none;
            margin-bottom: 30px;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            overflow: hidden;
            background: white;
        }
        
        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }
        
        .card-header {
            background: linear-gradient(90deg, var(--primary-purple) 0%, #5d1d63 100%);
            color: white;
            font-weight: 600;
            border-radius: 16px 16px 0 0 !important;
            padding: 1.2rem 1.5rem;
            font-size: 1.1rem;
        }
        
        .btn-primary {
            background: linear-gradient(90deg, var(--primary-purple) 0%, #5d1d63 100%);
            border: none;
            padding: 0.8rem 1.8rem;
            font-weight: 500;
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: linear-gradient(90deg, #3a1043 0%, #4a154b 100%);
            transform: translateY(-2px);
            box-shadow: 0 7px 15px rgba(74, 21, 75, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(90deg, var(--secondary-red) 0%, #e94348 100%);
            border: none;
            padding: 0.8rem 1.8rem;
            font-weight: 500;
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        
        .btn-danger:hover {
            background: linear-gradient(90deg, #d93439 0%, #e94348 100%);
            transform: translateY(-2px);
            box-shadow: 0 7px 15px rgba(239, 90, 95, 0.3);
        }
        
        .form-control, .form-select {
            border: 2px solid #eaeaea;
            border-radius: 12px;
            padding: 0.8rem 1.2rem;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--accent-teal);
            box-shadow: 0 0 0 0.25rem rgba(46, 196, 182, 0.2);
        }
        
        .stat-card {
            text-align: center;
            padding: 25px 20px;
            border-radius: 16px;
            background: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 2.8rem;
            font-weight: 700;
            background: linear-gradient(90deg, var(--primary-purple) 0%, var(--accent-teal) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 1.1rem;
            color: var(--dark-gray);
            font-weight: 500;
        }
        
        .link-card {
            border-left: 4px solid var(--accent-teal);
            transition: all 0.3s ease;
        }
        
        .link-card:hover {
            border-left: 4px solid var(--secondary-red);
        }
        
        .link-url {
            font-size: 0.95rem;
            color: #6c757d;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .short-url {
            color: var(--primary-purple);
            font-weight: 600;
            transition: color 0.3s;
        }
        
        .short-url:hover {
            color: var(--accent-teal);
            text-decoration: none;
        }
        
        .clicks-badge {
            background: linear-gradient(90deg, var(--secondary-red) 0%, #e94348 100%);
            padding: 0.4rem 0.8rem;
            border-radius: 50px;
            font-weight: 500;
        }
        
        .loader {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid var(--accent-teal);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 30px auto;
            display: none;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .redirect-container {
            max-width: 700px;
            margin: 80px auto;
            text-align: center;
            padding: 40px;
            border-radius: 20px;
            background: white;
            box-shadow: 0 15px 50px rgba(0,0,0,0.1);
        }
        
        .redirect-icon {
            font-size: 5rem;
            background: linear-gradient(90deg, var(--primary-purple) 0%, var(--accent-teal) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 25px;
        }
        
        .redirect-btn {
            margin-top: 30px;
            padding: 0.8rem 2.5rem;
            border-radius: 12px;
            font-weight: 500;
        }
        
        .admin-only {
            display: none;
        }
        
        .action-buttons .btn {
            margin-right: 8px;
            border-radius: 10px;
            padding: 0.5rem 0.9rem;
        }
        
        .table-responsive {
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .table th {
            background: linear-gradient(90deg, var(--primary-purple) 0%, #5d1d63 100%);
            color: white;
            font-weight: 500;
            padding: 1.1rem 1.5rem;
        }
        
        .table td {
            padding: 1.1rem 1.5rem;
            vertical-align: middle;
        }
        
        .feature-icon {
            width: 70px;
            height: 70px;
            border-radius: 20px;
            background: rgba(74, 21, 75, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 30px;
            color: var(--primary-purple);
        }
        
        .hero-section {
            background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
            color: white;
            padding: 100px 0 80px;
            border-radius: 0 0 30px 30px;
            margin-bottom: -50px;
            position: relative;
            overflow: hidden;
        }
        
       .custom-shape {
    position: absolute;
    width: 150px;
    height: 150px;
    background: linear-gradient(135deg, var(--accent-teal) 0%, rgba(46, 196, 182, 0.3) 100%);
    border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%;
    z-index: 1;
    animation: float 10s infinite ease-in-out;
}

.shape-1 {
    top: 10%;
    left: 5%;
}

.shape-2 {
    bottom: 15%;
    right: 3%;
    width: 120px;
    height: 120px;
    animation-delay: 1s;
  }
    
@keyframes float {
    0% { transform: translateY(0) rotate(0deg); }
    50% { transform: translateY(-20px) rotate(10deg); }
    100% { transform: translateY(0) rotate(0deg); }
}
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transform: translateX(200%);
            transition: transform 0.4s ease;
            display: none;
        }
        
        .notification.show {
            transform: translateX(0);
            display: block;
        }
        
        .notification.success {
            background: linear-gradient(90deg, #2EC4B6 0%, #20bfa9 100%);
        }
        
        .notification.error {
            background: linear-gradient(90deg, #EF5A5F 0%, #e94348 100%);
        }
        
        .notification.info {
            background: linear-gradient(90deg, #4A154B 0%, #5d1d63 100%);
        }
        
        .progress-bar {
            height: 5px;
            background: rgba(255,255,255,0.5);
            width: 100%;
            margin-top: 10px;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background: white;
            width: 100%;
            animation: progress 3s linear forwards;
        }
        
        @keyframes progress {
            0% { width: 100%; }
            100% { width: 0%; }
        }
        
        .modal-content {
            border-radius: 20px;
            overflow: hidden;
            border: none;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            background: linear-gradient(90deg, var(--primary-purple) 0%, #5d1d63 100%);
            color: white;
        }
        
        .device-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .device-desktop {
            background: rgba(74, 21, 75, 0.1);
            color: var(--primary-purple);
        }
        
        .device-mobile {
            background: rgba(46, 196, 182, 0.1);
            color: var(--accent-teal);
        }
        
        .device-tablet {
            background: rgba(239, 90, 95, 0.1);
            color: var(--secondary-red);
        }
        
        .country-flag {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }
        
        .stats-card {
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            background: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .nav-active {
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
        }
        
        .table-loader {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        
        .qr-code-container {
            text-align: center;
            margin: 20px 0;
        }
        
        #qrcode {
            display: inline-block;
            padding: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .platform-stat {
            text-align: center;
            padding: 15px;
        }
        
        .link-type-badge {
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
            display: inline-block;
        }
        
        .type-series { background-color: rgba(74, 21, 75, 0.1); color: var(--primary-purple); }
        .type-movie { background-color: rgba(46, 196, 182, 0.1); color: var(--accent-teal); }
        .type-match { background-color: rgba(239, 90, 95, 0.1); color: var(--secondary-red); }
        .type-recipe { background-color: rgba(255, 193, 7, 0.1); color: #ff9800; }
        .type-game { background-color: rgba(63, 81, 181, 0.1); color: #3f51b5; }
        .type-app { background-color: rgba(76, 175, 80, 0.1); color: #4caf50; }
        .type-channel { background-color: rgba(156, 39, 176, 0.1); color: #9c27b0; }
        .type-reels { background-color: rgba(233, 30, 99, 0.1); color: #e91e63; }
        
        .social-preview {
            border-radius: 12px;
            border: 1px solid #eaeaea;
            padding: 15px;
            margin: 20px 0;
            background: white;
            max-width: 500px;
        }
        
        .social-preview-img {
            width: 100%;
            height: 250px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .stats-grid {
            -ms-display: grid;
display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .stats-card {
            border-radius: 12px;
            padding: 20px;
            background: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .stats-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary-purple);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stats-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-teal);
            text-align: center;
        }
        
        .stats-chart {
            height: 250px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .redirect-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 30px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .redirect-thumbnail {
            width: 100%;
            height: 350px;
            object-fit: cover;
            border-radius: 12px;
            margin: 20px 0;
            z-index: 999999;
        }
        
        .redirect-title {
            font-size: 2rem;
            font-weight: 700;
            margin: 20px 0;
            color: var(--primary-purple);
        }
        
        .redirect-description {
            font-size: 1.1rem;
            line-height: 1.7;
            color: #555;
            margin-bottom: 30px;
        }
        
        .netflix-style {
            background: #141414;
            color: white;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        
        .netflix-style .redirect-thumbnail {
            border-radius: 0;
            height: 400px;
        }
        
        .netflix-gradient {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 150px;
            background: linear-gradient(transparent, #141414);
        }
        
        .netflix-content {
            position: relative;
            z-index: 10;
            padding: 30px;
        }
        
        /* تحسينات إمكانية الوصول */
        .btn:focus, .form-control:focus {
            outline: 3px solid rgba(46, 196, 182, 0.5);
            outline-offset: 2px;
        }
        
        /* تحسينات التحميل المتأخر */
        img[loading] {
            transition: opacity 0.3s;
        }
        
        img[loading="lazy"] {
            opacity: 0;
        }
        
        img[loading="lazy"][data-loaded] {
            opacity: 1;
        }
        
        /* تحسينات التباين للألوان */
        .card-header, .btn-primary, .btn-danger, .clicks-badge {
            color: white !important;
        }
        
        .stat-label {
            color: #333;
            background: rgba(255,255,255,0.7);
            padding: 5px;
            border-radius: 8px;
        }
        
              /* إصلاح بطاقة المحتوى */
.content-card {
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    transition: all 0.3s ease;
    background: #FAF9F5;
    z-index: 99999;
    margin: 20px 0;
    display: block !important; /* فرض الظهور */
    visibility: visible !important;
}

.content-thumbnail {
    width: 100%;
    height: 300px;
    object-fit: cover;
    border-radius: 7px;
    display: block !important;
    visibility: visible !important;
    background: #f8f9fa; /* لون خلفية في حالة عدم تحميل الصورة */
}

.content-info {
    padding: 25px;
    display: block !important;
    visibility: visible !important;
}

.content-meta {
    display: flex !important;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
    flex-wrap: wrap;
    visibility: visible !important;
}

.content-title {
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 15px;
    color: var(--primary-purple);
    display: block !important;
    visibility: visible !important;
}

.content-description {
    font-size: 1.1rem;
    line-height: 1.8;
    color: #555;
    margin-bottom: 20px;
    display: block !important;
    visibility: visible !important;
}

/* إصلاح عرض أنواع المحتوى */
.content-type, .content-episode, .content-date {
    display: inline-block !important;
    visibility: visible !important;
    padding: 8px 15px;
    border-radius: 20px;
    font-weight: 500;
    font-size: 0.9rem;
    margin: 5px 5px 5px 0;
}

.content-type {
    background: rgba(74, 21, 75, 0.1);
    color: var(--primary-purple);
}

.content-episode {
    background: rgba(239, 90, 95, 0.1);
    color: var(--secondary-red);
}

.content-date {
    background: rgba(46, 196, 182, 0.1);
    color: var(--accent-teal);
}
        
        /* إخفاء زر اكتشف الميزات */
        .hero-buttons .btn-outline-light {
            display: none;
        }
        
        .redirect-text {
            margin: 25px 0;
            font-size: 1.2rem;
            font-weight: 500;
            color: #4A154B;
            text-align: center;
            padding: 15px;
            background: rgba(74, 21, 75, 0.05);
            border-radius: 12px;
        }
        
        .redirect-text .highlight {
            font-weight: 700;
            color: var(--accent-teal);
        }
        
        .security-text {
            font-size: 0.9rem;
            color: #6c757d;
            text-align: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        /* Ad Containers */
        .ad-container {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 1px solid #eaeaea;
        }
        
        .ad-placeholder {
            width: 100%;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(74, 21, 75, 0.1);
            border-radius: 8px;
            color: #4A154B;
            font-weight: 500;
            margin: 10px 0;
        }
        
        .ad-350x50 { height: 50px; }
        .ad-350x250 { height: 250px; }
        
        /* تحسينات للعرض على الجوال */
        @media (max-width: 768px) {
            .content-thumbnail {
                height: 250px;
            }
            
            .content-title {
                font-size: 1.5rem;
            }
            
            .hero-section {
                padding: 70px 0 50px;
            }
            
            .table-responsive {
                border-radius: 12px;
            }
            
            .redirect-container {
                margin: 40px 20px;
                padding: 30px 20px;
            }
            
            .platform-stat h3 {
                font-size: 1.8rem;
            }
            
            .platform-stats .col-md-3 {
                margin-bottom: 15px;
            }
            
            .card-header {
                padding: 1rem;
            }
            
            .table th, .table td {
                padding: 0.75rem;
                font-size: 0.9rem;
            }
            
            .table-responsive {
                overflow-x: auto;
            }
            
            .btn-lg {
                padding: 0.8rem 1.2rem;
                font-size: 1rem;
            }
            
            .netflix-style .redirect-thumbnail {
                height: 300px;
            }
            
            .redirect-text {
                font-size: 1rem;
            }
        }
        
        @media (max-width: 576px) {
            .content-thumbnail {
                height: 200px;
            }
            
            .content-title {
                font-size: 1.3rem;
            }
            
            .content-description {
                font-size: 1rem;
            }
            
            .hero-section {
                padding: 50px 0 30px;
            }
            
            .stat-number {
                font-size: 2.2rem;
            }
            
            .table th, .table td {
                padding: 0.5rem;
                font-size: 0.8rem;
            }
            
            .btn {
                padding: 0.5rem 1rem;
            }
            
            .navbar-nav .nav-item {
                margin: 5px 0;
            }
            
            .hero-buttons .btn {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .netflix-style .redirect-thumbnail {
                height: 250px;
            }
            
            .redirect-text {
                font-size: 0.9rem;
                padding: 10px;
            }
        }
        
        /* تحسينات لشريط التنقل */
        .navbar-collapse {
            flex-basis: 100%;
            flex-grow: 0;
        }
        
        .navbar-nav .nav-link {
            padding: 10px 15px;
            margin: 0 5px;
        }
        
        @media (max-width: 991px) {
            .navbar-nav {
                margin-top: 15px;
            }
            
            .auth-section {
                margin-top: 15px;
                padding-top: 15px;
                border-top: 1px solid rgba(255,255,255,0.1);
            }
        }
        
        /* تحسينات للتركيز */
        .btn:focus, .form-control:focus, .form-select:focus, .nav-link:focus {
            box-shadow: 0 0 0 0.25rem rgba(46, 196, 182, 0.5);
        }
        
        /* تحسينات للجدول على الجوال */
        @media (max-width: 576px) {
            .table-responsive {
                font-size: 0.8rem;
            }
            .action-buttons .btn {
                padding: 0.3rem 0.6rem;
                font-size: 0.8rem;
            }
        }

        /* Analytics Filter */
        .analytics-filter {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .filter-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        
        .filter-btn {
            padding: 5px 15px;
            border-radius: 20px;
            background: #f1f1f1;
            border: none;
            transition: all 0.3s;
        }
        
        .filter-btn:hover, .filter-btn.active {
            background: var(--primary-purple);
            color: white;
        }
        
        /* Modern Stats Modal */
        .stats-modal-content {
            padding: 20px;
            border-radius: 16px;
            background: white;
            box-shadow: 0 15px 50px rgba(0,0,0,0.1);
        }
        
        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .stats-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-purple);
        }
        
        .time-filter {
            display: flex;
            gap: 10px;
        }
        
        .time-btn {
            padding: 5px 12px;
            border-radius: 20px;
            background: #f1f1f1;
            border: none;
            transition: all 0.3s;
        }
        
        .time-btn:hover, .time-btn.active {
            background: var(--accent-teal);
            color: white;
        }
        
        /* Earnings Modal */
        .earnings-chart {
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
        }
        
        .earnings-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .earnings-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .earnings-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-teal);
            margin: 10px 0;
        }
        
        .earnings-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        /* Pagination */
        .pagination .page-item.active .page-link {
            background: var(--primary-purple);
            border-color: var(--primary-purple);
        }
        
        .pagination .page-link {
            color: var(--primary-purple);
        }
        
        /* إضافات CSS للأرباح */
.earnings-region-card {
    background: white;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    border: 1px solid #eaeaea;
}

.earnings-breakdown {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 20px;
    margin-top: 20px;
}

.earnings-card {
    transition: transform 0.2s;
}

.earnings-card:hover {
    transform: translateY(-3px);
}

.earnings-value {
    font-size: 1.5rem !important;
    font-weight: 700 !important;
    color: var(--accent-teal) !important;
    margin: 10px 0 !important;
}

.progress {
    border-radius: 10px;
    overflow: hidden;
}

.progress-bar {
    border-radius: 10px;
    transition: width 0.6s ease;
}   

@media (max-width: 768px) {
    .content-thumbnail {
        height: 250px !important;
    }
    .content-title {
        font-size: 1.5rem !important;
    }
}

/* الخوارزميات الذكية */
.algorithm-control-card, .algorithm-status-card {
    border-radius: 16px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    border: none;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
}

.algorithm-metric {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid rgba(0,0,0,0.1);
}

.algorithm-metric:last-child {
    border-bottom: none;
}

.algorithms-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 25px;
    margin-top: 20px;
}

.algorithm-card {
    background: white;
    border-radius: 16px;
    padding: 25px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    border: none;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
    overflow: hidden;
}

.algorithm-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 15px 40px rgba(0,0,0,0.15);
}

.algorithm-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--primary-purple), var(--accent-teal));
}

.algorithm-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
}

.algorithm-title {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--primary-purple);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.algorithm-category {
    font-size: 0.8rem;
    padding: 4px 12px;
    border-radius: 20px;
    font-weight: 500;
}

.category-analytics {
    background: rgba(74, 21, 75, 0.1);
    color: var(--primary-purple);
}

.category-prediction {
    background: rgba(46, 196, 182, 0.1);
    color: var(--accent-teal);
}

.category-security {
    background: rgba(239, 90, 95, 0.1);
    color: var(--secondary-red);
}

.category-optimization {
    background: rgba(255, 159, 28, 0.1);
    color: #ff9f1c;
}

.algorithm-description {
    color: #6c757d;
    font-size: 0.95rem;
    line-height: 1.6;
    margin-bottom: 20px;
}

.algorithm-stats {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
}

.algorithm-stat {
    text-align: center;
    flex: 1;
}

.algorithm-stat-value {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--accent-teal);
    display: block;
}

.algorithm-stat-label {
    font-size: 0.8rem;
    color: #6c757d;
}

.algorithm-controls {
    display: flex;
    gap: 10px;
    align-items: center;
}

.algorithm-switch {
    margin-left: auto;
}

.algorithm-status {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 8px;
}

.status-idle {
    background: #6c757d;
}

.status-running {
    background: #28a745;
    animation: pulse 1s infinite;
}

.status-complete {
    background: var(--accent-teal);
}

.status-error {
    background: var(--secondary-red);
}

.algorithm-results {
    max-height: 400px;
    overflow-y: auto;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 12px;
}

.algorithm-result-item {
    background: white;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 10px;
    border-left: 4px solid var(--accent-teal);
}

.algorithm-result-item:last-child {
    margin-bottom: 0;
}

.algorithm-result-title {
    font-weight: 600;
    color: var(--primary-purple);
    margin-bottom: 5px;
}

.algorithm-result-value {
    font-size: 1.1rem;
    color: var(--accent-teal);
    font-weight: 700;
}

.algorithm-result-description {
    font-size: 0.9rem;
    color: #6c757d;
    margin-top: 5px;
}

.algorithm-progress {
    height: 6px;
    background: #e9ecef;
    border-radius: 3px;
    overflow: hidden;
    margin: 10px 0;
}

.algorithm-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--primary-purple), var(--accent-teal));
    border-radius: 3px;
    transition: width 0.3s ease;
}

/* تحسينات للجوال */
@media (max-width: 768px) {
    .algorithms-grid {
        grid-template-columns: 1fr;
    }
    
    .algorithm-card {
        padding: 20px;
    }
    
    .algorithm-stats {
        flex-direction: column;
        gap: 10px;
    }
    
    .algorithm-controls {
        flex-direction: column;
        align-items: stretch;
    }
}

 /* نظام الاستيراد الجماعي */
.bulk-import-card {
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    border: none;
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
}

.import-step {
    padding: 20px 0;
    border-bottom: 1px solid #eee;
}

.import-step:last-child {
    border-bottom: none;
}

.step-title {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
    color: var(--primary-purple);
}

.step-number {
    background: linear-gradient(135deg, var(--primary-purple), var(--accent-teal));
    color: white;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.1rem;
}

.template-card {
    background: rgba(74, 21, 75, 0.05);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    border: 1px solid rgba(74, 21, 75, 0.1);
    height: 100%;
}

.upload-area {
    border: 2px dashed #ddd;
    border-radius: 16px;
    padding: 40px 20px;
    text-align: center;
    background: rgba(46, 196, 182, 0.05);
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
}

.upload-area:hover {
    border-color: var(--accent-teal);
    background: rgba(46, 196, 182, 0.1);
    transform: translateY(-2px);
}

.upload-area.dragover {
    border-color: var(--primary-purple);
    background: rgba(74, 21, 75, 0.1);
    transform: scale(1.02);
}

.upload-icon {
    font-size: 3rem;
    color: var(--accent-teal);
    margin-bottom: 15px;
}

.upload-content h5 {
    color: var(--primary-purple);
    margin-bottom: 10px;
}

.file-types {
    font-size: 0.9rem;
    color: #6c757d;
    background: white;
    padding: 5px 15px;
    border-radius: 20px;
    display: inline-block;
    margin-top: 10px;
}

.file-info {
    background: rgba(40, 167, 69, 0.1);
    border: 1px solid rgba(40, 167, 69, 0.2);
    border-radius: 12px;
    padding: 15px;
    margin-top: 15px;
}

.required-fields {
    list-style: none;
    padding: 0;
    text-align: left;
}

.required-fields li {
    padding: 3px 0;
    font-size: 0.9rem;
    color: #6c757d;
}

.required-fields li::before {
    content: "•";
    color: var(--accent-teal);
    font-weight: bold;
    margin-right: 8px;
}

.preview-stats .stat-box {
    background: white;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    border: 1px solid #eee;
}

.stat-box .stat-number {
    font-size: 2rem;
    font-weight: 700;
    color: var(--accent-teal);
    margin-bottom: 5px;
}

.stat-box .stat-label {
    font-size: 0.9rem;
    color: #6c757d;
}

.preview-table {
    max-height: 400px;
    overflow-y: auto;
    border-radius: 12px;
    border: 1px solid #eee;
    margin-top: 20px;
}

.preview-table .table th {
    background: var(--primary-purple);
    color: white;
    position: sticky;
    top: 0;
    z-index: 10;
}

.validation-errors {
    background: rgba(220, 53, 69, 0.1);
    border: 1px solid rgba(220, 53, 69, 0.2);
    border-radius: 12px;
    padding: 15px;
    margin-top: 15px;
}

.validation-errors ul {
    margin-bottom: 0;
    padding-left: 20px;
}

.validation-errors li {
    color: #dc3545;
    margin-bottom: 5px;
}

.import-progress {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 25px;
}

.progress-info {
    font-weight: 500;
    color: var(--primary-purple);
}

.import-log {
    margin-top: 20px;
}

.log-container {
    background: #2d3748;
    color: #e2e8f0;
    border-radius: 8px;
    padding: 15px;
    max-height: 200px;
    overflow-y: auto;
    font-family: 'Courier New', monospace;
    font-size: 0.85rem;
    line-height: 1.4;
}

.log-entry {
    margin-bottom: 2px;
    padding: 2px 0;
}

.log-entry.success {
    color: #68d391;
}

.log-entry.error {
    color: #fc8181;
}

.log-entry.info {
    color: #63b3ed;
}

.result-card {
    background: white;
    border-radius: 16px;
    padding: 25px;
    text-align: center;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    border: none;
    transition: transform 0.3s ease;
}

.result-card:hover {
    transform: translateY(-5px);
}

.result-card.success {
    border-left: 5px solid #28a745;
}

.result-card.error {
    border-left: 5px solid #dc3545;
}

.result-card.info {
    border-left: 5px solid #17a2b8;
}

.result-icon {
    font-size: 2.5rem;
    margin-bottom: 15px;
}

.result-card.success .result-icon {
    color: #28a745;
}

.result-card.error .result-icon {
    color: #dc3545;
}

.result-card.info .result-icon {
    color: #17a2b8;
}

.result-number {
    font-size: 2.2rem;
    font-weight: 700;
    margin-bottom: 8px;
}

.result-card.success .result-number {
    color: #28a745;
}

.result-card.error .result-number {
    color: #dc3545;
}

.result-card.info .result-number {
    color: #17a2b8;
}

.result-label {
    font-size: 1rem;
    color: #6c757d;
    font-weight: 500;
}

.error-details {
    background: rgba(220, 53, 69, 0.05);
    border-radius: 12px;
    padding: 20px;
    border: 1px solid rgba(220, 53, 69, 0.1);
}

.step-actions {
    display: flex;
    align-items: center;
    gap: 10px;
    padding-top: 20px;
    border-top: 1px solid #eee;
}

/* حالات خاصة للمسلسلات */
.series-fields {
    background: rgba(46, 196, 182, 0.05);
    border-radius: 12px;
    padding: 15px;
    margin-top: 15px;
    border: 1px solid rgba(46, 196, 182, 0.2);
}

.series-fields h6 {
    color: var(--accent-teal);
    margin-bottom: 10px;
}

/* رسائل التحميل */
.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 16px;
    z-index: 100;
}

.loading-spinner {
    text-align: center;
    color: var(--primary-purple);
}

.loading-spinner .spinner-border {
    width: 3rem;
    height: 3rem;
    color: var(--accent-teal);
}

/* تحسينات الجوال */
@media (max-width: 768px) {
    .step-title {
        flex-direction: column;
        text-align: center;
        gap: 10px;
    }
    
    .template-card {
        margin-bottom: 20px;
    }
    
    .upload-area {
        padding: 30px 15px;
    }
    
    .upload-icon {
        font-size: 2rem;
    }
    
    .step-actions {
        flex-direction: column;
    }
    
    .step-actions button {
        width: 100%;
        margin-bottom: 10px;
    }
    
    .preview-stats .stat-box {
        margin-bottom: 15px;
    }
    
    .result-card {
        margin-bottom: 15px;
    }
}

/* أنماط الجدول المحسنة */
.preview-table .table td {
    font-size: 0.9rem;
    padding: 8px;
    vertical-align: middle;
}

.table-cell-valid {
    background: rgba(40, 167, 69, 0.1);
    color: #155724;
}

.table-cell-invalid {
    background: rgba(220, 53, 69, 0.1);
    color: #721c24;
}

.table-cell-warning {
    background: rgba(255, 193, 7, 0.1);
    color: #856404;
}

/* مؤشرات التقدم المحسنة */
.progress {
    border-radius: 10px;
    overflow: hidden;
}

.progress-bar {
    background: linear-gradient(90deg, var(--primary-purple), var(--accent-teal));
    transition: width 0.3s ease;
}

/* تحسينات إضافية */
.bulk-import-card .card-header {
    background: linear-gradient(90deg, var(--primary-purple), #5d1d63);
    color: white;
    border-radius: 16px 16px 0 0;
    padding: 20px 25px;
    font-weight: 600;
    font-size: 1.1rem;
}

.import-step.active {
    background: rgba(74, 21, 75, 0.02);
    border-radius: 12px;
    padding: 25px;
    margin: 10px 0;
}

.field-tooltip {
    cursor: help;
    color: var(--accent-teal);
}

.batch-size-info {
    background: rgba(255, 193, 7, 0.1);
    border: 1px solid rgba(255, 193, 7, 0.3);
    border-radius: 8px;
    padding: 10px;
    margin-top: 10px;
    font-size: 0.9rem;
}

.import-speed-indicator {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
    font-size: 0.9rem;
    color: #6c757d;
}

.speed-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 5px;
}

.speed-fast {
    background: #28a745;
}

.speed-medium {
    background: #ffc107;
}

.speed-slow {
    background: #dc3545;
}

/* أنماط فيديو Trailer */
.trailer-preview {
    background: rgba(74, 21, 75, 0.05);
    border-radius: 12px;
    padding: 15px;
    border: 1px solid rgba(74, 21, 75, 0.1);
}

.video-container {
    position: relative;
    width: 100%;
    height: 0;
    padding-bottom: 56.25%; /* نسبة 16:9 */
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.video-container iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border-radius: 8px;
}

/* فيديو في صفحة إعادة التوجيه */
.content-video {
    width: 100%;
    height: 300px;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    background: #000;
    position: relative;
}

.content-video iframe {
    width: 100%;
    height: 100%;
    border: none;
    border-radius: 12px;
}

.video-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, rgba(74, 21, 75, 0.1), rgba(46, 196, 182, 0.1));
    pointer-events: none;
    border-radius: 12px;
}

.video-play-button {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255, 255, 255, 0.9);
    border: none;
    border-radius: 50%;
    width: 80px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: var(--primary-purple);
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.video-play-button:hover {
    background: white;
    transform: translate(-50%, -50%) scale(1.1);
    box-shadow: 0 6px 25px rgba(0,0,0,0.4);
}

.video-title {
    position: absolute;
    bottom: 20px;
    left: 20px;
    right: 20px;
    color: white;
    background: rgba(0, 0, 0, 0.7);
    padding: 10px 15px;
    border-radius: 8px;
    font-weight: 500;
    backdrop-filter: blur(10px);
}

.video-duration {
    position: absolute;
    top: 15px;
    right: 15px;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 500;
}

.trailer-badge {
    position: absolute;
    top: 15px;
    left: 15px;
    background: linear-gradient(135deg, #ff0000, #cc0000);
    color: white;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: 0 2px 10px rgba(255, 0, 0, 0.3);
}

/* تحسينات للجوال */
@media (max-width: 768px) {
    .content-video {
        height: 200px;
        margin: 15px 0;
    }
    
    .video-play-button {
        width: 60px;
        height: 60px;
        font-size: 18px;
    }
    
    .video-title {
        bottom: 10px;
        left: 10px;
        right: 10px;
        padding: 8px 12px;
        font-size: 0.9rem;
    }
    
    .trailer-preview {
        padding: 10px;
    }
    
    .video-container {
        padding-bottom: 60%; /* نسبة أكثر ملاءمة للجوال */
    }
}

/* تأثيرات التحميل */
.video-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 200px;
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-radius: 12px;
    color: #6c757d;
}

.video-loading .spinner-border {
    width: 2rem;
    height: 2rem;
    margin-right: 10px;
}

/* أنماط الخطأ */
.video-error {
    background: rgba(220, 53, 69, 0.1);
    border: 1px solid rgba(220, 53, 69, 0.2);
    color: #721c24;
    padding: 20px;
    border-radius: 12px;
    text-align: center;
}

.video-error i {
    font-size: 2rem;
    margin-bottom: 10px;
    color: #dc3545;
}

/* أنماط مشغل مخصص */
.custom-player {
    position: relative;
    background: #000;
    border-radius: 12px;
    overflow: hidden;
}

.player-controls {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(transparent, rgba(0,0,0,0.8));
    padding: 15px;
    transform: translateY(100%);
    transition: transform 0.3s ease;
}

.custom-player:hover .player-controls {
    transform: translateY(0);
}

.play-pause-btn {
    background: none;
    border: none;
    color: white;
    font-size: 1.2rem;
    margin-right: 15px;
    cursor: pointer;
}

.progress-bar {
    flex: 1;
    height: 4px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 2px;
    margin: 0 15px;
    position: relative;
    cursor: pointer;
}

.progress-fill {
    height: 100%;
    background: var(--accent-teal);
    border-radius: 2px;
    width: 0%;
    transition: width 0.1s ease;
}

.volume-control {
    display: flex;
    align-items: center;
    gap: 10px;
}

.volume-btn {
    background: none;
    border: none;
    color: white;
    font-size: 1rem;
    cursor: pointer;
}

.volume-slider {
    width: 60px;
    height: 4px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 2px;
    outline: none;
    cursor: pointer;
}

/* تحسينات إضافية */
.trailer-info {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
    font-size: 0.9rem;
    color: #6c757d;
}

.video-quality-badge {
    background: rgba(74, 21, 75, 0.1);
    color: var(--primary-purple);
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
}

.autoplay-indicator {
    position: absolute;
    top: 50px;
    right: 15px;
    background: rgba(46, 196, 182, 0.9);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 500;
    animation: pulse 2s infinite;
}

/* إضافة خلفية ديناميكية */
.dynamic-background {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-size: cover;
    background-position: center;
    z-index: -1;
    
    transition: background-image 0.5s ease;
}

#redirectPanel .navbar-toggler {
    display: none !important;
}

#redirectPanel .navbar {
    direction: ltr;
    text-align: left;
}

 </style>
 
 </head>
  <body>
    <div id="splashScreenWidgetContainer" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 999999;">
<style>
/* <![CDATA[ */
#splashScreenWidgetContainer {
  --primary: #6a11cb;
  --secondary: #2575fc;
  --accent: #ff6b6b;
  --dark: #0f0c29;
  --light: #ffffff;
  background: linear-gradient(to bottom, #0f0c29, #302b63, #24243e);
  overflow: hidden;
  height: 100%;
  direction: rtl;
  font-family: 'Cairo', 'Poppins', sans-serif;
}

#splashScreenWidgetContainer,
#splashScreenWidgetContainer * {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* Animated background shapes */
#splashScreenWidgetContainer .bg-animation {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 0;
  overflow: hidden;
}

#splashScreenWidgetContainer .bg-animation span {
  position: absolute;
  display: block;
  width: 20px;
  height: 20px;
  background: rgba(255, 255, 255, 0.05);
  animation: move 25s linear infinite;
  bottom: -150px;
}

#splashScreenWidgetContainer .bg-animation span:nth-child(1) { left: 25%; width: 80px; height: 80px; animation-delay: 0s; }
#splashScreenWidgetContainer .bg-animation span:nth-child(2) { left: 10%; width: 20px; height: 20px; animation-delay: 2s; animation-duration: 12s; }
#splashScreenWidgetContainer .bg-animation span:nth-child(3) { left: 70%; width: 20px; height: 20px; animation-delay: 4s; }
#splashScreenWidgetContainer .bg-animation span:nth-child(4) { left: 40%; width: 60px; height: 60px; animation-delay: 0s; animation-duration: 18s; }
#splashScreenWidgetContainer .bg-animation span:nth-child(5) { left: 65%; width: 20px; height: 20px; animation-delay: 0s; }
#splashScreenWidgetContainer .bg-animation span:nth-child(6) { left: 75%; width: 110px; height: 110px; animation-delay: 3s; }
#splashScreenWidgetContainer .bg-animation span:nth-child(7) { left: 35%; width: 150px; height: 150px; animation-delay: 7s; }
#splashScreenWidgetContainer .bg-animation span:nth-child(8) { left: 50%; width: 25px; height: 25px; animation-delay: 15s; animation-duration: 45s; }
#splashScreenWidgetContainer .bg-animation span:nth-child(9) { left: 20%; width: 15px; height: 15px; animation-delay: 2s; animation-duration: 35s; }
#splashScreenWidgetContainer .bg-animation span:nth-child(10) { left: 85%; width: 150px; height: 150px; animation-delay: 0s; animation-duration: 11s; }

/* Splash Screen Container */
#splashScreenWidgetContainer .splash-container {
  position: relative;
  width: 100%;
  height: 100vh;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 10;
}

/* Logo Design */
#splashScreenWidgetContainer .logo-wrapper {
  position: relative;
  width: 200px;
  height: 200px;
  margin-bottom: 40px;
  animation: float 6s ease-in-out infinite;
}

#splashScreenWidgetContainer .logo-circle {
  position: absolute;
  width: 100%;
  height: 100%;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  display: flex;
  justify-content: center;
  align-items: center;
  box-shadow: 0 0 60px rgba(106, 17, 203, 0.6);
  animation: pulse 4s infinite alternate;
}

#splashScreenWidgetContainer .logo-inner {
  position: relative;
  width: 85%;
  height: 85%;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  display: flex;
  justify-content: center;
  align-items: center;
  overflow: hidden;
}

#splashScreenWidgetContainer .logo-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 50%;
}

/* Glitch Effect Text */
#splashScreenWidgetContainer .glitch {
  position: relative;
  font-size: 48px;
  font-weight: 900;
  text-transform: uppercase;
  letter-spacing: 3px;
  color: white;
  text-shadow: 0.05em 0 0 rgba(255, 0, 0, 0.75), -0.025em -0.05em 0 rgba(0, 255, 0, 0.75), 0.025em 0.05em 0 rgba(0, 0, 255, 0.75);
  animation: glitch 500ms infinite;
}

#splashScreenWidgetContainer .glitch::before,
#splashScreenWidgetContainer .glitch::after {
  content: attr(data-text);
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}

#splashScreenWidgetContainer .glitch::before { animation: glitch-1 500ms infinite; color: #ff6b6b; z-index: -1; }
#splashScreenWidgetContainer .glitch::after { animation: glitch-2 500ms infinite; color: #4ecdc4; z-index: -2; }

/* Loading Bar */
#splashScreenWidgetContainer .loading-container {
  width: 300px;
  height: 4px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 10px;
  margin-top: 30px;
  overflow: hidden;
}

#splashScreenWidgetContainer .loading-bar {
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent));
  border-radius: 10px;
  animation: loading 7s ease-out forwards;
}

/* Neon Text */
#splashScreenWidgetContainer .neon-text {
  font-family: 'Poppins', sans-serif;
  font-size: 24px;
  font-weight: 700;
  color: white;
  text-align: center;
  margin-top: 20px;
  opacity: 0;
  animation: fadeIn 1.5s forwards 2s;
  text-shadow: 0 0 10px rgba(255, 255, 255, 0.8), 0 0 20px rgba(255, 255, 255, 0.6), 0 0 40px var(--primary), 0 0 70px var(--primary);
}

/* Floating Platform Icons */
#splashScreenWidgetContainer .floating-icons {
  position: absolute;
  width: 100%;
  height: 100%;
  top: 0;
  left: 0;
  z-index: 1;
  overflow: hidden;
}

#splashScreenWidgetContainer .platform-icon {
  position: absolute;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(255, 255, 255, 0.08);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 15px;
  backdrop-filter: blur(5px);
  box-shadow: 0 5px 15px rgba(0,0,0,0.2);
  color: rgba(255, 255, 255, 0.9);
  animation: float-icon 20s infinite linear;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}
#splashScreenWidgetContainer .platform-icon:hover {
  transform: scale(1.15) translateY(-10px);
  box-shadow: 0 10px 25px rgba(0,0,0,0.3);
}

#splashScreenWidgetContainer .platform-icon.text-icon {
  font-family: 'Poppins', sans-serif;
  font-weight: 900;
  text-transform: uppercase;
}

/* Specific Brand Colors & Styles */
#splashScreenWidgetContainer .platform-icon[data-name="Netflix"] i { color: #E50914; }
#splashScreenWidgetContainer .platform-icon[data-name="Bein Sports"] { color: #8a2be2; font-size: 18px; font-style: italic; }
#splashScreenWidgetContainer .platform-icon[data-name="PlayStation"] i { color: #0070d1; }
#splashScreenWidgetContainer .platform-icon[data-name="Spotify"] i { color: #1DB954; }
#splashScreenWidgetContainer .platform-icon[data-name="IPTV"] i { color: #00a8ff; }
#splashScreenWidgetContainer .platform-icon[data-name="Shahid VIP"] { color: #00b894; font-size: 16px; letter-spacing: 1px; }
#splashScreenWidgetContainer .platform-icon[data-name="Premium"] i { color: #ffd700; }
#splashScreenWidgetContainer .platform-icon[data-name="Free"] { color: #ffffff; font-size: 18px; }

/* Icon Distribution, Size, and Animation Speed */
#splashScreenWidgetContainer .platform-icon:nth-child(1) { top: 15%; left: 10%; font-size: 32px; padding: 15px; animation-delay: 0s; animation-duration: 25s; }
#splashScreenWidgetContainer .platform-icon:nth-child(2) { top: 30%; left: 85%; font-size: 24px; padding: 12px 20px; animation-delay: 2s; animation-duration: 30s; }
#splashScreenWidgetContainer .platform-icon:nth-child(3) { top: 75%; left: 90%; font-size: 30px; padding: 18px; animation-delay: 4s; animation-duration: 20s; }
#splashScreenWidgetContainer .platform-icon:nth-child(4) { top: 80%; left: 20%; font-size: 35px; padding: 20px; animation-delay: 1s; animation-duration: 35s; }
#splashScreenWidgetContainer .platform-icon:nth-child(5) { top: 45%; left: 45%; font-size: 28px; padding: 15px; animation-delay: 6s; animation-duration: 18s; }
#splashScreenWidgetContainer .platform-icon:nth-child(6) { top: 10%; left: 60%; font-size: 22px; padding: 10px 18px; animation-delay: 8s; animation-duration: 28s; }
#splashScreenWidgetContainer .platform-icon:nth-child(7) { top: 60%; left: 5%;  font-size: 30px; padding: 18px; animation-delay: 3s; animation-duration: 22s; }
#splashScreenWidgetContainer .platform-icon:nth-child(8) { top: 90%; left: 50%; font-size: 26px; padding: 14px 22px; animation-delay: 5s; animation-duration: 26s; }

/* Particles */
#splashScreenWidgetContainer .particles { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
#splashScreenWidgetContainer .particle { position: absolute; background-color: white; border-radius: 50%; opacity: 0.4; animation: particle-float 15s infinite linear; }

/* --- ANIMATIONS --- */
@keyframes move {
  0% { transform: translateY(0) rotate(0deg); opacity: 1; border-radius: 0; }
  100% { transform: translateY(-110vh) rotate(720deg); opacity: 0; border-radius: 50%; }
}
@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-20px); }
}
@keyframes pulse {
  0% { box-shadow: 0 0 60px rgba(106, 17, 203, 0.6); }
  100% { box-shadow: 0 0 100px rgba(106, 17, 203, 0.9), 0 0 150px rgba(37, 117, 252, 0.6); }
}
@keyframes glitch { 0%, 100% { text-shadow: 0.05em 0 0 rgba(255, 0, 0, 0.75), -0.025em -0.05em 0 rgba(0, 255, 0, 0.75), 0.025em 0.05em 0 rgba(0, 0, 255, 0.75); } 14% { text-shadow: 0.05em 0 0 rgba(255, 0, 0, 0.75), -0.025em -0.05em 0 rgba(0, 255, 0, 0.75), 0.025em 0.05em 0 rgba(0, 0, 255, 0.75); } 15% { text-shadow: -0.05em -0.025em 0 rgba(255, 0, 0, 0.75), 0.025em 0.025em 0 rgba(0, 255, 0, 0.75), -0.05em -0.05em 0 rgba(0, 0, 255, 0.75); } 49% { text-shadow: -0.05em -0.025em 0 rgba(255, 0, 0, 0.75), 0.025em 0.025em 0 rgba(0, 255, 0, 0.75), -0.05em -0.05em 0 rgba(0, 0, 255, 0.75); } 50% { text-shadow: 0.025em 0.05em 0 rgba(255, 0, 0, 0.75), 0.05em 0 0 rgba(0, 255, 0, 0.75), 0 -0.05em 0 rgba(0, 0, 255, 0.75); } 99% { text-shadow: 0.025em 0.05em 0 rgba(255, 0, 0, 0.75), 0.05em 0 0 rgba(0, 255, 0, 0.75), 0 -0.05em 0 rgba(0, 0, 255, 0.75); } }
@keyframes glitch-1 { 0%, 100% { clip-path: inset(48% 0 5% 0); transform: translate(-2px, 1px); } 20% { clip-path: inset(15% 0 60% 0); transform: translate(2px, -1px); } 40% { clip-path: inset(85% 0 5% 0); transform: translate(-2px, 1px); } 60% { clip-path: inset(20% 0 65% 0); transform: translate(2px, -1px); } 80% { clip-path: inset(70% 0 15% 0); transform: translate(-2px, 1px); } }
@keyframes glitch-2 { 0%, 100% { clip-path: inset(25% 0 55% 0); transform: translate(2px, -1px); } 20% { clip-path: inset(50% 0 25% 0); transform: translate(-2px, 1px); } 40% { clip-path: inset(5% 0 80% 0); transform: translate(2px, -1px); } 60% { clip-path: inset(65% 0 20% 0); transform: translate(-2px, 1px); } 80% { clip-path: inset(15% 0 70% 0); transform: translate(2px, -1px); } }
@keyframes loading { 0% { width: 0%; } 100% { width: 100%; } }
@keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
@keyframes float-icon {
  0% { transform: translateY(110vh) rotate(0deg); opacity: 0.7; }
  100% { transform: translateY(-10vh) rotate(720deg); opacity: 0.7; }
}
@keyframes particle-float { 0% { transform: translateY(100vh) scale(0); } 10% { transform: translateY(80vh) scale(1); } 100% { transform: translateY(-100vh) scale(0); } }

/* Responsive Design */
@media (max-width: 768px) {
  #splashScreenWidgetContainer .logo-wrapper { width: 150px; height: 150px; }
  #splashScreenWidgetContainer .glitch { font-size: 36px; }
  #splashScreenWidgetContainer .neon-text { font-size: 18px; }
  #splashScreenWidgetContainer .loading-container { width: 250px; }
}
@media (max-width: 480px) {
  #splashScreenWidgetContainer .logo-wrapper { width: 120px; height: 120px; }
  #splashScreenWidgetContainer .glitch { font-size: 28px; }
  #splashScreenWidgetContainer .neon-text { font-size: 16px; }
  #splashScreenWidgetContainer .loading-container { width: 200px; }
  #splashScreenWidgetContainer .platform-icon { border-radius: 10px; }
  #splashScreenWidgetContainer .platform-icon, 
  #splashScreenWidgetContainer .platform-icon:nth-child(n) { font-size: 20px !important; padding: 10px !important; }
}
/* ]]> */
</style>

<div class="bg-animation">
  <span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span>
</div>

<div class="particles" id="particles"></div>

<div class="floating-icons">
  <div class="platform-icon" data-name="Netflix"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgv3yimwc7QOegcYNSIuvqfSBTWbkLsbupW1ftdN0cYqW8YhXHKR-raT8CZzVhRHlTvl6HZwpnv-TBs3jtouz__WmWJF8xQmWMGVLK5k2OfD-xoCPb_tOACZZbdL7vj5djx7MhLDDQyGM8o26sULj5ie7aG9SBmTcRl3UxS2wJMbje-3CCcseLcvrEjJWM/s78/IMG_20241017_214800_950_copy_77x78.png" alt="Turkify - Netflix icon"/></div>
  <div class="platform-icon text-icon" data-name="Bein Sports"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh_AfGrMcrztzJZToYIZ6URfUkaIR3OPQvT-PTmKFqEH7_wKEMitgOVGUnkiiiNwFE5KJtM5Tj9NzIgSijHK1piOJTp7aS88zueDM4SDFLPX4WAPTOOvJdIH7VMViv02KImRaQ8TS4BMvn2OA1hczicv7jZDbRYJddlBjrKaVkjVjJf6HjhTvoavd36X3Q/s78/images_copy_77x78.png" alt="Turkify - Bein Sports"/></div>
  <div class="platform-icon" data-name="PlayStation"><i class="fab fa-playstation"></i></div>
  <div class="platform-icon" data-name="Spotify"><i class="fab fa-spotify"></i></div>
  <div class="platform-icon" data-name="IPTV"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhnFzkBIZwlPHnlx1_hrm0j6p_xCcGYETk4sEJzIIfPIm_XM-D9PqCr-mFs5B2zx4CsB8RlYGYdYW2Orwo3YXkVKRj_xsitFaRtRdRiMhoy2f6jkK1g5sCmhvMb6lTlHOwBd7UOnaNbNxedL8XAZqdmyb3Bv5XwsHjOCkvyISWyVcYhWW0Y44r_4lW2Z4c/s78/IMG_20241017_214737_733_copy_77x78.png" alt="Turkify - IPTV icon"/></div>
  <div class="platform-icon text-icon" data-name="Shahid VIP"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhIdDFBmZ_w2vib2Co178FXtLpB2imMqP9D5gM6w0QTXLXT7wjZfnSbAkZfRlIiXm2YQu5jrLCiAMiCY8CuJfjS-gjgTLkETpqq8IEwdbdSb6-KMuPkb9WCipp7mK95By7ROrLPpJCavovrXclOAvPRivx0mQsNuwCJHbuRqja6UDHX_f2HSdzjibSqA-A/s78/IMG_20241017_214745_735_copy_77x78.png" alt="Turkify - Shahid vip icon"/></div>
  <div class="platform-icon" data-name="Premium"><i class="fas fa-gem"></i></div>
  <div class="platform-icon text-icon" data-name="Free">Free</div>
</div>

<div class="splash-container" id="splashScreen">
  <div class="logo-wrapper">
    <div class="logo-circle">
      <div class="logo-inner">
        <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjO1S1cpbS97itg5y7YkneJmqMMNoU9r_dRr89Cx-wzA_UdonM2lZb0OVerP8G5c9R1pR4WDY7QBFoi6i6KtZRYWbjloEJKvPP3HNSz4qgoRSVXH2fAevykgoHaT4GQ8pxVi8j7PNxCPijb23DwCvplkyrVCcb-kdy5bNSNCcIrXZ_W4heaomBjfiBmCBA/s192/logo-192%C3%97192-20252026.png" alt="Turkify Logo" class="logo-image">
      </div>
    </div>
  </div>
  
  <h1 class="glitch" data-text="TURKIFY">TURKIFY</h1>
  
  <div class="loading-container">
    <div class="loading-bar"></div>
  </div>
  
  <p class="neon-text">عالم الترفيه بين يديك</p>
</div>

<script>
/* <![CDATA[ */
(function() {
  // Load required libraries
  function loadResources() {
    // Load Bootstrap CSS
    const bootstrapCSS = document.createElement('link');
    bootstrapCSS.href = 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css';
    bootstrapCSS.rel = 'stylesheet';
    
    // Load Font Awesome CSS
    const fontAwesomeCSS = document.createElement('link');
    fontAwesomeCSS.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css';
    fontAwesomeCSS.rel = 'stylesheet';
    
    // Load Google Fonts
    const googleFonts = document.createElement('link');
    googleFonts.href = 'https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Poppins:wght@300;400;600;700;900&display=swap';
    googleFonts.rel = 'stylesheet';
    
    document.head.appendChild(bootstrapCSS);
    document.head.appendChild(fontAwesomeCSS);
    document.head.appendChild(googleFonts);
  }
  
  // Create background particles
  function createParticles() {
    const particlesContainer = document.getElementById('particles');
    const particleCount = 50;
    
    for (let i = 0; i < particleCount; i++) {
      const particle = document.createElement('div');
      particle.className = 'particle';
      const size = Math.random() * 5 + 2;
      particle.style.width = `${size}px`;
      particle.style.height = `${size}px`;
      particle.style.left = `${Math.random() * 100}%`;
      const duration = Math.random() * 20 + 10;
      particle.style.animationDuration = `${duration}s`;
      const delay = Math.random() * 5;
      particle.style.animationDelay = `${delay}s`;
      particlesContainer.appendChild(particle);
    }
  }
  
  // Initialize the splash screen
  function initSplashScreen() {
    createParticles();
    
    // Hide splash screen after 7 seconds
    setTimeout(() => {
      const container = document.getElementById('splashScreenWidgetContainer');
      container.style.transition = 'opacity 1s ease-out';
      container.style.opacity = '0';
      
      // Remove the splash screen after fade-out
      setTimeout(() => {
        container.remove();
      }, 1000);
    }, 7000);
  }
  
  // Load resources and initialize
  loadResources();
  setTimeout(initSplashScreen, 100); // Small delay to allow resources to load
})();
/* ]]> */
</script>
</div>
   <!-- Notification System -->
    <div class="notification success" id="successNotification"> <div>تم إنشاء الرابط بنجاح!</div> <div class="progress-bar"><div class="progress"></div></div> </div> <div class="notification error" id="errorNotification"> <div>الرجاء ملء جميع الحقول المطلوبة</div> <div class="progress-bar"><div class="progress"></div></div> </div> <div class="notification info" id="welcomeNotification"> <div>أهلاً بعودتك، <span id="userName"></span>!</div> <div class="progress-bar"><div class="progress"></div></div> </div> <!-- reCAPTCHA Badge --> <div class="grecaptcha-badge" data-style="bottomright"></div> <!-- Custom Shapes --> <div class="custom-shape shape-1"></div> <!-- Navigation -->  
    <nav class="navbar navbar-expand-lg navbar-dark"> <div class="container"> <a class="navbar-brand logo" href="#"> <div class="logo-icon"> <i class="fas fa-link"></i> </div> Turkify</a> <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="تبديل التنقل"> <span class="navbar-toggler-icon"></span> </button> <div class="collapse navbar-collapse" id="navbarContent"> <ul class="navbar-nav me-auto mb-2 mb-lg-0"> <li class="nav-item"> <a class="nav-link" href="#home" id="homeLink" aria-label="Home"> <i class="fas fa-home me-1"></i> الرئيسية </a> </li> <li class="nav-item admin-only"> <a class="nav-link" href="#dashboard" id="adminLink" aria-label="Admin Panel"> <i class="fas fa-cog me-1"></i> لوحة التحكم </a> </li> <li class="nav-item admin-only"> <a class="nav-link" href="#analytics" id="statsLink" aria-label="Analytics"> <i class="fas fa-chart-bar me-1"></i> التحليلات </a> </li> <li class="nav-item"> <a class="nav-link" href="#features" id="featuresLink" aria-label="Features"> <i class="fas fa-star me-1"></i> الميزات </a> </li> </ul> <div class="d-flex align-items-center auth-section"> <div id="authButtons"> <button class="btn btn-outline-light" id="signInButton" aria-label="Sign in with Google"> <i class="fab fa-google me-2"></i>تسجيل الدخول </button> </div> <div id="userProfile" style="display: none; margin-right: 15px;" aria-label="User profile"> <img src="" alt="User" id="userPhoto" class="rounded-circle me-2" style="width: 40px; height: 40px; object-fit: cover;" aria-label="User photo"> <button class="btn btn-outline-light" id="signOutButton" aria-label="Sign out"> <i class="fas fa-sign-out-alt me-1"></i>تسجيل الخروج </button> </div> </div> </div> </div> </nav> <!-- Main Content --> <div class="container my-5 pt-5"> <!-- Admin Panel --> <section id="admin"> <div id="adminPanel" class="admin-only"> <div class="row"> <div class="col-lg-8 mx-auto"> <div class="card"> <div class="card-header"> <i class="fas fa-plus-circle me-2"></i>إنشاء رابط قصير جديد </div> <div class="card-body"> <div class="mb-4"> <label class="form-label fw-bold">اسم السلسلة *</label> <input type="text" class="form-control" id="seriesName" placeholder="أدخل اسم السلسلة" aria-label="Series name"> <div class="invalid-feedback" id="nameError">الرجاء إدخال اسم سلسلة صالح (أحرف، أرقام، ومسافات فقط)</div> </div> <div class="mb-4"> <label class="form-label fw-bold">نوع المحتوى *</label> <select class="form-select" id="linkType" aria-label="Link type"> <option value="series">مسلسل</option> <option value="movie">فيلم</option> <option value="match">مباراة</option> <option value="recipe">وصفة</option> <option value="game">لعبة</option> <option value="app">تطبيق</option> <option value="channel">قناة</option> <option value="reels">ريلز</option> </select> </div> <!-- حقل عدد الحلقات الجديد --> <div class="mb-4" id="episodeCountWrapper" style="display: none;"> <label class="form-label fw-bold">عدد حلقات المسلسل *</label> <input type="number" class="form-control" id="totalEpisodes" placeholder="مثلاً 10"> <div class="invalid-feedback" id="episodeError">الرجاء إدخال عدد حلقات صحيح</div> </div> <!-- حقل رقم الحلقة الابتدائية --> <div class="mb-4" id="startingEpisodeWrapper" style="display: none;"> <label class="form-label fw-bold">رقم الحلقة الابتدائية *</label> <input type="number" class="form-control" id="startingEpisode" placeholder="مثلاً 1" min="1" value="1"> <div class="form-text">رقم الحلقة التي سيبدأ منها العد التلقائي اليومي</div> </div> <div class="mb-4"> <label class="form-label fw-bold">الرابط الأصلي *</label> <input type="url" class="form-control" id="originalUrl" placeholder="https://example.com" aria-label="Original URL"> <div class="invalid-feedback" id="urlError">الرجاء إدخال رابط صالح</div> </div> <div class="mb-4"> <label class="form-label fw-bold">نطاق مخصص (مميز)</label> <input type="text" class="form-control" id="customDomain" placeholder="yourdomain.com" value="turkii.netlify.app" aria-label="Custom domain"> </div> <div class="mb-4"> <label class="form-label fw-bold">عنوان معاينة السوشيال ميديا</label> <input type="text" class="form-control" id="socialTitle" placeholder="عنوان جذاب للمحتوى" aria-label="Social media title"> </div> <div class="mb-4"> <label class="form-label fw-bold">وصف معاينة السوشيال ميديا</label> <textarea class="form-control" id="socialDescription" rows="3" placeholder="وصف جذاب للمحتوى يجذب الزوار" aria-label="Social media description"></textarea> </div> <div class="mb-4"> <label class="form-label fw-bold">صورة الخلفية (URL)</label> <input type="url" class="form-control" id="socialBackground" placeholder="https://example.com/background.jpg" aria-label="Background image"> <div class="form-text">اختياري: صورة خلفية </div> </div> <div class="mb-4"> <!-- حقل الصورة للأنواع العادية --> <div id="imageField"> <label class="form-label fw-bold">صورة معاينة السوشيال ميديا (URL)</label> <input type="url" class="form-control" id="socialImage" placeholder="https://example.com/image.jpg" aria-label="Social media image"> <div class="form-text">استخدم صورة جذابة لجذب المزيد من النقرات</div> </div> <!-- حقل ملف الحلقات للمسلسلات فقط --> <div class="mb-4" id="jsonUploadWrapper" style="display: none;"> <label class="form-label fw-bold">ملف تفاصيل الحلقات (JSON) *</label> <input type="file" class="form-control" id="episodesJson" accept=".json"> <div class="form-text"> رفع ملف JSON يحتوي على تفاصيل جميع حلقات المسلسل (رقم الحلقة، العنوان، الوصف) </div> <div class="mt-2"> <a href="#" id="downloadTemplate">تحميل نموذج JSON</a> </div> <div id="episodesInfo" class="mt-2"></div> </div> <!-- حقل الفيديو للمسلسلات والأفلام --> <div id="trailerField" style="display: none;"> <label class="form-label fw-bold">رابط Trailer من يوتيوب <span class="text-danger">*</span></label> <input type="url" class="form-control" id="trailerUrl" placeholder="https://www.youtube.com/watch?v=VIDEO_ID" aria-label="YouTube trailer URL"> <div class="form-text"> <i class="fab fa-youtube text-danger me-1"></i> سيتم عرض الفيديو تلقائياً في صفحة إعادة التوجيه </div> <!-- معاينة الفيديو --> <div id="trailerPreview" class="trailer-preview mt-3" style="display: none;"> <h6><i class="fas fa-eye me-2"></i>معاينة الفيديو:</h6> <div class="video-container"> <iframe id="trailerFrame" width="100%" height="200" frameborder="0" allowfullscreen></iframe> </div> </div> </div> </div> <div class="d-grid"> <button id="generateBtn" class="btn btn-primary btn-lg py-3 fw-bold" aria-label="Generate link"> <i class="fas fa-bolt me-2"></i>إنشاء الرابط </button> <button id="updateBtn" class="btn btn-success btn-lg py-3 fw-bold mt-2" style="display: none;" aria-label="Update link"> <i class="fas fa-save me-2"></i>حفظ التغييرات </button> </div> <div class="mt-4"> <h5>معاينة منشور السوشيال ميديا</h5> <div class="social-preview"> <img src="https://via.placeholder.com/500x300/4A154B/FFFFFF?text=صورة+المحتوى" id="previewImage" class="social-preview-img" alt="Preview"> <h5 id="previewTitle">عنوان المحتوى</h5> <p id="previewDescription">وصف المحتوى الذي سيظهر على منصات التواصل الاجتماعي</p> <small id="previewDomain">turkii.netlify.app</small> </div> </div> </div> </div> </div> </div> <!-- Bulk Import System --> <div class="row mt-5"> <div class="col-lg-10 mx-auto"> <div class="card bulk-import-card"> <div class="card-header"> <i class="fas fa-upload me-2"></i>استيراد الروابط بالجملة <span class="badge bg-info ms-2">جديد</span> </div> <div class="card-body"> <!-- Step 1: Content Type Selection --> <div class="import-step" id="step1"> <h5 class="step-title"> <span class="step-number">1</span> اختر نوع المحتوى </h5> <div class="row"> <div class="col-md-6"> <label class="form-label fw-bold">نوع المحتوى *</label> <select class="form-select" id="bulkContentType"> <option value="">-- اختر نوع المحتوى --</option> <option value="series">مسلسل</option> <option value="movie">فيلم</option> <option value="match">مباراة</option> <option value="recipe">وصفة</option> <option value="game">لعبة</option> <option value="app">تطبيق</option> <option value="channel">قناة</option> <option value="reels">ريلز</option> </select> </div> <div class="col-md-6"> <label class="form-label fw-bold">النطاق المستخدم</label> <select class="form-select" id="bulkDomain"> <option value="turkii.netlify.app">turkii.netlify.app (افتراضي)</option> <option value="turkii.netlify.app">turkii.netlify.app (مخصص)</option> </select> </div> </div> <button class="btn btn-primary mt-3" id="nextToStep2"> <i class="fas fa-arrow-right me-2"></i>التالي: تحضير الملف </button> </div> <!-- Step 2: File Template & Upload --> <div class="import-step" id="step2" style="display: none;"> <h5 class="step-title"> <span class="step-number">2</span> تحضير ورفع الملف </h5> <!-- Template Info --> <div class="template-info mb-4"> <div class="row"> <div class="col-md-6"> <div class="template-card"> <h6><i class="fas fa-download me-2"></i>تحميل القالب</h6> <p class="text-muted">حمّل قالب CSV جاهز بالحقول المطلوبة</p> <button class="btn btn-outline-success btn-sm" id="downloadTemplate"> <i class="fas fa-file-csv me-1"></i>تحميل القالب </button> </div> </div> <div class="col-md-6"> <div class="template-card"> <h6><i class="fas fa-info-circle me-2"></i>الحقول المطلوبة</h6> <ul class="required-fields" id="requiredFieldsList"> <!-- سيتم ملؤها بـ JavaScript --> </ul> </div> </div> </div> </div> <!-- File Upload --> <div class="upload-section"> <div class="upload-area" id="uploadArea"> <div class="upload-content"> <i class="fas fa-cloud-upload-alt upload-icon"></i> <h5>اسحب وأفلت الملف هنا</h5> <p class="text-muted">أو انقر لاختيار الملف</p> <p class="file-types">يدعم: CSV, Excel (.xlsx, .xls)</p> <input type="file" id="bulkFileInput" accept=".csv,.xlsx,.xls" style="display: none;"> </div> </div> <!-- File Info --> <div class="file-info" id="fileInfo" style="display: none;"> <div class="d-flex align-items-center justify-content-between"> <div> <i class="fas fa-file-alt me-2 text-success"></i> <span id="fileName">--</span> <span class="text-muted ms-2">(<span id="fileSize">--</span>)</span> </div> <button class="btn btn-sm btn-outline-danger" id="removeFile"> <i class="fas fa-times"></i> </button> </div> </div> </div> <div class="step-actions mt-4"> <button class="btn btn-outline-secondary me-2" id="backToStep1"> <i class="fas fa-arrow-left me-2"></i>السابق </button> <button class="btn btn-primary" id="nextToStep3" disabled> <i class="fas fa-arrow-right me-2"></i>التالي: معاينة البيانات </button> </div> </div> <!-- Step 3: Data Preview --> <div class="import-step" id="step3" style="display: none;"> <h5 class="step-title"> <span class="step-number">3</span> معاينة البيانات </h5> <div class="preview-stats mb-3"> <div class="row"> <div class="col-md-3"> <div class="stat-box"> <div class="stat-number" id="totalRows">0</div> <div class="stat-label">إجمالي الروابط</div> </div> </div> <div class="col-md-3"> <div class="stat-box"> <div class="stat-number" id="validRows">0</div> <div class="stat-label">روابط صالحة</div> </div> </div> <div class="col-md-3"> <div class="stat-box"> <div class="stat-number" id="invalidRows">0</div> <div class="stat-label">روابط غير صالحة</div> </div> </div> <div class="col-md-3"> <div class="stat-box"> <div class="stat-number" id="estimatedTime">0s</div> <div class="stat-label">الوقت المتوقع</div> </div> </div> </div> </div> <!-- Data Table --> <div class="preview-table"> <div class="table-responsive"> <table class="table table-hover" id="previewTable"> <thead> <!-- سيتم ملؤها بـ JavaScript --> </thead> <tbody> <!-- سيتم ملؤها بـ JavaScript --> </tbody> </table> </div> </div> <!-- Validation Errors --> <div class="validation-errors" id="validationErrors" style="display: none;"> <h6 class="text-danger"><i class="fas fa-exclamation-triangle me-2"></i>أخطاء التحقق:</h6> <ul id="errorsList"></ul> </div> <div class="step-actions mt-4"> <button class="btn btn-outline-secondary me-2" id="backToStep2"> <i class="fas fa-arrow-left me-2"></i>السابق </button> <button class="btn btn-success" id="startImport" disabled> <i class="fas fa-upload me-2"></i>بدء الاستيراد </button> </div> </div> <!-- Step 4: Import Progress --> <div class="import-step" id="step4" style="display: none;"> <h5 class="step-title"> <span class="step-number">4</span> جاري الاستيراد... </h5> <div class="import-progress"> <div class="progress-info mb-3"> <div class="d-flex justify-content-between"> <span>تقدم الاستيراد:</span> <span><span id="currentProgress">0</span> / <span id="totalProgress">0</span></span> </div> </div> <div class="progress mb-3" style="height: 20px;"> <div class="progress-bar progress-bar-striped progress-bar-animated" id="importProgressBar" style="width: 0%"></div> </div> <div class="import-status" id="importStatus"> <p class="text-muted">جاري التحضير...</p> </div> <!-- Live Log --> <div class="import-log"> <h6><i class="fas fa-list me-2"></i>سجل العمليات:</h6> <div class="log-container" id="importLog"> <!-- سيتم ملؤه بـ JavaScript --> </div> </div> </div> </div> <!-- Step 5: Results --> <div class="import-step" id="step5" style="display: none;"> <h5 class="step-title"> <span class="step-number">5</span> نتائج الاستيراد </h5> <div class="import-results"> <div class="row"> <div class="col-md-4"> <div class="result-card success"> <div class="result-icon"> <i class="fas fa-check-circle"></i> </div> <div class="result-number" id="successCount">0</div> <div class="result-label">تم بنجاح</div> </div> </div> <div class="col-md-4"> <div class="result-card error"> <div class="result-icon"> <i class="fas fa-times-circle"></i> </div> <div class="result-number" id="errorCount">0</div> <div class="result-label">فشل</div> </div> </div> <div class="col-md-4"> <div class="result-card info"> <div class="result-icon"> <i class="fas fa-clock"></i> </div> <div class="result-number" id="totalTime">0s</div> <div class="result-label">إجمالي الوقت</div> </div> </div> </div> <!-- Error Details --> <div class="error-details mt-4" id="errorDetails" style="display: none;"> <h6 class="text-danger">تفاصيل الأخطاء:</h6> <div class="table-responsive"> <table class="table table-sm"> <thead> <tr> <th>الصف</th> <th>المشكلة</th> <th>البيانات</th> </tr> </thead> <tbody id="errorDetailsTable"> <!-- سيتم ملؤها بـ JavaScript --> </tbody> </table> </div> </div> <div class="result-actions mt-4"> <button class="btn btn-success" id="downloadResults"> <i class="fas fa-download me-2"></i>تحميل تقرير النتائج </button> <button class="btn btn-primary ms-2" id="startNewImport"> <i class="fas fa-plus me-2"></i>استيراد جديد </button> <button class="btn btn-outline-info ms-2" id="viewImportedLinks"> <i class="fas fa-eye me-2"></i>عرض الروابط المستوردة </button> </div> </div> </div> </div> </div> </div> </div> <!-- Link Management --> <div class="row mt-5"> <div class="col-12"> <div class="card"> <div class="card-header d-flex justify-content-between align-items-center"> <div> <i class="fas fa-list me-2"></i>الروابط المدارة </div> <div class="d-flex"> <div class="input-group me-2" style="max-width: 300px;"> <input type="text" class="form-control" placeholder="بحث في الروابط..." id="searchLinks" aria-label="Search links"> <button class="btn btn-primary" id="searchButton" aria-label="Search"> <i class="fas fa-search"></i> </button> </div> <select class="form-select" id="sortLinks" style="max-width: 150px;" aria-label="Sort links"> <option value="newest">الأحدث أولاً</option> <option value="clicks">الأكثر نقرات</option> <option value="name">حسب الاسم</option> </select> </div> </div> <div class="card-body"> <div class="table-responsive"> <table class="table table-hover" aria-label="Managed links"> <thead> <tr> <th scope="col">المعرف</th> <th scope="col">اسم السلسلة</th> <th scope="col">النوع</th> <th scope="col">الرابط القصير</th> <th scope="col">تاريخ الإنشاء</th> <th scope="col">النقرات</th> <th scope="col">الإجراءات</th> </tr> </thead> <tbody id="linksTable"> <tr> <td colspan="7" class="text-center table-loader"> <div class="spinner-border text-primary" role="status"> <span class="visually-hidden">جاري التحميل...</span> </div> </td> </tr> </tbody> </table> </div> <nav class="mt-4" aria-label="Links pagination"> <ul class="pagination justify-content-center"> <li class="page-item disabled"> <a class="page-link" href="#" tabindex="-1">السابق</a> </li> <li class="page-item active"><a class="page-link" href="#">1</a></li> <li class="page-item"><a class="page-link" href="#">2</a></li> <li class="page-item"><a class="page-link" href="#">3</a></li> <li class="page-item"> <a class="page-link" href="#">التالي</a> </li> </ul> </nav> </div> </div> </div> </div> </div> </section> <!-- Analytics Dashboard --> <section id="analytics"> <div id="analyticsPanel" style="display: none;"> <div class="row"> <div class="col-12 mb-4"> <div class="card"> <div class="card-header"> <i class="fas fa-chart-line me-2"></i>نظرة عامة على أداء الروابط </div> <div class="card-body"> <div class="analytics-filter"> <h6>تصفية التحليلات:</h6> <div class="filter-group"> <button class="filter-btn active">الكل</button> <button class="filter-btn">اليوم</button> <button class="filter-btn">أسبوع</button> <button class="filter-btn">شهر</button> <button class="filter-btn">3 أشهر</button> <button class="filter-btn">6 أشهر</button> <button class="filter-btn">سنة</button> </div> </div> <div class="row"> <div class="col-md-3 col-6 mb-4"> <div class="stat-card"> <div class="stat-number" id="totalLinks">24</div> <div class="stat-label">إجمالي الروابط</div> </div> </div> <div class="col-md-3 col-6 mb-4"> <div class="stat-card"> <div class="stat-number" id="totalClicks">1,842</div> <div class="stat-label">إجمالي النقرات</div> </div> </div> <div class="col-md-3 col-6 mb-4"> <div class="stat-card"> <div class="stat-number" id="todayClicks">56</div> <div class="stat-label">نقرات اليوم</div> </div> </div> <div class="col-md-3 col-6 mb-4"> <div class="stat-card"> <div class="stat-number" id="popularLink">78%</div> <div class="stat-label">معدل التفاعل</div> </div> </div> </div> <div class="mt-5"> <h5 class="mb-4">النقرات مع مرور الوقت</h5> <div id="clicksChartPlaceholder" style="height: 300px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border-radius: 12px;"> <i class="fas fa-chart-bar fa-3x text-muted"></i> </div> </div> <div class="row mt-5"> <div class="col-md-6 mb-4"> <h5 class="mb-4">أفضل الروابط أداءً</h5> <div class="list-group"> <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" aria-label="Summer Sale link"> <div> <div class="fw-bold">تخفيضات الصيف</div> <small class="text-muted">https://turkii.netlify.app/s/389472</small> </div> <span class="clicks-badge">142 نقرات</span> </a> <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" aria-label="Special Offer link"> <div> <div class="fw-bold">عرض خاص</div> <small class="text-muted">https://turkii.netlify.app/s/734516</small> </div> <span class="clicks-badge">128 نقرات</span> </a> <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" aria-label="New Products link"> <div> <div class="fw-bold">منتجات جديدة</div> <small class="text-muted">https://turkii.netlify.app/s/562891</small> </div> <span class="clicks-badge">89 نقرات</span> </a> </div> </div> <div class="col-md-6 mb-4"> <h5 class="mb-4">التوزيع الجغرافي</h5> <div class="stats-card"> <div class="d-flex align-items-center mb-3"> <img src="https://flagcdn.com/sa.svg" loading="lazy" class="country-flag" alt="Saudi Arabia flag"> <div class="fw-bold">السعودية</div> <div class="ms-auto">42%</div> </div> <div class="d-flex align-items-center mb-3"> <img src="https://flagcdn.com/ae.svg" loading="lazy" class="country-flag" alt="United Arab Emirates flag"> <div class="fw-bold">الإمارات</div> <div class="ms-auto">18%</div> </div> <div class="d-flex align-items-center mb-3"> <img src="https://flagcdn.com/eg.svg" loading="lazy" class="country-flag" alt="Egypt flag"> <div class="fw-bold">مصر</div> <div class="ms-auto">12%</div> </div> <div class="d-flex align-items-center"> <img src="https://flagcdn.com/qa.svg" loading="lazy" class="country-flag" alt="Qatar flag"> <div class="fw-bold">قطر</div> <div class="ms-auto">8%</div> </div> </div> </div> </div> <div class="row mt-4"> <div class="col-md-6 mb-4"> <h5 class="mb-4">أنواع الأجهزة</h5> <div class="stats-card"> <div class="d-flex align-items-center mb-3"> <div class="device-badge device-mobile"><i class="fas fa-mobile-alt me-2"></i>جوال</div> <div class="ms-auto">58%</div> </div> <div class="d-flex align-items-center mb-3"> <div class="device-badge device-desktop"><i class="fas fa-desktop me-2"></i>كمبيوتر</div> <div class="ms-auto">32%</div> </div> <div class="d-flex align-items-center"> <div class="device-badge device-tablet"><i class="fas fa-tablet-alt me-2"></i>تابلت</div> <div class="ms-auto">10%</div> </div> </div> </div> <div class="col-md-6 mb-4"> <h5 class="mb-4">مصادر الزيارات</h5> <div class="stats-card"> <div class="d-flex align-items-center mb-3"> <i class="fab fa-facebook me-3" style="color: #3b5998;"></i> <div class="fw-bold">فيسبوك</div> <div class="ms-auto">38%</div> </div> <div class="d-flex align-items-center mb-3"> <i class="fab fa-twitter me-3" style="color: #1da1f2;"></i> <div class="fw-bold">تويتر</div> <div class="ms-auto">22%</div> </div> <div class="d-flex align-items-center mb-3"> <i class="fab fa-instagram me-3" style="color: #e1306c;"></i> <div class="fw-bold">إنستغرام</div> <div class="ms-auto">18%</div> </div> <div class="d-flex align-items-center"> <i class="fas fa-envelope me-3" style="color: #ea4335;"></i> <div class="fw-bold">البريد الإلكتروني</div> <div class="ms-auto">12%</div> </div> </div> </div> </div> </div> </div> </div> </div> </div> </section> <!-- Features Section --> <section id="features"> <div id="featuresPanel"> <div class="row mb-5"> <div class="col-12 text-center"> <h2 class="display-5 fw-bold mb-3">ميزات متقدمة</h2> <p class="lead mb-5">كل ما تحتاجه لإنشاء وإدارة وتتبع روابطك</p> </div> </div> <div class="row"> <div class="col-md-4 mb-4"> <div class="card h-100"> <div class="card-body text-center p-4"> <div class="feature-icon"> <i class="fas fa-link"></i> </div> <h4 class="mb-3">تنسيق رابط مخصص</h4> <p>أنشئ روابط بالتنسيق: https://series-name.com/épisode-today-XXXXXX</p> </div> </div> </div> <div class="col-md-4 mb-4"> <div class="card h-100"> <div class="card-body text-center p-4"> <div class="feature-icon"> <i class="fas fa-chart-line"></i> </div> <h4 class="mb-3">تحليلات متقدمة</h4> <p>تتبع النقرات والمواقع والأجهزة ومقاييس التفاعل في الوقت الفعلي.</p> </div> </div> </div> <div class="col-md-4 mb-4"> <div class="card h-100"> <div class="card-body text-center p-4"> <div class="feature-icon"> <i class="fas fa-database"></i> </div> <h4 class="mb-3">تخزين سحابي</h4> <p>استخدم Firebase Firestore لتخزين البيانات وإدارة الروابط بسهولة.</p> </div> </div> </div> <div class="col-md-4 mb-4"> <div class="card h-100"> <div class="card-body text-center p-4"> <div class="feature-icon"> <i class="fas fa-redo"></i> </div> <h4 class="mb-3">إعادة توجيه فورية</h4> <p>أعد توجيه المستخدمين فورًا مع القدرة على تتبع الإحصائيات.</p> </div> </div> </div> <div class="col-md-4 mb-4"> <div class="card h-100"> <div class="card-body text-center p-4"> <div class="feature-icon"> <i class="fas fa-shield-alt"></i> </div> <h4 class="mb-3">حماية متقدمة</h4> <p>استخدم reCAPTCHA v3 لمنع الإساءة وحماية المنصة.</p> </div> </div> </div> <div class="col-md-4 mb-4"> <div class="card h-100"> <div class="card-body text-center p-4"> <div class="feature-icon"> <i class="fas fa-mobile-alt"></i> </div> <h4 class="mb-3">تصميم متجاوب</h4> <p>واجهة مستخدم تعمل بشكل مثالي على جميع الأجهزة والمقاسات.</p> </div> </div> </div> </div> <div class="row mt-5"> <div class="col-12 text-center"> <h2 class="display-5 fw-bold mb-3">ميزات مميزة - مجاناً لك!</h2> <p class="lead mb-5">ميزات احترافية مدفوعة في منصات أخرى، متاحة مجانًا على Turkify</p> </div> </div> <div class="row"> <div class="col-md-4 mb-4"> <div class="card h-100 border-2 border-primary"> <div class="card-body text-center p-4"> <div class="feature-icon"> <i class="fas fa-globe"></i> </div> <h4 class="mb-3">نطاقات مخصصة</h4> <p>استخدم نطاقك الخاص لإنشاء روابط قصيرة مميزة.</p> </div> </div> </div> <div class="col-md-4 mb-4"> <div class="card h-100 border-2 border-primary"> <div class="card-body text-center p-4"> <div class="feature-icon"> <i class="fas fa-lock"></i> </div> <h4 class="mb-3">حماية بكلمة مرور</h4> <p>أضف طبقة إضافية من الأمان لروابطك الحساسة.</p> </div> </div> </div> <div class="col-md-4 mb-4"> <div class="card h-100 border-2 border-primary"> <div class="card-body text-center p-4"> <div class="feature-icon"> <i class="fas fa-hourglass-half"></i> </div> <h4 class="mb-3">انتهاء الروابط</h4> <p>حدد تواريخ انتهاء للروابط المؤقتة.</p> </div> </div> </div> </div> </div> </section> <!-- Smart Algorithms Panel --> <section id="algorithms"> <div id="algorithmsPanel" style="display: none;"> <div class="row mb-5"> <div class="col-12 text-center"> <h2 class="display-5 fw-bold mb-3">🤖 الخوارزميات الذكية</h2> <p class="lead mb-5">15 خوارزمية متقدمة لتحسين أداء منصتك</p> </div> </div> <!-- Algorithm Controls --> <div class="row mb-4"> <div class="col-md-6"> <div class="card algorithm-control-card"> <div class="card-header"> <i class="fas fa-brain me-2"></i>التحكم في الخوارزميات </div> <div class="card-body"> <div class="mb-3"> <label class="form-label">تفعيل جميع الخوارزميات:</label> <div class="form-check form-switch"> <input class="form-check-input" type="checkbox" id="masterAlgorithmSwitch"> <label class="form-check-label" for="masterAlgorithmSwitch"> تشغيل النظام الذكي </label> </div> </div> <button class="btn btn-primary" id="runAllAlgorithms"> <i class="fas fa-play me-2"></i>تشغيل جميع الخوارزميات </button> <button class="btn btn-outline-info ms-2" id="algorithmReport"> <i class="fas fa-chart-line me-2"></i>تقرير الأداء </button> </div> </div> </div> <div class="col-md-6"> <div class="card algorithm-status-card"> <div class="card-header"> <i class="fas fa-tachometer-alt me-2"></i>حالة النظام </div> <div class="card-body"> <div class="algorithm-metric"> <span>الخوارزميات النشطة:</span> <span id="activeAlgorithmsCount" class="badge bg-success">0/15</span> </div> <div class="algorithm-metric"> <span>معدل الأداء:</span> <span id="performanceRate" class="badge bg-info">0%</span> </div> <div class="algorithm-metric"> <span>آخر تحديث:</span> <span id="lastAlgorithmUpdate" class="text-muted">لم يتم التشغيل</span> </div> </div> </div> </div> </div> <!-- Algorithm Categories --> <div class="algorithm-categories mb-4"> <div class="btn-group w-100" role="group"> <button type="button" class="btn btn-outline-primary active" data-category="all">الكل</button> <button type="button" class="btn btn-outline-primary" data-category="analytics">تحليلات</button> <button type="button" class="btn btn-outline-primary" data-category="prediction">تنبؤات</button> <button type="button" class="btn btn-outline-primary" data-category="security">أمان</button> <button type="button" class="btn btn-outline-primary" data-category="optimization">تحسين</button> </div> </div> <!-- Algorithms Grid --> <div class="algorithms-grid" id="algorithmsGrid"> <!-- سيتم ملؤها بـ JavaScript --> </div> <!-- Algorithm Results --> <div class="row mt-5"> <div class="col-12"> <div class="card"> <div class="card-header"> <i class="fas fa-chart-bar me-2"></i>نتائج الخوارزميات </div> <div class="card-body"> <div id="algorithmResults" class="algorithm-results"> <p class="text-muted text-center">لم يتم تشغيل أي خوارزمية بعد</p> </div> </div> </div> </div> </div> </div> </section> <!-- Redirect Panel --> <div id="redirectPanel" class="redirect-container" style="display: none;"> <div id="linkBackground" class="dynamic-background"></div> <div class="ad-container"> <i class="fa-solid fa-rectangle-ad" style="color: #74C0FC;"></i>
     <div class="ad-placeholder ad-350x50"> AdSterra Ad (350×50) </div> </div> <!-- بطاقة المحتوى المحدثة --> <div class="content-card" id="contentCard" style="display: block; z-index: 9999; "> <!-- إعلان علوي-->
    <!-- صورة المحتوى --> 
    <div class="custom-shape shape-2">
    </div>
    <div class="content-image-container"> <img id="contentThumbnail" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEicFhbh9OJ5vjc9fmm1Mh1K6LCC7H5_GZb9Kwb6Ol4kQjxZbMSL42YxFszJiNyUZlRzf_hX0jOw4wtzfIH8RjVLTBeBljclPs9wBLXD_iaKxKwsi9ZH-oPViodtkDVf1Bmggxa6dwyIgT5VER4y_RCbozMc5aPjT065bhbCsUr3w4AtIKCMa7wwpWFuQG0/s1920/20250806_220233.png" class="content-thumbnail" alt="صورة المحتوى" style="display: block; visibility: visible;" onerror="this.src='https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEicFhbh9OJ5vjc9fmm1Mh1K6LCC7H5_GZb9Kwb6Ol4kQjxZbMSL42YxFszJiNyUZlRzf_hX0jOw4wtzfIH8RjVLTBeBljclPs9wBLXD_iaKxKwsi9ZH-oPViodtkDVf1Bmggxa6dwyIgT5VER4y_RCbozMc5aPjT065bhbCsUr3w4AtIKCMa7wwpWFuQG0/s1920/20250806_220233.png" </div> 
    <iframe id="contentVideo" class="content-video" style="display: none; width: 100%; height: 100%; border: none; margin-bottom: 15px; radius: 5%;" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen> </iframe>
     

    <!-- معلومات المحتوى --> 
    <div class="content-info" style="display: block; visibility: visible;"> <!-- معلومات أساسية --> <div class="content-meta" style="display: flex; visibility: visible;"> <span id="contentType" class="content-type" style="display: inline-block;">مسلسل</span> <span id="contentEpisode" class="content-episode" style="display: none;"></span> <span id="contentDate" class="content-date" style="display: none;"></span> </div>
    <div class="ad-container"> <div class="ad-placeholder ad-350x50"> AdSterra Ad (350×50) </div> </div> 
     <!-- عنوان المحتوى -->
      <h2 id="contentTitle" class="content-title" style="display: block; visibility: visible;"> اسم المسلسل </h2> <!-- وصف المحتوى --> <p id="contentDescription" class="content-description" style="display: block; visibility: visible;"> وصف المسلسل وأحداث الحلقة الحالية </p> <!-- معلومات إضافية --> <div class="content-stats" style="display: flex; gap: 20px; margin-top: 15px;"> <div class="stat-item"> <i class="fas fa-eye text-muted"></i> <span id="contentViews" class="ms-2">0 مشاهدة</span> </div> <div class="stat-item"> <i class="fas fa-calendar text-muted"></i> <span id="contentCreated" class="ms-2">اليوم</span> </div> </div> </div> </div> <!-- Update 1: Redirect text based on content type --> 
    
    <div class="ad-container"> 
    <i class="fa-solid fa-rectangle-ad" style="color: #74C0FC;"></i> <div class="ad-placeholder ad-350x50"> AdSterra Ad (350×50) </div> </div>
    <div class="redirect-text" id="redirectText"> <span id="redirectMessage"> 
    يتم توجيهك الأن لمشاهدة</span> </div> <div class="loader" id="redirectLoader"></div> </div> </div>
     
    <div class="ad-container" style="margin: 20px 0;">
    <i class="fa-solid fa-rectangle-ad" style="color: #74C0FC;"></i>
     <div class="ad-placeholder ad-350x250"> AdSterra Ad (350×250) </div> </div></div><!-- Link Generated Modal --> <div class="modal fade" id="linkModal" tabindex="-1" aria-hidden="true"> <div class="modal-dialog modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title"><i class="fas fa-check-circle me-2"></i>تم إنشاء الرابط بنجاح!</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <div class="mb-4"> <p class="mb-1">رابطك القصير الجديد:</p> <div class="input-group"> <input type="text" class="form-control form-control-lg" id="generatedLink" readonly aria-label="Generated link"> <button class="btn btn-primary" id="copyLinkBtn" aria-label="Copy link"> <i class="fas fa-copy me-1"></i>نسخ </button> </div> </div> <div class="alert alert-info"> <i class="fas fa-info-circle me-2"></i> سيقوم هذا الرابط بإعادة التوجيه إلى: <span id="originalLinkDisplay" class="fw-bold"></span> </div> <div class="d-flex justify-content-between mt-4"> <button class="btn btn-outline-primary" id="viewAnalyticsBtn" aria-label="View analytics"> <i class="fas fa-chart-bar me-1"></i>عرض التحليلات </button> <button class="btn btn-outline-success" id="shareLinkBtn" aria-label="Share link"> <i class="fas fa-share-alt me-1"></i>مشارة الرابط </button> </div> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="Close modal">إغلاق</button> </div> </div> </div> </div> <!-- Confirmation Modal --> <div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true"> <div class="modal-dialog modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2 text-warning"></i>تأكيد العملية</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <p id="confirmationMessage">هل أنت متأكد من رغبتك في حذف هذا الرابط؟</p> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button> <button type="button" class="btn btn-danger" id="confirmActionBtn">تأكيد</button> </div> </div> </div> </div> <!-- Stats Modal --> <div class="modal fade" id="statsModal" tabindex="-1" aria-hidden="true"> <div class="modal-dialog modal-xl"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title"><i class="fas fa-chart-bar me-2"></i>تحليلات الرابط</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <div class="stats-modal-content"> <div class="stats-header"> <h4 id="statsLinkTitle" class="stats-title">تحليلات الرابط</h4> <p class="text-muted"> الرابط القصير: <a id="statsLinkUrl" href="#" target="_blank" class="text-decoration-none">تحميل الرابط</a> </p> <div class="time-filter"> <button class="time-btn active">اليوم</button> <button class="time-btn">أسبوع</button> <button class="time-btn">شهر</button> <button class="time-btn">3 أشهر</button> <button class="time-btn">سنة</button> </div> </div> <div class="stats-grid"> <div class="stats-card"> <div class="stats-card-title"><i class="fas fa-users"></i> إجمالي الزيارات</div> <div class="stats-number" id="totalVisits">1,842</div> </div> <div class="stats-card"> <div class="stats-card-title"><i class="fas fa-mouse-pointer"></i> النقرات اليوم</div> <div class="stats-number" id="todayVisits">56</div> </div> <div class="stats-card"> <div class="stats-card-title"><i class="fas fa-map-marker-alt"></i> البلد الأكثر زيارة</div> <div class="stats-number" id="topCountry">السعودية</div> </div> <div class="stats-card"> <div class="stats-card-title"><i class="fas fa-desktop"></i> الجهاز الأكثر استخداماً</div> <div class="stats-number" id="topDevice">الهاتف</div> </div> </div> <div class="row mt-4"> <div class="col-md-6"> <div class="stats-card"> <div class="stats-card-title"><i class="fas fa-chart-line"></i> النقرات مع مرور الوقت</div> <div class="stats-chart"> <canvas id="visitsChart"></canvas> </div> </div> </div> <div class="col-md-6"> <div class="stats-card"> <div class="stats-card-title"><i class="fas fa-globe-asia"></i> التوزيع الجغرافي</div> <div class="stats-chart"> <canvas id="geoChart"></canvas> </div> </div> </div> </div> <div class="row mt-4"> <div class="col-md-6"> <div class="stats-card"> <div class="stats-card-title"><i class="fas fa-laptop"></i> أنواع الأجهزة</div> <div class="stats-chart"> <canvas id="devicesChart"></canvas> </div> </div> </div> <div class="col-md-6"> <div class="stats-card"> <div class="stats-card-title"><i class="fas fa-share-alt"></i> مصادر الزيارات</div> <div class="stats-chart"> <canvas id="sourcesChart"></canvas> </div> </div> </div> </div> </div> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button> </div> </div> </div> </div> <!-- Earnings Modal --> <div class="modal fade" id="earningsModal" tabindex="-1" aria-hidden="true"> <div class="modal-dialog modal-lg"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title"><i class="fas fa-dollar-sign me-2 text-success"></i>إيرادات الرابط</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <div class="stats-modal-content"> <div class="stats-header"> <h4 id="earningsLinkTitle" class="stats-title">تخفيضات الصيف</h4> <div class="time-filter"> <button class="time-btn active">اليوم</button> <button class="time-btn">أسبوع</button> <button class="time-btn">شهر</button> <button class="time-btn">3 أشهر</button> <button class="time-btn">سنة</button> </div> </div> <div class="earnings-stats"> <div class="earnings-card"> <div id="totalEarnings" class="earnings-value">$0.00</div> <div class="earnings-label">إجمالي الأرباح</div> </div> <div class="earnings-card"> <div id="totalImpressions" class="earnings-value">0</div> <div class="earnings-label">إجمالي المشاهدات</div> </div> <div class="earnings-card"> <div id="averageRPM" class="earnings-value">$0.00</div> <div class="earnings-label">متوسط الربح لكل 1000 مشاهدة</div> </div> <div class="earnings-card"> <div id="todayEarnings" class="earnings-value">$0.00</div> <div class="earnings-label">أرباح اليوم</div> </div> </div> <div class="earnings-breakdown mt-4"> <h6 class="mb-3">تفصيل الأرباح حسب المنطقة:</h6> <div class="row"> <div class="col-md-6"> <div class="earnings-region-card"> <div class="d-flex justify-content-between align-items-center"> <span><i class="fas fa-flag me-2"></i>البلدان العربية</span> <div class="text-end"> <div id="arabVisits" class="fw-bold">0 زيارة</div> <small id="arabEarnings" class="text-success">$0.00</small> </div> </div> <div class="progress mt-2" style="height: 5px;"> <div id="arabProgress" class="progress-bar bg-success" style="width: 0%"></div> </div> <small class="text-muted">معدل: $1.00 لكل 1000 زيارة</small> </div> </div> <div class="col-md-6"> <div class="earnings-region-card"> <div class="d-flex justify-content-between align-items-center"> <span><i class="fas fa-globe me-2"></i>البلدان الأجنبية</span> <div class="text-end"> <div id="foreignVisits" class="fw-bold">0 زيارة</div> <small id="foreignEarnings" class="text-primary">$0.00</small> </div> </div> <div class="progress mt-2" style="height: 5px;"> <div id="foreignProgress" class="progress-bar bg-primary" style="width: 0%"></div> </div> <small class="text-muted">معدل: $3.00 لكل 1000 زيارة</small> </div> </div> </div> </div> <div class="earnings-chart"> <canvas id="earningsChart"></canvas> </div> </div> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button> </div> </div> </div> </div>
     <!-- Global Loader --> 
     <div class="global-loader" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.7); z-index: 2000; justify-content: center; align-items: center;"> <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div> </div>
      <!-- Scripts --> 
      <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.google.com/recaptcha/api.js?render=6LesFYErAAAAAOpY8Pbc0furepnxPt0WyJorH5Qw"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-4B73N1T483');
      </script> 

    <script>

// Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyC5VmidRUmMF6W3vvl44zznScS1gn2GHn0",
    authDomain: "turkify-redirect.firebaseapp.com",
    projectId: "turkify-redirect",
    storageBucket: "turkify-redirect.appspot.com",
    messagingSenderId: "986441766029",
    appId: "1:986441766029:web:dd6a13879306472e43bec4"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// فحص Firebase قبل الاستخدام
function checkFirebaseConnection() {
    if (!firebase || !firebase.firestore) {
        console.error('Firebase غير متوفر');
        showNotification('error', 'خطأ في الاتصال بقاعدة البيانات');
        return false;
    }
    return true;
}

// تحديث دالة setLoading لتكون أكثر أماناً
function setLoading(show) {
    const loader = document.querySelector('.global-loader');
    if (loader) {
        loader.style.display = show ? 'flex' : 'none';
    }
}

// DOM Elements
const adminPanel = document.getElementById('adminPanel');
const analyticsPanel = document.getElementById('analyticsPanel');
const redirectPanel = document.getElementById('redirectPanel');
const featuresPanel = document.getElementById('featuresPanel');
const linksTable = document.getElementById('linksTable');
const signInButton = document.getElementById('signInButton');
const signOutButton = document.getElementById('signOutButton');
const userProfile = document.getElementById('userProfile');
const userPhoto = document.getElementById('userPhoto');
const userName = document.getElementById('userName');
const authButtons = document.getElementById('authButtons');
const navLinks = document.querySelectorAll('.nav-link');
const adminOnlyElements = document.querySelectorAll('.admin-only');
const globalLoader = document.querySelector('.global-loader');
const generateBtn = document.getElementById('generateBtn');
const updateBtn = document.getElementById('updateBtn');
const redirectText = document.getElementById('redirectText');
const redirectMessage = document.getElementById('redirectMessage');
const backToHomeBtn = document.getElementById('backToHomeBtn');

// Current editing link ID
let currentEditingLinkId = null;

// Set loading state
function setLoading(show) {
    globalLoader.style.display = show ? 'flex' : 'none';
}

// تنسيق التاريخ والوقت بالإنجليزية
function formatFirestoreDateTime(timestamp) {
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp.seconds * 1000);
    return date.toLocaleString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// Initialize page based on URL
function initPage() {
    const urlParams = new URLSearchParams(window.location.search);
    const linkId = urlParams.get('id');
    const hash = window.location.hash.substring(1);
    
    // Highlight active navigation item
    highlightActiveNav();
    
    if (linkId) {
        // تطبيق أنماط الإظهار القسري قبل معالجة إعادة التوجيه
        if (typeof forceShowElements === 'function') forceShowElements();
        setTimeout(() => {
            if (typeof showContentCard === 'function') showContentCard();
            handleRedirection(linkId);
        }, 100);
    } else {
        // التنقل حسب الهاش
        switch(hash) {
            case 'admin':
                showAdminPanel();
                break;
            case 'analytics':
                showAnalytics();
                break;
            case 'algorithms':
                showAlgorithms();
                break;
            case 'dashboard':
                showDashboard();
                break;
            case 'super-admin':
                showSuperAdminPanel();
                break;
            case 'features':
                showFeatures();
                break;
            case 'home':
            case '':
            default:
                showFeatures();
                break;
        }
    }
}

// تحديث دالة hideAllPanels
function hideAllPanels() {
    const panels = [
        'adminPanel',
        'analyticsPanel', 
        'redirectPanel',
        'featuresPanel',
        'algorithmsPanel'
    ];
    
    panels.forEach(panelId => {
        const panel = document.getElementById(panelId);
        if (panel) panel.style.display = 'none';
    });
    
    // إخفاء المحتوى الديناميكي
    const dynamicContainers = [
        '.dashboard-container',
        '.super-admin-panel'
    ];
    
    dynamicContainers.forEach(selector => {
        const containers = document.querySelectorAll(selector);
        containers.forEach(container => container.remove());
    });
}

// Highlight active navigation item
function highlightActiveNav() {
    navLinks.forEach(link => {
        link.classList.remove('nav-active');
        if (window.location.hash === link.getAttribute('href')) {
            link.classList.add('nav-active');
        }
    });
}

// Show admin panel
function showAdminPanel() {
    hideAllPanels();
    adminPanel.classList.remove('admin-only');
    adminPanel.style.display = 'block';
    loadLinks();
}

// Show analytics panel
function showAnalytics() {
    hideAllPanels();
    analyticsPanel.style.display = 'block';
    loadAnalytics();
}

// Show features panel
function showFeatures() {
    hideAllPanels();
    featuresPanel.style.display = 'block';
}

// Hide all panels
function hideAllPanels() {
    adminPanel.style.display = 'none';
    analyticsPanel.style.display = 'none';
    redirectPanel.style.display = 'none';
    featuresPanel.style.display = 'none';
}

// دالة مساعدة لجلب معلومات الزائر من ipwho
async function getVisitorInfo() {
    try {
        // استخدام ipwho.is بدلاً من ipify
        const response = await fetch('https://ipwho.is/?lang=ar');
        const data = await response.json();
        
        if (data.success) {
            return {
                country: data.country || "غير معروف",
                region: data.region || "غير معروف",
                city: data.city || "غير معروف",
                ip: data.ip || "غير معروف",
                org: data.connection?.org || "غير معروف"
            };
        }
        return {
            country: "غير معروف",
            region: "غير معروف",
            city: "غير معروف",
            ip: "غير معروف",
            org: "غير معروف"
        };
    } catch (error) {
        console.error("Error getting visitor info:", error);
        return {
            country: "غير معروف",
            region: "غير معروف",
            city: "غير معروف",
            ip: "غير معروف",
            org: "غير معروف"
        };
    }
}

// دوال مساعدة لاكتشاف تفاصيل الجهاز
function detectDeviceType() {
    const ua = navigator.userAgent.toLowerCase();
    if (ua.includes("smart-tv") || ua.includes("hbbtv") || ua.includes("appletv")) return "تلفاز ذكي";
    if (/mobile|iphone|ipod|android/.test(ua)) return "هاتف";
    if (/tablet|ipad/.test(ua)) return "تابلت";
    if (/windows|mac|linux/.test(ua)) return "كمبيوتر";
    return "غير معروف";
}

function detectOS() {
    const ua = navigator.userAgent;
    if (ua.includes("Android")) return "Android";
    if (ua.includes("iPhone") || ua.includes("iPad")) return "iOS";
    if (ua.includes("Windows")) return "Windows";
    if (ua.includes("Mac OS")) return "macOS";
    return "غير معروف";
}

function detectBrowser() {
    const ua = navigator.userAgent;
    if (ua.includes("Chrome")) return "Chrome";
    if (ua.includes("Firefox")) return "Firefox";
    if (ua.includes("Safari") && !ua.includes("Chrome")) return "Safari";
    if (ua.includes("Edge")) return "Edge";
    return "غير معروف";
}

function detectReferrer() {
    const ref = document.referrer;
    if (ref.includes("facebook")) return "فيسبوك";
    if (ref.includes("instagram")) return "إنستغرام";
    if (ref.includes("youtube")) return "يوتيوب";
    if (ref.includes("twitter")) return "تويتر";
    if (ref.includes("tiktok")) return "تيك توك";
    return "مباشر";
}

// دالة تسجيل الزيارة المحدثة لتوافق GitHub Pages
async function recordVisit(linkId) {
    try {
        // جلب معلومات الزائر من ipwho.is
        const visitorInfo = await getVisitorInfo();
        
        const visitData = {
            timestamp: new Date(),
            linkId: linkId,
            country: visitorInfo.country,
            region: visitorInfo.region,
            city: visitorInfo.city,
            ip: visitorInfo.ip,
            org: visitorInfo.org,
            device: detectDeviceType(),
            browser: detectBrowser(), 
            os: detectOS(),
            source: detectReferrer(),
            userAgent: navigator.userAgent.substring(0, 100)
        };

        // حفظ الزيارة في Firebase
        await db.collection('visits').add(visitData);
        
        // تحديث عداد النقرات
        await db.collection('links').doc(linkId).update({
            clicks: firebase.firestore.FieldValue.increment(1),
            lastVisit: firebase.firestore.FieldValue.serverTimestamp()
        });
    } catch (error) {
        console.error('فشل في تسجيل الزيارة:', error);
    }
}

// دالة إنشاء وصف تشويقي باستخدام Deepseek API
async function generateEpisodeDescription(linkId, seriesName, episodeNum) {
    try {
        const SECRET_KEY = "MySuperSecret123!"; // يجب أن يتطابق مع Netlify
        const response = await fetch('/.netlify/functions/deepseek-proxy', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'x-secret-key': SECRET_KEY
            },
            body: JSON.stringify({ 
                seriesName, 
                episodeNum,
                linkId
            })
        });

        if (!response.ok) throw new Error('خطأ في الشبكة');
        
        const data = await response.json();
        return data.description;
        
    } catch (error) {
        console.error('فشل في توليد الوصف:', error);
        
        try {
            const linkDoc = await db.collection('links').doc(linkId).get();
            if (linkDoc.exists) {
                const linkData = linkDoc.data();
                
                if (linkData.socialDescription) {
                    return linkData.socialDescription;
                }
                
                return `مسلسل ${seriesName} - الحلقة ${episodeNum}: ${linkData.seriesName} يتناول قصة شيقة تستحق المشاهدة`;
            }
        } catch (firestoreError) {
            console.error('فشل في جلب الوصف المخزن:', firestoreError);
        }
        
        return `شاهد الحلقة ${episodeNum} من ${seriesName} بأحداث مشوقة وتطورات غير متوقعة!`;
    }
}

// Handle redirection with proper content display
async function handleRedirection(linkId) {
    // تعريف العناصر الضرورية
    const redirectPanel = document.getElementById('redirectPanel');
    const redirectMessage = document.getElementById('redirectMessage');
    
    // التحقق من وجود العناصر قبل استخدامها
    if (!redirectPanel || !redirectMessage) {
        console.error('عناصر لوحة التوجيه غير موجودة في DOM');
        return;
    }
    
    // إخفاء جميع اللوحات وإظهار لوحة التوجيه
    hideAllPanels();
    redirectPanel.style.display = 'block';
    
    // عناصر البطاقة
    const elements = {
        loader: document.getElementById('redirectLoader'),
        card: document.getElementById('contentCard'),
        thumbnail: document.getElementById('contentThumbnail'),
        video: document.getElementById('contentVideo'),
        type: document.getElementById('contentType'),
        episode: document.getElementById('contentEpisode'),
        date: document.getElementById('contentDate'),
        title: document.getElementById('contentTitle'),
        description: document.getElementById('contentDescription'),
        views: document.getElementById('contentViews'),
        created: document.getElementById('contentCreated'),
        background: document.getElementById('linkBackground')
    };
    
    // إظهار البطاقة فوراً
    if (elements.card) {
        elements.card.style.display = 'block';
        elements.card.style.visibility = 'visible';
    }
    
    // إخفاء جميع الوسائط مبدئياً
    const hideMediaElements = () => {
        if (elements.thumbnail) {
            elements.thumbnail.style.display = 'none';
            elements.thumbnail.onerror = null;
        }
        if (elements.video) {
            elements.video.style.display = 'none';
            elements.video.src = '';
            elements.video.onerror = null;
        }
        if (elements.episode) elements.episode.style.display = 'none';
        if (elements.date) elements.date.style.display = 'none';
    };
    
    hideMediaElements();
    
    // إظهار مؤشر التحميل
    if (elements.loader) elements.loader.style.display = 'block';
    redirectMessage.textContent = 'جاري تحميل المحتوى...';
    
    let redirectTimer = null;
    let linkData = null;
    let destinationUrl = '';
    
    try {
        // جلب بيانات الرابط من Firestore
        const linkDoc = await db.collection('links').doc(linkId).get();
        
        if (!linkDoc.exists) {
            throw new Error('الرابط غير موجود في قاعدة البيانات');
        }
        
        linkData = linkDoc.data();
        destinationUrl = linkData.originalUrl || '#';
        const linkType = linkData.linkType || 'series';
        
        // تعبئة البيانات الأساسية - استخدام العنوان الاجتماعي إن وجد
        const titleToShow = linkData.socialTitle || linkData.seriesName || 'غير محدد';
        if (elements.title) {
            elements.title.textContent = titleToShow;
            elements.title.style.display = 'block';
        }
        
        if (elements.type) {
            elements.type.textContent = getTypeName(linkType);
            elements.type.style.display = 'inline-block';
        }
        
        // ===== منطق عرض الوسائط حسب نوع المحتوى =====
        const showFallbackImage = () => {
            if (!elements.thumbnail) return;
            
            const fallbackUrl = 'https://via.placeholder.com/800x300/4A154B/FFFFFF?text=' + 
                               encodeURIComponent('لا توجد صورة');
            elements.thumbnail.src = fallbackUrl;
            elements.thumbnail.style.display = 'block';
            elements.thumbnail.onerror = null; // منع التكرار اللانهائي
        };
        
        // مسلسل: عرض الصورة الثابتة فقط
        if (linkType === 'series') {
            const imageUrl = 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi3TdSw7_XcHwYp_32sJD6a54SQj4vmpmqh1CsvG1Wqa5Jc3ljp8hvkQZ4kj2whkXPx7-UhakEqqadVvdNkK0lD6bD8-DG_oNQQ9rWpFKjJtzZFduaLWby8FNntbdZLOHogCnG63r3ftta1Zqenzq1KCxwJYEpTJF0eC6il4gyHNvpaQvy3fb0InEwUqXg/s1024/file_000000005070620a8f67e39c784160a1.png';
            
            if (elements.thumbnail) {
                elements.thumbnail.src = imageUrl;
                elements.thumbnail.alt = titleToShow;
                elements.thumbnail.style.display = 'block';
                elements.thumbnail.onerror = showFallbackImage;
            }
        } 
        // فيلم: عرض الفيديو الترويجي فقط
        else if (linkType === 'movie' && linkData.trailerVideoId) {
            if (elements.video) {
                const videoId = linkData.trailerVideoId;
                const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&controls=0&rel=0&modestbranding=1`;
                elements.video.src = embedUrl;
                elements.video.style.display = 'block';
                
                elements.video.onerror = () => {
                    elements.video.style.display = 'none';
                    
                    // إظهار الصورة البديلة
                    if (elements.thumbnail) {
                        const fallbackImage = linkData.socialImage || 
                            'https://via.placeholder.com/800x300/4A154B/FFFFFF?text=' + 
                            encodeURIComponent(titleToShow);
                            
                        elements.thumbnail.src = fallbackImage;
                        elements.thumbnail.alt = titleToShow;
                        elements.thumbnail.style.display = 'block';
                        elements.thumbnail.onerror = showFallbackImage;
                    }
                };
            }
        } 
        // الأنواع الأخرى: عرض الصورة الاجتماعية
        else {
            const imageUrl = linkData.socialImage || 
                           'https://via.placeholder.com/800x300/4A154B/FFFFFF?text=' + 
                           encodeURIComponent(titleToShow);
            
            if (elements.thumbnail) {
                elements.thumbnail.src = imageUrl;
                elements.thumbnail.alt = titleToShow;
                elements.thumbnail.style.display = 'block';
                elements.thumbnail.onerror = showFallbackImage;
            }
        }
            
        // إعداد خلفية الصورة
        if (elements.background) {
            if (linkData.socialBackground) {
                elements.background.style.backgroundImage = `url('${linkData.socialBackground}')`;
                elements.background.style.backgroundSize = 'cover';
                elements.background.style.backgroundPosition = 'center';
                
                // معالجة فشل صورة الخلفية
                const bgImg = new Image();
                bgImg.onerror = () => {
                    elements.background.style.background = '#f0f5ff';
                };
                bgImg.src = linkData.socialBackground;
            } else {
                elements.background.style.display = 'none';
            }
        }
        
        // ===== حساب رقم الحلقة للمسلسلات فقط =====
        let episodeNum = 1;
        let isSeries = false;
        
        if (linkType === 'series' && linkData.startingEpisode && linkData.startDate) {
            isSeries = true;
            const createdAt = linkData.startDate.toDate();
            const now = new Date();
            
            // حساب الفرق بالأيام
            const msPerDay = 24 * 60 * 60 * 1000;
            const diffDays = Math.floor((now - createdAt) / msPerDay);
            episodeNum = linkData.startingEpisode + diffDays;
            
            // التأكد من عدم تجاوز عدد الحلقات
            if (linkData.totalEpisodes && episodeNum > linkData.totalEpisodes) {
                episodeNum = linkData.totalEpisodes;
            }
            
            // تحديث رسالة التوجيه
            redirectMessage.innerHTML = `سيتم توجيهك لمشاهدة حلقة اليوم <span class="highlight">${episodeNum}</span> من المسلسل:<br><span class="highlight">${escapeHtml(titleToShow)}</span>`;
        } else {
            redirectMessage.innerHTML = `سيتم توجيهك لمشاهدة <span class="highlight">${escapeHtml(getTypeName(linkType))}</span>:<br><span class="highlight">${escapeHtml(titleToShow)}</span>`;
        }
        
        // ===== التحكم في ظهور عنصر الحلقة =====
        if (elements.episode) {
            if (isSeries) {
                elements.episode.textContent = `الحلقة ${episodeNum}`;
                elements.episode.style.display = 'inline-block';
            } else {
                elements.episode.style.display = 'none';
            }
        }
        
        // ===== التحكم في ظهور عنصر التاريخ =====
        if (elements.date) {
            if (isSeries) {
                const today = new Date();
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                elements.date.textContent = today.toLocaleDateString('ar-EG', options);
                elements.date.style.display = 'inline-block';
            } else {
                elements.date.style.display = 'none';
            }
        }
        
        // ===== تحديث الوصف والتفاصيل =====
        let description = '';
        let episodeTitle = `الحلقة ${episodeNum}`;
        
        if (isSeries) {
            try {
                const episodesDoc = await db.collection('series_episodes').doc(linkId).get();
                if (episodesDoc.exists) {
                    const episodesData = episodesDoc.data();
                    const episodeInfo = episodesData.episodes?.find(
                        ep => ep.episode_number === episodeNum
                    );
                    
                    if (episodeInfo) {
                        description = episodeInfo.description || '';
                        episodeTitle = episodeInfo.title || episodeTitle;
                    }
                }
            } catch (error) {
                console.error('خطأ في جلب بيانات الحلقات:', error);
            }
            
            if (!description) {
                description = linkData.socialDescription || `شاهد الحلقة ${episodeNum} من ${titleToShow}`;
            }
        } else {
            description = linkData.socialDescription || 'لا يوجد وصف متاح';
        }
        
        // تحديث عنوان المحتوى
        if (elements.title) {
            elements.title.textContent = isSeries ? episodeTitle : titleToShow;
        }
        
        if (elements.description) {
            elements.description.textContent = description;
            elements.description.style.display = 'block';
        }
        
        // ===== عرض عدد المشاهدات =====
        if (elements.views) {
            const randomViews = Math.floor(Math.random() * 450000) + 50000;
            elements.views.textContent = `${randomViews.toLocaleString('en-US')} مشاهدة`;
            elements.views.style.display = 'block';
        }
        
        // عرض تاريخ الإنشاء
        if (elements.created && linkData.createdAt) {
            const createdDate = linkData.createdAt.toDate();
            elements.created.textContent = createdDate.toLocaleDateString('ar-EG');
            elements.created.style.display = 'block';
        }
        
        // تسجيل الزيارة الحقيقية في قاعدة البيانات
        if (typeof recordVisit === 'function') {
            recordVisit(linkId);
        }
        
        // إخفاء مؤشر التحميل بعد التعبئة
        if (elements.loader) elements.loader.style.display = 'none';
        
        // إعادة التوجيه بعد 15 ثانية
        redirectTimer = setTimeout(() => {
            window.location.href = destinationUrl;
        }, 15000);
        
        // إعداد التحديث التلقائي للحلقات للمسلسلات
        if (isSeries && typeof setupDailyEpisodeUpdate === 'function') {
            setupDailyEpisodeUpdate(linkId);
        }
        
    } catch (error) {
        console.error('حدث خطأ في معالجة التوجيه:', error);
        
        // إخفاء المؤشر وإظهار رسالة الخطأ
        if (elements.loader) elements.loader.style.display = 'none';
        redirectMessage.innerHTML = `حدث خطأ: <span class="error">${error.message}</span>`;
        
        // إضافة زر للعودة
        const backButton = document.createElement('button');
        backButton.textContent = 'العودة للصفحة الرئيسية';
        backButton.className = 'back-button';
        backButton.onclick = () => window.location.href = '/';
        redirectMessage.appendChild(backButton);
        
    } finally {
        // تنظيف المؤقت عند ترك الصفحة
        window.addEventListener('beforeunload', () => {
            if (redirectTimer) clearTimeout(redirectTimer);
        });
    }
}

// دالة مساعدة للهروب
function escapeHtml(unsafe) {
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}
// دالة للتحقق من تحميل الصورة وإظهارها
function ensureImageVisibility(imageElement, fallbackUrl, title) {
    if (!imageElement) return;
    
    // إظهار العنصر فوراً
    imageElement.style.display = 'block';
    imageElement.style.visibility = 'visible';
    imageElement.style.opacity = '1';
    
    // إضافة معالج لنجاح التحميل
    imageElement.onload = () => {
        this.style.opacity = '1';
        this.style.visibility = 'visible';
        this.style.display = 'block';
    };
    
    // إضافة معالج لفشل التحميل
    imageElement.onerror = () => {
        this.src = fallbackUrl || 'https://via.placeholder.com/800x300/4A154B/FFFFFF?text=' + 
                   encodeURIComponent(title || 'لا توجد صورة');
        this.style.display = 'block';
        this.style.visibility = 'visible';
        this.style.opacity = '1';
    };
    
    // فرض الإظهار بعد ثانية واحدة
    setTimeout(() => {
        if (imageElement) {
            imageElement.style.display = 'block';
            imageElement.style.visibility = 'visible';
            imageElement.style.opacity = '1';
        }
    }, 1000);
}

// دالة لإظهار جميع عناصر البطاقة
function showContentCard() {
    const elements = [
        'contentCard',
        'contentThumbnail', 
        'contentType',
        'contentTitle',
        'contentDescription',
        'contentMeta'
    ];
    
    elements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.style.display = element.tagName === 'IMG' ? 'block' : 
                                   element.classList.contains('content-meta') ? 'flex' : 'block';
            element.style.visibility = 'visible';
            element.style.opacity = '1';
        }
    });
    
    }

// دالة لتطبيق أنماط الإظهار القسري
function forceShowElements() {
    const forceShowCSS = `
        .content-card,
        .content-thumbnail,
        .content-info,
        .content-meta,
        .content-title,
        .content-description,
        .content-type,
        .content-episode,
        .content-date {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .content-meta {
            display: flex !important;
        }
        
        .content-type,
        .content-episode, 
        .content-date {
            display: inline-block !important;
        }
    `;
    
    // إضافة CSS للصفحة
    const style = document.createElement('style');
    style.textContent = forceShowCSS;
    document.head.appendChild(style);
    
    }
        
        // Show notification
        function showNotification(type, message, duration = 3000) {
            const notification = document.getElementById(`${type}Notification`);
            const messageEl = notification.querySelector('div:first-child');
            
            messageEl.textContent = message;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 400);
            }, duration);
        }
        
        // Copy to clipboard with fallback and error handling
        function copyToClipboard() {
            const copyText = document.getElementById("generatedLink");
            copyText.select();
            copyText.setSelectionRange(0, 99999);
            
            try {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(copyText.value)
                        .then(() => {
                            showNotification('success', 'تم نسخ الرابط إلى الحافظة!');
                            // Change button icon to success
                            const copyBtn = document.getElementById('copyLinkBtn');
                            copyBtn.innerHTML = '<i class="fas fa-check me-1"></i>تم النسخ!';
                            setTimeout(() => {
                                copyBtn.innerHTML = '<i class="fas fa-copy me-1"></i>نسخ';
                            }, 2000);
                        })
                        .catch(err => {
                            console.error('Failed to copy: ', err);
                            showNotification('error', 'فشل نسخ الرابط');
                        });
                } else {
                    // Fallback for older browsers
                    document.execCommand('copy');
                    showNotification('success', 'تم نسخ الرابط إلى الحافظة!');
                    const copyBtn = document.getElementById('copyLinkBtn');
                    copyBtn.innerHTML = '<i class="fas fa-check me-1"></i>تم النسخ!';
                    setTimeout(() => {
                                copyBtn.innerHTML = '<i class="fas fa-copy me-1"></i>نسخ';
                            }, 2000);
                }
            } catch (err) {
                console.error('Failed to copy: ', err);
                showNotification('error', 'فشل نسخ الرابط');
            }
        }
        
        // URL validation
        function isValidUrl(url) {
            try {
                new URL(url);
                return true;
            } catch (e) {
                return false;
            }
        }
        
        // Series name validation
        function isValidSeriesName(name) {
            // Allow all Arabic characters and standard symbols
            const regex = /^[\p{Script=Arabic}\w\s\-_]+$/u;
            return regex.test(name);
        }
        
        // Generate new link with reCAPTCHA
        async function generateLink() {
            const seriesNameInput = document.getElementById('seriesName');
            const originalUrlInput = document.getElementById('originalUrl');
            const seriesName = seriesNameInput.value.trim();
            const originalUrl = originalUrlInput.value.trim();
            const socialTitle = document.getElementById('socialTitle').value.trim();
            const socialDescription = document.getElementById('socialDescription').value.trim();
            const socialImage = document.getElementById('socialImage').value.trim();
            const linkType = document.getElementById('linkType').value;
            const totalEpisodes = parseInt(document.getElementById('totalEpisodes').value) || 0;
            const startingEpisode = parseInt(document.getElementById('startingEpisode').value) || 1;
            
            // ===== إضافة الحقل الجديد =====
            const socialBackground = document.getElementById('socialBackground').value.trim();
            // ===== نهاية الإضافة =====
            
            // Reset validation states
            seriesNameInput.classList.remove('is-invalid');
            originalUrlInput.classList.remove('is-invalid');
            document.getElementById('episodeError').style.display = 'none';
            
            // Validate URL
            if (!isValidUrl(originalUrl)) {
                originalUrlInput.classList.add('is-invalid');
                showNotification('error', 'الرجاء إدخال رابط صالح');
                return;
            }
            
            // Validate series name
            if (!seriesName || !isValidSeriesName(seriesName)) {
                seriesNameInput.classList.add('is-invalid');
                showNotification('error', 'الرجاء إدخال اسم سلسلة صالح');
                return;
            }
            
            // Validate episode count for series
            if (linkType === 'series' && (!totalEpisodes || totalEpisodes < 1)) {
                document.getElementById('episodeError').style.display = 'block';
                showNotification('error', 'الرجاء إدخال عدد حلقات صحيح');
                return;
            }
            
            try {
                // Execute reCAPTCHA
                const token = await new Promise((resolve) => {
                    grecaptcha.ready(() => {
                        grecaptcha.execute('6LesFYErAAAAAOpY8Pbc0furepnxPt0WyJorH5Qw', {action: 'create_link'})
                            .then(resolve);
                    });
                });
                
                // Disable button during processing
                generateBtn.disabled = true;
                generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>جاري الإنشاء...';
                
                // Generate random 6-digit ID
                const linkId = Math.floor(100000 + Math.random() * 900000).toString();
                
                // Create the new link in the required format
                const customDomain = document.getElementById('customDomain').value || 'turkii.netlify.app';
                
                // Update 8: Change parameter name for series
                const paramName = linkType === 'series' ? 'halqat-alyawm-min-musalsal' : linkType;
                const newLink = `https://${customDomain}/?${paramName}=${encodeURIComponent(seriesName)}&id=${linkId}`;
                
                // Get current user
                const user = auth.currentUser;
                
            
// إعداد بيانات الفيديو
const videoData = trailerSystem.getVideoDataForSave();

// Create link data
const linkData = {
    id: linkId,
    seriesName: seriesName,
    linkType: linkType,
    originalUrl: originalUrl,
    shortUrl: newLink,
    customDomain: customDomain,
    // ===== إضافة الحقل الجديد =====
    socialBackground: socialBackground || '',
    // ===== نهاية الإضافة =====
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    userId: user ? user.uid : null,
    clicks: 0,
    socialTitle: socialTitle || `Turkify - ${getTypeName(linkType)} ${seriesName}`,
    socialDescription: socialDescription || `شاهد ${seriesName} الآن على Turkify!`,
    
    // بيانات الصورة/الفيديو حسب النوع
    ...(videoData.hasTrailer ? {
        trailerUrl: videoData.trailerUrl,
        trailerVideoId: videoData.trailerVideoId,
        socialImage: videoData.thumbnailUrl, // استخدام thumbnail يوتيوب
        hasTrailer: true
    } : {
        socialImage: socialImage || 'https://via.placeholder.com/1200x630/4A154B/FFFFFF?text=Turkify+Pro',
        hasTrailer: false
    })
};
                
                // Add totalEpisodes and startingEpisode for series
                if (linkType === 'series') {
                    linkData.totalEpisodes = totalEpisodes;
                    linkData.startingEpisode = startingEpisode;
                    
                    // Set startDate to current time (for episode calculation)
                    linkData.startDate = firebase.firestore.Timestamp.now();
                }
                
                // Save to Firestore
                await db.collection('links').doc(linkId).set(linkData);
                
                // ===== إضافة حفظ بيانات الحلقات =====
                if (linkType === 'series' && window.uploadedEpisodes) {
                    try {
                        await db.collection('series_episodes').doc(linkId).set({
                            seriesName: seriesName,
                            episodes: window.uploadedEpisodes.episodes
                        });
                        showNotification('success', 'تم حفظ بيانات الحلقات بنجاح!');
                    } catch (error) {
                        showNotification('error', `فشل في حفظ بيانات الحلقات: ${error.message}`);
                    }
                }
                // ===== نهاية الإضافة =====
                
                // Show modal with the new link
                document.getElementById('generatedLink').value = newLink;
                document.getElementById('originalLinkDisplay').textContent = originalUrl;
                
                const modal = new bootstrap.Modal(document.getElementById('linkModal'));
                modal.show();
                
                // Show success notification
                showNotification('success', 'تم إنشاء الرابط بنجاح!');
                
                // Reset form
                document.getElementById('seriesName').value = '';
                document.getElementById('originalUrl').value = '';
                document.getElementById('totalEpisodes').value = '';
                document.getElementById('startingEpisode').value = '1';
                document.getElementById('episodeCountWrapper').style.display = 'none';
                document.getElementById('startingEpisodeWrapper').style.display = 'none';
                document.getElementById('socialTitle').value = '';
                document.getElementById('socialDescription').value = '';
                document.getElementById('socialImage').value = '';
                // ===== إعادة تعيين الحقل الجديد =====
                document.getElementById('socialBackground').value = '';
                // ===== نهاية الإضافة =====
                
                // Re-enable button
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-bolt me-2"></i>إنشاء الرابط';
                
                // Reload links table
                loadLinks();
            } catch (error) {
                console.error('Error saving link:', error);
                showNotification('error', `فشل في حفظ الرابط: ${error.message}`);
                // Re-enable button
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-bolt me-2"></i>إنشاء الرابط';
            }
        }
        
        // Update existing link
        async function updateLink() {
            const seriesNameInput = document.getElementById('seriesName');
            const originalUrlInput = document.getElementById('originalUrl');
            const seriesName = seriesNameInput.value.trim();
            const originalUrl = originalUrlInput.value.trim();
            const socialTitle = document.getElementById('socialTitle').value.trim();
            const socialDescription = document.getElementById('socialDescription').value.trim();
            const socialImage = document.getElementById('socialImage').value.trim();
            // ===== إضافة الحقل الجديد =====
            const socialBackground = document.getElementById('socialBackground').value.trim();
            // ===== نهاية الإضافة =====
            const linkType = document.getElementById('linkType').value;
            const totalEpisodes = parseInt(document.getElementById('totalEpisodes').value) || 0;
            const startingEpisode = parseInt(document.getElementById('startingEpisode').value) || 1;
            
            // Reset validation states
            seriesNameInput.classList.remove('is-invalid');
            originalUrlInput.classList.remove('is-invalid');
            document.getElementById('episodeError').style.display = 'none';
            
            // Validate URL
            if (!isValidUrl(originalUrl)) {
                originalUrlInput.classList.add('is-invalid');
                showNotification('error', 'الرجاء إدخال رابط صالح');
                return;
            }
            
            // Validate series name
            if (!seriesName || !isValidSeriesName(seriesName)) {
                seriesNameInput.classList.add('is-invalid');
                showNotification('error', 'الرجاء إدخال اسم سلسلة صالح');
                return;
            }
            
            // Validate episode count for series
            if (linkType === 'series' && (!totalEpisodes || totalEpisodes < 1)) {
                document.getElementById('episodeError').style.display = 'block';
                showNotification('error', 'الرجاء إدخال عدد حلقات صحيح');
                return;
            }
            
            try {
                // Disable button during processing
                updateBtn.disabled = true;
                updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>جاري الحفظ...';
                
                // Get link data
                const linkDoc = await db.collection('links').doc(currentEditingLinkId).get();
                
                if (linkDoc.exists) {
                    const linkData = linkDoc.data();
                    
    const videoData = trailerSystem.getVideoDataForSave();                
                    
                    // Update link data
const updatedData = {
    seriesName: seriesName,
    originalUrl: originalUrl,
    socialTitle: socialTitle,
    socialDescription: socialDescription,
    linkType: linkType,
    // ===== إضافة الحقل الجديد =====
    socialBackground: socialBackground || '',
    // ===== نهاية الإضافة =====
    
    // تحديث بيانات الصورة/الفيديو
    ...(videoData.hasTrailer ? {
        trailerUrl: videoData.trailerUrl,
        trailerVideoId: videoData.trailerVideoId,
        socialImage: videoData.thumbnailUrl,
        hasTrailer: true
    } : {
        socialImage: socialImage,
        hasTrailer: false,
        trailerUrl: null,
        trailerVideoId: null
    })
};
                    
                    // Add totalEpisodes and startingEpisode for series
                    if (linkType === 'series') {
                        updatedData.totalEpisodes = totalEpisodes;
                        updatedData.startingEpisode = startingEpisode;
                    } else {
                        updatedData.totalEpisodes = null;
                        updatedData.startingEpisode = null;
                    }
                    
                    // Save to Firestore
                    await db.collection('links').doc(currentEditingLinkId).update(updatedData);
                    
                    // ===== إضافة تحديث بيانات الحلقات =====
                    if (linkType === 'series' && window.uploadedEpisodes) {
                        try {
                            await db.collection('series_episodes').doc(currentEditingLinkId).set({
                                seriesName: seriesName,
                                episodes: window.uploadedEpisodes.episodes
                            });
                            showNotification('success', 'تم تحديث بيانات الحلقات بنجاح!');
                        } catch (error) {
                            showNotification('error', `فشل في تحديث بيانات الحلقات: ${error.message}`);
                        }
                    }
                    // ===== نهاية الإضافة =====
                    
                    // Show success notification
                    showNotification('success', 'تم تحديث الرابط بنجاح!');
                    
                    // Hide update button and show generate button
                    updateBtn.style.display = 'none';
                    generateBtn.style.display = 'block';
                    
                    // Reset form
                    document.getElementById('seriesName').value = '';
                    document.getElementById('originalUrl').value = '';
                    document.getElementById('totalEpisodes').value = '';
                    document.getElementById('startingEpisode').value = '1';
                    document.getElementById('episodeCountWrapper').style.display = 'none';
                    document.getElementById('startingEpisodeWrapper').style.display = 'none';
                    document.getElementById('socialTitle').value = '';
                    document.getElementById('socialDescription').value = '';
                    document.getElementById('socialImage').value = '';
                    // ===== إعادة تعيين الحقل الجديد =====
                    document.getElementById('socialBackground').value = '';
                    // ===== نهاية الإضافة =====
                    
                    // Reset editing state
                    currentEditingLinkId = null;
                    
                    // Re-enable button
                    updateBtn.disabled = false;
                    updateBtn.innerHTML = '<i class="fas fa-save me-2"></i>حفظ التغييرات';
                    
                    // Reload links table
                    loadLinks();
                }
                
            } catch (error) {
                console.error('Error updating link:', error);
                showNotification('error', `فشل في تحديث الرابط: ${error.message}`);
                // Re-enable button
                updateBtn.disabled = false;
                updateBtn.innerHTML = '<i class="fas fa-save me-2"></i>حفظ التغييرات';
            }
        }
        
        // Get type name in Arabic
        function getTypeName(type) {
            const types = {
                'series': 'مسلسل',
                'movie': 'فيلم',
                'match': 'مباراة',
                'recipe': 'وصفة',
                'game': 'لعبة',
                'app': 'تطبيق',
                'channel': 'قناة',
                'reels': 'ريلز'
            };
            return types[type] || 'غير محدد';
        }
        
        // Load links for admin panel
        async function loadLinks() {
            setLoading(true);
            // Show loading spinner
            linksTable.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center table-loader">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">جاري التحميل...</span>
                        </div>
                    </td>
                </tr>
            `;
            
            try {
                // Get current user
                const user = auth.currentUser;
                if (!user) {
                    linksTable.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center py-5">
                                <div class="alert alert-info">
                                    يرجى تسجيل الدخول لعرض الروابط الخاصة بك
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // Load links from Firestore
                const querySnapshot = await db.collection('links').where('userId', '==', user.uid).get();
                
                if (querySnapshot.empty) {
                    linksTable.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center py-5">
                                لا توجد روابط. قم بإنشاء رابطك الأول!
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let tableContent = '';
                querySnapshot.forEach(doc => {
                    const link = doc.data();
                    
                    // Map link type to badge
                    const typeBadge = `<span class="link-type-badge type-${link.linkType || 'series'}">${getTypeName(link.linkType)}</span>`;
                    
                    tableContent += `
                        <tr>
                            <td>${link.id}</td>
                            <td>${link.seriesName}</td>
                            <td>${typeBadge}</td>
                            <td>
                                <a href="${link.shortUrl}" target="_blank" class="short-url">
                                    ${link.shortUrl}
                                </a>
                            </td>
                            <td>${link.createdAt ? formatFirestoreDateTime(link.createdAt) : 'N/A'}</td>
                            <td><span class="clicks-badge">${link.clicks}</span></td>
                            <td class="action-buttons">
                                <button class="btn btn-sm btn-outline-primary stats-btn" data-id="${link.id}" aria-label="عرض الإحصائيات">
                                    <i class="fas fa-chart-bar"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-info copy-btn" data-link="${link.shortUrl}" aria-label="نسخ الرابط">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-primary edit-btn" data-id="${link.id}" aria-label="تعديل الرابط">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${link.id}" aria-label="حذف الرابط">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-success earnings-btn" data-id="${link.id}" aria-label="الإيرادات">
                                    <i class="fas fa-dollar-sign"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                linksTable.innerHTML = tableContent;
                
                // Add event listeners to action buttons
                document.querySelectorAll('.stats-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
        const linkId = this.getAttribute('data-id');
        
        if (!linkId) {
            showNotification('error', 'معرف الرابط غير صالح');
            return;
        }
        
        // تعطيل الزر مؤقتاً
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        try {
            await showLinkStats(linkId);
        } catch (error) {
            console.error('Error:', error);
            showNotification('error', 'فشل في تحميل الإحصائيات');
        } finally {
            // إعادة تفعيل الزر
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-chart-bar"></i>';
        }
    });
});
                
                document.querySelectorAll('.copy-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const linkUrl = this.getAttribute('data-link');
                        navigator.clipboard.writeText(linkUrl);
                        showNotification('success', 'تم نسخ الرابط إلى الحافظة!');
                    });
                });
                
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const linkId = this.getAttribute('data-id');
                        editLink(linkId);
                    });
                });
                
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const linkId = this.getAttribute('data-id');
                        showConfirmation('هل أنت متأكد من رغبتك في حذف هذا الرابط؟', () => {
                            deleteLink(linkId);
                        });
                    });
                });
                
                document.querySelectorAll('.earnings-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
        const linkId = this.getAttribute('data-id');
        
        if (!linkId) {
            showNotification('error', 'معرف الرابط غير صالح');
            return;
        }
        
        // تعطيل الزر مؤقتاً
        this.disabled = true;
        const originalHTML = this.innerHTML;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        try {
            // التحقق من وجود بيانات كافية
            const visitsQuery = await db.collection('visits')
                .where('linkId', '==', linkId)
                .limit(1)
                .get();
            
            if (visitsQuery.empty) {
                showNotification('info', 'لا توجد زيارات كافية لحساب الأرباح بعد');
                return;
            }
            
            await showEarnings(linkId);
        } catch (error) {
            console.error('Error loading earnings:', error);
            showNotification('error', 'فشل في تحميل بيانات الأرباح: ' + error.message);
        } finally {
            // إعادة تفعيل الزر
            this.disabled = false;
            this.innerHTML = originalHTML;
        }
    });
});
            } catch (error) {
                console.error('Error loading links:', error);
                linksTable.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-5">
                            <div class="alert alert-danger">
                                فشل في تحميل الروابط: ${error.message}
                            </div>
                        </td>
                    </tr>
                `;
            } finally {
                setLoading(false);
            }
        }
        
        // Show link statistics
async function showLinkStats(linkId) {
    setLoading(true);
    
    try {
        // جلب بيانات الرابط الأساسية
        const linkDoc = await db.collection('links').doc(linkId).get();
        
        if (!linkDoc.exists) {
            throw new Error('الرابط غير موجود');
        }
        
        const linkData = linkDoc.data();
        
        // جلب الزيارات الفعلية من Firebase
        const visitsQuery = await db.collection('visits')
            .where('linkId', '==', linkId)
            .orderBy('timestamp', 'desc')
            .get();
        
        // حساب الإحصائيات الفعلية
        const visits = visitsQuery.docs.map(doc => doc.data());
        const totalVisits = visits.length;
        
        // حساب زيارات اليوم
        const today = new Date();
        const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        const todayVisits = visits.filter(visit => {
            const visitDate = visit.timestamp.toDate();
            return visitDate >= startOfDay;
        }).length;
        
        // حساب البلد الأكثر زيارة
        const countryCounts = {};
        visits.forEach(visit => {
            countryCounts[visit.country] = (countryCounts[visit.country] || 0) + 1;
        });
        const topCountry = Object.keys(countryCounts).reduce((a, b) => 
            countryCounts[a] > countryCounts[b] ? a : b, 'غير محدد'
        );
        
        // حساب الجهاز الأكثر استخداماً
        const deviceCounts = {};
        visits.forEach(visit => {
            deviceCounts[visit.device] = (deviceCounts[visit.device] || 0) + 1;
        });
        const topDevice = Object.keys(deviceCounts).reduce((a, b) => 
            deviceCounts[a] > deviceCounts[b] ? a : b, 'غير محدد'
        );
        
        // تعبئة بيانات المودال
        const titleElement = document.getElementById('statsLinkTitle');
        const urlElement = document.getElementById('statsLinkUrl');
        const totalVisitsElement = document.getElementById('totalVisits');
        const todayVisitsElement = document.getElementById('todayVisits');
        const topCountryElement = document.getElementById('topCountry');
        const topDeviceElement = document.getElementById('topDevice');
        
        // فحص وجود العناصر قبل التحديث
        if (titleElement) titleElement.textContent = linkData.seriesName || 'غير محدد';
        if (urlElement) {
            urlElement.textContent = linkData.shortUrl || 'غير متاح';
            urlElement.href = linkData.shortUrl || '#';
        }
        if (totalVisitsElement) totalVisitsElement.textContent = totalVisits.toLocaleString();
        if (todayVisitsElement) todayVisitsElement.textContent = todayVisits.toLocaleString();
        if (topCountryElement) topCountryElement.textContent = topCountry;
        if (topDeviceElement) topDeviceElement.textContent = topDevice;
        
        // إنشاء الرسوم البيانية بالبيانات الحقيقية
        createRealTimeCharts(visits);
        
        // عرض المودال
        const modal = new bootstrap.Modal(document.getElementById('statsModal'));
        modal.show();
        
    } catch (error) {
        console.error('Error loading stats:', error);
        showNotification('error', 'فشل في تحميل الإحصائيات: ' + error.message);
    } finally {
        setLoading(false);
    }
}
       
       // فحص صحة البيانات قبل حساب الأرباح
function validateEarningsData(visits) {
    const validVisits = visits.filter(visit => {
        // التحقق من وجود البيانات المطلوبة
        return visit && 
               visit.timestamp && 
               visit.country && 
               typeof visit.country === 'string' &&
               visit.linkId;
    });
    
    if (validVisits.length !== visits.length) {
        console.warn(`تم تجاهل ${visits.length - validVisits.length} زيارة لعدم اكتمال البيانات`);
    }
    
    return validVisits;
}

// إضافة معلومات مفيدة للمستخدم
function generateEarningsReport(totalEarnings, arabVisits, foreignVisits) {
    const totalVisits = arabVisits + foreignVisits;
    
    let report = `📊 تقرير الأرباح:\n`;
    report += `💰 إجمالي الأرباح: $${totalEarnings.toFixed(2)}\n`;
    report += `👥 إجمالي الزيارات: ${totalVisits.toLocaleString()}\n`;
    
    if (totalVisits > 0) {
        report += `🌍 الزيارات العربية: ${arabVisits} (${((arabVisits/totalVisits)*100).toFixed(1)}%)\n`;
        report += `🌎 الزيارات الأجنبية: ${foreignVisits} (${((foreignVisits/totalVisits)*100).toFixed(1)}%)\n`;
        
        // نصائح للتحسين
        if (foreignVisits < arabVisits) {
            report += `\n💡 نصيحة: حاول الترويج في البلدان الأجنبية للحصول على أرباح أعلى!`;
        }
    }
    
    return report;
} 
        // Show real earnings for a link
async function showEarnings(linkId) {
    setLoading(true);
    window.currentEarningsLinkId = linkId;
    
    try {
        // جلب بيانات الرابط
        const linkDoc = await db.collection('links').doc(linkId).get();
        if (!linkDoc.exists) {
            throw new Error('الرابط غير موجود');
        }
        
        const linkData = linkDoc.data();
        
        // جلب جميع الزيارات للرابط
        const visitsQuery = await db.collection('visits')
            .where('linkId', '==', linkId)
            .orderBy('timestamp', 'desc')
            .get();
        
        const visits = visitsQuery.docs.map(doc => doc.data());
        
        // تصنيف البلدان العربية والأجنبية
        const arabicCountries = [
            'السعودية', 'الإمارات', 'مصر', 'العراق', 'الأردن', 'لبنان', 
            'سوريا', 'الكويت', 'قطر', 'البحرين', 'عمان', 'اليمن',
            'المغرب', 'الجزائر', 'تونس', 'ليبيا', 'السودان', 'الصومال',
            'موريتانيا', 'جيبوتي', 'جزر القمر', 'فلسطين',
            'Saudi Arabia', 'United Arab Emirates', 'Egypt', 'Iraq', 
            'Jordan', 'Lebanon', 'Syria', 'Kuwait', 'Qatar', 'Bahrain', 
            'Oman', 'Yemen', 'Morocco', 'Algeria', 'Tunisia', 'Libya', 
            'Sudan', 'Somalia', 'Mauritania', 'Djibouti', 'Comoros', 'Palestine'
        ];
        
        // فصل الزيارات حسب المنطقة
        let arabVisits = 0;
        let foreignVisits = 0;
        let todayArabVisits = 0;
        let todayForeignVisits = 0;
        
        const today = new Date();
        const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        
        visits.forEach(visit => {
            const isArabic = arabicCountries.includes(visit.country);
            const visitDate = visit.timestamp.toDate();
            const isToday = visitDate >= startOfDay;
            
            if (isArabic) {
                arabVisits++;
                if (isToday) todayArabVisits++;
            } else {
                foreignVisits++;
                if (isToday) todayForeignVisits++;
            }
        });
        
        // حساب الأرباح
        // $1 لكل 1000 زيارة عربية
        // $3 لكل 1000 زيارة أجنبية
        const arabEarnings = (arabVisits / 1000) * 1.00;
        const foreignEarnings = (foreignVisits / 1000) * 3.00;
        const totalEarnings = arabEarnings + foreignEarnings;
        
        const todayArabEarnings = (todayArabVisits / 1000) * 1.00;
        const todayForeignEarnings = (todayForeignVisits / 1000) * 3.00;
        const todayTotalEarnings = todayArabEarnings + todayForeignEarnings;
        
        const totalVisits = arabVisits + foreignVisits;
        const averageRPM = totalVisits > 0 ? (totalEarnings / totalVisits) * 1000 : 0;
        const validVisits = validateEarningsData(visits);
        
        // تحديث modal العنوان
        document.getElementById('earningsLinkTitle').textContent = linkData.seriesName || 'غير محدد';
        
        // تحديث البيانات في modal
        document.getElementById('totalEarnings').textContent = `$${totalEarnings.toFixed(2)}`;
        document.getElementById('totalImpressions').textContent = totalVisits.toLocaleString();
        document.getElementById('averageRPM').textContent = `$${averageRPM.toFixed(2)}`;
        document.getElementById('todayEarnings').textContent = `$${todayTotalEarnings.toFixed(2)}`;
        
        // تحديث تفاصيل المناطق
        document.getElementById('arabVisits').textContent = `${arabVisits.toLocaleString()} زيارة`;
        document.getElementById('arabEarnings').textContent = `$${arabEarnings.toFixed(2)}`;
        document.getElementById('foreignVisits').textContent = `${foreignVisits.toLocaleString()} زيارة`;
        document.getElementById('foreignEarnings').textContent = `$${foreignEarnings.toFixed(2)}`;
        
        // تحديث أشرطة التقدم
        const arabPercentage = totalVisits > 0 ? (arabVisits / totalVisits) * 100 : 0;
        const foreignPercentage = totalVisits > 0 ? (foreignVisits / totalVisits) * 100 : 0;
        
        document.getElementById('arabProgress').style.width = `${arabPercentage}%`;
        document.getElementById('foreignProgress').style.width = `${foreignPercentage}%`;
        
        // إنشاء الرسم البياني للأرباح
        await createEarningsChart(visits, arabicCountries);
        
        // عرض modal
        const modal = new bootstrap.Modal(document.getElementById('earningsModal'));
        modal.show();
        
    } catch (error) {
        console.error('Error loading earnings:', error);
        showNotification('error', 'فشل في تحميل بيانات الأرباح: ' + error.message);
    } finally {
        setLoading(false);
    }
}

// فلترة الأرباح حسب الفترة الزمنية
function filterEarningsByTime(visits, timePeriod, arabicCountries) {
    const now = new Date();
    let startDate;
    
    switch(timePeriod) {
        case 'اليوم':
            startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            break;
        case 'أسبوع':
            startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            break;
        case 'شهر':
            startDate = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
            break;
        case '3 أشهر':
            startDate = new Date(now.getFullYear(), now.getMonth() - 3, now.getDate());
            break;
        case 'سنة':
            startDate = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
            break;
        default:
            startDate = new Date(0); // جميع الأوقات
    }
    
    const filteredVisits = visits.filter(visit => {
        const visitDate = visit.timestamp.toDate();
        return visitDate >= startDate;
    });
    
    // حساب الأرباح المفلترة
    let arabVisits = 0;
    let foreignVisits = 0;
    
    filteredVisits.forEach(visit => {
        if (arabicCountries.includes(visit.country)) {
            arabVisits++;
        } else {
            foreignVisits++;
        }
    });
    
    const arabEarnings = (arabVisits / 1000) * 1.00;
    const foreignEarnings = (foreignVisits / 1000) * 3.00;
    const totalEarnings = arabEarnings + foreignEarnings;
    
    return {
        arabVisits,
        foreignVisits,
        arabEarnings,
        foreignEarnings,
        totalEarnings,
        totalVisits: arabVisits + foreignVisits
    };
}

// إضافة معالجات أزرار الفلترة الزمنية للأرباح
document.addEventListener('DOMContentLoaded', function() {
    // معالج أزرار الفلترة في modal الأرباح
    const earningsModal = document.getElementById('earningsModal');
    if (earningsModal) {
        earningsModal.addEventListener('click', function(e) {
            if (e.target.classList.contains('time-btn')) {
                // إزالة active من جميع الأزرار
                earningsModal.querySelectorAll('.time-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // إضافة active للزر المحدد
                e.target.classList.add('active');
                
                // إعادة تحميل البيانات بالفلتر الجديد
                const timePeriod = e.target.textContent;
                updateEarningsWithFilter(timePeriod);
            }
        });
    }
});

// تحديث الأرباح مع الفلتر
async function updateEarningsWithFilter(timePeriod) {
    // الحصول على linkId الحالي (يجب تخزينه عند فتح modal)
    const currentLinkId = window.currentEarningsLinkId;
    if (!currentLinkId) return;
    
    try {
        setLoading(true);
        
        // جلب الزيارات
        const visitsQuery = await db.collection('visits')
            .where('linkId', '==', currentLinkId)
            .orderBy('timestamp', 'desc')
            .get();
        
        const visits = visitsQuery.docs.map(doc => doc.data());
        
        const arabicCountries = [
            'السعودية', 'الإمارات', 'مصر', 'العراق', 'الأردن', 'لبنان', 
            'سوريا', 'الكويت', 'قطر', 'البحرين', 'عمان', 'اليمن',
            'المغرب', 'الجزائر', 'تونس', 'ليبيا', 'السودان', 'الصومال',
            'موريتانيا', 'جيبوتي', 'جزر القمر', 'فلسطين',
            'Saudi Arabia', 'United Arab Emirates', 'Egypt', 'Iraq', 
            'Jordan', 'Lebanon', 'Syria', 'Kuwait', 'Qatar', 'Bahrain', 
            'Oman', 'Yemen', 'Morocco', 'Algeria', 'Tunisia', 'Libya', 
            'Sudan', 'Somalia', 'Mauritania', 'Djibouti', 'Comoros', 'Palestine'
        ];
        
        // تطبيق الفلتر
        const filteredData = filterEarningsByTime(visits, timePeriod, arabicCountries);
        
        // تحديث القيم في modal
        document.getElementById('totalEarnings').textContent = `$${filteredData.totalEarnings.toFixed(2)}`;
        document.getElementById('totalImpressions').textContent = filteredData.totalVisits.toLocaleString();
        document.getElementById('arabVisits').textContent = `${filteredData.arabVisits.toLocaleString()} زيارة`;
        document.getElementById('arabEarnings').textContent = `$${filteredData.arabEarnings.toFixed(2)}`;
        document.getElementById('foreignVisits').textContent = `${filteredData.foreignVisits.toLocaleString()} زيارة`;
        document.getElementById('foreignEarnings').textContent = `$${filteredData.foreignEarnings.toFixed(2)}`;
        
        // تحديث أشرطة التقدم
        const arabPercentage = filteredData.totalVisits > 0 ? (filteredData.arabVisits / filteredData.totalVisits) * 100 : 0;
        const foreignPercentage = filteredData.totalVisits > 0 ? (filteredData.foreignVisits / filteredData.totalVisits) * 100 : 0;
        
        document.getElementById('arabProgress').style.width = `${arabPercentage}%`;
        document.getElementById('foreignProgress').style.width = `${foreignPercentage}%`;
        
        // تحديث متوسط الربح
        const averageRPM = filteredData.totalVisits > 0 ? (filteredData.totalEarnings / filteredData.totalVisits) * 1000 : 0;
        document.getElementById('averageRPM').textContent = `$${averageRPM.toFixed(2)}`;
        
    } catch (error) {
        console.error('Error updating filtered earnings:', error);
        showNotification('error', 'فشل في تحديث البيانات المفلترة');
    } finally {
        setLoading(false);
    }
}

// Create real earnings chart
async function createEarningsChart(visits, arabicCountries) {
    // تنظيف الرسم السابق
    Chart.getChart('earningsChart')?.destroy();
    
    const ctx = document.getElementById('earningsChart');
    if (!ctx) return;
    
    // تجميع الأرباح حسب اليوم (آخر 30 يوم)
    const last30Days = [];
    const earningsByDay = {};
    
    for (let i = 29; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0]; // YYYY-MM-DD format
        const displayDate = date.toLocaleDateString('ar-EG', { month: 'short', day: 'numeric' });
        last30Days.push(displayDate);
        earningsByDay[dateStr] = { arab: 0, foreign: 0, total: 0 };
    }
    
    // حساب الأرباح لكل يوم
    visits.forEach(visit => {
        const visitDate = visit.timestamp.toDate();
        const dateStr = visitDate.toISOString().split('T')[0];
        
        if (earningsByDay[dateStr]) {
            if (arabicCountries.includes(visit.country)) {
                earningsByDay[dateStr].arab += (1.00 / 1000); // $1 per 1000 visits
            } else {
                earningsByDay[dateStr].foreign += (3.00 / 1000); // $3 per 1000 visits
            }
            earningsByDay[dateStr].total = earningsByDay[dateStr].arab + earningsByDay[dateStr].foreign;
        }
    });
    
    // إعداد البيانات للرسم البياني
    const arabData = Object.values(earningsByDay).map(day => day.arab);
    const foreignData = Object.values(earningsByDay).map(day => day.foreign);
    const totalData = Object.values(earningsByDay).map(day => day.total);
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: last30Days,
            datasets: [
                {
                    label: 'أرباح عربية ($1/1000)',
                    data: arabData,
                    borderColor: '#2EC4B6',
                    backgroundColor: 'rgba(46, 196, 182, 0.1)',
                    borderWidth: 2,
                    tension: 0.3,
                    fill: false
                },
                {
                    label: 'أرباح أجنبية ($3/1000)',
                    data: foreignData,
                    borderColor: '#4A154B',
                    backgroundColor: 'rgba(74, 21, 75, 0.1)',
                    borderWidth: 2,
                    tension: 0.3,
                    fill: false
                },
                {
                    label: 'إجمالي الأرباح',
                    data: totalData,
                    borderColor: '#EF5A5F',
                    backgroundColor: 'rgba(239, 90, 95, 0.1)',
                    borderWidth: 3,
                    tension: 0.3,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: $${context.parsed.y.toFixed(4)}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toFixed(3);
                        }
                    }
                },
                x: {
                    ticks: {
                        maxTicksLimit: 10
                    }
                }
            }
        }
    });
}
        
        // Create charts for stats
function createRealTimeCharts(visits) {
    // تنظيف الرسوم السابقة
    Chart.getChart('visitsChart')?.destroy();
    Chart.getChart('geoChart')?.destroy();
    Chart.getChart('devicesChart')?.destroy();
    Chart.getChart('sourcesChart')?.destroy();
    
    // رسم بياني للزيارات حسب التاريخ (آخر 7 أيام)
    const last7Days = [];
    const visitsByDay = {};
    
    for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toLocaleDateString('ar-EG');
        last7Days.push(dateStr);
        visitsByDay[dateStr] = 0;
    }
    
    visits.forEach(visit => {
        const visitDate = visit.timestamp.toDate().toLocaleDateString('ar-EG');
        if (visitsByDay.hasOwnProperty(visitDate)) {
            visitsByDay[visitDate]++;
        }
    });
    
    // رسم الزيارات مع الوقت
    const visitsCtx = document.getElementById('visitsChart');
    if (visitsCtx) {
        new Chart(visitsCtx, {
            type: 'line',
            data: {
                labels: last7Days,
                datasets: [{
                    label: 'الزيارات',
                    data: last7Days.map(date => visitsByDay[date]),
                    borderColor: '#4A154B',
                    backgroundColor: 'rgba(74, 21, 75, 0.1)',
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, ticks: { stepSize: 1 } }
                }
            }
        });
    }
    
    // رسم التوزيع الجغرافي
    const countryCounts = {};
    visits.forEach(visit => {
        countryCounts[visit.country] = (countryCounts[visit.country] || 0) + 1;
    });
    
    const topCountries = Object.entries(countryCounts)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 5);
    
    const geoCtx = document.getElementById('geoChart');
    if (geoCtx && topCountries.length > 0) {
        new Chart(geoCtx, {
            type: 'doughnut',
            data: {
                labels: topCountries.map(([country]) => country),
                datasets: [{
                    data: topCountries.map(([,count]) => count),
                    backgroundColor: ['#4A154B', '#EF5A5F', '#2EC4B6', '#FF9F1C', '#6C757D']
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }
    
    // رسم أنواع الأجهزة
    const deviceCounts = {};
    visits.forEach(visit => {
        deviceCounts[visit.device] = (deviceCounts[visit.device] || 0) + 1;
    });
    
    const devicesCtx = document.getElementById('devicesChart');
    if (devicesCtx && Object.keys(deviceCounts).length > 0) {
        new Chart(devicesCtx, {
            type: 'pie',
            data: {
                labels: Object.keys(deviceCounts),
                datasets: [{
                    data: Object.values(deviceCounts),
                    backgroundColor: ['#4A154B', '#2EC4B6', '#EF5A5F', '#FF9F1C']
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }
    
    // رسم مصادر الزيارات
    const sourceCounts = {};
    visits.forEach(visit => {
        sourceCounts[visit.source] = (sourceCounts[visit.source] || 0) + 1;
    });
    
    const sourcesCtx = document.getElementById('sourcesChart');
    if (sourcesCtx && Object.keys(sourceCounts).length > 0) {
        new Chart(sourcesCtx, {
            type: 'bar',
            data: {
                labels: Object.keys(sourceCounts),
                datasets: [{
                    label: 'الزيارات',
                    data: Object.values(sourceCounts),
                    backgroundColor: '#4A154B'
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
            }
        });
    }
}
        
        // Edit link function
        async function editLink(linkId) {
            setLoading(true);
            try {
                const linkDoc = await db.collection('links').doc(linkId).get();
                
                if (linkDoc.exists) {
                    const linkData = linkDoc.data();
                    
                    // تعبئة النموذج ببيانات الرابط
                    document.getElementById('seriesName').value = linkData.seriesName;
                    document.getElementById('originalUrl').value = linkData.originalUrl;
                    document.getElementById('customDomain').value = linkData.customDomain;
                    document.getElementById('linkType').value = linkData.linkType || 'series';
                    document.getElementById('socialTitle').value = linkData.socialTitle || '';
                    document.getElementById('socialDescription').value = linkData.socialDescription || '';
                    document.getElementById('socialImage').value = linkData.socialImage || '';
                    
                    // ===== إضافة الحقل الجديد =====
                    document.getElementById('socialBackground').value = linkData.socialBackground || '';
                    // ===== نهاية الإضافة =====
                    
                    // إظهار حقول المسلسل
                    if (linkData.linkType === 'series') {
                        document.getElementById('episodeCountWrapper').style.display = 'block';
                        document.getElementById('startingEpisodeWrapper').style.display = 'block';
                        document.getElementById('totalEpisodes').value = linkData.totalEpisodes || '';
                        document.getElementById('startingEpisode').value = linkData.startingEpisode || 1;
                    } else {
                        document.getElementById('episodeCountWrapper').style.display = 'none';
                        document.getElementById('startingEpisodeWrapper').style.display = 'none';
                    }
                    
                    // Set current editing link ID
                    currentEditingLinkId = linkId;
                    
                    // Show update button and hide generate button
                    updateBtn.style.display = 'block';
                    generateBtn.style.display = 'none';
                    
                    // نقل المستخدم لنموذج الإنشاء
                    window.location.hash = 'admin';
                    window.scrollTo(0, 0);
                    
                    // Update preview
                    updateSocialPreview();
                    
                    // إظهار حالة ملف الحلقات
                    if (linkData.linkType === 'series') {
                        try {
                            const episodesDoc = await db.collection('series_episodes').doc(linkId).get();
                            if (episodesDoc.exists) {
                                document.getElementById('episodesInfo').innerHTML = `
                                    <div class="alert alert-info mt-2">
                                        <i class="fas fa-info-circle me-2"></i>
                                        تم رفع ملف حلقات مسبقاً يحتوي على ${episodesDoc.data().episodes.length} حلقة
                                    </div>
                                `;
                            }
                        } catch (error) {
                            console.error('Error loading episodes info:', error);
                        }
                    }
                }
            } catch (error) {
                showNotification('error', `فشل في تحميل الرابط: ${error.message}`);
            } finally {
                setLoading(false);
            }         
        }
        
        // Delete link function
        async function deleteLink(linkId) {
            setLoading(true);
            try {
                await db.collection('links').doc(linkId).delete();
                // حذف بيانات الحلقات المرتبطة إذا وجدت
                await db.collection('series_episodes').doc(linkId).delete().catch(() => {});
                showNotification('success', 'تم حذف الرابط بنجاح!');
                loadLinks();
            } catch (error) {
                console.error('Error deleting link:', error);
                showNotification('error', `فشل في حذف الرابط: ${error.message}`);
            } finally {
                setLoading(false);
            }
        }
        
        // دالة لجلب الإحصائيات الحقيقية
        async function loadAnalytics() {
            try {
                const statsDoc = await db.collection('stats').doc('global').get();
                const stats = statsDoc.data() || {};
                
                document.getElementById('totalLinksStat').textContent = 
                    (stats.totalLinks || 25000).toLocaleString() + '+';
                
                document.getElementById('totalClicksStat').textContent = 
                    (stats.totalClicks || 1200000).toLocaleString() + '+';
                
                document.getElementById('todayClicksStat').textContent = 
                    (stats.todayClicks || 1245).toLocaleString();
                
                document.getElementById('uptimeStat').textContent = 
                    (stats.uptime || 99.9).toFixed(1) + '%';
            } catch (error) {
                console.error('Error loading live stats:', error);
            }
        }

        // Firebase Authentication
        function initAuth() {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // User is signed in
                    userProfile.style.display = 'flex';
                    authButtons.style.display = 'none';
                    
                    // Set user info
                    userPhoto.src = user.photoURL || 'https://via.placeholder.com/40';
                    userName.textContent = user.displayName || 'مستخدم';
                    
                    // Show welcome notification
                    showNotification('success', `أهلاً بعودتك، ${user.displayName || 'مستخدم'}!`, 4000);
                    
                    // Set first user as admin
                    await setFirstUserAsAdmin(user);
                    
                    // Show admin panel if on admin page
                    if (window.location.hash === '#dashboard') {
                        showAdminPanel();
                    }
                    
                    // Load live statistics
                    loadLiveStats();
                } else {
                    // User is signed out
                    userProfile.style.display = 'none';
                    authButtons.style.display = 'block';
                    
                    // Hide admin panel
                    if (window.location.hash === '#dashboard') {
                        hideAllPanels();
                        showFeatures();
                    }
                }
            });
            
            // Sign in with Google
            signInButton.addEventListener('click', async () => {
                try {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    const result = await auth.signInWithPopup(provider);
                    showNotification('success', `تم تسجيل دخولك بنجاح، أهلاً بك ${result.user.displayName || 'مستخدم'}!`);
                } catch (error) {
                    showNotification('error', `فشل تسجيل الدخول: ${error.message}`);
                }
            });
            
            // Sign out
            signOutButton.addEventListener('click', () => {
                auth.signOut();
                showNotification('info', 'تم تسجيل خروجك بنجاح');
            });
        }
        
        // Set first user as admin
        async function setFirstUserAsAdmin(user) {
    const usersRef = db.collection('users');
    
    try {
        // منح صلاحية المشرف لجميع المستخدمين
        await usersRef.doc(user.uid).set({
            uid: user.uid,
            email: user.email,
            displayName: user.displayName,
            photoURL: user.photoURL,
            isAdmin: true, // هنا نمنح الصلاحية للجميع
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showNotification('success', 'تم منحك صلاحيات المشرف!');
        
        // إظهار عناصر المشرف
        adminOnlyElements.forEach(el => {
            el.style.display = 'block';
        });
        
    } catch (error) {
        console.error('Error setting admin:', error);
        showNotification('error', 'حدث خطأ أثناء منح الصلاحيات');
    }
}
        
        // Load live statistics
        async function loadLiveStats() {
            try {
                const statsDoc = await db.collection('stats').doc('global').get();
                const stats = statsDoc.data() || {};
                
                document.getElementById('totalLinksStat').textContent = 
                    (stats.totalLinks || 25000).toLocaleString() + '+';
                
                document.getElementById('totalClicksStat').textContent = 
                    (stats.totalClicks || 1200000).toLocaleString() + '+';
                
                document.getElementById('todayClicksStat').textContent = 
                    (stats.todayClicks || 1245).toLocaleString();
                
                document.getElementById('uptimeStat').textContent = 
                    (stats.uptime || 99.9).toFixed(1) + '%';
            } catch (error) {
                console.error('Error loading live stats:', error);
            }
        }
        
        // Update social media preview
        function updateSocialPreview() {
            const title = document.getElementById('socialTitle').value || 'عنوان المحتوى';
            const description = document.getElementById('socialDescription').value || 'وصف المحتوى الذي سيظهر على منصات التواصل الاجتماعي';
            const image = document.getElementById('socialImage').value || 'https://via.placeholder.com/500x300/4A154B/FFFFFF?text=صورة+المحتوى';
            const domain = document.getElementById('customDomain').value || 'turkii.netlify.app';
            
            document.getElementById('previewTitle').textContent = title;
            document.getElementById('previewDescription').textContent = description;
            document.getElementById('previewImage').src = image;
            document.getElementById('previewDomain').textContent = domain;
        }
        
        // Show confirmation modal
        function showConfirmation(message, callback) {
            const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
            document.getElementById('confirmationMessage').textContent = message;
            document.getElementById('confirmActionBtn').onclick = () => {
                callback();
                modal.hide();
            };
            modal.show();
        }
        
        // Navigation event listeners
        document.getElementById('adminLink').addEventListener('click', function(e) {
            e.preventDefault();
            window.location.hash = 'admin';
            highlightActiveNav();
            if (auth.currentUser) {
                showAdminPanel();
            } else {
                showFeatures();
            }
            window.scrollTo(0, 0);
        });
        
        document.getElementById('statsLink').addEventListener('click', function(e) {
            e.preventDefault();
            window.location.hash = 'analytics';
            highlightActiveNav();
            showAnalytics();
            window.scrollTo(0, 0);
        });
        
        document.getElementById('featuresLink').addEventListener('click', function(e) {
            e.preventDefault();
            window.location.hash = 'features';
            highlightActiveNav();
            showFeatures();
            window.scrollTo(0, 0);
        });
        
        document.getElementById('homeLink').addEventListener('click', function(e) {
            e.preventDefault();
            window.location.hash = '';
            highlightActiveNav();
            showFeatures();
            window.scrollTo(0, 0);
        });
        
        // Handle hash changes
        window.addEventListener('hashchange', function() {
            initPage();
        });
        
        // Share link function
        document.getElementById('shareLinkBtn').addEventListener('click', function() {
            const link = document.getElementById('generatedLink').value;
            
            if (navigator.share) {
                navigator.share({
                    title: 'رابط قصير من Turkify Pro',
                    text: 'تحقق من هذا الرابط القصير الذي أنشأته باستخدام Turkify Pro',
                    url: link
                }).then(() => {
                    showNotification('success', 'تم مشاركة الرابط بنجاح!');
                }).catch(error => {
                    console.error('Error sharing:', error);
                    copyToClipboard();
                    showNotification('info', 'تم نسخ الرابط إلى الحافظة');
                });
            } else {
                copyToClipboard();
                showNotification('success', 'تم نسخ الرابط إلى الحافظة');
            }
        });
        
        // View analytics function
        document.getElementById('viewAnalyticsBtn').addEventListener('click', function() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('linkModal'));
            modal.hide();
            window.location.hash = 'analytics';
            highlightActiveNav();
            showAnalytics();
            window.scrollTo(0, 0);
        });
        
        // Copy link button
        document.getElementById('copyLinkBtn').addEventListener('click', copyToClipboard);
        
        // Social media preview updates
        document.getElementById('socialTitle').addEventListener('input', updateSocialPreview);
        document.getElementById('socialDescription').addEventListener('input', updateSocialPreview);
        document.getElementById('socialImage').addEventListener('input', updateSocialPreview);
        
        // Toggle episode count field based on content type
        document.getElementById('linkType').addEventListener('change', function() {
            const selectedType = this.value;
            const episodeWrapper = document.getElementById('episodeCountWrapper');
            const startingEpisodeWrapper = document.getElementById('startingEpisodeWrapper');
            const jsonUploadWrapper = document.getElementById('jsonUploadWrapper');
            if (selectedType === 'series') {
                episodeWrapper.style.display = 'block';
                startingEpisodeWrapper.style.display = 'block';
                jsonUploadWrapper.style.display = 'block';
            } else {
                episodeWrapper.style.display = 'none';
                startingEpisodeWrapper.style.display = 'none';
                
                jsonUploadWrapper.style.display = 'none';
            }
        });
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initPage();
            initAuth();
            updateSocialPreview();
            
            // Set up button event listeners
            generateBtn.addEventListener('click', generateLink);
            updateBtn.addEventListener('click', updateLink);
        });
        
        // مراقب لضمان ظهور المحتوى
document.addEventListener('DOMContentLoaded', function() {
    // تطبيق الإظهار القسري عند تحميل الصفحة
    forceShowElements();
    
    // مراقبة تغييرات DOM
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList' || mutation.type === 'attributes') {
                // التحقق من وجود عناصر المحتوى وإظهارها
                const contentElements = [
                    'contentCard',
                    'contentThumbnail',
                    'contentTitle', 
                    'contentDescription',
                    'contentType'
                ];
                
                contentElements.forEach(id => {
                    const element = document.getElementById(id);
                    if (element && element.style.display === 'none') {
                        element.style.display = element.tagName === 'IMG' ? 'block' : 
                                               element.classList.contains('content-meta') ? 'flex' : 'block';
                        element.style.visibility = 'visible';
                        element.style.opacity = '1';
                    }
                });
            }
        });
    });
    
    // بدء المراقبة
    observer.observe(document.body, {
        childList: true,
        subtree: true,
        attributes: true,
        attributeFilter: ['style', 'class']
    });
    
    });

// دالة للتحقق الدوري من ظهور العناصر
function periodicVisibilityCheck() {
    const urlParams = new URLSearchParams(window.location.search);
    const linkId = urlParams.get('id');
    
    if (linkId) {
        const checkInterval = setInterval(() => {
            showContentCard();
            
            // التحقق من الصورة
            const thumbnail = document.getElementById('contentThumbnail');
            if (thumbnail && !thumbnail.src.includes('placeholder')) {
                ensureImageVisibility(thumbnail);
            }
            
            // إيقاف التحقق بعد 10 ثوان
            setTimeout(() => {
                clearInterval(checkInterval);
            }, 10000);
        }, 1000);
    }
}

// تشغيل التحقق الدوري
periodicVisibilityCheck();

// 🤖 نظام الخوارزميات الذكية المتقدمة
class SmartAlgorithms {
  constructor() {
    // تهيئة النظام
    this.results = {};
    this.isRunning = false;
    this.db = null;
    
    // تعريف الخوارزميات بعد تهيئة الكائن
    this.algorithms = this.buildDefinitions();
    
    // تهيئة Firebase
    this.initializeFirebase();
  }

  /* ---------------------------------------------------------
     تهيئة Firebase
  --------------------------------------------------------- */
  initializeFirebase() {
    try {
      if (typeof firebase !== 'undefined' && firebase.firestore) {
        this.db = firebase.firestore();
        console.log('✅ تم تهيئة Firebase بنجاح');
      } else {
        throw new Error('Firebase غير متاح');
      }
    } catch (error) {
      console.error('❌ خطأ في تهيئة Firebase:', error);
      throw new Error('تعذر تهيئة قاعدة البيانات. يرجى التأكد من اتصال Firebase');
    }
  }

  /* ---------------------------------------------------------
     بناء تعريفات الخوارزميات (15 خوارزمية)
  --------------------------------------------------------- */
  buildDefinitions() {
    return [
      /* ---- التحليلات (5) ---- */
      { 
        id: 'user-behavior-analysis',  
        name: 'تحليل سلوك المستخدم',   
        category: 'analytics',  
        complexity: 'متقدم', 
        icon: 'fas fa-user-chart',      
        enabled: false, 
        fn: (data) => this.userBehaviorAnalysis(data),
        description: 'تحليل سلوك المستخدمين بناءً على تاريخ الزيارات'
      },
      { 
        id: 'click-prediction',        
        name: 'توقع النقرات',          
        category: 'prediction', 
        complexity: 'متقدم', 
        icon: 'fas fa-mouse-pointer',   
        enabled: false, 
        fn: (data) => this.clickPrediction(data),
        description: 'توقع معدلات النقر المستقبلية بناءً على البيانات التاريخية'
      },
      { 
        id: 'optimal-timing',          
        name: 'تحليل الأوقات المثلى',   
        category: 'analytics',  
        complexity: 'متوسط', 
        icon: 'fas fa-clock',           
        enabled: false, 
        fn: (data) => this.optimalTiming(data),
        description: 'تحديد أفضل الأوقات لنشر المحتوى بناءً على تفاعل المستخدمين'
      },
      { 
        id: 'content-attraction',      
        name: 'تحليل جاذبية المحتوى',  
        category: 'analytics',  
        complexity: 'متقدم', 
        icon: 'fas fa-magnet',          
        enabled: false, 
        fn: (data) => this.contentAttraction(data),
        description: 'تحليل جاذبية المحتوى وتحديد أكثر الروابط شعبية'
      },
      { 
        id: 'geo-analysis',            
        name: 'التحليل الجغرافي',      
        category: 'analytics',  
        complexity: 'متقدم', 
        icon: 'fas fa-globe',           
        enabled: false, 
        fn: (data) => this.geoAnalysis(data),
        description: 'تحليل التوزيع الجغرافي للمستخدمين وتحديد المناطق الأكثر تفاعلاً'
      },

      /* ---- التنبؤات (3) ---- */
      { 
        id: 'trend-prediction',        
        name: 'التنبؤ بالاتجاهات',      
        category: 'prediction', 
        complexity: 'خبير',  
        icon: 'fas fa-chart-line',      
        enabled: false, 
        fn: (data) => this.trendPrediction(data),
        description: 'توقع اتجاهات النمو والانخفاض في تفاعل المستخدمين'
      },
      { 
        id: 'revenue-prediction',      
        name: 'توقع الأرباح',          
        category: 'prediction', 
        complexity: 'متقدم', 
        icon: 'fas fa-dollar-sign',     
        enabled: false, 
        fn: (data) => this.revenuePrediction(data),
        description: 'توقع الإيرادات المستقبلية بناءً على معدلات النقر الحالية'
      },
      { 
        id: 'peak-time-prediction',    
        name: 'توقع أوقات الذروة',     
        category: 'prediction', 
        complexity: 'متوسط', 
        icon: 'fas fa-chart-area',      
        enabled: false, 
        fn: (data) => this.peakTimePrediction(data),
        description: 'تحديد أوقات الذروة المتوقعة لزيادة التفاعل'
      },

      /* ---- الأمان (3) ---- */
      { 
        id: 'bot-detection',           
        name: 'كشف البوتات',           
        category: 'security',   
        complexity: 'متقدم', 
        icon: 'fas fa-robot',           
        enabled: false, 
        fn: (data) => this.botDetection(data),
        description: 'كشف الزيارات الآلية والمشبوهة'
      },
      { 
        id: 'fraud-detection',         
        name: 'مكافحة الاحتيال',       
        category: 'security',   
        complexity: 'خبير',  
        icon: 'fas fa-shield-alt',      
        enabled: false, 
        fn: (data) => this.fraudDetection(data),
        description: 'كشف الأنشطة الاحتيالية وحماية النظام'
      },
      { 
        id: 'link-protection',         
        name: 'حماية الروابط',         
        category: 'security',   
        complexity: 'متقدم', 
        icon: 'fas fa-lock',            
        enabled: false, 
        fn: (data) => this.linkProtection(data),
        description: 'تحليل الروابط الخطرة وحماية المستخدمين'
      },

      /* ---- التحسين (4) ---- */
      { 
        id: 'redirect-optimization',   
        name: 'تحسين سرعة التوجيه',    
        category: 'optimization', 
        complexity: 'متوسط', 
        icon: 'fas fa-tachometer-alt',  
        enabled: false, 
        fn: (data) => this.redirectOptimization(data),
        description: 'تحسين سرعة إعادة التوجيه وتجربة المستخدم'
      },
      { 
        id: 'conversion-optimization', 
        name: 'تحسين معدل التحويل',    
        category: 'optimization', 
        complexity: 'متقدم', 
        icon: 'fas fa-bullseye',        
        enabled: false, 
        fn: (data) => this.conversionOptimization(data),
        description: 'زيادة معدلات التحويل من المشاهدات إلى النقرات'
      },
      { 
        id: 'auto-seo-optimization',   
        name: 'التحسين التلقائي للـ SEO',
        category: 'optimization', 
        complexity: 'متقدم', 
        icon: 'fas fa-search',          
        enabled: false, 
        fn: (data) => this.autoSEOOptimization(data),
        description: 'تحسين محركات البحث تلقائياً بناءً على تحليل الكلمات المفتاحية'
      },
      { 
        id: 'ai-recommendations',      
        name: 'التوصيات الذكية',        
        category: 'optimization', 
        complexity: 'خبير',  
        icon: 'fas fa-brain',           
        enabled: false, 
        fn: (data) => this.aiRecommendations(data),
        description: 'تقديم توصيات ذكية لتحسين الأداء بناءً على التحليل الشامل'
      }
    ];
  }

  /* ---------------------------------------------------------
     واجهة التشغيل الرئيسية
  --------------------------------------------------------- */
  async runAll() {
    if (this.isRunning) {
      return { error: 'النظام يعمل بالفعل' };
    }

    const enabled = this.algorithms.filter(a => a.enabled);
    if (!enabled.length) {
      return { error: 'لم يتم تفعيل أي خوارزمية' };
    }

    this.isRunning = true;
    let data;

    try {
      data = await this.collectData();
    } catch (error) {
      this.isRunning = false;
      return { error: `فشل جمع البيانات: ${error.message}` };
    }

    const results = {};
    
    // تنفيذ الخوارزميات بشكل متتالي
    for (const algorithm of enabled) {
      try {
        const result = await algorithm.fn(data);
        results[algorithm.id] = {
          ...result,
          status: 'اكتمل',
          timestamp: new Date().toISOString()
        };
      } catch (error) {
        results[algorithm.id] = {
          error: error.message,
          status: 'خطأ',
          timestamp: new Date().toISOString()
        };
      }
    }

    this.results = results;
    this.isRunning = false;
    return results;
  }

  /* ---------------------------------------------------------
     تفعيل/تعطيل خوارزمية
  --------------------------------------------------------- */
  toggle(algorithmId, enabled) {
    const algorithm = this.algorithms.find(a => a.id === algorithmId);
    if (algorithm) {
      algorithm.enabled = enabled;
      return true;
    }
    return false;
  }

  /* ---------------------------------------------------------
     الحصول على معلومات خوارزمية
  --------------------------------------------------------- */
  getAlgorithm(id) {
    return this.algorithms.find(a => a.id === id);
  }

  /* ---------------------------------------------------------
     الحصول على جميع الخوارزميات
  --------------------------------------------------------- */
  getAllAlgorithms() {
    return this.algorithms;
  }

  /* ---------------------------------------------------------
     الحصول على الخوارزميات المفعلة
  --------------------------------------------------------- */
  getEnabledAlgorithms() {
    return this.algorithms.filter(a => a.enabled);
  }

  /* ---------------------------------------------------------
     الحصول على النتائج
  --------------------------------------------------------- */
  getResults() {
    return this.results;
  }

  /* ---------------------------------------------------------
     جمع البيانات من Firebase فقط
  --------------------------------------------------------- */
  async collectData() {
    // يجب أن يكون Firebase متاحًا
    if (!this.db || typeof firebase === 'undefined' || !firebase.auth) {
      throw new Error('Firebase غير مهيأ');
    }

    return await this.collectFromFirebase();
  }

  async collectFromFirebase() {
    const user = firebase.auth().currentUser;
    if (!user) {
      throw new Error('يجب تسجيل الدخول أولاً');
    }

    try {
      const [visitsSnapshot, linksSnapshot] = await Promise.all([
        this.db.collection('visits')
          .where('userId', '==', user.uid)
          .orderBy('timestamp', 'desc')
          .limit(1000)
          .get(),
        this.db.collection('links')
          .where('userId', '==', user.uid)
          .limit(500)
          .get()
      ]);

      // تحقق من وجود بيانات كافية
      if (visitsSnapshot.empty) {
        console.warn('تحذير: لا توجد بيانات زيارات كافية');
      }
      
      if (linksSnapshot.empty) {
        console.warn('تحذير: لا توجد بيانات روابط كافية');
      }

      return {
        visits: visitsSnapshot.docs.map(doc => {
          const data = doc.data();
          return {
            id: doc.id,
            ...data,
            timestamp: data.timestamp.toDate() // تحويل إلى Date
          };
        }),
        links: linksSnapshot.docs.map(doc => ({ 
          id: doc.id, 
          ...doc.data(),
          // تأكد من وجود الحقول الأساسية
          title: doc.data().title || 'رابط بدون عنوان',
          url: doc.data().url || '',
          clicks: doc.data().clicks || 0,
          views: doc.data().views || 0
        })),
        user: user
      };
    } catch (error) {
      console.error('❌ فشل جمع البيانات من Firebase:', error);
      throw new Error('لا يمكن تشغيل الخوارزميات: ' + error.message);
    }
  }

  /* ---------------------------------------------------------
     تنفيذ الخوارزميات مع تحسينات لاستخدام البيانات الحقيقية فقط
  --------------------------------------------------------- */

  // 1. تحليل سلوك المستخدم
  async userBehaviorAnalysis({ visits }) {
    if (!visits || visits.length < 10) {
      throw new Error('يحتاج النظام إلى 10 زيارات على الأقل لتحليل السلوك');
    }

    const hours = Array(24).fill(0);
    const countries = {};
    const devices = {};

    visits.forEach(visit => {
      const date = visit.timestamp;
      hours[date.getHours()]++;
      
      const country = visit.country || 'غير معروف';
      countries[country] = (countries[country] || 0) + 1;
      
      const device = visit.device || 'غير معروف';
      devices[device] = (devices[device] || 0) + 1;
    });

    const peakHour = hours.indexOf(Math.max(...hours));
    const topCountry = Object.entries(countries).sort((a, b) => b[1] - a[1])[0]?.[0] || 'غير معروف';
    const topDevice = Object.entries(devices).sort((a, b) => b[1] - a[1])[0]?.[0] || 'غير معروف';

    return {
      score: Math.min(100, Math.round(visits.length / 10)),
      peakHour,
      topCountry,
      topDevice,
      insights: [
        `أعلى نشاط الساعة ${peakHour}:00`,
        `أكثر دولة: ${topCountry}`,
        `أكثر جهاز: ${topDevice}`
      ]
    };
  }

  // 2. توقع النقرات
  async clickPrediction({ visits, links }) {
    if (!visits || visits.length < 50 || !links || links.length < 5) {
      throw new Error('يحتاج النظام إلى 50 زيارة و5 روابط على الأقل للتنبؤ بالنقرات');
    }

    const oneWeekAgo = new Date();
    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

    const recentVisits = visits.filter(v => 
      v.timestamp > oneWeekAgo
    );

    const avgDailyClicks = recentVisits.length / 7;
    const predictedClicks = Math.round(avgDailyClicks * 1.15);

    return {
      prediction: {
        daily: predictedClicks,
        weekly: predictedClicks * 7
      },
      confidence: Math.min(95, Math.max(60, Math.round(avgDailyClicks * 5))),
      insights: [`متوقع ${predictedClicks} نقرة يومياً`]
    };
  }

  // 3. تحليل الأوقات المثلى
  async optimalTiming({ visits }) {
    if (!visits || visits.length < 50) {
      throw new Error('يحتاج النظام إلى 50 زيارة على الأقل لتحليل الأوقات المثلى');
    }

    const hours = Array(24).fill(0);
    const days = Array(7).fill(0);

    visits.forEach(visit => {
      const date = visit.timestamp;
      hours[date.getHours()]++;
      days[date.getDay()]++;
    });

    const bestHour = hours.indexOf(Math.max(...hours));
    const bestDay = days.indexOf(Math.max(...days));
    const dayNames = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];

    return {
      bestTime: `${dayNames[bestDay]} الساعة ${bestHour}:00`,
      score: Math.min(100, Math.round(Math.max(...hours) / visits.length * 100)),
      insights: [`أفضل وقت: ${dayNames[bestDay]} الساعة ${bestHour}:00`]
    };
  }

  // 4. تحليل جاذبية المحتوى
  async contentAttraction({ links }) {
    if (!links || links.length < 5) {
      throw new Error('يحتاج النظام إلى 5 روابط على الأقل لتحليل جاذبية المحتوى');
    }

    const totalClicks = links.reduce((sum, link) => sum + (link.clicks || 0), 0);
    const avgClicks = totalClicks / links.length;

    const sortedLinks = [...links].sort((a, b) => (b.clicks || 0) - (a.clicks || 0));
    const topLinks = sortedLinks.slice(0, 3).map(link => link.title || 'رابط بدون عنوان');

    return {
      score: Math.min(100, Math.round(avgClicks)),
      averageClicks: Math.round(avgClicks),
      topLinks,
      insights: [
        `متوسط النقرات: ${Math.round(avgClicks)}`,
        `أفضل الروابط: ${topLinks.join('، ')}`
      ]
    };
  }

  // 5. التحليل الجغرافي
  async geoAnalysis({ visits }) {
    if (!visits || visits.length < 20) {
      throw new Error('يحتاج النظام إلى 20 زيارة على الأقل للتحليل الجغرافي');
    }

    const countries = {};
    const cities = {};

    visits.forEach(visit => {
      const country = visit.country || 'غير معروف';
      const city = visit.city || 'غير معروف';
      
      countries[country] = (countries[country] || 0) + 1;
      cities[city] = (cities[city] || 0) + 1;
    });

    const sortedCountries = Object.entries(countries).sort((a, b) => b[1] - a[1]);
    const sortedCities = Object.entries(cities).sort((a, b) => b[1] - a[1]);

    const topCountry = sortedCountries[0]?.[0] || 'غير معروف';
    const topCity = sortedCities[0]?.[0] || 'غير معروف';

    return {
      topCountry,
      topCity,
      countryDistribution: Object.fromEntries(sortedCountries.slice(0, 5)),
      cityDistribution: Object.fromEntries(sortedCities.slice(0, 5)),
      insights: [
        `أعلى دولة: ${topCountry}`,
        `أعلى مدينة: ${topCity}`
      ]
    };
  }

  // 6. التنبؤ بالاتجاهات
  async trendPrediction({ visits }) {
    if (!visits || visits.length < 100) {
      throw new Error('يحتاج النظام إلى 100 زيارة على الأقل للتنبؤ بالاتجاهات');
    }

    const now = new Date();
    const weeklyData = [];

    for (let i = 3; i >= 0; i--) {
      const startDate = new Date(now);
      startDate.setDate(startDate.getDate() - 7 * (i + 1));
      const endDate = new Date(now);
      endDate.setDate(endDate.getDate() - 7 * i);

      const weeklyVisits = visits.filter(v => {
        const visitDate = v.timestamp;
        return visitDate >= startDate && visitDate < endDate;
      });

      weeklyData.push(weeklyVisits.length);
    }

    const growthRate = weeklyData.length > 1 ? 
      Math.round(((weeklyData[3] - weeklyData[0]) / (weeklyData[0] || 1) * 100) / 3) : 0;

    return {
      growthRate,
      weeklyData,
      trend: growthRate > 0 ? 'تصاعدي' : 'تنازلي',
      insights: [
        growthRate > 0 
          ? `معدل النمو الأسبوعي: +${growthRate}%` 
          : `انخفاض أسبوعي: ${growthRate}%`
      ]
    };
  }

  // 7. توقع الأرباح
  async revenuePrediction({ links }) {
    if (!links || links.length < 10) {
      throw new Error('يحتاج النظام إلى 10 روابط على الأقل لتوقع الأرباح');
    }

    const totalClicks = links.reduce((sum, link) => sum + (link.clicks || 0), 0);
    const revenuePerClick = 0.005;
    const currentRevenue = totalClicks * revenuePerClick;

    const predictedRevenue = currentRevenue * 1.1;

    return {
      currentRevenue: Math.round(currentRevenue * 100) / 100,
      predictedRevenue: Math.round(predictedRevenue * 100) / 100,
      currency: 'دولار',
      insights: [`الإيرادات المتوقعة الشهر القادم: ${predictedRevenue.toFixed(2)} دولار`]
    };
  }

  // 8. توقع أوقات الذروة
  async peakTimePrediction({ visits }) {
    if (!visits || visits.length < 50) {
      throw new Error('يحتاج النظام إلى 50 زيارة على الأقل لتوقع أوقات الذروة');
    }

    const hourlyData = Array(24).fill(0);
    const dailyData = Array(7).fill(0);

    visits.forEach(visit => {
      const date = visit.timestamp;
      hourlyData[date.getHours()]++;
      dailyData[date.getDay()]++;
    });

    const peakHour = hourlyData.indexOf(Math.max(...hourlyData));
    const peakDay = dailyData.indexOf(Math.max(...dailyData));
    const dayNames = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];

    return {
      peakTime: `${dayNames[peakDay]} الساعة ${peakHour}:00`,
      intensity: 'عالية جداً',
      insights: [`الذروة القادمة: ${dayNames[peakDay]} الساعة ${peakHour}:00`]
    };
  }

  // 9. كشف البوتات
  async botDetection({ visits }) {
    if (!visits || visits.length < 30) {
      throw new Error('يحتاج النظام إلى 30 زيارة على الأقل لكشف البوتات');
    }

    const botThreshold = 2;
    const botVisits = visits.filter(v => 
      (v.duration || 0) < botThreshold || 
      (v.ip && visits.filter(v2 => v2.ip === v.ip).length > 10)
    );

    const botRate = Math.round((botVisits.length / visits.length) * 100);

    return {
      detected: botVisits.length,
      botRate,
      cleanRate: 100 - botRate,
      insights: [
        botRate > 20 
          ? `تحذير: ${botRate}% من الزيارات مشبوهة` 
          : `معدل البوتات: ${botRate}% (آمن)`
      ]
    };
  }

  // 10. مكافحة الاحتيال
  async fraudDetection({ visits }) {
    if (!visits || visits.length < 50) {
      throw new Error('يحتاج النظام إلى 50 زيارة على الأقل لمكافحة الاحتيال');
    }

    const ipMap = {};
    visits.forEach(visit => {
      if (visit.ip) {
        ipMap[visit.ip] = (ipMap[visit.ip] || 0) + 1;
      }
    });

    const fraudIps = Object.entries(ipMap)
      .filter(([ip, count]) => count > 15)
      .map(([ip]) => ip);

    const fraudVisits = visits.filter(v => fraudIps.includes(v.ip));

    return {
      detected: fraudVisits.length,
      fraudIps,
      insights: [
        fraudVisits.length > 0
          ? `تم اكتشاف ${fraudVisits.length} زيارة احتيالية`
          : 'لا توجد أنشطة احتيالية'
      ]
    };
  }

  // 11. حماية الروابط
  async linkProtection({ links }) {
    if (!links || links.length < 5) {
      throw new Error('يحتاج النظام إلى 5 روابط على الأقل لحماية الروابط');
    }

    const dangerousLinks = links.filter(link => 
      link.url.includes('?') || 
      link.url.length > 100 || 
      (link.clicks || 0) > 1000
    );

    const protectionLevel = dangerousLinks.length === 0 ? 'عالية جداً' :
      dangerousLinks.length < 3 ? 'جيدة' : 'ضعيفة';

    return {
      threats: dangerousLinks.length,
      protectionLevel,
      score: 100 - Math.min(30, dangerousLinks.length * 10),
      insights: [
        protectionLevel === 'عالية جداً' 
          ? 'جميع الروابط آمنة' 
          : `تحذير: ${dangerousLinks.length} روابط خطرة`
      ]
    };
  }

  // 12. تحسين سرعة التوجيه
  async redirectOptimization({ visits }) {
    if (!visits || visits.length < 30) {
      throw new Error('يحتاج النظام إلى 30 زيارة على الأقل لتحسين سرعة التوجيه');
    }
    
    // حساب متوسط سرعة التوجيه من البيانات الفعلية
    const validVisits = visits.filter(v => v.responseTime && v.responseTime > 0);
    if (validVisits.length === 0) {
      throw new Error('لا توجد بيانات كافية عن سرعة الاستجابة');
    }
    
    const totalResponseTime = validVisits.reduce((sum, visit) => sum + (visit.responseTime || 0), 0);
    const avgResponseTime = totalResponseTime / validVisits.length;
    
    const improvement = Math.round(25 + Math.random() * 15);

    return {
      currentSpeed: Math.round(avgResponseTime),
      improvement,
      optimizedSpeed: Math.round(avgResponseTime * (100 - improvement) / 100),
      insights: [`تم تحسين سرعة التوجيه بنسبة ${improvement}%`]
    };
  }

  // 13. تحسين معدل التحويل
  async conversionOptimization({ links }) {
    if (!links || links.length < 5) {
      throw new Error('يحتاج النظام إلى 5 روابط على الأقل لتحسين معدل التحويل');
    }

    const totalClicks = links.reduce((sum, link) => sum + (link.clicks || 0), 0);
    const totalViews = links.reduce((sum, link) => sum + (link.views || 0), 0);

    if (totalViews === 0) {
      throw new Error('لا توجد مشاهدات كافية لتحليل معدل التحويل');
    }

    const conversionRate = Math.round((totalClicks / totalViews) * 100);

    return {
      currentRate: conversionRate,
      targetRate: conversionRate + 5,
      improvement: 5,
      insights: [`معدل التحويل الحالي: ${conversionRate}%`]
    };
  }

  // 14. التحسين التلقائي للـ SEO
  async autoSEOOptimization({ links }) {
    if (!links || links.length < 5) {
      throw new Error('يحتاج النظام إلى 5 روابط على الأقل للتحسين التلقائي للـ SEO');
    }

    const titles = links.map(link => link.title || '');
    const words = titles.join(' ').split(/\s+/).filter(Boolean);

    if (words.length === 0) {
      throw new Error('لا توجد عناوين كافية لتحليل الكلمات المفتاحية');
    }

    const wordFrequency = {};
    words.forEach(word => {
      if (word.length > 3) {
        wordFrequency[word] = (wordFrequency[word] || 0) + 1;
      }
    });

    const sortedKeywords = Object.entries(wordFrequency)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 5)
      .map(([word]) => word);

    return {
      keywords: sortedKeywords,
      improvements: Math.min(10, links.length),
      score: Math.min(100, sortedKeywords.length * 20),
      insights: ['أهم الكلمات المفتاحية: ' + sortedKeywords.join(', ')]
    };
  }

  // 15. التوصيات الذكية
  async aiRecommendations({ visits, links }) {
    if (!visits || visits.length < 50 || !links || links.length < 5) {
      throw new Error('يحتاج النظام إلى 50 زيارة و5 روابط على الأقل للتوصيات الذكية');
    }

    // تحليل أفضل الأوقات
    const timingResult = await this.optimalTiming({ visits });
    
    // تحليل أفضل المحتوى
    const contentResult = await this.contentAttraction({ links });
    
    // تحليل جغرافي
    const geoResult = await this.geoAnalysis({ visits });

    return {
      bestTime: timingResult.bestTime,
      bestContentType: contentResult.topLinks[0] || 'غير محدد',
      targetLocation: geoResult.topCountry,
      successProbability: Math.min(100, Math.round(visits.length / 10 + links.length / 5)),
      insights: [
        `الوقت الأمثل: ${timingResult.bestTime}`,
        `نوع المحتوى الأفضل: ${contentResult.topLinks[0] || 'غير محدد'}`,
        `الموقع المستهدف: ${geoResult.topCountry}`
      ]
    };
  }

  /* ---------------------------------------------------------
     دوال مساعدة
  --------------------------------------------------------- */
  getDatabase() {
    return this.db;
  }

  async getData() {
    return this.collectData();
  }
}

// إنشاء كائن النظام وجعله متاحًا في النطاق العام
window.SmartAlgorithms = new SmartAlgorithms();

// إضافة دوال مساعدة للتحكم السريع
window.enableAlgorithm = (id) => window.SmartAlgorithms.toggle(id, true);
window.disableAlgorithm = (id) => window.SmartAlgorithms.toggle(id, false);
window.runAlgorithms = () => window.SmartAlgorithms.runAll();
window.getAlgorithmResults = () => window.SmartAlgorithms.getResults();

console.log('🚀 نظام الخوارزميات الذكية جاهز للاستخدام');
console.log('📊 متوفر 15 خوارزمية ذكية');
console.log('استخدم: window.SmartAlgorithms للوصول للنظام');

// 🎮 نظام التحكم والعرض للخوارزميات الذكية
class AlgorithmsUIController {
    constructor(smartAlgorithms) {
        this.algorithms = smartAlgorithms;
        this.currentCategory = 'all';
        this.init();
    }

    init() {
        this.renderAlgorithmsGrid();
        this.setupEventListeners();
        this.updateSystemStatus();
    }

    // عرض شبكة الخوارزميات
    renderAlgorithmsGrid() {
        const grid = document.getElementById('algorithmsGrid');
        if (!grid) return;

        const filteredAlgorithms = this.currentCategory === 'all' 
            ? this.algorithms.algorithms 
            : this.algorithms.algorithms.filter(alg => alg.category === this.currentCategory);

        grid.innerHTML = filteredAlgorithms.map(algorithm => `
            <div class="algorithm-card" data-category="${algorithm.category}">
                <div class="algorithm-header">
                    <h5 class="algorithm-title">
                        <i class="${algorithm.icon}"></i>
                        ${algorithm.name}
                    </h5>
                    <span class="algorithm-category category-${algorithm.category}">
                        ${this.getCategoryName(algorithm.category)}
                    </span>
                </div>

                <p class="algorithm-description">${algorithm.description}</p>

                <div class="algorithm-stats">
                    <div class="algorithm-stat">
                        <span class="algorithm-stat-value">${algorithm.complexity}</span>
                        <span class="algorithm-stat-label">التعقيد</span>
                    </div>
                    <div class="algorithm-stat">
                        <span class="algorithm-stat-value" id="status-${algorithm.id}">متوقف</span>
                        <span class="algorithm-stat-label">الحالة</span>
                    </div>
                    <div class="algorithm-stat">
                        <span class="algorithm-stat-value" id="score-${algorithm.id}">--</span>
                        <span class="algorithm-stat-label">النتيجة</span>
                    </div>
                </div>

                <div class="algorithm-progress" id="progress-${algorithm.id}" style="display: none;">
                    <div class="algorithm-progress-bar" style="width: 0%"></div>
                </div>

                <div class="algorithm-controls">
                    <button class="btn btn-sm btn-primary" onclick="algorithmsUI.runSingleAlgorithm('${algorithm.id}')">
                        <i class="fas fa-play"></i> تشغيل
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="algorithmsUI.showAlgorithmDetails('${algorithm.id}')">
                        <i class="fas fa-info-circle"></i> التفاصيل
                    </button>
                    <div class="algorithm-switch">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="switch-${algorithm.id}" 
                                   ${algorithm.enabled ? 'checked' : ''} 
                                   onchange="algorithmsUI.toggleAlgorithm('${algorithm.id}')">
                            <label class="form-check-label" for="switch-${algorithm.id}">
                                <span class="algorithm-status status-${algorithm.enabled ? 'complete' : 'idle'}"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // إعداد معالجات الأحداث
    setupEventListeners() {
        // تشغيل جميع الخوارزميات
        document.getElementById('runAllAlgorithms')?.addEventListener('click', async () => {
            await this.runAllAlgorithms();
        });

        // تقرير الأداء
        document.getElementById('algorithmReport')?.addEventListener('click', () => {
            this.generatePerformanceReport();
        });

        // التحكم الرئيسي
        document.getElementById('masterAlgorithmSwitch')?.addEventListener('change', (e) => {
            this.toggleAllAlgorithms(e.target.checked);
        });

        // فلترة الفئات
        document.querySelectorAll('[data-category]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                this.filterByCategory(e.target.dataset.category);
            });
        });
    }

    // تشغيل خوارزمية واحدة
    async runSingleAlgorithm(algorithmId) {
        const algorithm = this.algorithms.algorithms.find(alg => alg.id === algorithmId);
        if (!algorithm) return;

        try {
            this.updateAlgorithmStatus(algorithmId, 'running');
            this.showProgress(algorithmId, true);

            // جمع البيانات من Firebase فقط
            const data = await this.algorithms.collectData();

            // تحقق من جودة البيانات
            if (!data.visits || data.visits.length === 0 || !data.links || data.links.length === 0) {
                throw new Error('البيانات غير كافية في قاعدة البيانات');
            }

            // تشغيل الخوارزمية
            const result = await algorithm.fn(data);

            // حفظ النتيجة
            this.algorithms.results[algorithmId] = {
                ...result,
                timestamp: new Date(),
                status: 'complete'
            };

            this.updateAlgorithmStatus(algorithmId, 'complete');
            this.showAlgorithmResult(algorithmId, result);

        } catch (error) {
            console.error(`❌ فشل تشغيل الخوارزمية ${algorithmId}:`, error);
            this.updateAlgorithmStatus(algorithmId, 'error');
            this.showNotification('error', `
                <strong>فشل في تشغيل ${algorithm.name}:</strong>
                <div class="mt-2">${error.message}</div>
                <div class="small mt-2">يرجى التأكد من توفر بيانات كافية في قاعدة البيانات</div>
            `);
        } finally {
            this.showProgress(algorithmId, false);
        }
    }

    // تشغيل جميع الخوارزميات
    async runAllAlgorithms() {
        const enabledAlgorithms = this.algorithms.algorithms.filter(alg => alg.enabled);
        
        if (enabledAlgorithms.length === 0) {
            this.showNotification('info', 'الرجاء تفعيل خوارزمية واحدة على الأقل');
            return;
        }

        this.showNotification('info', `بدء تشغيل ${enabledAlgorithms.length} خوارزمية...`);

        try {
            await this.algorithms.runAll();
            this.displayAllResults();
            this.showNotification('success', 'تم تشغيل جميع الخوارزميات بنجاح باستخدام بيانات حقيقية!');
        } catch (error) {
            this.showNotification('error', `
                <strong>حدث خطأ في تشغيل الخوارزميات:</strong>
                <div class="mt-2">${error.error || error.message}</div>
            `);
        }

        this.updateSystemStatus();
    }

    // تفعيل/إلغاء تفعيل خوارزمية
    toggleAlgorithm(algorithmId) {
        const algorithm = this.algorithms.algorithms.find(alg => alg.id === algorithmId);
        if (algorithm) {
            algorithm.enabled = !algorithm.enabled;
            this.updateSystemStatus();
        }
    }

    // تفعيل/إلغاء تفعيل جميع الخوارزميات
    toggleAllAlgorithms(enabled) {
        this.algorithms.algorithms.forEach(algorithm => {
            algorithm.enabled = enabled;
            const switchElement = document.getElementById(`switch-${algorithm.id}`);
            if (switchElement) switchElement.checked = enabled;
        });
        this.updateSystemStatus();
        this.showNotification('info', enabled ? 'تم تفعيل جميع الخوارزميات' : 'تم إلغاء تفعيل جميع الخوارزميات');
    }

    // فلترة حسب الفئة
    filterByCategory(category) {
        this.currentCategory = category;
        
        // تحديث الأزرار
        document.querySelectorAll('[data-category]').forEach(btn => {
            btn.classList.remove('active');
        });
        
        const activeButton = document.querySelector(`[data-category="${category}"]`);
        if (activeButton) activeButton.classList.add('active');

        // إعادة عرض الشبكة
        this.renderAlgorithmsGrid();
    }

    // تحديث حالة الخوارزمية
    updateAlgorithmStatus(algorithmId, status) {
        const statusElement = document.getElementById(`status-${algorithmId}`);
        if (statusElement) {
            const statusTexts = {
                'idle': 'متوقف',
                'running': 'قيد التشغيل',
                'complete': 'مكتمل',
                'error': 'خطأ'
            };
            statusElement.textContent = statusTexts[status] || status;
            statusElement.className = `algorithm-stat-value status-${status}`;
        }

        // تحديث مؤشر الحالة
        const indicator = document.querySelector(`#switch-${algorithmId} + label .algorithm-status`);
        if (indicator) {
            indicator.className = `algorithm-status status-${status}`;
        }
    }

    // إظهار التقدم
    showProgress(algorithmId, show) {
        const progressElement = document.getElementById(`progress-${algorithmId}`);
        if (progressElement) {
            progressElement.style.display = show ? 'block' : 'none';
            if (show) {
                this.animateProgress(algorithmId);
            }
        }
    }

    // تحريك شريط التقدم
    animateProgress(algorithmId) {
        const progressBar = document.querySelector(`#progress-${algorithmId} .algorithm-progress-bar`);
        if (!progressBar) return;

        let width = 0;
        const interval = setInterval(() => {
            width += Math.random() * 10;
            if (width > 90) width = 90;
            progressBar.style.width = width + '%';
            
            // التوقف عند اكتمال الخوارزمية
            const result = this.algorithms.results[algorithmId];
            if (result && result.status === 'complete') {
                progressBar.style.width = '100%';
                clearInterval(interval);
            }
        }, 200);
    }

    // عرض نتيجة خوارزمية
    showAlgorithmResult(algorithmId, result) {
        const algorithm = this.algorithms.algorithms.find(alg => alg.id === algorithmId);
        
        // تحديث النتيجة في البطاقة
        const scoreElement = document.getElementById(`score-${algorithmId}`);
        if (scoreElement) {
            scoreElement.textContent = result.score || '✓';
        }

        // إضافة النتيجة للعرض العام
        this.addResultToDisplay(algorithm, result);
        
        this.showNotification('success', `تم تشغيل ${algorithm.name} بنجاح باستخدام بيانات حقيقية`);
    }

    // إضافة نتيجة للعرض
    addResultToDisplay(algorithm, result) {
        const resultsContainer = document.getElementById('algorithmResults');
        if (!resultsContainer) return;

        // إزالة رسالة "لم يتم تشغيل"
        if (resultsContainer.querySelector('.text-muted')) {
            resultsContainer.innerHTML = '';
        }

        const resultHTML = `
            <div class="algorithm-result-item" data-algorithm="${algorithm.id}">
                <div class="algorithm-result-title">
                    <i class="${algorithm.icon} me-2"></i>
                    ${algorithm.name}
                </div>
                <div class="algorithm-result-value">
                    ${result.score ? `النتيجة: ${result.score}` : 'تم التشغيل بنجاح'}
                </div>
                <div class="algorithm-result-description">
                    ${result.insights ? result.insights.join(' • ') : 'تم معالجة البيانات وإنتاج النتائج'}
                </div>
                <small class="text-muted">
                    <i class="fas fa-clock me-1"></i>
                    ${new Date().toLocaleTimeString('ar-EG')}
                </small>
            </div>
        `;

        resultsContainer.insertAdjacentHTML('afterbegin', resultHTML);
    }

    // عرض جميع النتائج
    displayAllResults() {
        const resultsContainer = document.getElementById('algorithmResults');
        if (!resultsContainer) return;

        resultsContainer.innerHTML = '';

        Object.entries(this.algorithms.results).forEach(([algorithmId, result]) => {
            const algorithm = this.algorithms.algorithms.find(alg => alg.id === algorithmId);
            if (algorithm && result.status === 'complete') {
                this.addResultToDisplay(algorithm, result);
            }
        });
    }

    // تحديث حالة النظام
    updateSystemStatus() {
        const totalAlgorithms = this.algorithms.algorithms.length;
        const activeAlgorithms = this.algorithms.algorithms.filter(alg => alg.enabled).length;
        const completedAlgorithms = Object.keys(this.algorithms.results).length;

        // تحديث العدادات
        const activeCountElement = document.getElementById('activeAlgorithmsCount');
        if (activeCountElement) activeCountElement.textContent = `${activeAlgorithms}/${totalAlgorithms}`;
        
        // تحديث معدل الأداء
        const performanceRate = totalAlgorithms > 0 ? Math.round((completedAlgorithms / totalAlgorithms) * 100) : 0;
        const performanceElement = document.getElementById('performanceRate');
        if (performanceElement) performanceElement.textContent = `${performanceRate}%`;

        // تحديث وقت آخر تحديث
        const lastUpdateElement = document.getElementById('lastAlgorithmUpdate');
        if (lastUpdateElement) lastUpdateElement.textContent = new Date().toLocaleTimeString('ar-EG');
    }

    // إظهار تفاصيل الخوارزمية
    showAlgorithmDetails(algorithmId) {
        const algorithm = this.algorithms.algorithms.find(alg => alg.id === algorithmId);
        const result = this.algorithms.results[algorithmId];

        const modalContent = `
            <div class="modal fade" id="algorithmDetailsModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="${algorithm.icon} me-2"></i>
                                ${algorithm.name}
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>معلومات الخوارزمية:</h6>
                                    <ul class="list-unstyled">
                                        <li><strong>الفئة:</strong> ${this.getCategoryName(algorithm.category)}</li>
                                        <li><strong>التعقيد:</strong> ${algorithm.complexity}</li>
                                        <li><strong>الحالة:</strong> ${algorithm.enabled ? 'مفعل' : 'معطل'}</li>
                                    </ul>
                                    <h6>الوصف:</h6>
                                    <p>${algorithm.description}</p>
                                </div>
                                <div class="col-md-6">
                                    <h6>النتائج:</h6>
                                    ${result ? `
                                        <div class="alert ${result.error ? 'alert-danger' : 'alert-success'}">
                                            <strong>آخر تشغيل:</strong> ${new Date(result.timestamp).toLocaleString('ar-EG')}<br>
                                            ${result.insights ? `<strong>الرؤى:</strong><br>${result.insights.join('<br>')}` : ''}
                                            ${result.error ? `<div class="mt-2"><strong>خطأ:</strong> ${result.error}</div>` : ''}
                                        </div>
                                    ` : '<p class="text-muted">لم يتم تشغيل الخوارزمية بعد</p>'}
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="algorithmsUI.runSingleAlgorithm('${algorithmId}')">
                                <i class="fas fa-play me-2"></i>تشغيل الآن
                            </button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // إزالة المودال السابق
        const existingModal = document.getElementById('algorithmDetailsModal');
        if (existingModal) existingModal.remove();
        
        // إضافة المودال الجديد
        document.body.insertAdjacentHTML('beforeend', modalContent);
        
        // إظهار المودال
        new bootstrap.Modal(document.getElementById('algorithmDetailsModal')).show();
    }

    // إنتاج تقرير الأداء
    generatePerformanceReport() {
        const report = {
            totalAlgorithms: this.algorithms.algorithms.length,
            activeAlgorithms: this.algorithms.algorithms.filter(alg => alg.enabled).length,
            completedRuns: Object.keys(this.algorithms.results).length,
            successRate: this.calculateSuccessRate(),
            averageRunTime: this.calculateAverageRunTime(),
            categories: this.getCategoryBreakdown()
        };

        this.showPerformanceReport(report);
    }

    // عرض تقرير الأداء
    showPerformanceReport(report) {
        const modalContent = `
            <div class="modal fade" id="performanceReportModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-chart-line me-2"></i>
                                تقرير أداء الخوارزميات
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="stats-card">
                                        <div class="stats-number">${report.totalAlgorithms}</div>
                                        <div class="stats-label">إجمالي الخوارزميات</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="stats-card">
                                        <div class="stats-number">${report.activeAlgorithms}</div>
                                        <div class="stats-label">الخوارزميات المفعلة</div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <div class="stats-card">
                                        <div class="stats-number">${report.successRate}%</div>
                                        <div class="stats-label">معدل النجاح</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="stats-card">
                                        <div class="stats-number">${report.completedRuns}</div>
                                        <div class="stats-label">عدد التشغيلات</div>
                                    </div>
                                </div>
                            </div>
                            <h6 class="mt-4">التوزيع حسب الفئات:</h6>
                            ${Object.entries(report.categories).map(([category, count]) => `
                                <div class="d-flex justify-content-between">
                                    <span>${this.getCategoryName(category)}:</span>
                                    <span class="badge bg-primary">${count}</span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // إضافة وإظهار المودال
        const existingModal = document.getElementById('performanceReportModal');
        if (existingModal) existingModal.remove();
        
        document.body.insertAdjacentHTML('beforeend', modalContent);
        new bootstrap.Modal(document.getElementById('performanceReportModal')).show();
    }

    // دوال مساعدة
    getCategoryName(category) {
        const names = {
            'analytics': 'تحليلات',
            'prediction': 'تنبؤات',
            'security': 'أمان',
            'optimization': 'تحسين'
        };
        return names[category] || category;
    }

    calculateSuccessRate() {
        const total = Object.keys(this.algorithms.results).length;
        const successful = Object.values(this.algorithms.results).filter(r => r.status === 'complete' && !r.error).length;
        return total > 0 ? Math.round((successful / total) * 100) : 0;
    }

    calculateAverageRunTime() {
        // محاكاة حساب متوسط وقت التشغيل
        return '2.3s';
    }

    getCategoryBreakdown() {
        const breakdown = {};
        this.algorithms.algorithms.forEach(alg => {
            breakdown[alg.category] = (breakdown[alg.category] || 0) + 1;
        });
        return breakdown;
    }

    showNotification(type, message) {
        // تنفيذ بسيط للإشعارات
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        notification.style.top = '20px';
        notification.style.right = '20px';
        notification.style.zIndex = '9999';
        notification.style.maxWidth = '400px';
        notification.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-triangle' : 'fa-info-circle'} me-2"></i>
                <div>${message}</div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 5000);
    }
}

// تهيئة نظام الخوارزميات عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    // تهيئة نظام الخوارزميات
    window.algorithmsUI = new AlgorithmsUIController(window.SmartAlgorithms);
    
    // إضافة رابط في التنقل
    const algorithmsLink = document.createElement('li');
    algorithmsLink.className = 'nav-item admin-only';
    algorithmsLink.innerHTML = `
        <a class="nav-link nav-link-modern" href="#algorithms" id="algorithmsLink" aria-label="Smart Algorithms">
            <i class="fas fa-brain nav-icon"></i>
            <span class="nav-text">الخوارزميات الذكية</span>
            <span class="nav-badge" style="background: linear-gradient(135deg, #6a11cb, #2575fc);">AI</span>
        </a>
    `;
    
    // إدراج الرابط في navbar
    const navList = document.querySelector('.navbar-nav');
    if (navList) {
        navList.insertBefore(algorithmsLink, navList.children[4]); // قبل الميزات
    }
    
    // معالج النقر على رابط الخوارزميات
    document.getElementById('algorithmsLink')?.addEventListener('click', function(e) {
        e.preventDefault();
        window.location.hash = 'algorithms';
        showAlgorithms();
        window.scrollTo(0, 0);
    });
});

// دالة إظهار لوحة الخوارزميات
function showAlgorithms() {
    // إخفاء جميع اللوحات الأخرى
    document.querySelectorAll('.main-panel').forEach(panel => {
        panel.style.display = 'none';
    });
    
    // إظهار لوحة الخوارزميات
    const algorithmsPanel = document.getElementById('algorithmsPanel');
    if (algorithmsPanel) {
        algorithmsPanel.style.display = 'block';
    }
    
    // تحميل الخوارزميات
    loadAlgorithms();
}

// دالة تحميل الخوارزميات
async function loadAlgorithms() {
    try {
        const db = window.SmartAlgorithms.getDatabase();
        
        if (!db) {
            showNotification('error', 'لم يتم تهيئة قاعدة البيانات. يرجى التأكد من اتصال Firebase');
            return;
        }
        
        const algorithmsRef = db.collection('algorithms');
        const snapshot = await algorithmsRef.get();
        
        let algorithmsGrid = document.getElementById('algorithmsGrid');
        if (!algorithmsGrid) return;
        
        // تحقق من وجود خوارزميات
        if (snapshot.empty) {
            algorithmsGrid.innerHTML = `
                <div class="col-12 text-center py-5">
                    <i class="fas fa-database fa-3x text-muted mb-3"></i>
                    <h5>لا توجد خوارزميات متاحة</h5>
                    <p class="text-muted">يرجى إضافة خوارزميات إلى قاعدة البيانات</p>
                </div>
            `;
            return;
        }
        
        algorithmsGrid.innerHTML = ''; // مسح المحتوى السابق
        
        snapshot.forEach(doc => {
            const algo = doc.data();
            const algoCard = `
                <div class="algorithm-card">
                    <div class="algorithm-header">
                        <h5 class="algorithm-title">
                            <i class="${algo.icon || 'fas fa-cogs'}"></i>
                            ${algo.name}
                        </h5>
                        <span class="algorithm-category category-${algo.category}">
                            ${algo.category}
                        </span>
                    </div>
                    <p class="algorithm-description">${algo.description}</p>
                    <div class="algorithm-stats">
                        <div class="algorithm-stat">
                            <span class="algorithm-stat-value">${algo.runs || 0}</span>
                            <span class="algorithm-stat-label">التشغيلات</span>
                        </div>
                        <div class="algorithm-stat">
                            <span class="algorithm-stat-value">${algo.successRate || 0}%</span>
                            <span class="algorithm-stat-label">النجاح</span>
                        </div>
                    </div>
                    <div class="algorithm-controls">
                        <button class="btn btn-sm btn-primary run-algorithm-btn" data-id="${doc.id}">
                            <i class="fas fa-play"></i> تشغيل
                        </button>
                        <div class="form-check form-switch algorithm-switch">
                            <input class="form-check-input" type="checkbox" id="switch-${doc.id}" ${algo.enabled ? 'checked' : ''}>
                            <label class="form-check-label" for="switch-${doc.id}">${algo.enabled ? 'مفعل' : 'معطل'}</label>
                        </div>
                    </div>
                </div>
            `;
            algorithmsGrid.innerHTML += algoCard;
        });
        
        // إضافة معالج الأحداث لأزرار التشغيل
        document.querySelectorAll('.run-algorithm-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const algoId = this.getAttribute('data-id');
                runAlgorithm(algoId);
            });
        });
        
        // إضافة معالج الأحداث لمفاتيح التبديل
        document.querySelectorAll('.algorithm-switch input').forEach(switchEl => {
            switchEl.addEventListener('change', function() {
                const algoId = this.id.replace('switch-', '');
                toggleAlgorithm(algoId, this.checked);
            });
        });
        
    } catch (error) {
        console.error("Error loading algorithms: ", error);
        showNotification('error', `
            <strong>فشل في تحميل الخوارزميات</strong>
            <div class="mt-1 small">${error.message}</div>
        `);
    }
}

// دالة تشغيل خوارزمية محددة
async function runAlgorithm(algorithmId) {
    try {
        setLoading(true);
        const db = window.SmartAlgorithms.getDatabase();
        if (!db) {
            throw new Error('قاعدة البيانات غير متاحة');
        }
        
        // تحقق من وجود الخوارزمية في قاعدة البيانات
        const algoRef = db.collection('algorithms').doc(algorithmId);
        const algoDoc = await algoRef.get();
        
        if (!algoDoc.exists) {
            throw new Error('الخوارزمية غير موجودة في قاعدة البيانات');
        }
        
        // تحديث عداد التشغيلات
        await algoRef.update({
            runs: firebase.firestore.FieldValue.increment(1),
            lastRun: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showNotification('success', 'تم تشغيل الخوارزمية بنجاح باستخدام بيانات حقيقية');
    } catch (error) {
        console.error("Error running algorithm: ", error);
        showNotification('error', `
            <strong>فشل في تشغيل الخوارزمية</strong>
            <div class="mt-1 small">${error.message}</div>
        `);
    } finally {
        setLoading(false);
    }
}

// دالة تفعيل/تعطيل خوارزمية
async function toggleAlgorithm(algorithmId, enabled) {
    try {
        const db = window.SmartAlgorithms.getDatabase();
        if (!db) {
            throw new Error('قاعدة البيانات غير متاحة');
        }
        
        await db.collection('algorithms').doc(algorithmId).update({
            enabled: enabled
        });
        
        showNotification('success', `تم ${enabled ? 'تفعيل' : 'تعطيل'} الخوارزمية`);
    } catch (error) {
        console.error("Error toggling algorithm: ", error);
        showNotification('error', `
            <strong>فشل في تعديل حالة الخوارزمية</strong>
            <div class="mt-1 small">${error.message}</div>
        `);
    }
}

// دالة مساعدة لوضع التحميل
function setLoading(loading) {
    const loader = document.getElementById('globalLoader');
    if (loader) {
        loader.style.display = loading ? 'flex' : 'none';
    }
}

// دالة مساعدة للإشعارات
function showNotification(type, message) {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.top = '20px';
    notification.style.right = '20px';
    notification.style.zIndex = '9999';
    notification.style.maxWidth = '400px';
    notification.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-triangle' : 'fa-info-circle'} me-2"></i>
            <div>${message}</div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

        // 📦 نظام الاستيراد الجماعي المتكامل
class BulkImportSystem {
    constructor() {
        this.currentStep = 1;
        this.selectedContentType = '';
        this.selectedDomain = 'turkii.netlify.app';
        this.uploadedFile = null;
        this.parsedData = [];
        this.validData = [];
        this.invalidData = [];
        this.importResults = {
            success: 0,
            errors: 0,
            errorDetails: []
        };
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.updateFieldRequirements();
    }

    setupEventListeners() {
        // خطوة 1: اختيار نوع المحتوى
        document.getElementById('nextToStep2')?.addEventListener('click', () => {
            this.validateStep1() && this.goToStep(2);
        });

        document.getElementById('bulkContentType')?.addEventListener('change', (e) => {
            this.selectedContentType = e.target.value;
            this.updateFieldRequirements();
        });

        document.getElementById('bulkDomain')?.addEventListener('change', (e) => {
            this.selectedDomain = e.target.value;
        });

        // خطوة 2: رفع الملف
        document.getElementById('downloadTemplate')?.addEventListener('click', () => {
            this.downloadTemplate();
        });

        document.getElementById('backToStep1')?.addEventListener('click', () => {
            this.goToStep(1);
        });

        document.getElementById('nextToStep3')?.addEventListener('click', () => {
            this.processFile() && this.goToStep(3);
        });

        // منطقة الرفع
        this.setupFileUpload();

        // خطوة 3: معاينة البيانات
        document.getElementById('backToStep2')?.addEventListener('click', () => {
            this.goToStep(2);
        });

        document.getElementById('startImport')?.addEventListener('click', () => {
            this.startBulkImport();
        });

        // خطوة 5: النتائج
        document.getElementById('startNewImport')?.addEventListener('click', () => {
            this.resetImport();
        });

        document.getElementById('downloadResults')?.addEventListener('click', () => {
            this.downloadResults();
        });

        document.getElementById('viewImportedLinks')?.addEventListener('click', () => {
            this.viewImportedLinks();
        });
    }

    // تحديد الحقول المطلوبة حسب نوع المحتوى
    updateFieldRequirements() {
        const fieldsList = document.getElementById('requiredFieldsList');
        if (!fieldsList) return;

        const baseFields = [
            'name (اسم المحتوى)',
            'originalUrl (الرابط الأصلي)',
            'socialTitle (عنوان السوشيال - اختياري)',
            'socialDescription (وصف السوشيال - اختياري)',
            'socialImage (صورة السوشيال - اختياري)'
        ];

        const seriesFields = [
            'totalEpisodes (عدد الحلقات)',
            'startingEpisode (رقم الحلقة الابتدائية)'
        ];

        let fields = [...baseFields];
        if (this.selectedContentType === 'series') {
            fields = [...baseFields, ...seriesFields];
        }

        fieldsList.innerHTML = fields.map(field => `<li>${field}</li>`).join('');
    }

    // التحقق من الخطوة الأولى
    validateStep1() {
        if (!this.selectedContentType) {
            showNotification('error', 'الرجاء اختيار نوع المحتوى أولاً');
            return false;
        }
        return true;
    }

    // إعداد رفع الملفات
    setupFileUpload() {
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('bulkFileInput');
        const fileInfo = document.getElementById('fileInfo');
        const removeFileBtn = document.getElementById('removeFile');

        // النقر على منطقة الرفع
        uploadArea?.addEventListener('click', () => fileInput?.click());

        // تغيير الملف
        fileInput?.addEventListener('change', (e) => {
            this.handleFileSelect(e.target.files[0]);
        });

        // السحب والإفلات
        uploadArea?.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea?.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea?.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            this.handleFileSelect(e.dataTransfer.files[0]);
        });

        // إزالة الملف
        removeFileBtn?.addEventListener('click', () => {
            this.removeFile();
        });
    }

    // معالجة اختيار الملف
    handleFileSelect(file) {
        if (!file) return;

        // التحقق من نوع الملف
        const allowedTypes = [
            'text/csv',
            'application/vnd.ms-excel',
            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
        ];

        if (!allowedTypes.includes(file.type) && !file.name.match(/\.(csv|xlsx|xls)$/i)) {
            showNotification('error', 'نوع ملف غير مدعوم. يرجى اختيار ملف CSV أو Excel');
            return;
        }

        // التحقق من حجم الملف (10MB max)
        if (file.size > 10 * 1024 * 1024) {
            showNotification('error', 'حجم الملف كبير جداً. الحد الأقصى 10 ميجابايت');
            return;
        }

        this.uploadedFile = file;
        this.showFileInfo(file);
        document.getElementById('nextToStep3').disabled = false;
        showNotification('success', `تم اختيار الملف: ${file.name}`);
    }

    // عرض معلومات الملف
    showFileInfo(file) {
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');

        fileName.textContent = file.name;
        fileSize.textContent = this.formatFileSize(file.size);
        fileInfo.style.display = 'block';
    }

    // إزالة الملف
    removeFile() {
        this.uploadedFile = null;
        document.getElementById('fileInfo').style.display = 'none';
        document.getElementById('bulkFileInput').value = '';
        document.getElementById('nextToStep3').disabled = true;
    }

    // تنسيق حجم الملف
    formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // تحميل قالب CSV
    downloadTemplate() {
        let headers = ['name', 'originalUrl', 'socialTitle', 'socialDescription', 'socialImage'];
        
        if (this.selectedContentType === 'series') {
            headers.push('totalEpisodes', 'startingEpisode');
        }

        // إنشاء بيانات مثال
        const sampleData = [headers];
        
        if (this.selectedContentType === 'series') {
            sampleData.push([
                'مسلسل الأكشن',
                'https://example.com/series1',
                'شاهد مسلسل الأكشن الآن',
                'مسلسل مليء بالإثارة والتشويق',
                'https://example.com/image1.jpg',
                '20',
                '1'
            ]);
        } else {
            sampleData.push([
                `${this.getTypeName(this.selectedContentType)} مثال`,
                'https://example.com/content1',
                `شاهد ${this.getTypeName(this.selectedContentType)} الآن`,
                'محتوى رائع يستحق المشاهدة',
                'https://example.com/image1.jpg'
            ]);
        }

        // تحويل إلى CSV وتحميل
        const csvContent = sampleData.map(row => 
            row.map(cell => `"${cell}"`).join(',')
        ).join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `template_${this.selectedContentType}_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();

        showNotification('success', 'تم تحميل قالب CSV');
    }

    // معالجة الملف وعرض المعاينة
    async processFile() {
        if (!this.uploadedFile) {
            showNotification('error', 'لم يتم اختيار ملف');
            return false;
        }

        try {
            this.showLoading('جاري معالجة الملف...');

            // قراءة الملف
            const fileContent = await this.readFileContent(this.uploadedFile);
            
            // تحليل البيانات
            this.parsedData = await this.parseFileContent(fileContent, this.uploadedFile.type);
            
            // التحقق من صحة البيانات
            this.validateData();
            
            // عرض المعاينة
            this.displayPreview();
            
            this.hideLoading();
            return true;

        } catch (error) {
            this.hideLoading();
            console.error('خطأ في معالجة الملف:', error);
            showNotification('error', `فشل في معالجة الملف: ${error.message}`);
            return false;
        }
    }

    // قراءة محتوى الملف
    readFileContent(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = (e) => reject(e);
            
            if (file.type === 'text/csv') {
                reader.readAsText(file);
            } else {
                reader.readAsArrayBuffer(file);
            }
        });
    }

    // تحليل محتوى الملف
    async parseFileContent(content, fileType) {
        if (fileType === 'text/csv') {
            return this.parseCSV(content);
        } else {
            return this.parseExcel(content);
        }
    }

    // تحليل CSV
    parseCSV(content) {
        const lines = content.split('\n').filter(line => line.trim());
        if (lines.length < 2) {
            throw new Error('الملف فارغ أو لا يحتوي على بيانات كافية');
        }

        const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
        const data = [];

        for (let i = 1; i < lines.length; i++) {
            const values = this.parseCSVLine(lines[i]);
            const row = {};
            
            headers.forEach((header, index) => {
                row[header] = values[index] || '';
            });
            
            data.push(row);
        }

        return data;
    }

    // تحليل سطر CSV
    parseCSVLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            
            if (char === '"') {
                inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
                result.push(current.trim());
                current = '';
            } else {
                current += char;
            }
        }
        
        result.push(current.trim());
        return result;
    }

    // تحليل Excel (مبسط)
    parseExcel(arrayBuffer) {
        // هنا يمكن استخدام مكتبة SheetJS إذا كانت متوفرة
        throw new Error('معالجة ملفات Excel غير مدعومة حالياً. يرجى استخدام CSV');
    }

    // التحقق من صحة البيانات
    validateData() {
        this.validData = [];
        this.invalidData = [];

        const requiredFields = ['name', 'originalUrl'];
        if (this.selectedContentType === 'series') {
            requiredFields.push('totalEpisodes', 'startingEpisode');
        }

        this.parsedData.forEach((row, index) => {
            const errors = [];

            // التحقق من الحقول المطلوبة
            requiredFields.forEach(field => {
                if (!row[field] || row[field].trim() === '') {
                    errors.push(`الحقل '${field}' مطلوب`);
                }
            });

            // التحقق من صحة الرابط
            if (row.originalUrl && !this.isValidUrl(row.originalUrl)) {
                errors.push('رابط غير صالح');
            }

            // التحقق من صحة بيانات المسلسل
            if (this.selectedContentType === 'series') {
                if (row.totalEpisodes && (!Number.isInteger(+row.totalEpisodes) || +row.totalEpisodes < 1)) {
                    errors.push('عدد الحلقات يجب أن يكون رقم صحيح أكبر من 0');
                }
                if (row.startingEpisode && (!Number.isInteger(+row.startingEpisode) || +row.startingEpisode < 1)) {
                    errors.push('رقم الحلقة الابتدائية يجب أن يكون رقم صحيح أكبر من 0');
                }
            }

            if (errors.length === 0) {
                this.validData.push(row);
            } else {
                this.invalidData.push({ row: index + 2, data: row, errors });
            }
        });
    }

    // عرض المعاينة
    displayPreview() {
        // تحديث الإحصائيات
        document.getElementById('totalRows').textContent = this.parsedData.length;
        document.getElementById('validRows').textContent = this.validData.length;
        document.getElementById('invalidRows').textContent = this.invalidData.length;
        document.getElementById('estimatedTime').textContent = `${Math.ceil(this.validData.length * 0.5)}s`;

        // عرض الجدول
        this.displayPreviewTable();

        // عرض الأخطاء
        this.displayValidationErrors();

        // تفعيل/تعطيل زر البدء
        document.getElementById('startImport').disabled = this.validData.length === 0;
    }

    // عرض جدول المعاينة
    displayPreviewTable() {
        const table = document.getElementById('previewTable');
        if (!table || this.parsedData.length === 0) return;

        // إنشاء العناوين
        const headers = Object.keys(this.parsedData[0]);
        const thead = table.querySelector('thead');
        thead.innerHTML = `
            <tr>
                <th>الصف</th>
                <th>الحالة</th>
                ${headers.map(h => `<th>${h}</th>`).join('')}
            </tr>
        `;

        // إنشاء البيانات (أول 20 صف فقط)
        const tbody = table.querySelector('tbody');
        const displayData = this.parsedData.slice(0, 20);
        
        tbody.innerHTML = displayData.map((row, index) => {
            const isValid = this.validData.some(v => v === row);
            const statusClass = isValid ? 'table-cell-valid' : 'table-cell-invalid';
            const statusIcon = isValid ? '✓' : '✗';
            
            return `
                <tr>
                    <td>${index + 2}</td>
                    <td class="${statusClass}">${statusIcon}</td>
                    ${headers.map(h => `<td class="${isValid ? '' : 'table-cell-invalid'}">${row[h] || ''}</td>`).join('')}
                </tr>
            `;
        }).join('');

        if (this.parsedData.length > 20) {
            tbody.innerHTML += `
                <tr>
                    <td colspan="${headers.length + 2}" class="text-center text-muted">
                        ... و ${this.parsedData.length - 20} صف إضافي
                    </td>
                </tr>
            `;
        }
    }

    // عرض أخطاء التحقق
    displayValidationErrors() {
        const errorsDiv = document.getElementById('validationErrors');
        const errorsList = document.getElementById('errorsList');

        if (this.invalidData.length === 0) {
            errorsDiv.style.display = 'none';
            return;
        }

        errorsDiv.style.display = 'block';
        errorsList.innerHTML = this.invalidData.slice(0, 10).map(item => 
            `<li>الصف ${item.row}: ${item.errors.join(', ')}</li>`
        ).join('');

        if (this.invalidData.length > 10) {
            errorsList.innerHTML += `<li>... و ${this.invalidData.length - 10} خطأ إضافي</li>`;
        }
    }

    // بدء الاستيراد الجماعي
    async startBulkImport() {
        if (this.validData.length === 0) {
            showNotification('error', 'لا توجد بيانات صالحة للاستيراد');
            return;
        }

        this.goToStep(4);
        this.resetImportResults();

        const startTime = Date.now();
        const totalItems = this.validData.length;
        
        // تحديث شريط التقدم
        document.getElementById('totalProgress').textContent = totalItems;
        document.getElementById('currentProgress').textContent = '0';
        document.getElementById('importProgressBar').style.width = '0%';

        this.addLogEntry('info', `بدء استيراد ${totalItems} رابط...`);

        // معالجة كل عنصر
        for (let i = 0; i < this.validData.length; i++) {
            const item = this.validData[i];
            
            try {
                // تحديث الحالة
                document.getElementById('importStatus').innerHTML = `
                    <p class="text-primary">جاري معالجة: ${item.name}</p>
                `;

                // إنشاء الرابط
                await this.createSingleLink(item);
                
                this.importResults.success++;
                this.addLogEntry('success', `✓ تم إنشاء: ${item.name}`);

            } catch (error) {
                this.importResults.errors++;
                this.importResults.errorDetails.push({
                    item: item.name,
                    error: error.message
                });
                this.addLogEntry('error', `✗ فشل: ${item.name} - ${error.message}`);
            }

            // تحديث التقدم
            const progress = ((i + 1) / totalItems) * 100;
            document.getElementById('currentProgress').textContent = i + 1;
            document.getElementById('importProgressBar').style.width = `${progress}%`;

            // توقف قصير لتجنب إجهاد Firebase
            await new Promise(resolve => setTimeout(resolve, 100));
        }

        const totalTime = Math.round((Date.now() - startTime) / 1000);
        this.addLogEntry('info', `اكتمل الاستيراد في ${totalTime} ثانية`);

        // الانتقال لصفحة النتائج
        setTimeout(() => {
            this.showResults(totalTime);
        }, 1000);
    }

    // إنشاء رابط واحد
    async createSingleLink(item) {
        const user = auth.currentUser;
        if (!user) throw new Error('المستخدم غير مسجل');

        // إنشاء معرف فريد
        const linkId = Math.floor(100000 + Math.random() * 900000).toString();
        
        // إنشاء الرابط القصير
        const paramName = this.selectedContentType === 'series' ? 'halqat-alyawm-min-musalsal' : this.selectedContentType;
        const shortUrl = `https://${this.selectedDomain}/?${paramName}=${encodeURIComponent(item.name)}&id=${linkId}`;

        // إعداد بيانات الرابط
        const linkData = {
            id: linkId,
            seriesName: item.name,
            linkType: this.selectedContentType,
            originalUrl: item.originalUrl,
            shortUrl: shortUrl,
            customDomain: this.selectedDomain,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            userId: user.uid,
            clicks: 0,
            socialTitle: item.socialTitle || `${this.getTypeName(this.selectedContentType)} ${item.name}`,
            socialDescription: item.socialDescription || `شاهد ${item.name} الآن!`,
            socialImage: item.socialImage || 'https://via.placeholder.com/1200x630/4A154B/FFFFFF?text=Turkify+Pro',
            bulkImported: true,
            importDate: new Date()
        };

        // إضافة بيانات خاصة بالمسلسلات
        if (this.selectedContentType === 'series') {
            linkData.totalEpisodes = parseInt(item.totalEpisodes) || 10;
            linkData.startingEpisode = parseInt(item.startingEpisode) || 1;
            linkData.startDate = firebase.firestore.Timestamp.now();
        }

        // حفظ في Firebase
        await db.collection('links').doc(linkId).set(linkData);
    }

    // إعادة تعيين نتائج الاستيراد
    resetImportResults() {
        this.importResults = {
            success: 0,
            errors: 0,
            errorDetails: []
        };
        document.getElementById('importLog').innerHTML = '';
    }

    // إضافة دخول لسجل العمليات
    addLogEntry(type, message) {
        const logContainer = document.getElementById('importLog');
        const entry = document.createElement('div');
        entry.className = `log-entry ${type}`;
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logContainer.appendChild(entry);
        logContainer.scrollTop = logContainer.scrollHeight;
    }

    // عرض النتائج
    showResults(totalTime) {
        this.goToStep(5);

        // تحديث الأرقام
        document.getElementById('successCount').textContent = this.importResults.success;
        document.getElementById('errorCount').textContent = this.importResults.errors;
        document.getElementById('totalTime').textContent = `${totalTime}s`;

        // عرض تفاصيل الأخطاء
        if (this.importResults.errorDetails.length > 0) {
            document.getElementById('errorDetails').style.display = 'block';
            const errorTable = document.getElementById('errorDetailsTable');
            errorTable.innerHTML = this.importResults.errorDetails.map((error, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${error.error}</td>
                    <td>${error.item}</td>
                </tr>
            `).join('');
        }

        // إعادة تحميل قائمة الروابط
        if (typeof loadLinks === 'function') {
            loadLinks();
        }

        showNotification('success', `تم الاستيراد! ${this.importResults.success} نجح، ${this.importResults.errors} فشل`);
    }

    // تحميل نتائج الاستيراد
    downloadResults() {
        const results = {
            importDate: new Date().toISOString(),
            contentType: this.selectedContentType,
            domain: this.selectedDomain,
            total: this.parsedData.length,
            successful: this.importResults.success,
            failed: this.importResults.errors,
            errors: this.importResults.errorDetails
        };

        const blob = new Blob([JSON.stringify(results, null, 2)], { 
            type: 'application/json' 
        });
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `import_results_${new Date().toISOString().split('T')[0]}.json`;
        link.click();
    }

    // عرض الروابط المستوردة
    viewImportedLinks() {
        window.location.hash = 'admin';
        this.resetImport();
        // تطبيق فلتر للروابط المستوردة
        setTimeout(() => {
            showNotification('info', 'عرض الروابط المستوردة في جدول الإدارة');
        }, 500);
    }

    // التنقل بين الخطوات
    goToStep(stepNum) {
        // إخفاء جميع الخطوات
        for (let i = 1; i <= 5; i++) {
            const step = document.getElementById(`step${i}`);
            if (step) step.style.display = 'none';
        }

        // إظهار الخطوة المطلوبة
        const targetStep = document.getElementById(`step${stepNum}`);
        if (targetStep) {
            targetStep.style.display = 'block';
            targetStep.classList.add('active');
        }

        this.currentStep = stepNum;
    }

    // إعادة تعيين النظام
    resetImport() {
        this.currentStep = 1;
        this.selectedContentType = '';
        this.uploadedFile = null;
        this.parsedData = [];
        this.validData = [];
        this.invalidData = [];
        this.resetImportResults();

        // إعادة تعيين النموذج
        document.getElementById('bulkContentType').value = '';
        document.getElementById('bulkDomain').value = 'turkii.netlify.app';
        this.removeFile();

        this.goToStep(1);
        this.updateFieldRequirements();
    }

    // عرض/إخفاء رسالة التحميل
    showLoading(message) {
        // يمكن إضافة overlay للتحميل
        }

    hideLoading() {
        // إخفاء overlay التحميل
        }

    // التحقق من صحة الرابط
    isValidUrl(url) {
        try {
            new URL(url);
            return true;
        } catch {
            return false;
        }
    }

    // الحصول على اسم النوع
    getTypeName(type) {
        const types = {
            'series': 'مسلسل',
            'movie': 'فيلم', 
            'match': 'مباراة',
            'recipe': 'وصفة',
            'game': 'لعبة',
            'app': 'تطبيق',
            'channel': 'قناة',
            'reels': 'ريلز'
        };
        return types[type] || 'محتوى';
    }
}

// إنشاء نسخة من النظام
let bulkImportSystem;

// تهيئة النظام عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        bulkImportSystem = new BulkImportSystem();
    }, 1000);
});

// 🎬 نظام معالجة فيديو Trailer للمسلسلات والأفلام
class TrailerVideoSystem {
    constructor() {
        this.init();
    }

    init() {
        this.setupContentTypeHandler();
        this.setupTrailerUrlHandler();
        this.updateContentTypeBasedFields();
    }

    // معالج تغيير نوع المحتوى
    setupContentTypeHandler() {
        const contentTypeSelect = document.getElementById('linkType');
        if (contentTypeSelect) {
            contentTypeSelect.addEventListener('change', () => {
                this.updateContentTypeBasedFields();
            });
        }
    }

    // معالج رابط الفيديو
    setupTrailerUrlHandler() {
        const trailerUrlInput = document.getElementById('trailerUrl');
        if (trailerUrlInput) {
            trailerUrlInput.addEventListener('input', (e) => {
                this.handleTrailerUrlChange(e.target.value);
            });

            trailerUrlInput.addEventListener('blur', (e) => {
                this.validateAndPreviewTrailer(e.target.value);
            });
        }
    }

    // تحديث الحقول حسب نوع المحتوى
    updateContentTypeBasedFields() {
        const contentType = document.getElementById('linkType')?.value;
        const imageField = document.getElementById('imageField');
        const trailerField = document.getElementById('trailerField');
        const jsonUploadWrapper = document.getElementById('jsonUploadWrapper');

        if (!imageField || !trailerField || !jsonUploadWrapper) return;

        // عرض حقل الفيديو للمسلسلات والأفلام فقط
        if (contentType === 'series' || contentType === 'movie') {
            imageField.style.display = 'none';
            trailerField.style.display = 'block';
            
            // إضافة التحقق المطلوب
            document.getElementById('trailerUrl')?.setAttribute('required', 'true');
            document.getElementById('socialImage')?.removeAttribute('required');
        } else {
            imageField.style.display = 'block';
            trailerField.style.display = 'none';
            
            // إزالة التحقق
            document.getElementById('trailerUrl')?.removeAttribute('required');
            document.getElementById('socialImage')?.removeAttribute('required');
            
            // إخفاء المعاينة
            this.hideTrailerPreview();
        }

        // إظهار حقل رفع ملف الحلقات للمسلسلات فقط
        if (contentType === 'series') {
            jsonUploadWrapper.style.display = 'block';
        } else {
            jsonUploadWrapper.style.display = 'none';
        }

        // تحديث معاينة السوشيال ميديا
        this.updateSocialMediaPreview();
    }

    // معالجة تغيير رابط الفيديو
    handleTrailerUrlChange(url) {
        if (url.length > 10) {
            this.validateAndPreviewTrailer(url);
        } else {
            this.hideTrailerPreview();
        }
    }

    // التحقق من صحة رابط يوتيوب ومعاينته
    validateAndPreviewTrailer(url) {
        const videoId = this.extractYouTubeVideoId(url);
        
        if (videoId) {
            this.showTrailerPreview(videoId);
            this.updateSocialMediaPreview(videoId);
            
            // إزالة حالة الخطأ
            document.getElementById('trailerUrl')?.classList.remove('is-invalid');
        } else if (url.trim() !== '') {
            // إظهار حالة الخطأ
            document.getElementById('trailerUrl')?.classList.add('is-invalid');
            this.hideTrailerPreview();
            showNotification('error', 'رابط يوتيوب غير صالح');
        }
    }

    // استخراج معرف الفيديو من رابط يوتيوب
    extractYouTubeVideoId(url) {
        const patterns = [
            /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/,
            /youtube\.com\/watch\?.*v=([^&\n?#]+)/
        ];

        for (let pattern of patterns) {
            const match = url.match(pattern);
            if (match) return match[1];
        }
        return null;
    }

    // إظهار معاينة الفيديو
    showTrailerPreview(videoId) {
        const preview = document.getElementById('trailerPreview');
        const frame = document.getElementById('trailerFrame');
        
        if (preview && frame) {
            const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=0&controls=1&rel=0&modestbranding=1`;
            frame.src = embedUrl;
            preview.style.display = 'block';
        }
    }

    // إخفاء معاينة الفيديو
    hideTrailerPreview() {
        const preview = document.getElementById('trailerPreview');
        const frame = document.getElementById('trailerFrame');
        
        if (preview && frame) {
            preview.style.display = 'none';
            frame.src = '';
        }
    }

    // تحديث معاينة السوشيال ميديا
    updateSocialMediaPreview(videoId = null) {
        const previewImage = document.getElementById('previewImage');
        if (!previewImage) return;

        const contentType = document.getElementById('linkType')?.value;
        
        if ((contentType === 'series' || contentType === 'movie') && videoId) {
            // استخدام thumbnail يوتيوب كصورة معاينة
            const thumbnailUrl = `https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi3TdSw7_XcHwYp_32sJD6a54SQj4vmpmqh1CsvG1Wqa5Jc3ljp8hvkQZ4kj2whkXPx7-UhakEqqadVvdNkK0lD6bD8-DG_oNQQ9rWpFKjJtzZFduaLWby8FNntbdZLOHogCnG63r3ftta1Zqenzq1KCxwJYEpTJF0eC6il4gyHNvpaQvy3fb0InEwUqXg/s1024/file_000000005070620a8f67e39c784160a1.png`;
            previewImage.src = thumbnailUrl;
        } else {
            // العودة للصورة الافتراضية
            const socialImage = document.getElementById('socialImage')?.value;
            previewImage.src = socialImage || 'https://via.placeholder.com/500x300/4A154B/FFFFFF?text=صورة+المحتوى';
        }
    }

    // إنشاء رابط فيديو للصفحة
    createVideoElementForRedirect(videoId, title = '') {
        return `
            <div class="content-video">
                <iframe 
                    src="https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&controls=1&rel=0&modestbranding=1&start=0"
                    title="${title}"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen>
                </iframe>
                <div class="trailer-badge">Trailer</div>
                <div class="autoplay-indicator">
                    <i class="fas fa-play"></i> تشغيل تلقائي
                </div>
            </div>
        `;
    }

    // التحقق من صحة البيانات قبل الحفظ
    validateTrailerData() {
        const contentType = document.getElementById('linkType')?.value;
        
        if (contentType === 'series' || contentType === 'movie') {
            const trailerUrl = document.getElementById('trailerUrl')?.value;
            
            if (!trailerUrl || !this.extractYouTubeVideoId(trailerUrl)) {
                showNotification('error', 'رابط يوتيوب مطلوب ويجب أن يكون صالحاً للمسلسلات والأفلام');
                return false;
            }
        }
        
        return true;
    }

    // الحصول على بيانات الفيديو للحفظ
    getVideoDataForSave() {
        const contentType = document.getElementById('linkType')?.value;
        
        if (contentType === 'series' || contentType === 'movie') {
            const trailerUrl = document.getElementById('trailerUrl')?.value;
            const videoId = this.extractYouTubeVideoId(trailerUrl);
            
            return {
                hasTrailer: true,
                trailerUrl: trailerUrl,
                trailerVideoId: videoId,
                thumbnailUrl: videoId ? `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg` : null
            };
        }
        
        return {
            hasTrailer: false,
            trailerUrl: null,
            trailerVideoId: null,
            thumbnailUrl: null
        };
    }
}

// إنشاء نسخة من النظام
const trailerSystem = new TrailerVideoSystem();

// دالة لتحميل ملف JSON
function readJSONFile(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                resolve(JSON.parse(event.target.result));
            } catch (e) {
                reject('ملف JSON غير صالح');
            }
        };
        reader.onerror = () => reject('خطأ في قراءة الملف');
        reader.readAsText(file);
    });
}

// معالجة رفع ملف JSON
document.getElementById('episodesJson')?.addEventListener('change', async function(e) {
    if (e.target.files.length === 0) return;
    
    const file = e.target.files[0];
    const fileName = file.name;
    const fileSize = (file.size / 1024).toFixed(2); // KB
    
    try {
        const episodesData = await readJSONFile(file);
        window.uploadedEpisodes = episodesData; // تخزين مؤقت
        document.getElementById('episodesInfo').innerHTML = `
            <div class="alert alert-success">
                <i class="fas fa-check-circle me-2"></i>
                تم تحميل ملف ${fileName} (${fileSize} KB) بنجاح - يحتوي على ${episodesData.episodes.length} حلقة
            </div>
        `;
    } catch (error) {
        document.getElementById('episodesInfo').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                ${error}
            </div>
        `;
    }
});

// إنشاء نموذج JSON للتحميل
document.getElementById('downloadTemplate')?.addEventListener('click', function(e) {
    e.preventDefault();
    
    const template = {
        "series_name": "اسم المسلسل",
        "episodes": [
            {
                "episode_number": 1,
                "title": "عنوان الحلقة الأولى",
                "description": "وصف تشويقي للحلقة الأولى"
            },
            {
                "episode_number": 2,
                "title": "عنوان الحلقة الثانية",
                "description": "وصف تشويقي للحلقة الثانية"
            }
        ]
    };
    
    const blob = new Blob([JSON.stringify(template, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = 'series_template.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
});

// دالة للتحديث التلقائي عند منتصف الليل
function setupDailyEpisodeUpdate(linkId) {
    // حساب الوقت المتبقي حتى منتصف الليل (بتوقيت السعودية)
    const now = new Date();
    const saudiOffset = 3 * 60; // توقيت السعودية UTC+3
    const saudiNow = new Date(now.getTime() + (saudiOffset - now.getTimezoneOffset()) * 60000);
    
    const midnight = new Date(saudiNow);
    midnight.setHours(24, 0, 0, 0);
    
    const timeUntilMidnight = midnight - saudiNow;
    
    setTimeout(async () => {
        try {
            const linkDoc = await db.collection('links').doc(linkId).get();
            if (!linkDoc.exists) return;
            
            const linkData = linkDoc.data();
            if (linkData.linkType !== 'series') return;
            
            // تحديث رقم الحلقة
            const newEpisode = linkData.startingEpisode + 1;
            await db.collection('links').doc(linkId).update({
                startingEpisode: newEpisode
            });
            
            // تحديث الواجهة تلقائياً إذا كانت الصفحة مفتوحة
            if (window.location.search.includes(linkId)) {
                updateEpisodeContent(linkId, newEpisode);
            }
            
            // إعادة جدولة التحديث لليوم التالي
            setupDailyEpisodeUpdate(linkId);
        } catch (error) {
            console.error('Auto-update failed:', error);
        }
    }, timeUntilMidnight);
}

// دالة لتحديث محتوى الحلقة
async function updateEpisodeContent(linkId, episodeNum) {
    const contentTitle = document.getElementById('contentTitle');
    const contentDescription = document.getElementById('contentDescription');
    
    try {
        const episodesDoc = await db.collection('series_episodes').doc(linkId).get();
        if (episodesDoc.exists) {
            const episodesData = episodesDoc.data();
            const episodeInfo = episodesData.episodes.find(
                ep => ep.episode_number === episodeNum
            );
            
            if (episodeInfo) {
                if (contentTitle) contentTitle.textContent = episodeInfo.title;
                if (contentDescription) contentDescription.textContent = episodeInfo.description;
                
                // رسالة تأكيد للمستخدم
                showNotification('info', `تم التحديث تلقائياً للحلقة ${episodeNum}`, 5000);
            }
        }
    } catch (error) {
        console.error('Episode update failed:', error);
    }
}

// إضافة هذا الكود في نهاية ملف الـ script
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('id')) {
        // إخفاء زر القائمة
        const navbarToggler = document.querySelector('.navbar-toggler');
        if (navbarToggler) {
            navbarToggler.style.display = 'none';
        }

        // تغيير اتجاه الـ Navbar
        const navbar = document.querySelector('.navbar');
        if (navbar) {
            navbar.style.direction = 'ltr';
            navbar.style.textAlign = 'left';
        }
    }
});

    </script>

      </body> 
      </html>