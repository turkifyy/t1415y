<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="منصة متقدمة لإدارة الروابط مع تحليلات ونطاقات مخصصة وميزات متطورة">
    <meta name="keywords" content="تقصير الروابط, إدارة الروابط, تحليلات, تسويق رقمي">
    <title>Turkify Pro - منصة متقدمة لإدارة الروابط</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-purple: #4A154B;
            --secondary-red: #EF5A5F;
            --accent-teal: #2EC4B6;
            --light-gray: #f8f9fa;
            --dark-gray: #343a40;
            --gradient-start: #6a11cb;
            --gradient-end: #2575fc;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Tajawal', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--light-gray) 0%, #eef2f5 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: #333;
            line-height: 1.8;
        }
        
        .navbar {
            background: linear-gradient(90deg, var(--primary-purple) 0%, #5d1d63 100%);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 0.8rem 0;
        }
        
        .logo {
            font-weight: 700;
            color: white;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo span {
            color: var(--secondary-red);
        }
        
        .logo-icon {
            background: var(--secondary-red);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .navbar-toggler {
            border: none;
            outline: none;
            box-shadow: none;
        }
        
        .nav-link {
            padding: 0.5rem 1rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
        }
        
        .nav-link:hover {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }
        
        .navbar-collapse {
            justify-content: flex-end;
        }
        
        .card {
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            border: none;
            margin-bottom: 30px;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            overflow: hidden;
            background: white;
        }
        
        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }
        
        .card-header {
            background: linear-gradient(90deg, var(--primary-purple) 0%, #5d1d63 100%);
            color: white;
            font-weight: 600;
            border-radius: 16px 16px 0 0 !important;
            padding: 1.2rem 1.5rem;
            font-size: 1.1rem;
        }
        
        .btn-primary {
            background: linear-gradient(90deg, var(--primary-purple) 0%, #5d1d63 100%);
            border: none;
            padding: 0.8rem 1.8rem;
            font-weight: 500;
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: linear-gradient(90deg, #3a1043 0%, #4a154b 100%);
            transform: translateY(-2px);
            box-shadow: 0 7px 15px rgba(74, 21, 75, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(90deg, var(--secondary-red) 0%, #e94348 100%);
            border: none;
            padding: 0.8rem 1.8rem;
            font-weight: 500;
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        
        .btn-danger:hover {
            background: linear-gradient(90deg, #d93439 0%, #e94348 100%);
            transform: translateY(-2px);
            box-shadow: 0 7px 15px rgba(239, 90, 95, 0.3);
        }
        
        .form-control, .form-select {
            border: 2px solid #eaeaea;
            border-radius: 12px;
            padding: 0.8rem 1.2rem;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--accent-teal);
            box-shadow: 0 0 0 0.25rem rgba(46, 196, 182, 0.2);
        }
        
        .stat-card {
            text-align: center;
            padding: 25px 20px;
            border-radius: 16px;
            background: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 2.8rem;
            font-weight: 700;
            background: linear-gradient(90deg, var(--primary-purple) 0%, var(--accent-teal) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 1.1rem;
            color: var(--dark-gray);
            font-weight: 500;
        }
        
        .link-card {
            border-left: 4px solid var(--accent-teal);
            transition: all 0.3s ease;
        }
        
        .link-card:hover {
            border-left: 4px solid var(--secondary-red);
        }
        
        .link-url {
            font-size: 0.95rem;
            color: #6c757d;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .short-url {
            color: var(--primary-purple);
            font-weight: 600;
            transition: color 0.3s;
        }
        
        .short-url:hover {
            color: var(--accent-teal);
            text-decoration: none;
        }
        
        .clicks-badge {
            background: linear-gradient(90deg, var(--secondary-red) 0%, #e94348 100%);
            padding: 0.4rem 0.8rem;
            border-radius: 50px;
            font-weight: 500;
        }
        
        .loader {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid var(--accent-teal);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 30px auto;
            display: none;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .redirect-container {
            max-width: 700px;
            margin: 80px auto;
            text-align: center;
            padding: 40px;
            border-radius: 20px;
            background: white;
            box-shadow: 0 15px 50px rgba(0,0,0,0.1);
        }
        
        .redirect-icon {
            font-size: 5rem;
            background: linear-gradient(90deg, var(--primary-purple) 0%, var(--accent-teal) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 25px;
        }
        
        .redirect-btn {
            margin-top: 30px;
            padding: 0.8rem 2.5rem;
            border-radius: 12px;
            font-weight: 500;
        }
        
        .admin-only {
            display: none;
        }
        
        .action-buttons .btn {
            margin-right: 8px;
            border-radius: 10px;
            padding: 0.5rem 0.9rem;
        }
        
        .table-responsive {
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .table th {
            background: linear-gradient(90deg, var(--primary-purple) 0%, #5d1d63 100%);
            color: white;
            font-weight: 500;
            padding: 1.1rem 1.5rem;
        }
        
        .table td {
            padding: 1.1rem 1.5rem;
            vertical-align: middle;
        }
        
        .feature-icon {
            width: 70px;
            height: 70px;
            border-radius: 20px;
            background: rgba(74, 21, 75, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 30px;
            color: var(--primary-purple);
        }
        
        .hero-section {
            background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
            color: white;
            padding: 100px 0 80px;
            border-radius: 0 0 30px 30px;
            margin-bottom: -50px;
            position: relative;
            overflow: hidden;
        }
        
        .custom-shape {
            position: absolute;
            width: 150px;
            height: 150px;
            background: linear-gradient(135deg, var(--accent-teal) 0%, rgba(46, 196, 182, 0.3) 100%);
            border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%;
            z-index: 0;
        }
        
        .shape-1 {
            top: 10%;
            left: 5%;
            animation: float 8s infinite ease-in-out;
        }
        
        .shape-2 {
            bottom: 15%;
            right: 7%;
            width: 120px;
            height: 120px;
            animation: float 10s infinite ease-in-out;
            animation-delay: 1s;
        }
        
        @keyframes float {
            0% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(10deg); }
            100% { transform: translateY(0) rotate(0deg); }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transform: translateX(200%);
            transition: transform 0.4s ease;
            display: none;
        }
        
        .notification.show {
            transform: translateX(0);
            display: block;
        }
        
        .notification.success {
            background: linear-gradient(90deg, #2EC4B6 0%, #20bfa9 100%);
        }
        
        .notification.error {
            background: linear-gradient(90deg, #EF5A5F 0%, #e94348 100%);
        }
        
        .notification.info {
            background: linear-gradient(90deg, #4A154B 0%, #5d1d63 100%);
        }
        
        .progress-bar {
            height: 5px;
            background: rgba(255,255,255,0.5);
            width: 100%;
            margin-top: 10px;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background: white;
            width: 100%;
            animation: progress 3s linear forwards;
        }
        
        @keyframes progress {
            0% { width: 100%; }
            100% { width: 0%; }
        }
        
        .modal-content {
            border-radius: 20px;
            overflow: hidden;
            border: none;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            background: linear-gradient(90deg, var(--primary-purple) 0%, #5d1d63 100%);
            color: white;
        }
        
        .device-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .device-desktop {
            background: rgba(74, 21, 75, 0.1);
            color: var(--primary-purple);
        }
        
        .device-mobile {
            background: rgba(46, 196, 182, 0.1);
            color: var(--accent-teal);
        }
        
        .device-tablet {
            background: rgba(239, 90, 95, 0.1);
            color: var(--secondary-red);
        }
        
        .country-flag {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }
        
        .stats-card {
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            background: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .nav-active {
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
        }
        
        .table-loader {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        
        .qr-code-container {
            text-align: center;
            margin: 20px 0;
        }
        
        #qrcode {
            display: inline-block;
            padding: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .platform-stat {
            text-align: center;
            padding: 15px;
        }
        
        .link-type-badge {
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
            display: inline-block;
        }
        
        .type-series { background-color: rgba(74, 21, 75, 0.1); color: var(--primary-purple); }
        .type-movie { background-color: rgba(46, 196, 182, 0.1); color: var(--accent-teal); }
        .type-match { background-color: rgba(239, 90, 95, 0.1); color: var(--secondary-red); }
        .type-recipe { background-color: rgba(255, 193, 7, 0.1); color: #ff9800; }
        .type-game { background-color: rgba(63, 81, 181, 0.1); color: #3f51b5; }
        .type-app { background-color: rgba(76, 175, 80, 0.1); color: #4caf50; }
        .type-channel { background-color: rgba(156, 39, 176, 0.1); color: #9c27b0; }
        .type-reels { background-color: rgba(233, 30, 99, 0.1); color: #e91e63; }
        
        .social-preview {
            border-radius: 12px;
            border: 1px solid #eaeaea;
            padding: 15px;
            margin: 20px 0;
            background: white;
            max-width: 500px;
        }
        
        .social-preview-img {
            width: 100%;
            height: 250px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .stats-card {
            border-radius: 12px;
            padding: 20px;
            background: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .stats-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary-purple);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stats-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-teal);
            text-align: center;
        }
        
        .stats-chart {
            height: 250px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .redirect-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 30px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .redirect-thumbnail {
            width: 100%;
            height: 350px;
            object-fit: cover;
            border-radius: 12px;
            margin: 20px 0;
            z-index: 999999;
        }
        
        .redirect-title {
            font-size: 2rem;
            font-weight: 700;
            margin: 20px 0;
            color: var(--primary-purple);
        }
        
        .redirect-description {
            font-size: 1.1rem;
            line-height: 1.7;
            color: #555;
            margin-bottom: 30px;
        }
        
        .netflix-style {
            background: #141414;
            color: white;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        
        .netflix-style .redirect-thumbnail {
            border-radius: 0;
            height: 400px;
        }
        
        .netflix-gradient {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 150px;
            background: linear-gradient(transparent, #141414);
        }
        
        .netflix-content {
            position: relative;
            z-index: 10;
            padding: 30px;
        }
        
        /* تحسينات إمكانية الوصول */
        .btn:focus, .form-control:focus {
            outline: 3px solid rgba(46, 196, 182, 0.5);
            outline-offset: 2px;
        }
        
        /* تحسينات التحميل المتأخر */
        img[loading] {
            transition: opacity 0.3s;
        }
        
        img[loading="lazy"] {
            opacity: 0;
        }
        
        img[loading="lazy"][data-loaded] {
            opacity: 1;
        }
        
        /* تحسينات التباين للألوان */
        .card-header, .btn-primary, .btn-danger, .clicks-badge {
            color: white !important;
        }
        
        .stat-label {
            color: #333;
            background: rgba(255,255,255,0.7);
            padding: 5px;
            border-radius: 8px;
        }
        
              /* إصلاح بطاقة المحتوى */
.content-card {
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    transition: all 0.3s ease;
    background: #fff;
    margin: 20px 0;
    display: block !important; /* فرض الظهور */
    visibility: visible !important;
}

.content-thumbnail {
    width: 100%;
    height: 300px;
    object-fit: cover;
    border-radius: 0;
    display: block !important;
    visibility: visible !important;
    background: #f8f9fa; /* لون خلفية في حالة عدم تحميل الصورة */
}

.content-info {
    padding: 25px;
    display: block !important;
    visibility: visible !important;
}

.content-meta {
    display: flex !important;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
    flex-wrap: wrap;
    visibility: visible !important;
}

.content-title {
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 15px;
    color: var(--primary-purple);
    display: block !important;
    visibility: visible !important;
}

.content-description {
    font-size: 1.1rem;
    line-height: 1.8;
    color: #555;
    margin-bottom: 20px;
    display: block !important;
    visibility: visible !important;
}

/* إصلاح عرض أنواع المحتوى */
.content-type, .content-episode, .content-date {
    display: inline-block !important;
    visibility: visible !important;
    padding: 8px 15px;
    border-radius: 20px;
    font-weight: 500;
    font-size: 0.9rem;
    margin: 5px 5px 5px 0;
}

.content-type {
    background: rgba(74, 21, 75, 0.1);
    color: var(--primary-purple);
}

.content-episode {
    background: rgba(239, 90, 95, 0.1);
    color: var(--secondary-red);
}

.content-date {
    background: rgba(46, 196, 182, 0.1);
    color: var(--accent-teal);
}
        
        /* إخفاء زر اكتشف الميزات */
        .hero-buttons .btn-outline-light {
            display: none;
        }
        
        .redirect-text {
            margin: 25px 0;
            font-size: 1.2rem;
            font-weight: 500;
            color: #4A154B;
            text-align: center;
            padding: 15px;
            background: rgba(74, 21, 75, 0.05);
            border-radius: 12px;
        }
        
        .redirect-text .highlight {
            font-weight: 700;
            color: var(--accent-teal);
        }
        
        .security-text {
            font-size: 0.9rem;
            color: #6c757d;
            text-align: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        /* Ad Containers */
        .ad-container {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 1px solid #eaeaea;
        }
        
        .ad-placeholder {
            width: 100%;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(74, 21, 75, 0.1);
            border-radius: 8px;
            color: #4A154B;
            font-weight: 500;
            margin: 10px 0;
        }
        
        .ad-350x50 { height: 50px; }
        .ad-350x250 { height: 250px; }
        
        /* تحسينات للعرض على الجوال */
        @media (max-width: 768px) {
            .content-thumbnail {
                height: 250px;
            }
            
            .content-title {
                font-size: 1.5rem;
            }
            
            .hero-section {
                padding: 70px 0 50px;
            }
            
            .table-responsive {
                border-radius: 12px;
            }
            
            .redirect-container {
                margin: 40px 20px;
                padding: 30px 20px;
            }
            
            .platform-stat h3 {
                font-size: 1.8rem;
            }
            
            .platform-stats .col-md-3 {
                margin-bottom: 15px;
            }
            
            .card-header {
                padding: 1rem;
            }
            
            .table th, .table td {
                padding: 0.75rem;
                font-size: 0.9rem;
            }
            
            .table-responsive {
                overflow-x: auto;
            }
            
            .btn-lg {
                padding: 0.8rem 1.2rem;
                font-size: 1rem;
            }
            
            .netflix-style .redirect-thumbnail {
                height: 300px;
            }
            
            .redirect-text {
                font-size: 1rem;
            }
        }
        
        @media (max-width: 576px) {
            .content-thumbnail {
                height: 200px;
            }
            
            .content-title {
                font-size: 1.3rem;
            }
            
            .content-description {
                font-size: 1rem;
            }
            
            .hero-section {
                padding: 50px 0 30px;
            }
            
            .stat-number {
                font-size: 2.2rem;
            }
            
            .table th, .table td {
                padding: 0.5rem;
                font-size: 0.8rem;
            }
            
            .btn {
                padding: 0.5rem 1rem;
            }
            
            .navbar-nav .nav-item {
                margin: 5px 0;
            }
            
            .hero-buttons .btn {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .netflix-style .redirect-thumbnail {
                height: 250px;
            }
            
            .redirect-text {
                font-size: 0.9rem;
                padding: 10px;
            }
        }
        
        /* تحسينات لشريط التنقل */
        .navbar-collapse {
            flex-basis: 100%;
            flex-grow: 0;
        }
        
        .navbar-nav .nav-link {
            padding: 10px 15px;
            margin: 0 5px;
        }
        
        @media (max-width: 991px) {
            .navbar-nav {
                margin-top: 15px;
            }
            
            .auth-section {
                margin-top: 15px;
                padding-top: 15px;
                border-top: 1px solid rgba(255,255,255,0.1);
            }
        }
        
        /* تحسينات للتركيز */
        .btn:focus, .form-control:focus, .form-select:focus, .nav-link:focus {
            box-shadow: 0 0 0 0.25rem rgba(46, 196, 182, 0.5);
        }
        
        /* تحسينات للجدول على الجوال */
        @media (max-width: 576px) {
            .table-responsive {
                font-size: 0.8rem;
            }
            .action-buttons .btn {
                padding: 0.3rem 0.6rem;
                font-size: 0.8rem;
            }
        }

        /* Analytics Filter */
        .analytics-filter {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .filter-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        
        .filter-btn {
            padding: 5px 15px;
            border-radius: 20px;
            background: #f1f1f1;
            border: none;
            transition: all 0.3s;
        }
        
        .filter-btn:hover, .filter-btn.active {
            background: var(--primary-purple);
            color: white;
        }
        
        /* Modern Stats Modal */
        .stats-modal-content {
            padding: 20px;
            border-radius: 16px;
            background: white;
            box-shadow: 0 15px 50px rgba(0,0,0,0.1);
        }
        
        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .stats-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-purple);
        }
        
        .time-filter {
            display: flex;
            gap: 10px;
        }
        
        .time-btn {
            padding: 5px 12px;
            border-radius: 20px;
            background: #f1f1f1;
            border: none;
            transition: all 0.3s;
        }
        
        .time-btn:hover, .time-btn.active {
            background: var(--accent-teal);
            color: white;
        }
        
        /* Earnings Modal */
        .earnings-chart {
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
        }
        
        .earnings-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .earnings-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .earnings-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-teal);
            margin: 10px 0;
        }
        
        .earnings-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        /* Pagination */
        .pagination .page-item.active .page-link {
            background: var(--primary-purple);
            border-color: var(--primary-purple);
        }
        
        .pagination .page-link {
            color: var(--primary-purple);
        }
        
        /* إضافات CSS للأرباح */
.earnings-region-card {
    background: white;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    border: 1px solid #eaeaea;
}

.earnings-breakdown {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 20px;
    margin-top: 20px;
}

.earnings-card {
    transition: transform 0.2s;
}

.earnings-card:hover {
    transform: translateY(-3px);
}

.earnings-value {
    font-size: 1.5rem !important;
    font-weight: 700 !important;
    color: var(--accent-teal) !important;
    margin: 10px 0 !important;
}

.progress {
    border-radius: 10px;
    overflow: hidden;
}

.progress-bar {
    border-radius: 10px;
    transition: width 0.6s ease;
}   

@media (max-width: 768px) {
    .content-thumbnail {
        height: 250px !important;
    }
    .content-title {
        font-size: 1.5rem !important;
    }
}

/* الخوارزميات الذكية */
.algorithm-control-card, .algorithm-status-card {
    border-radius: 16px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    border: none;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
}

.algorithm-metric {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid rgba(0,0,0,0.1);
}

.algorithm-metric:last-child {
    border-bottom: none;
}

.algorithms-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 25px;
    margin-top: 20px;
}

.algorithm-card {
    background: white;
    border-radius: 16px;
    padding: 25px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    border: none;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
    overflow: hidden;
}

.algorithm-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 15px 40px rgba(0,0,0,0.15);
}

.algorithm-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--primary-purple), var(--accent-teal));
}

.algorithm-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
}

.algorithm-title {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--primary-purple);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.algorithm-category {
    font-size: 0.8rem;
    padding: 4px 12px;
    border-radius: 20px;
    font-weight: 500;
}

.category-analytics {
    background: rgba(74, 21, 75, 0.1);
    color: var(--primary-purple);
}

.category-prediction {
    background: rgba(46, 196, 182, 0.1);
    color: var(--accent-teal);
}

.category-security {
    background: rgba(239, 90, 95, 0.1);
    color: var(--secondary-red);
}

.category-optimization {
    background: rgba(255, 159, 28, 0.1);
    color: #ff9f1c;
}

.algorithm-description {
    color: #6c757d;
    font-size: 0.95rem;
    line-height: 1.6;
    margin-bottom: 20px;
}

.algorithm-stats {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
}

.algorithm-stat {
    text-align: center;
    flex: 1;
}

.algorithm-stat-value {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--accent-teal);
    display: block;
}

.algorithm-stat-label {
    font-size: 0.8rem;
    color: #6c757d;
}

.algorithm-controls {
    display: flex;
    gap: 10px;
    align-items: center;
}

.algorithm-switch {
    margin-left: auto;
}

.algorithm-status {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 8px;
}

.status-idle {
    background: #6c757d;
}

.status-running {
    background: #28a745;
    animation: pulse 1s infinite;
}

.status-complete {
    background: var(--accent-teal);
}

.status-error {
    background: var(--secondary-red);
}

.algorithm-results {
    max-height: 400px;
    overflow-y: auto;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 12px;
}

.algorithm-result-item {
    background: white;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 10px;
    border-left: 4px solid var(--accent-teal);
}

.algorithm-result-item:last-child {
    margin-bottom: 0;
}

.algorithm-result-title {
    font-weight: 600;
    color: var(--primary-purple);
    margin-bottom: 5px;
}

.algorithm-result-value {
    font-size: 1.1rem;
    color: var(--accent-teal);
    font-weight: 700;
}

.algorithm-result-description {
    font-size: 0.9rem;
    color: #6c757d;
    margin-top: 5px;
}

.algorithm-progress {
    height: 6px;
    background: #e9ecef;
    border-radius: 3px;
    overflow: hidden;
    margin: 10px 0;
}

.algorithm-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--primary-purple), var(--accent-teal));
    border-radius: 3px;
    transition: width 0.3s ease;
}

/* تحسينات للجوال */
@media (max-width: 768px) {
    .algorithms-grid {
        grid-template-columns: 1fr;
    }
    
    .algorithm-card {
        padding: 20px;
    }
    
    .algorithm-stats {
        flex-direction: column;
        gap: 10px;
    }
    
    .algorithm-controls {
        flex-direction: column;
        align-items: stretch;
    }
}

/* أنماط فيديو Trailer */
.trailer-preview {
    background: rgba(74, 21, 75, 0.05);
    border-radius: 12px;
    padding: 15px;
    border: 1px solid rgba(74, 21, 75, 0.1);
}

.video-container {
    position: relative;
    width: 100%;
    height: 0;
    padding-bottom: 56.25%; /* نسبة 16:9 */
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.video-container iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border-radius: 8px;
}

/* فيديو في صفحة إعادة التوجيه */
.content-video {
    width: 100%;
    height: 300px;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    background: #000;
    position: relative;
}

.content-video iframe {
    width: 100%;
    height: 100%;
    border: none;
    border-radius: 12px;
}

.video-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, rgba(74, 21, 75, 0.1), rgba(46, 196, 182, 0.1));
    pointer-events: none;
    border-radius: 12px;
}

.video-play-button {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255, 255, 255, 0.9);
    border: none;
    border-radius: 50%;
    width: 80px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: var(--primary-purple);
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.video-play-button:hover {
    background: white;
    transform: translate(-50%, -50%) scale(1.1);
    box-shadow: 0 6px 25px rgba(0,0,0,0.4);
}

.video-title {
    position: absolute;
    bottom: 20px;
    left: 20px;
    right: 20px;
    color: white;
    background: rgba(0, 0, 0, 0.7);
    padding: 10px 15px;
    border-radius: 8px;
    font-weight: 500;
    backdrop-filter: blur(10px);
}

.video-duration {
    position: absolute;
    top: 15px;
    right: 15px;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 500;
}

.trailer-badge {
    position: absolute;
    top: 15px;
    left: 15px;
    background: linear-gradient(135deg, #ff0000, #cc0000);
    color: white;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: 0 2px 10px rgba(255, 0, 0, 0.3);
}

/* تحسينات للجوال */
@media (max-width: 768px) {
    .content-video {
        height: 200px;
        margin: 15px 0;
    }
    
    .video-play-button {
        width: 60px;
        height: 60px;
        font-size: 18px;
    }
    
    .video-title {
        bottom: 10px;
        left: 10px;
        right: 10px;
        padding: 8px 12px;
        font-size: 0.9rem;
    }
    
    .trailer-preview {
        padding: 10px;
    }
    
    .video-container {
        padding-bottom: 60%; /* نسبة أكثر ملاءمة للجوال */
    }
}

/* تأثيرات التحميل */
.video-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 200px;
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-radius: 12px;
    color: #6c757d;
}

.video-loading .spinner-border {
    width: 2rem;
    height: 2rem;
    margin-right: 10px;
}

/* أنماط الخطأ */
.video-error {
    background: rgba(220, 53, 69, 0.1);
    border: 1px solid rgba(220, 53, 69, 0.2);
    color: #721c24;
    padding: 20px;
    border-radius: 12px;
    text-align: center;
}

.video-error i {
    font-size: 2rem;
    margin-bottom: 10px;
    color: #dc3545;
}

/* أنماط مشغل مخصص */
.custom-player {
    position: relative;
    background: #000;
    border-radius: 12px;
    overflow: hidden;
}

.player-controls {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(transparent, rgba(0,0,0,0.8));
    padding: 15px;
    transform: translateY(100%);
    transition: transform 0.3s ease;
}

.custom-player:hover .player-controls {
    transform: translateY(0);
}

.play-pause-btn {
    background: none;
    border: none;
    color: white;
    font-size: 1.2rem;
    margin-right: 15px;
    cursor: pointer;
}

.progress-bar {
    flex: 1;
    height: 4px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 2px;
    margin: 0 15px;
    position: relative;
    cursor: pointer;
}

.progress-fill {
    height: 100%;
    background: var(--accent-teal);
    border-radius: 2px;
    width: 0%;
    transition: width 0.1s ease;
}

.volume-control {
    display: flex;
    align-items: center;
    gap: 10px;
}

.volume-btn {
    background: none;
    border: none;
    color: white;
    font-size: 1rem;
    cursor: pointer;
}

.volume-slider {
    width: 60px;
    height: 4px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 2px;
    outline: none;
    cursor: pointer;
}

/* تحسينات إضافية */
.trailer-info {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
    font-size: 0.9rem;
    color: #6c757d;
}

.video-quality-badge {
    background: rgba(74, 21, 75, 0.1);
    color: var(--primary-purple);
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
}

.autoplay-indicator {
    position: absolute;
    top: 50px;
    right: 15px;
    background: rgba(46, 196, 182, 0.9);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 500;
    animation: pulse 2s infinite;
}

/* نظام الاستيراد بالجملة */
.bulk-import-card {
    border: none;
    box-shadow: 0 15px 50px rgba(0,0,0,0.1);
    border-radius: 20px;
    overflow: hidden;
}

.bulk-step {
    display: none;
    padding: 30px 0;
}

.bulk-step.active {
    display: block;
}

.step-title {
    display: flex;
    align-items: center;
    margin-bottom: 30px;
    color: var(--primary-purple);
    font-weight: 700;
}

.step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-purple), var(--accent-teal));
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    font-weight: 700;
}

.file-upload-area {
    border: 3px dashed #ddd;
    border-radius: 16px;
    padding: 40px;
    text-align: center;
    transition: all 0.3s ease;
    background: #f8f9fa;
}

.file-upload-area:hover {
    border-color: var(--accent-teal);
    background: rgba(46, 196, 182, 0.05);
}

.file-upload-area.dragover {
    border-color: var(--primary-purple);
    background: rgba(74, 21, 75, 0.05);
    transform: scale(1.02);
}

.upload-placeholder i {
    color: #6c757d;
}

.file-info {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 12px;
    padding: 15px;
}

.summary-card, .processing-stat {
    background: white;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    margin-bottom: 15px;
}

.summary-number, .stat-value {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 5px;
}

.summary-label, .stat-label {
    color: #6c757d;
    font-size: 0.9rem;
}

.data-preview {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #e9ecef;
    border-radius: 12px;
}

.progress-container {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
}

.progress {
    height: 20px;
    border-radius: 10px;
    overflow: hidden;
}

.progress-bar {
    background: linear-gradient(90deg, var(--primary-purple), var(--accent-teal));
}

.progress-info {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
    font-weight: 500;
}

.processing-details {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
}

.log-container {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    max-height: 200px;
    overflow-y: auto;
    font-family: monospace;
    font-size: 0.9rem;
}

.log-entry {
    margin-bottom: 8px;
    padding: 5px 0;
    border-bottom: 1px solid #eee;
}

.log-entry:last-child {
    border-bottom: none;
}

.log-entry.success {
    color: #28a745;
}

.log-entry.error {
    color: #dc3545;
}

.log-entry.warning {
    color: #ffc107;
}

.results-summary {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-radius: 16px;
    padding: 30px;
}

.validation-error {
    background: #fff5f5;
    border: 1px solid #fed7d7;
    color: #c53030;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.85rem;
}

.validation-success {
    background: #f0fff4;
    border: 1px solid #9ae6b4;
    color: #2f855a;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.85rem;
}

/* خصائص متجاوبة */
@media (max-width: 768px) {
    .bulk-step {
        padding: 20px 0;
    }
    
    .file-upload-area {
        padding: 30px 20px;
    }
    
    .step-title {
        flex-direction: column;
        text-align: center;
        gap: 10px;
    }
    
    .summary-card, .processing-stat {
        margin-bottom: 10px;
    }
}

    </style>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4B73N1T483"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-4B73N1T483');
    </script>
</head>
<body>
    <!-- Notification System -->
    <div class="notification success" id="successNotification">
        <div>تم إنشاء الرابط بنجاح!</div>
        <div class="progress-bar"><div class="progress"></div></div>
    </div>
    
    <div class="notification error" id="errorNotification">
        <div>الرجاء ملء جميع الحقول المطلوبة</div>
        <div class="progress-bar"><div class="progress"></div></div>
    </div>
    
    <div class="notification info" id="welcomeNotification">
        <div>أهلاً بعودتك، <span id="userName"></span>!</div>
        <div class="progress-bar"><div class="progress"></div></div>
    </div>

    <!-- reCAPTCHA Badge -->
    <div class="grecaptcha-badge" data-style="bottomright"></div>

    <!-- Custom Shapes -->
    <div class="custom-shape shape-1"></div>
    <div class="custom-shape shape-2"></div>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand logo" href="#">
                <div class="logo-icon">
                    <i class="fas fa-link"></i>
                </div>
                Turk<span>ify</span> Pro
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent" 
                    aria-controls="navbarContent" aria-expanded="false" aria-label="تبديل التنقل">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="#home" id="homeLink" aria-label="Home">
                            <i class="fas fa-home me-1"></i> الرئيسية
                        </a>
                    </li>
                    <li class="nav-item admin-only">
                        <a class="nav-link" href="#admin" id="adminLink" aria-label="Admin Panel">
                            <i class="fas fa-cog me-1"></i> لوحة التحكم
                        </a>
                    </li>
                    <li class="nav-item admin-only">
                        <a class="nav-link" href="#analytics" id="statsLink" aria-label="Analytics">
                            <i class="fas fa-chart-bar me-1"></i> التحليلات
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#features" id="featuresLink" aria-label="Features">
                            <i class="fas fa-star me-1"></i> الميزات
                        </a>
                    </li>
                    <li class="nav-item user-only" style="display: none;">
    <a class="nav-link nav-link-modern" href="#bulk-import" id="bulkImportLink">
        <i class="fas fa-upload nav-icon"></i>
        <span class="nav-text">استيراد بالجملة</span>
        <span class="nav-badge" style="background: #ff6b35;">BULK</span>
    </a>
</li>
                </ul>
                
                <div class="d-flex align-items-center auth-section">
                    <div id="authButtons">
                        <button class="btn btn-outline-light" id="signInButton" aria-label="Sign in with Google">
                            <i class="fab fa-google me-2"></i>تسجيل الدخول
                        </button>
                    </div>
                    <div id="userProfile" style="display: none; margin-right: 15px;" aria-label="User profile">
                        <img src="" alt="User" id="userPhoto" class="rounded-circle me-2" 
                             style="width: 40px; height: 40px; object-fit: cover;" aria-label="User photo">
                        <button class="btn btn-outline-light" id="signOutButton" aria-label="Sign out">
                            <i class="fas fa-sign-out-alt me-1"></i>تسجيل الخروج
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero-section" id="home">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-6">
                    <h1 class="display-4 fw-bold mb-4">منصة متقدمة لإدارة الروابط</h1>
                    <p class="lead mb-5">أنشئ، تتبع، وطور روابطك باستخدام تحليلات قوية وميزات متطورة</p>
                    <div class="d-flex flex-wrap gap-3 hero-buttons">
                        <a href="#admin" class="btn btn-light btn-lg px-4 py-3 rounded-pill fw-bold" role="button" aria-label="Get started">
                            <i class="fas fa-rocket me-2"></i>ابدأ الآن
                        </a>
                    </div>
                </div>
                <div class="col-lg-6 text-center d-none d-lg-block">
                    <div class="position-relative">
                        <div class="card p-4 mx-auto" style="max-width: 400px; transform: rotate(3deg);">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h3 class="mb-0">تحليلات الروابط</h3>
                                    <span class="clicks-badge">+24%</span>
                                </div>
                                <div class="mb-4" style="height: 200px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.1); border-radius: 8px;">
                                    <i class="fas fa-chart-line fa-3x"></i>
                                </div>
                                <div class="d-flex justify-content-around">
                                    <div>
                                        <div class="fw-bold">1.2K</div>
                                        <small>نقرات</small>
                                    </div>
                                    <div>
                                        <div class="fw-bold">78%</div>
                                        <small>تفاعل</small>
                                    </div>
                                    <div>
                                        <div class="fw-bold">42</div>
                                        <small>روابط</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="platform-stats mt-5">
                <div class="row">
                    <div class="col-md-3 col-6">
                        <div class="platform-stat">
                            <h3 id="totalLinksStat">25K+</h3>
                            <p>روابط تم إنشاؤها</p>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="platform-stat">
                            <h3 id="totalClicksStat">1.2M+</h3>
                            <p>إجمالي النقرات</p>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="platform-stat">
                            <h3 id="uptimeStat">99.9%</h3>
                            <p>وقت التشغيل</p>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="platform-stat">
                            <h3 id="todayClicksStat">1,245</h3>
                            <p>نقرات اليوم</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <div class="container my-5 pt-5">
        <!-- Admin Panel -->
        <section id="admin">
            <div id="adminPanel" class="admin-only">
                <div class="row">
                    <div class="col-lg-8 mx-auto">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-plus-circle me-2"></i>إنشاء رابط قصير جديد
                            </div>
                            <div class="card-body">
                                <div class="mb-4">
                                    <label class="form-label fw-bold">اسم السلسلة *</label>
                                    <input type="text" class="form-control" id="seriesName" placeholder="أدخل اسم السلسلة" aria-label="Series name">
                                    <div class="invalid-feedback" id="nameError">الرجاء إدخال اسم سلسلة صالح (أحرف، أرقام، ومسافات فقط)</div>
                                </div>
<div class="mb-4">
                                    <label class="form-label fw-bold">نوع المحتوى *</label>
                                    <select class="form-select" id="linkType" aria-label="Link type">
                                        <option value="series">مسلسل</option>
                                        <option value="movie">فيلم</option>
                                        <option value="match">مباراة</option>
                                        <option value="recipe">وصفة</option>
                                        <option value="game">لعبة</option>
                                        <option value="app">تطبيق</option>
                                        <option value="channel">قناة</option>
                                        <option value="reels">ريلز</option>
                                    </select>
                                </div>
                                
                                <!-- حقل عدد الحلقات الجديد -->
                                <div class="mb-4" id="episodeCountWrapper" style="display: none;">
                                    <label class="form-label fw-bold">عدد حلقات المسلسل *</label>
                                    <input type="number" class="form-control" id="totalEpisodes" placeholder="مثلاً 10">
                                    <div class="invalid-feedback" id="episodeError">الرجاء إدخال عدد حلقات صحيح</div>
                                </div>
                                
                                <!-- حقل رقم الحلقة الابتدائية -->
                                <div class="mb-4" id="startingEpisodeWrapper" style="display: none;">
                                    <label class="form-label fw-bold">رقم الحلقة الابتدائية *</label>
                                    <input type="number" class="form-control" id="startingEpisode" placeholder="مثلاً 1" min="1" value="1">
                                    <div class="form-text">رقم الحلقة التي سيبدأ منها العد التلقائي اليومي</div>
                                </div>
                                
                                <div class="mb-4">
                                    <label class="form-label fw-bold">الرابط الأصلي *</label>
                                    <input type="url" class="form-control" id="originalUrl" placeholder="https://example.com" aria-label="Original URL">
                                    <div class="invalid-feedback" id="urlError">الرجاء إدخال رابط صالح</div>
                                </div>
                                
                                <div class="mb-4">
                                    <label class="form-label fw-bold">نطاق مخصص (مميز)</label>
                                    <input type="text" class="form-control" id="customDomain" placeholder="yourdomain.com" value="turkify.com" aria-label="Custom domain">
                                </div>
                                
                                <div class="mb-4">
                                    <label class="form-label fw-bold">عنوان معاينة السوشيال ميديا</label>
                                    <input type="text" class="form-control" id="socialTitle" placeholder="عنوان جذاب للمحتوى" aria-label="Social media title">
                                </div>
                                
                                <div class="mb-4">
                                    <label class="form-label fw-bold">وصف معاينة السوشيال ميديا</label>
                                    <textarea class="form-control" id="socialDescription" rows="3" placeholder="وصف جذاب للمحتوى يجذب الزوار" aria-label="Social media description"></textarea>
                                </div>
                                
                                <div class="mb-4">
    <!-- حقل الصورة للأنواع العادية -->
    <div id="imageField">
        <label class="form-label fw-bold">صورة معاينة السوشيال ميديا (URL)</label>
        <input type="url" class="form-control" id="socialImage" placeholder="https://example.com/image.jpg" aria-label="Social media image">
        <div class="form-text">استخدم صورة جذابة لجذب المزيد من النقرات</div>
    </div>
    
    <!-- حقل الفيديو للمسلسلات والأفلام -->
    <div id="trailerField" style="display: none;">
        <label class="form-label fw-bold">رابط Trailer من يوتيوب <span class="text-danger">*</span></label>
        <input type="url" class="form-control" id="trailerUrl" placeholder="https://www.youtube.com/watch?v=VIDEO_ID" aria-label="YouTube trailer URL">
        <div class="form-text">
            <i class="fab fa-youtube text-danger me-1"></i>
            سيتم عرض الفيديو تلقائياً في صفحة إعادة التوجيه
        </div>
        
        <!-- معاينة الفيديو -->
        <div id="trailerPreview" class="trailer-preview mt-3" style="display: none;">
            <h6><i class="fas fa-eye me-2"></i>معاينة الفيديو:</h6>
            <div class="video-container">
                <iframe id="trailerFrame" width="100%" height="200" frameborder="0" allowfullscreen></iframe>
            </div>
        </div>
    </div>
</div>
                                
                                <div class="d-grid">
                                    <button id="generateBtn" class="btn btn-primary btn-lg py-3 fw-bold" aria-label="Generate link">
                                        <i class="fas fa-bolt me-2"></i>إنشاء الرابط
                                    </button>
                                    <button id="updateBtn" class="btn btn-success btn-lg py-3 fw-bold mt-2" style="display: none;" aria-label="Update link">
                                        <i class="fas fa-save me-2"></i>حفظ التغييرات
                                    </button>
                                </div>
                                
                                <div class="mt-4">
                                    <h5>معاينة منشور السوشيال ميديا</h5>
                                    <div class="social-preview">
                                        <img src="https://via.placeholder.com/500x300/4A154B/FFFFFF?text=صورة+المحتوى" id="previewImage" class="social-preview-img" alt="Preview">
                                        <h5 id="previewTitle">عنوان المحتوى</h5>
                                        <p id="previewDescription">وصف المحتوى الذي سيظهر على منصات التواصل الاجتماعي</p>
                                        <small id="previewDomain">turkify.com</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Bulk Import Section -->
<div class="row mt-5">
    <div class="col-12">
        <div class="card bulk-import-card">
            <div class="card-header">
                <i class="fas fa-upload me-2"></i>استيراد الروابط بالجملة
                <span class="badge bg-success ms-2">جديد</span>
            </div>
            <div class="card-body">
                <!-- Step 1: Content Type Selection -->
                <div class="bulk-step active" id="step1">
                    <h5 class="step-title">
                        <span class="step-number">1</span>
                        اختر نوع المحتوى
                    </h5>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">نوع المحتوى *</label>
                            <select class="form-select form-select-lg" id="bulkContentType">
                                <option value="">-- اختر نوع المحتوى --</option>
                                <option value="series">مسلسل</option>
                                <option value="movie">فيلم</option>
                                <option value="match">مباراة</option>
                                <option value="recipe">وصفة</option>
                                <option value="game">لعبة</option>
                                <option value="app">تطبيق</option>
                                <option value="channel">قناة</option>
                                <option value="reels">ريلز</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">النطاق المستخدم</label>
                            <select class="form-select form-select-lg" id="bulkDomain">
                                <option value="turkify.netlify.app">turkify.netlify.app (الافتراضي)</option>
                                <option value="turkii.netlify.app">turkii.netlify.app (مخصص)</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-4">
                        <button class="btn btn-primary btn-lg" id="nextToStep2" disabled>
                            <i class="fas fa-arrow-right me-2"></i>المتابعة للخطوة التالية
                        </button>
                    </div>
                </div>

                <!-- Step 2: File Upload -->
                <div class="bulk-step" id="step2">
                    <h5 class="step-title">
                        <span class="step-number">2</span>
                        رفع ملف البيانات
                    </h5>
                    
                    <!-- Template Download -->
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>تحميل قالب CSV:</strong>
                        <button class="btn btn-sm btn-outline-info ms-2" id="downloadTemplate">
                            <i class="fas fa-download me-1"></i>تحميل القالب
                        </button>
                        <div class="mt-2">
                            <small id="templateInfo">اختر نوع المحتوى أولاً لتحميل القالب المناسب</small>
                        </div>
                    </div>

                    <!-- File Upload Area -->
                    <div class="file-upload-area" id="fileUploadArea">
                        <div class="upload-placeholder">
                            <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
                            <h5>اسحب وأفلت الملف هنا</h5>
                            <p>أو انقر لاختيار ملف CSV أو Excel</p>
                            <input type="file" id="bulkFileInput" accept=".csv,.xlsx,.xls" hidden>
                            <button class="btn btn-outline-primary" id="selectFileBtn">
                                <i class="fas fa-folder-open me-2"></i>اختر ملف
                            </button>
                        </div>
                    </div>

                    <!-- File Info -->
                    <div class="file-info mt-3" id="fileInfo" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-file me-2"></i>
                                <span id="fileName">--</span>
                                <span class="badge bg-secondary ms-2" id="fileSize">--</span>
                            </div>
                            <button class="btn btn-sm btn-outline-danger" id="removeFile">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <div class="mt-4">
                        <button class="btn btn-secondary me-2" id="backToStep1">
                            <i class="fas fa-arrow-left me-2"></i>العودة
                        </button>
                        <button class="btn btn-primary btn-lg" id="nextToStep3" disabled>
                            <i class="fas fa-arrow-right me-2"></i>معاينة البيانات
                        </button>
                    </div>
                </div>

                <!-- Step 3: Data Preview -->
                <div class="bulk-step" id="step3">
                    <h5 class="step-title">
                        <span class="step-number">3</span>
                        معاينة البيانات
                    </h5>
                    
                    <div class="data-summary mb-4" id="dataSummary">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="summary-card">
                                    <div class="summary-number" id="totalRows">0</div>
                                    <div class="summary-label">إجمالي الصفوف</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="summary-card">
                                    <div class="summary-number text-success" id="validRows">0</div>
                                    <div class="summary-label">صفوف صحيحة</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="summary-card">
                                    <div class="summary-number text-warning" id="errorRows">0</div>
                                    <div class="summary-label">صفوف بها أخطاء</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="summary-card">
                                    <div class="summary-number text-info" id="estimatedTime">--</div>
                                    <div class="summary-label">وقت المعالجة المتوقع</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="data-preview" id="dataPreview">
                        <div class="table-responsive">
                            <table class="table table-striped" id="previewTable">
                                <thead></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="mt-4">
                        <button class="btn btn-secondary me-2" id="backToStep2">
                            <i class="fas fa-arrow-left me-2"></i>العودة
                        </button>
                        <button class="btn btn-success btn-lg" id="startBulkImport" disabled>
                            <i class="fas fa-rocket me-2"></i>بدء الاستيراد
                        </button>
                    </div>
                </div>

                <!-- Step 4: Processing -->
                <div class="bulk-step" id="step4">
                    <h5 class="step-title">
                        <span class="step-number">4</span>
                        معالجة البيانات
                    </h5>
                    
                    <div class="processing-status">
                        <div class="progress-container">
                            <div class="progress mb-3">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     id="importProgress" style="width: 0%"></div>
                            </div>
                            <div class="progress-info">
                                <span id="progressText">جاري البدء...</span>
                                <span id="progressPercent" class="float-end">0%</span>
                            </div>
                        </div>

                        <div class="processing-details mt-4">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="processing-stat">
                                        <div class="stat-value text-success" id="processedCount">0</div>
                                        <div class="stat-label">تم المعالجة</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="processing-stat">
                                        <div class="stat-value text-warning" id="skippedCount">0</div>
                                        <div class="stat-label">تم التخطي</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="processing-stat">
                                        <div class="stat-value text-danger" id="failedCount">0</div>
                                        <div class="stat-label">فشل</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="processing-log mt-4">
                            <h6>سجل المعالجة:</h6>
                            <div class="log-container" id="processingLog">
                                <div class="log-entry">انتظار بدء المعالجة...</div>
                            </div>
                        </div>

                        <div class="mt-4">
                            <button class="btn btn-danger me-2" id="cancelImport">
                                <i class="fas fa-stop me-2"></i>إيقاف المعالجة
                            </button>
                            <button class="btn btn-primary" id="viewResults" style="display: none;">
                                <i class="fas fa-eye me-2"></i>عرض النتائج
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 5: Results -->
                <div class="bulk-step" id="step5">
                    <h5 class="step-title">
                        <span class="step-number">5</span>
                        نتائج الاستيراد
                    </h5>
                    
                    <div class="results-summary mb-4" id="resultsSummary">
                        <!-- ستملأ بـ JavaScript -->
                    </div>

                    <div class="results-details">
                        <ul class="nav nav-tabs" id="resultsTab">
                            <li class="nav-item">
                                <a class="nav-link active" href="#successfulLinks" data-bs-toggle="tab">
                                    الروابط الناجحة <span class="badge bg-success" id="successBadge">0</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#failedLinks" data-bs-toggle="tab">
                                    الروابط الفاشلة <span class="badge bg-danger" id="failedBadge">0</span>
                                </a>
                            </li>
                        </ul>
                        
                        <div class="tab-content mt-3">
                            <div class="tab-pane active" id="successfulLinks">
                                <div class="table-responsive">
                                    <table class="table table-success table-striped">
                                        <thead>
                                            <tr>
                                                <th>اسم المحتوى</th>
                                                <th>الرابط القصير</th>
                                                <th>الإجراءات</th>
                                            </tr>
                                        </thead>
                                        <tbody id="successfulLinksBody"></tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="tab-pane" id="failedLinks">
                                <div class="table-responsive">
                                    <table class="table table-danger table-striped">
                                        <thead>
                                            <tr>
                                                <th>اسم المحتوى</th>
                                                <th>سبب الفشل</th>
                                                <th>الإجراءات</th>
                                            </tr>
                                        </thead>
                                        <tbody id="failedLinksBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <button class="btn btn-outline-primary me-2" id="exportResults">
                            <i class="fas fa-download me-2"></i>تصدير النتائج
                        </button>
                        <button class="btn btn-success" id="startNewImport">
                            <i class="fas fa-plus me-2"></i>استيراد جديد
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
                
             </div>
           </div>        
                <!-- Link Management -->
                <div class="row mt-5">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-list me-2"></i>الروابط المدارة
                                </div>
                                <div class="d-flex">
                                    <div class="input-group me-2" style="max-width: 300px;">
                                        <input type="text" class="form-control" placeholder="بحث في الروابط..." id="searchLinks" aria-label="Search links">
                                        <button class="btn btn-primary" id="searchButton" aria-label="Search">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                    <select class="form-select" id="sortLinks" style="max-width: 150px;" aria-label="Sort links">
                                        <option value="newest">الأحدث أولاً</option>
                                        <option value="clicks">الأكثر نقرات</option>
                                        <option value="name">حسب الاسم</option>
                                    </select>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover" aria-label="Managed links">
                                        <thead>
                                            <tr>
                                                <th scope="col">المعرف</th>
                                                <th scope="col">اسم السلسلة</th>
                                                <th scope="col">النوع</th>
                                                <th scope="col">الرابط القصير</th>
                                                <th scope="col">تاريخ الإنشاء</th>
                                                <th scope="col">النقرات</th>
                                                <th scope="col">الإجراءات</th>
                                            </tr>
                                        </thead>
                                        <tbody id="linksTable">
                                            <tr>
                                                <td colspan="7" class="text-center table-loader">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">جاري التحميل...</span>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                                <nav class="mt-4" aria-label="Links pagination">
                                    <ul class="pagination justify-content-center">
                                        <li class="page-item disabled">
                                            <a class="page-link" href="#" tabindex="-1">السابق</a>
                                        </li>
                                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                                        <li class="page-item"><a class="page-link" href="#">3</a></li>
                                        <li class="page-item">
                                            <a class="page-link" href="#">التالي</a>
                                        </li>
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Analytics Dashboard -->
        <section id="analytics">
            <div id="analyticsPanel" style="display: none;">
                <div class="row">
                    <div class="col-12 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-chart-line me-2"></i>نظرة عامة على أداء الروابط
                            </div>
                            <div class="card-body">
                                <div class="analytics-filter">
                                    <h6>تصفية التحليلات:</h6>
                                    <div class="filter-group">
<button class="filter-btn active">الكل</button>
                                        <button class="filter-btn">اليوم</button>
                                        <button class="filter-btn">أسبوع</button>
                                        <button class="filter-btn">شهر</button>
                                        <button class="filter-btn">3 أشهر</button>
                                        <button class="filter-btn">6 أشهر</button>
                                        <button class="filter-btn">سنة</button>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-3 col-6 mb-4">
                                        <div class="stat-card">
                                            <div class="stat-number" id="totalLinks">24</div>
                                            <div class="stat-label">إجمالي الروابط</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-6 mb-4">
                                        <div class="stat-card">
                                            <div class="stat-number" id="totalClicks">1,842</div>
                                            <div class="stat-label">إجمالي النقرات</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-6 mb-4">
                                        <div class="stat-card">
                                            <div class="stat-number" id="todayClicks">56</div>
                                            <div class="stat-label">نقرات اليوم</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-6 mb-4">
                                        <div class="stat-card">
                                            <div class="stat-number" id="popularLink">78%</div>
                                            <div class="stat-label">معدل التفاعل</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-5">
                                    <h5 class="mb-4">النقرات مع مرور الوقت</h5>
                                    <div id="clicksChartPlaceholder" style="height: 300px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border-radius: 12px;">
                                        <i class="fas fa-chart-bar fa-3x text-muted"></i>
                                    </div>
                                </div>
                                
                                <div class="row mt-5">
                                    <div class="col-md-6 mb-4">
                                        <h5 class="mb-4">أفضل الروابط أداءً</h5>
                                        <div class="list-group">
                                            <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" aria-label="Summer Sale link">
                                                <div>
                                                    <div class="fw-bold">تخفيضات الصيف</div>
                                                    <small class="text-muted">https://turkify.com/s/389472</small>
                                                </div>
                                                <span class="clicks-badge">142 نقرات</span>
                                            </a>
                                            <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" aria-label="Special Offer link">
                                                <div>
                                                    <div class="fw-bold">عرض خاص</div>
                                                    <small class="text-muted">https://turkify.com/s/734516</small>
                                                </div>
                                                <span class="clicks-badge">128 نقرات</span>
                                            </a>
                                            <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" aria-label="New Products link">
                                                <div>
                                                    <div class="fw-bold">منتجات جديدة</div>
                                                    <small class="text-muted">https://turkify.com/s/562891</small>
                                                </div>
                                                <span class="clicks-badge">89 نقرات</span>
                                            </a>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-4">
                                        <h5 class="mb-4">التوزيع الجغرافي</h5>
                                        <div class="stats-card">
                                            <div class="d-flex align-items-center mb-3">
                                                <img src="https://flagcdn.com/sa.svg" loading="lazy" class="country-flag" alt="Saudi Arabia flag">
                                                <div class="fw-bold">السعودية</div>
                                                <div class="ms-auto">42%</div>
                                            </div>
                                            <div class="d-flex align-items-center mb-3">
                                                <img src="https://flagcdn.com/ae.svg" loading="lazy" class="country-flag" alt="United Arab Emirates flag">
                                                <div class="fw-bold">الإمارات</div>
                                                <div class="ms-auto">18%</div>
                                            </div>
                                            <div class="d-flex align-items-center mb-3">
                                                <img src="https://flagcdn.com/eg.svg" loading="lazy" class="country-flag" alt="Egypt flag">
                                                <div class="fw-bold">مصر</div>
                                                <div class="ms-auto">12%</div>
                                            </div>
                                            <div class="d-flex align-items-center">
                                                <img src="https://flagcdn.com/qa.svg" loading="lazy" class="country-flag" alt="Qatar flag">
                                                <div class="fw-bold">قطر</div>
                                                <div class="ms-auto">8%</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mt-4">
                                    <div class="col-md-6 mb-4">
                                        <h5 class="mb-4">أنواع الأجهزة</h5>
                                        <div class="stats-card">
                                            <div class="d-flex align-items-center mb-3">
                                                <div class="device-badge device-mobile"><i class="fas fa-mobile-alt me-2"></i>جوال</div>
                                                <div class="ms-auto">58%</div>
                                            </div>
                                            <div class="d-flex align-items-center mb-3">
                                                <div class="device-badge device-desktop"><i class="fas fa-desktop me-2"></i>كمبيوتر</div>
                                                <div class="ms-auto">32%</div>
                                            </div>
                                            <div class="d-flex align-items-center">
                                                <div class="device-badge device-tablet"><i class="fas fa-tablet-alt me-2"></i>تابلت</div>
                                                <div class="ms-auto">10%</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-4">
                                        <h5 class="mb-4">مصادر الزيارات</h5>
                                        <div class="stats-card">
                                            <div class="d-flex align-items-center mb-3">
                                                <i class="fab fa-facebook me-3" style="color: #3b5998;"></i>
                                                <div class="fw-bold">فيسبوك</div>
                                                <div class="ms-auto">38%</div>
                                            </div>
                                            <div class="d-flex align-items-center mb-3">
                                                <i class="fab fa-twitter me-3" style="color: #1da1f2;"></i>
                                                <div class="fw-bold">تويتر</div>
                                                <div class="ms-auto">22%</div>
                                            </div>
                                            <div class="d-flex align-items-center mb-3">
                                                <i class="fab fa-instagram me-3" style="color: #e1306c;"></i>
                                                <div class="fw-bold">إنستغرام</div>
                                                <div class="ms-auto">18%</div>
                                            </div>
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-envelope me-3" style="color: #ea4335;"></i>
                                                <div class="fw-bold">البريد الإلكتروني</div>
                                                <div class="ms-auto">12%</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Features Section -->
        <section id="features">
            <div id="featuresPanel">
                <div class="row mb-5">
                    <div class="col-12 text-center">
                        <h2 class="display-5 fw-bold mb-3">ميزات متقدمة</h2>
                        <p class="lead mb-5">كل ما تحتاجه لإنشاء وإدارة وتتبع روابطك</p>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4 mb-4">
                        <div class="card h-100">
                            <div class="card-body text-center p-4">
                                <div class="feature-icon">
                                    <i class="fas fa-link"></i>
                                </div>
                                <h4 class="mb-3">تنسيق رابط مخصص</h4>
                                <p>أنشئ روابط بالتنسيق: https://series-name.com/épisode-today-XXXXXX</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card h-100">
                            <div class="card-body text-center p-4">
                                <div class="feature-icon">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <h4 class="mb-3">تحليلات متقدمة</h4>
                                <p>تتبع النقرات والمواقع والأجهزة ومقاييس التفاعل في الوقت الفعلي.</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card h-100">
                            <div class="card-body text-center p-4">
                                <div class="feature-icon">
                                    <i class="fas fa-database"></i>
                                </div>
                                <h4 class="mb-3">تخزين سحابي</h4>
                                <p>استخدم Firebase Firestore لتخزين البيانات وإدارة الروابط بسهولة.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-4">
                        <div class="card h-100">
                            <div class="card-body text-center p-4">
                                <div class="feature-icon">
                                    <i class="fas fa-redo"></i>
                                </div>
                                <h4 class="mb-3">إعادة توجيه فورية</h4>
                                <p>أعد توجيه المستخدمين فورًا مع القدرة على تتبع الإحصائيات.</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card h-100">
                            <div class="card-body text-center p-4">
                                <div class="feature-icon">
                                    <i class="fas fa-shield-alt"></i>
                                </div>
                                <h4 class="mb-3">حماية متقدمة</h4>
                                <p>استخدم reCAPTCHA v3 لمنع الإساءة وحماية المنصة.</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card h-100">
                            <div class="card-body text-center p-4">
                                <div class="feature-icon">
                                    <i class="fas fa-mobile-alt"></i>
                                </div>
                                <h4 class="mb-3">تصميم متجاوب</h4>
                                <p>واجهة مستخدم تعمل بشكل مثالي على جميع الأجهزة والمقاسات.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-5">
                    <div class="col-12 text-center">
                        <h2 class="display-5 fw-bold mb-3">ميزات مميزة - مجاناً لك!</h2>
                        <p class="lead mb-5">ميزات احترافية مدفوعة في منصات أخرى، متاحة مجانًا على Turkify</p>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4 mb-4">
                        <div class="card h-100 border-2 border-primary">
                            <div class="card-body text-center p-4">
                                <div class="feature-icon">
                                    <i class="fas fa-globe"></i>
                                </div>
                                <h4 class="mb-3">نطاقات مخصصة</h4>
                                <p>استخدم نطاقك الخاص لإنشاء روابط قصيرة مميزة.</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card h-100 border-2 border-primary">
                            <div class="card-body text-center p-4">
                                <div class="feature-icon">
                                    <i class="fas fa-lock"></i>
                                </div>
                                <h4 class="mb-3">حماية بكلمة مرور</h4>
                                <p>أضف طبقة إضافية من الأمان لروابطك الحساسة.</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card h-100 border-2 border-primary">
                            <div class="card-body text-center p-4">
                                <div class="feature-icon">
                                    <i class="fas fa-hourglass-half"></i>
                                </div>
                                <h4 class="mb-3">انتهاء الروابط</h4>
                                <p>حدد تواريخ انتهاء للروابط المؤقتة.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!-- Smart Algorithms Panel -->
<section id="algorithms">
    <div id="algorithmsPanel" style="display: none;">
        <div class="row mb-5">
            <div class="col-12 text-center">
                <h2 class="display-5 fw-bold mb-3">🤖 الخوارزميات الذكية</h2>
                <p class="lead mb-5">15 خوارزمية متقدمة لتحسين أداء منصتك</p>
            </div>
        </div>

        <!-- Algorithm Controls -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card algorithm-control-card">
                    <div class="card-header">
                        <i class="fas fa-brain me-2"></i>التحكم في الخوارزميات
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">تفعيل جميع الخوارزميات:</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="masterAlgorithmSwitch">
                                <label class="form-check-label" for="masterAlgorithmSwitch">
                                    تشغيل النظام الذكي
                                </label>
                            </div>
                        </div>
                        <button class="btn btn-primary" id="runAllAlgorithms">
                            <i class="fas fa-play me-2"></i>تشغيل جميع الخوارزميات
                        </button>
                        <button class="btn btn-outline-info ms-2" id="algorithmReport">
                            <i class="fas fa-chart-line me-2"></i>تقرير الأداء
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card algorithm-status-card">
                    <div class="card-header">
                        <i class="fas fa-tachometer-alt me-2"></i>حالة النظام
                    </div>
                    <div class="card-body">
                        <div class="algorithm-metric">
                            <span>الخوارزميات النشطة:</span>
                            <span id="activeAlgorithmsCount" class="badge bg-success">0/15</span>
                        </div>
                        <div class="algorithm-metric">
                            <span>معدل الأداء:</span>
                            <span id="performanceRate" class="badge bg-info">0%</span>
                        </div>
                        <div class="algorithm-metric">
                            <span>آخر تحديث:</span>
                            <span id="lastAlgorithmUpdate" class="text-muted">لم يتم التشغيل</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Algorithm Categories -->
        <div class="algorithm-categories mb-4">
            <div class="btn-group w-100" role="group">
                <button type="button" class="btn btn-outline-primary active" data-category="all">الكل</button>
                <button type="button" class="btn btn-outline-primary" data-category="analytics">تحليلات</button>
                <button type="button" class="btn btn-outline-primary" data-category="prediction">تنبؤات</button>
                <button type="button" class="btn btn-outline-primary" data-category="security">أمان</button>
                <button type="button" class="btn btn-outline-primary" data-category="optimization">تحسين</button>
            </div>
        </div>

        <!-- Algorithms Grid -->
        <div class="algorithms-grid" id="algorithmsGrid">
            <!-- سيتم ملؤها بـ JavaScript -->
        </div>

        <!-- Algorithm Results -->
        <div class="row mt-5">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-chart-bar me-2"></i>نتائج الخوارزميات
                    </div>
                    <div class="card-body">
                        <div id="algorithmResults" class="algorithm-results">
                            <p class="text-muted text-center">لم يتم تشغيل أي خوارزمية بعد</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
        <!-- Redirect Panel -->
        <div id="redirectPanel" class="redirect-container" style="display: none;">
            <div class="ad-container">
                <h6>إعلانات من شركائنا</h6>
                <div class="ad-placeholder ad-350x50">
                    AdSterra Ad (350×50)
                </div>
            </div>

            <!-- بطاقة المحتوى المحدثة -->
<div class="content-card" id="contentCard" style="display: block;">
    <!-- إعلان علوي -->
    <div class="ad-container" style="margin: 20px 0;">
        <div class="ad-placeholder ad-350x50">
            AdSterra Ad (350×50)
        </div>
    </div>
    
    <!-- صورة المحتوى -->
    <div class="content-image-container">
        <img id="contentThumbnail" 
             src="https://via.placeholder.com/800x300/4A154B/FFFFFF?text=جاري+التحميل..." 
             class="content-thumbnail" 
             alt="صورة المحتوى" 
             style="display: block; visibility: visible;"
             onerror="this.src='https://via.placeholder.com/800x300/4A154B/FFFFFF?text=لا+توجد+صورة';">
    </div>
    
    <!-- إعلان وسطي -->
    <div class="ad-container" style="margin: 20px 0;">
        <div class="ad-placeholder ad-350x250">
            AdSterra Ad (350×250)
        </div>
    </div>
    
    <!-- معلومات المحتوى -->
    <div class="content-info" style="display: block; visibility: visible;">
        <!-- معلومات أساسية -->
        <div class="content-meta" style="display: flex; visibility: visible;">
            <span id="contentType" class="content-type" style="display: inline-block;">مسلسل</span>
            <span id="contentEpisode" class="content-episode" style="display: none;">الحلقة 1</span>
            <span id="contentDate" class="content-date" style="display: none;">اليوم</span>
        </div>
        
        <!-- عنوان المحتوى -->
        <h2 id="contentTitle" class="content-title" style="display: block; visibility: visible;">
            اسم المسلسل
        </h2>
        
        <!-- وصف المحتوى -->
        <p id="contentDescription" class="content-description" style="display: block; visibility: visible;">
            وصف المسلسل وأحداث الحلقة الحالية
        </p>
        
        <!-- معلومات إضافية -->
        <div class="content-stats" style="display: flex; gap: 20px; margin-top: 15px;">
            <div class="stat-item">
                <i class="fas fa-eye text-muted"></i>
                <span id="contentViews" class="ms-2">0 مشاهدة</span>
            </div>
            <div class="stat-item">
                <i class="fas fa-calendar text-muted"></i>
                <span id="contentCreated" class="ms-2">اليوم</span>
            </div>
        </div>
    </div>
</div>
            
            <!-- Update 1: Redirect text based on content type -->
            <div class="redirect-text" id="redirectText">
                <span id="redirectMessage">يتم توجيهك الآن</span>
            </div>
            
            <div class="loader" id="redirectLoader"></div>
            <div class="security-text">
                <p><i class="fas fa-shield-alt me-2"></i>اتصالك آمن ومشفّر</p>
                <p><i class="fas fa-bolt me-2"></i>مدعوم من منصة Turkify Pro لإدارة الروابط</p>
            </div>
            <button class="btn btn-primary redirect-btn" id="manualRedirectBtn" style="display: none;" aria-label="Continue to destination">
                <i class="fas fa-arrow-right me-2"></i>المتابعة إلى الوجهة
            </button>
        </div>
    </div>
    
    <!-- Link Generated Modal -->
    <div class="modal fade" id="linkModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-check-circle me-2"></i>تم إنشاء الرابط بنجاح!</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <p class="mb-1">رابطك القصير الجديد:</p>
                        <div class="input-group">
                            <input type="text" class="form-control form-control-lg" id="generatedLink" readonly aria-label="Generated link">
                            <button class="btn btn-primary" id="copyLinkBtn" aria-label="Copy link">
                                <i class="fas fa-copy me-1"></i>نسخ
                            </button>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        سيقوم هذا الرابط بإعادة التوجيه إلى: <span id="originalLinkDisplay" class="fw-bold"></span>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-4">
                        <button class="btn btn-outline-primary" id="viewAnalyticsBtn" aria-label="View analytics">
                            <i class="fas fa-chart-bar me-1"></i>عرض التحليلات
                        </button>
                        <button class="btn btn-outline-success" id="shareLinkBtn" aria-label="Share link">
                            <i class="fas fa-share-alt me-1"></i>مشارة الرابط
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="Close modal">إغلاق</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2 text-warning"></i>تأكيد العملية</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="confirmationMessage">هل أنت متأكد من رغبتك في حذف هذا الرابط؟</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-danger" id="confirmActionBtn">تأكيد</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Stats Modal -->
    <div class="modal fade" id="statsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-chart-bar me-2"></i>تحليلات الرابط</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="stats-modal-content">
                        <div class="stats-header">
                         <h4 id="statsLinkTitle" class="stats-title">تحليلات الرابط</h4>
    <p class="text-muted">
        الرابط القصير: <a id="statsLinkUrl" href="#" target="_blank" class="text-decoration-none">تحميل الرابط</a>
    </p>
    <div class="time-filter">
        <button class="time-btn active">اليوم</button>
        <button class="time-btn">أسبوع</button>
        <button class="time-btn">شهر</button>
        <button class="time-btn">3 أشهر</button>
        <button class="time-btn">سنة</button>
    </div>
</div>
                        
                        <div class="stats-grid">
                            <div class="stats-card">
                                <div class="stats-card-title"><i class="fas fa-users"></i> إجمالي الزيارات</div>
                                <div class="stats-number" id="totalVisits">1,842</div>
                            </div>
                            <div class="stats-card">
                                <div class="stats-card-title"><i class="fas fa-mouse-pointer"></i> النقرات اليوم</div>
                                <div class="stats-number" id="todayVisits">56</div>
                            </div>
                            <div class="stats-card">
                                <div class="stats-card-title"><i class="fas fa-map-marker-alt"></i> البلد الأكثر زيارة</div>
                                <div class="stats-number" id="topCountry">السعودية</div>
                            </div>
                            <div class="stats-card">
                                <div class="stats-card-title"><i class="fas fa-desktop"></i> الجهاز الأكثر استخداماً</div>
                                <div class="stats-number" id="topDevice">الهاتف</div>
                            </div>
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="stats-card">
                                    <div class="stats-card-title"><i class="fas fa-chart-line"></i> النقرات مع مرور الوقت</div>
                                    <div class="stats-chart">
                                        <canvas id="visitsChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="stats-card">
                                    <div class="stats-card-title"><i class="fas fa-globe-asia"></i> التوزيع الجغرافي</div>
                                    <div class="stats-chart">
                                        <canvas id="geoChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="stats-card">
                                    <div class="stats-card-title"><i class="fas fa-laptop"></i> أنواع الأجهزة</div>
                                    <div class="stats-chart">
                                        <canvas id="devicesChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="stats-card">
                                    <div class="stats-card-title"><i class="fas fa-share-alt"></i> مصادر الزيارات</div>
                                    <div class="stats-chart">
                                        <canvas id="sourcesChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Earnings Modal -->
    <div class="modal fade" id="earningsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-dollar-sign me-2 text-success"></i>إيرادات الرابط</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="stats-modal-content">
                        <div class="stats-header">
                            <h4 id="earningsLinkTitle" class="stats-title">تخفيضات الصيف</h4>
                            <div class="time-filter">
                                <button class="time-btn active">اليوم</button>
                                <button class="time-btn">أسبوع</button>
                                <button class="time-btn">شهر</button>
                                <button class="time-btn">3 أشهر</button>
                                <button class="time-btn">سنة</button>
                            </div>
                        </div>
                        
                        <div class="earnings-stats">
    <div class="earnings-card">
        <div id="totalEarnings" class="earnings-value">$0.00</div>
        <div class="earnings-label">إجمالي الأرباح</div>
    </div>
    <div class="earnings-card">
        <div id="totalImpressions" class="earnings-value">0</div>
        <div class="earnings-label">إجمالي المشاهدات</div>
    </div>
<div class="earnings-card">
        <div id="averageRPM" class="earnings-value">$0.00</div>
        <div class="earnings-label">متوسط الربح لكل 1000 مشاهدة</div>
    </div>
    <div class="earnings-card">
        <div id="todayEarnings" class="earnings-value">$0.00</div>
        <div class="earnings-label">أرباح اليوم</div>
    </div>
</div>

<div class="earnings-breakdown mt-4">
    <h6 class="mb-3">تفصيل الأرباح حسب المنطقة:</h6>
    <div class="row">
        <div class="col-md-6">
            <div class="earnings-region-card">
                <div class="d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-flag me-2"></i>البلدان العربية</span>
                    <div class="text-end">
                        <div id="arabVisits" class="fw-bold">0 زيارة</div>
                        <small id="arabEarnings" class="text-success">$0.00</small>
                    </div>
                </div>
                <div class="progress mt-2" style="height: 5px;">
                    <div id="arabProgress" class="progress-bar bg-success" style="width: 0%"></div>
                </div>
                <small class="text-muted">معدل: $1.00 لكل 1000 زيارة</small>
            </div>
        </div>
        <div class="col-md-6">
            <div class="earnings-region-card">
                <div class="d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-globe me-2"></i>البلدان الأجنبية</span>
                    <div class="text-end">
                        <div id="foreignVisits" class="fw-bold">0 زيارة</div>
                        <small id="foreignEarnings" class="text-primary">$0.00</small>
                    </div>
                </div>
                <div class="progress mt-2" style="height: 5px;">
                    <div id="foreignProgress" class="progress-bar bg-primary" style="width: 0%"></div>
                </div>
                <small class="text-muted">معدل: $3.00 لكل 1000 زيارة</small>
            </div>
        </div>
    </div>
</div>
                        
                        <div class="earnings-chart">
                            <canvas id="earningsChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Global Loader -->
    <div class="global-loader" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.7); z-index: 2000; justify-content: center; align-items: center;">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
    </div>
<!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.google.com/recaptcha/api.js?render=6LesFYErAAAAAOpY8Pbc0furepnxPt0WyJorH5Qw"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC5VmidRUmMF6W3vvl44zznScS1gn2GHn0",
            authDomain: "turkify-redirect.firebaseapp.com",
            projectId: "turkify-redirect",
            storageBucket: "turkify-redirect.appspot.com",
            messagingSenderId: "986441766029",
            appId: "1:986441766029:web:dd6a13879306472e43bec4"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- Global State Variables ---
        let currentEditingLinkId = null; // Current editing link ID
        let currentEarningsLinkId = null; // Stores the link ID for earnings modal filtering

        // --- DOM Elements ---
        // These are accessed globally, ensure they exist in the HTML structure.
        const adminPanel = document.getElementById('adminPanel');
        const analyticsPanel = document.getElementById('analyticsPanel');
        const redirectPanel = document.getElementById('redirectPanel');
        const featuresPanel = document.getElementById('featuresPanel');
        const algorithmsPanel = document.getElementById('algorithmsPanel');
        const linksTable = document.getElementById('linksTable');
        const signInButton = document.getElementById('signInButton');
        const signOutButton = document.getElementById('signOutButton');
        const userProfile = document.getElementById('userProfile');
        const userPhoto = document.getElementById('userPhoto');
        const userName = document.getElementById('userName');        const authButtons = document.getElementById('authButtons');
        const navLinks = document.querySelectorAll('.nav-link');
        const adminOnlyElements = document.querySelectorAll('.admin-only');
        const globalLoader = document.querySelector('.global-loader');
        const generateBtn = document.getElementById('generateBtn');
        const updateBtn = document.getElementById('updateBtn');
        const redirectText = document.getElementById('redirectText');
        const redirectMessage = document.getElementById('redirectMessage');
        const backToHomeBtn = document.getElementById('backToHomeBtn');

        // Elements for the content card (used in redirection)
        const contentCard = document.getElementById('contentCard');
        const redirectLoader = document.getElementById('redirectLoader');
        const contentThumbnail = document.getElementById('contentThumbnail');
        const contentType = document.getElementById('contentType');
        const contentEpisode = document.getElementById('contentEpisode');
        const contentDate = document.getElementById('contentDate');
        const contentTitle = document.getElementById('contentTitle');
        const contentDescription = document.getElementById('contentDescription');        const contentViews = document.getElementById('contentViews');
        const contentCreated = document.getElementById('contentCreated');
        const contentMeta = document.getElementById('contentMeta');

        // Elements for notifications
        const successNotification = document.getElementById('successNotification');
        const errorNotification = document.getElementById('errorNotification');

        // Elements for link generation/update form
        const seriesNameInput = document.getElementById('seriesName');
        const originalUrlInput = document.getElementById('originalUrl');
        const socialTitleInput = document.getElementById('socialTitle');        const socialDescriptionInput = document.getElementById('socialDescription');
        const socialImageInput = document.getElementById('socialImage');
        const linkTypeSelect = document.getElementById('linkType');
        const totalEpisodesInput = document.getElementById('totalEpisodes');
        const startingEpisodeInput = document.getElementById('startingEpisode');
        const episodeErrorDiv = document.getElementById('episodeError');
        const customDomainInput = document.getElementById('customDomain');
        const generatedLinkInput = document.getElementById('generatedLink');
        const originalLinkDisplay = document.getElementById('originalLinkDisplay');
        const linkModal = document.getElementById('linkModal');
        const episodeCountWrapper = document.getElementById('episodeCountWrapper');
        const startingEpisodeWrapper = document.getElementById('startingEpisodeWrapper');
        const copyLinkBtn = document.getElementById('copyLinkBtn');        const shareLinkBtn = document.getElementById('shareLinkBtn');
        const viewAnalyticsBtn = document.getElementById('viewAnalyticsBtn');

        // Elements for social media preview
        const previewTitle = document.getElementById('previewTitle');
        const previewDescription = document.getElementById('previewDescription');
        const previewImage = document.getElementById('previewImage');
        const previewDomain = document.getElementById('previewDomain');

        // Elements for stats modal
        const statsModal = document.getElementById('statsModal');
        const statsLinkTitle = document.getElementById('statsLinkTitle');
        const statsLinkUrl = document.getElementById('statsLinkUrl');
        const totalVisitsElement = document.getElementById('totalVisits');
        const todayVisitsElement = document.getElementById('todayVisits');        const topCountryElement = document.getElementById('topCountry');
        const topDeviceElement = document.getElementById('topDevice');        const visitsChart = document.getElementById('visitsChart');
        const geoChart = document.getElementById('geoChart');
        const devicesChart = document.getElementById('devicesChart');
        const sourcesChart = document.getElementById('sourcesChart');

        // Elements for earnings modal
        const earningsModal = document.getElementById('earningsModal');
        const earningsLinkTitle = document.getElementById('earningsLinkTitle');
        const totalEarningsElement = document.getElementById('totalEarnings');
        const totalImpressionsElement = document.getElementById('totalImpressions');
        const averageRPMElement = document.getElementById('averageRPM');
        const todayEarningsElement = document.getElementById('todayEarnings');
        const arabVisitsElement = document.getElementById('arabVisits');
        const arabEarningsElement = document.getElementById('arabEarnings');
        const foreignVisitsElement = document.getElementById('foreignVisits');
        const foreignEarningsElement = document.getElementById('foreignEarnings');
        const arabProgress = document.getElementById('arabProgress');
        const foreignProgress = document.getElementById('foreignProgress');
        const earningsChart = document.getElementById('earningsChart');

        // Elements for global stats (from loadLiveStats)
        const totalLinksStat = document.getElementById('totalLinksStat');
        const totalClicksStat = document.getElementById('totalClicksStat');
        const todayClicksStat = document.getElementById('todayClicksStat');
        const uptimeStat = document.getElementById('uptimeStat');

        // Elements for confirmation modal
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmationMessage = document.getElementById('confirmationMessage');
        const confirmActionBtn = document.getElementById('confirmActionBtn');

        // Navigation links (for explicit event listeners)
        const adminLink = document.getElementById('adminLink');
        const statsLink = document.getElementById('statsLink');
        const featuresLink = document.getElementById('featuresLink');
        const homeLink = document.getElementById('homeLink');        // Elements for Algorithms UI Controller
        const algorithmsGrid = document.getElementById('algorithmsGrid');
        const runAllAlgorithmsBtn = document.getElementById('runAllAlgorithms'); // Renamed to avoid clash with method
        const algorithmReportBtn = document.getElementById('algorithmReport'); // Renamed to avoid clash with method
        const masterAlgorithmSwitch = document.getElementById('masterAlgorithmSwitch');
        const activeAlgorithmsCount = document.getElementById('activeAlgorithmsCount');
        const performanceRate = document.getElementById('performanceRate');
        const lastAlgorithmUpdate = document.getElementById('lastAlgorithmUpdate');
        const algorithmResults = document.getElementById('algorithmResults');

        // New: Elements for Trailer Video System
        const trailerUrl = document.getElementById('trailerUrl');
        const trailerField = document.getElementById('trailerField');
        const imageField = document.getElementById('imageField');
        const trailerPreview = document.getElementById('trailerPreview');
        const trailerFrame = document.getElementById('trailerFrame');

        // New: Elements for Bulk Link Importer
        const bulkImportPanel = document.getElementById('bulkImportPanel'); // Main panel for bulk import
        const bulkContentType = document.getElementById('bulkContentType');
        const nextToStep2 = document.getElementById('nextToStep2');
        const bulkFileInput = document.getElementById('bulkFileInput');        const fileUploadArea = document.getElementById('fileUploadArea');
        const selectFileBtn = document.getElementById('selectFileBtn');
        const removeFileBtn = document.getElementById('removeFile');
        const downloadTemplate = document.getElementById('downloadTemplate');
        const backToStep1 = document.getElementById('backToStep1');
        const nextToStep3 = document.getElementById('nextToStep3');
        const backToStep2 = document.getElementById('backToStep2');
        const startBulkImport = document.getElementById('startBulkImport');
        const cancelImport = document.getElementById('cancelImport');
        const viewResults = document.getElementById('viewResults');
        const exportResults = document.getElementById('exportResults');
        const startNewImport = document.getElementById('startNewImport');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const fileInfo = document.getElementById('fileInfo');
        const templateInfo = document.getElementById('templateInfo');
        const totalRows = document.getElementById('totalRows');
        const validRows = document.getElementById('validRows');
        const errorRows = document.getElementById('errorRows');
        const estimatedTime = document.getElementById('estimatedTime');
        const previewTable = document.getElementById('previewTable');
        const importProgress = document.getElementById('importProgress');
        const progressPercent = document.getElementById('progressPercent');
        const progressText = document.getElementById('progressText');
        const processedCount = document.getElementById('processedCount');
        const skippedCount = document.getElementById('skippedCount');
        const failedCount = document.getElementById('failedCount');
        const processingLog = document.getElementById('processingLog');
        const bulkImportLink = document.getElementById('bulkImportLink'); // Nav link
        const bulkDomainInput = document.getElementById('bulkDomain');


        // --- Constants ---
        const arabicCountries = [
            'السعودية', 'الإمارات', 'مصر', 'العراق', 'الأردن', 'لبنان',
            'سوريا', 'الكويت', 'قطر', 'البحرين', 'عمان', 'اليمن',
            'المغرب', 'الجزائر', 'تونس', 'ليبيا', 'السودان', 'الصومال',
            'موريتانيا', 'جيبوتي', 'جزر القمر', 'فلسطين',
            'Saudi Arabia', 'United Arab Emirates', 'Egypt', 'Iraq',
            'Jordan', 'Lebanon', 'Syria', 'Kuwait', 'Qatar', 'Bahrain',
            'Oman', 'Yemen', 'Morocco', 'Algeria', 'Tunisia', 'Libya',
            'Sudan', 'Somalia', 'Mauritania', 'Djibouti', 'Comoros', 'Palestine'
        ];

        // --- Helper Functions (General) ---

        // Check Firebase connection before use
        function checkFirebaseConnection() {
            if (!firebase || !firebase.firestore) {
                console.error('Firebase is not available.');
                showNotification('error', 'خطأ في الاتصال بقاعدة البيانات');
                return false;
            }
            return true;
        }

        // Set loading state (consolidated function)
        function setLoading(show) {
            if (globalLoader) {                globalLoader.style.display = show ? 'flex' : 'none';
            } else {
                console.warn('Global loader element not found.');
            }
        }

        // Format date and time to English locale
        function formatFirestoreDateTime(timestamp) {
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp.seconds * 1000);
            return date.toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });        }        // Show notification (improved version)
        function showNotification(type, message, duration = 3000) {
            const notification = document.getElementById(`${type}Notification`);
            if (!notification) {                console.warn(`Notification element for type "${type}" not found.`);
                return;
            }
            const messageEl = notification.querySelector('div:first-child');

            if (messageEl) {
                messageEl.textContent = message;
            }
            notification.style.display = 'block';
            setTimeout(() => {
                notification.classList.add('show');
            }, 10); // Small delay to trigger CSS transition

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 400); // Wait for transition to finish before hiding display
            }, duration);
        }

        // Copy to clipboard with fallback and error handling
        function copyToClipboard() {
            if (!generatedLinkInput || !copyLinkBtn) {
                console.error('Required DOM elements for copyToClipboard not found.');
                showNotification('error', 'خطأ: عناصر النسخ غير موجودة.');
                return;
            }

            generatedLinkInput.select();            generatedLinkInput.setSelectionRange(0, 99999); // For mobile devices

            try {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(generatedLinkInput.value)
                        .then(() => {
                            showNotification('success', 'تم نسخ الرابط إلى الحافظة!');
                            if (copyLinkBtn) {
                                copyLinkBtn.innerHTML = '<i class="fas fa-check me-1"></i>تم النسخ!';
                                setTimeout(() => {
                                    copyLinkBtn.innerHTML = '<i class="fas fa-copy me-1"></i>نسخ';
                                }, 2000);
                            }
                        })
                        .catch(err => {
                            console.error('Failed to copy using Clipboard API: ', err);                            showNotification('error', 'فشل نسخ الرابط');
                        });
                } else {
                    // Fallback for older browsers
                    document.execCommand('copy');
                    showNotification('success', 'تم نسخ الرابط إلى الحافظة!');
                    if (copyLinkBtn) {
                        copyLinkBtn.innerHTML = '<i class="fas fa-check me-1"></i>تم النسخ!';
                        setTimeout(() => {                            copyLinkBtn.innerHTML = '<i class="fas fa-copy me-1"></i>نسخ';
                        }, 2000);
                    }
                }
            } catch (err) {
                console.error('Failed to copy: ', err);
                showNotification('error', 'فشل نسخ الرابط');
            }
        }

        // URL validation
        function isValidUrl(url) {
            try {
                new URL(url);
                return true;
            } catch (e) {
                return false;
            }
        }
        // New: YouTube URL validation
        function isValidYouTubeUrl(url) {
            const youtubeRegex = /^(https?:\/\/)?(www\.)?(youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)[a-zA-Z0-9_-]{11}.*$/;
            return youtubeRegex.test(url);
        }

        // Series name validation (allows Arabic characters and standard symbols)
        function isValidSeriesName(name) {
            const regex = /^[\p{Script=Arabic}\w\s\-_]+$/u;
            return regex.test(name);
        }

        // Get type name in Arabic
        function getTypeName(type) {
            const types = {
                'series': 'مسلسل',
                'movie': 'فيلم',
                'match': 'مباراة',
                'recipe': 'وصفة',
                'game': 'لعبة',
                'app': 'تطبيق',
                'channel': 'قناة',
                'reels': 'ريلز'
            };
            return types[type] || 'غير محدد';        }

        // Placeholder for ensureImageVisibility (re-added as requested in the snippet)
        function ensureImageVisibility(imgElement) {
            if (!imgElement) return;
            imgElement.style.display = 'block';
            imgElement.style.visibility = 'visible';
            imgElement.style.opacity = '1';
            console.log('Image visibility ensured for:', imgElement.id);
        }        // --- UI/Display Functions ---

        // دالة لإظهار جميع عناصر البطاقة
        function showContentCard() {
            const elements = [
                contentCard,
                contentThumbnail,
                contentType,
                contentTitle,
                contentDescription,
                contentMeta
            ];

            elements.forEach(element => {
                if (element) {
                    element.style.display = element === contentThumbnail ? 'block' :                                           element === contentMeta ? 'flex' : 'block';
                    element.style.visibility = 'visible';
                    element.style.opacity = '1';
                }
            });

            console.log('تم إظهار جميع عناصر البطاقة');
        }

        // دالة لتطبيق أنماط الإظهار القسري (Fixed selectors to use IDs)
        function forceShowElements() {
            const forceShowCSS = `
                #contentCard,
                #contentThumbnail,
                .content-info,
                #contentMeta,
                #contentTitle,
                #contentDescription,
                #contentType,                #contentEpisode,
                #contentDate {
                    display: block !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                }

                #contentMeta {
                    display: flex !important;
                }

                #contentType,
                #contentEpisode,
                #contentDate {
                    display: inline-block !important;
                }
            `;

            // إضافة CSS للصفحة
            const style = document.createElement('style');
            style.textContent = forceShowCSS;
            document.head.appendChild(style);

            console.log('تم تطبيق أنماط الإظهار القسري');        }

        // Update social media preview
        function updateSocialPreview() {
            const title = socialTitleInput ? socialTitleInput.value.trim() || 'عنوان المحتوى' : 'عنوان المحتوى';            const description = socialDescriptionInput ? socialDescriptionInput.value.trim() || 'وصف المحتوى الذي سيظهر على منصات التواصل الاجتماعي' : 'وصف المحتوى الذي سيظهر على منصات التواصل الاجتماعي';
            const image = socialImageInput ? socialImageInput.value.trim() || 'https://via.placeholder.com/500x300/4A154B/FFFFFF?text=صورة+المحتوى' : 'https://via.placeholder.com/500x300/4A154B/FFFFFF?text=صورة+المحتوى';
            const domain = customDomainInput ? customDomainInput.value.trim() || 'turkify.com' : 'turkify.com';

            if (previewTitle) previewTitle.textContent = title;
            if (previewDescription) previewDescription.textContent = description;
            
            // Integrate trailerSystem's preview update logic
            if (trailerSystem && typeof trailerSystem.updateSocialMediaPreview === 'function') {
                trailerSystem.updateSocialMediaPreview(trailerSystem.extractYouTubeVideoId(trailerUrl?.value || ''));
            } else if (previewImage) {
                 previewImage.src = image; // Fallback if trailerSystem not ready/available
            }

            if (previewDomain) previewDomain.textContent = domain;
        }


        // --- Panel Management Functions ---

        // Hide all panels (consolidated and comprehensive function)
        function hideAllPanels() {
            const panels = [
                adminPanel,
                analyticsPanel,
                redirectPanel,
                featuresPanel,
                algorithmsPanel,
                bulkImportPanel // Add this
            ];

            panels.forEach(panel => {                if (panel) panel.style.display = 'none';
            });

            // Hide dynamic content containers (e.g., dashboard, super admin)
            const dynamicContainers = [
                '.dashboard-container',
                '.super-admin-panel'
            ];

            dynamicContainers.forEach(selector => {
                const containers = document.querySelectorAll(selector);
                containers.forEach(container => container.remove());
            });
        }

        // Highlight active navigation item (now uses updateActiveNavLink)        function highlightActiveNav() {
            const hash = window.location.hash.substring(1);
            updateActiveNavLink(hash === '' ? 'features' : hash);
        }

        // New: Function to update active nav link
        function updateActiveNavLink(hash) {
            navLinks.forEach(link => {
                link.classList.remove('nav-active');
                const linkHash = link.getAttribute('href').substring(1);
                if (linkHash === hash) {
                    link.classList.add('nav-active');
                }
            });
        }

        // Show admin panel
        function showAdminPanel() {
            hideAllPanels();
            if (adminPanel) {
                adminPanel.classList.remove('admin-only');
                adminPanel.style.display = 'block';
                loadLinks();
            }
        }

        // Show analytics panel
        function showAnalytics() {
            hideAllPanels();
            if (analyticsPanel) {
                analyticsPanel.style.display = 'block';
                loadLiveStats();            }
        }

        // Show features panel
        function showFeatures() {
            hideAllPanels();
            if (featuresPanel) {
                featuresPanel.style.display = 'block';
            }
        }

        // Show algorithms panel
        function showAlgorithms() {
            hideAllPanels();
            if (algorithmsPanel) algorithmsPanel.style.display = 'block';
            console.log('Showing Algorithms Panel.');
            // algorithmsUI.renderAlgorithmsGrid(); // Re-render if dynamic content changes often
            // algorithmsUI.updateSystemStatus(); // Update status on panel entry
        }

        // New: Show bulk import panel
        function showBulkImportPanel() {
            hideAllPanels();
            if (bulkImportPanel) {
                bulkImportPanel.style.display = 'block';
                // Reset importer state if needed, or rely on its own init
                if (bulkImporter) bulkImporter.resetImporter();
            }
        }

        // Placeholder for showDashboard function
        function showDashboard() {
            hideAllPanels();
            console.log('Showing Dashboard (functionality not fully implemented in this snippet).');
        }

        // Placeholder for showSuperAdminPanel function
        function showSuperAdminPanel() {
            hideAllPanels();
            console.log('Showing Super Admin Panel (functionality not fully implemented in this snippet).');
        }
        // Initialize page based on URL and hash
        function initPage() {
            const urlParams = new URLSearchParams(window.location.search);
            const linkId = urlParams.get('id');
            const hash = window.location.hash.substring(1);

            highlightActiveNav();

            if (linkId) {
                forceShowElements();
                showContentCard();

                setTimeout(() => {
                    handleRedirection(linkId);
                }, 100);
            } else {
                switch(hash) {
                    case 'admin':
                        if (auth.currentUser) {
                            showAdminPanel();
                        } else {
                            showFeatures();                        }
                        break;
                    case 'analytics':
                        showAnalytics();
                        break;
                    case 'algorithms':
                        showAlgorithms();
                        break;
                    case 'bulk-import': // New case
                        showBulkImportPanel();
                        break;
                    case 'dashboard':
                        showDashboard();                        break;
                    case 'super-admin':
                        showSuperAdminPanel();
                        break;
                    case 'features':
                        showFeatures();
                        break;
                    case 'home':
                    case '':                    default:
                        showFeatures();
                        break;
                }
            }
        }

        // --- Visitor Information & Analytics ---

        // Helper function to get visitor information from ip-api (original method)        async function getVisitorInfo() {
            try {
                const ipRes = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipRes.json();
                const ip = ipData.ip;

                const response = await fetch(`https://ip-api.com/json/${ip}?fields=status,message,country,countryCode,regionName,city,isp,org,query&lang=ar`);
                const data = await response.json();

                if (data.status === 'success') {
                    return {
                        country: data.country || "غير معروف",
                        region: data.regionName || "غير معروف",
                        city: data.city || "غير معروف",
                        ip: ip,
                        org: data.org || "غير معروف"
                    };
                }
                return {
                    country: "غير معروف",                    region: "غير معروف",
                    city: "غير معروف",
                    ip: "غير معروف",
                    org: "غير معروف"
                };
            } catch (error) {
                console.error("Error getting visitor info:", error);
                return {
                    country: "غير معروف",                    region: "غير معروف",
                    city: "غير معروف",
                    ip: "غير معروف",
                    org: "غير معروف"
                };
            }
        }

        // Helper functions to detect device details
        function detectDeviceType() {
            const ua = navigator.userAgent.toLowerCase();
            if (ua.includes("smart-tv") || ua.includes("hbbtv") || ua.includes("appletv")) return "تلفاز ذكي";
            if (/mobile|iphone|ipod|android/.test(ua)) return "هاتف";
            if (/tablet|ipad/.test(ua)) return "تابلت";
            if (/windows|mac|linux/.test(ua)) return "كمبيوتر";
            return "غير معروف";
        }

        function detectOS() {
            const ua = navigator.userAgent;
            if (ua.includes("Android")) return "Android";
            if (ua.includes("iPhone") || ua.includes("iPad")) return "iOS";
            if (ua.includes("Windows")) return "Windows";            if (ua.includes("Mac OS")) return "macOS";
            if (ua.includes("Linux")) return "Linux";
            return "غير معروف";
        }

        function detectBrowser() {
            const ua = navigator.userAgent;
            if (ua.includes("Chrome") && !ua.includes("Edge")) return "Chrome";
            if (ua.includes("Firefox")) return "Firefox";
            if (ua.includes("Safari") && !ua.includes("Chrome")) return "Safari";
            if (ua.includes("Edge")) return "Edge";
            if (ua.includes("Opera") || ua.includes("OPR")) return "Opera";
            return "غير معروف";
        }

        function detectReferrer() {
            const ref = document.referrer;
            if (!ref) return "مباشر";
            if (ref.includes("facebook.com")) return "فيسبوك";
            if (ref.includes("instagram.com")) return "إنستغرام";
            if (ref.includes("youtube.com")) return "يوتيوب";
            if (ref.includes("twitter.com") || ref.includes("x.com")) return "تويتر";
            if (ref.includes("tiktok.com")) return "تيك توك";
            if (ref.includes("google.com")) return "بحث جوجل";
            return "غير معروف";
        }

        // Updated visit recording function for GitHub Pages compatibility
        async function recordVisit(linkId) {
            try {
                let ipInfo = {
                    country: "غير معروف",
                    region: "غير معروف",
                    city: "غير معروف",
                    ip: "غير معروف",
                    org: "غير معروف"
                };

                try {
                    const response = await fetch('https://ipapi.co/json/');
                    if (response.ok) {
                        const data = await response.json();                        ipInfo = {
                            country: data.country_name || "غير معروف",
                            region: data.region || "غير معروف",
                            city: data.city || "غير معروف",
                            ip: data.ip || "غير معروف",
                            org: data.org || "غير معروف"
                        };
                    }
                } catch (ipError) {
                    console.log('Failed to fetch IP information from ipapi.co:', ipError.message);
                }

                const visitData = {
                    timestamp: new Date(),
                    linkId: linkId,
                    country: ipInfo.country,
                    region: ipInfo.region,
                    city: ipInfo.city,
                    ip: ipInfo.ip,
                    org: ipInfo.org,
                    device: detectDeviceType(),
                    browser: detectBrowser(),
                    os: detectOS(),
                    source: detectReferrer(),
                    userAgent: navigator.userAgent.substring(0, 255)
                };

                await db.collection('visits').add(visitData);                await db.collection('links').doc(linkId).update({
                    clicks: firebase.firestore.FieldValue.increment(1),
                    lastVisit: firebase.firestore.FieldValue.serverTimestamp()
                });

                console.log('Visit recorded successfully.');

            } catch (error) {
                console.error('Failed to record visit:', error);

                try {
                    await db.collection('links').doc(linkId).update({                        clicks: firebase.firestore.FieldValue.increment(1)
                    });
                } catch (basicError) {
                    console.error('Failed to record basic click count:', basicError);
                }
            }        }

        // Function to generate a descriptive episode description using Deepseek API
        async function generateEpisodeDescription(linkId, seriesName, episodeNum) {
            try {
                const SECRET_KEY = "MySuperSecret123!";
                const response = await fetch('/.netlify/functions/deepseek-proxy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-secret-key': SECRET_KEY
                    },
                    body: JSON.stringify({
                        seriesName,                        episodeNum,
                        linkId
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Network error or API issue: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                return data.description;

            } catch (error) {
                console.error('Failed to generate description:', error);

                try {
                    const linkDoc = await db.collection('links').doc(linkId).get();
                    if (linkDoc.exists) {
                        const linkData = linkDoc.data();

                        if (linkData.socialDescription) {
                            return linkData.socialDescription;                        }

                        return `مسلسل ${seriesName} - الحلقة ${episodeNum}: ${linkData.seriesName} يتناول قصة شيقة تستحق المشاهدة`;
                    }
                } catch (firestoreError) {
                    console.error('Failed to fetch stored description:', firestoreError);
                }

                return `شاهد الحلقة ${episodeNum} من ${seriesName} بأحداث مشوقة وتطورات غير متوقعة!`;
            }        }

        // --- Link Management Functions (Generate, Update, Delete, Load) ---

        // Original generateLink function, now potentially wrapped
        async function originalGenerateLink() {
            if (seriesNameInput) seriesNameInput.classList.remove('is-invalid');
            if (originalUrlInput) originalUrlInput.classList.remove('is-invalid');
            if (episodeErrorDiv) episodeErrorDiv.style.display = 'none';

            const seriesName = seriesNameInput ? seriesNameInput.value.trim() : '';            const originalUrl = originalUrlInput ? originalUrlInput.value.trim() : '';
            const socialTitle = socialTitleInput ? socialTitleInput.value.trim() : '';
            const socialDescription = socialDescriptionInput ? socialDescriptionInput.value.trim() : '';
            const linkType = linkTypeSelect ? linkTypeSelect.value : 'series';
            const totalEpisodes = totalEpisodesInput ? parseInt(totalEpisodesInput.value) || 0 : 0;
            const startingEpisode = startingEpisodeInput ? parseInt(startingEpisodeInput.value) || 1 : 1;

            if (!isValidUrl(originalUrl)) {
                if (originalUrlInput) originalUrlInput.classList.add('is-invalid');
                showNotification('error', 'الرجاء إدخال رابط صالح');
                return;
            }

            if (!seriesName || !isValidSeriesName(seriesName)) {
                if (seriesNameInput) seriesNameInput.classList.add('is-invalid');                showNotification('error', 'الرجاء إدخال اسم سلسلة صالح');                return;
            }

            if (linkType === 'series' && (!totalEpisodes || totalEpisodes < 1)) {
                if (episodeErrorDiv) episodeErrorDiv.style.display = 'block';                showNotification('error', 'الرجاء إدخال عدد حلقات صحيح');
                return;
            }

            try {
                const token = await new Promise((resolve) => {
                    grecaptcha.ready(() => {
                        grecaptcha.execute('6LesFYErAAAAAOpY8Pbc0furepnxPt0WyJorH5Qw', {action: 'create_link'})
                            .then(resolve);
                    });
                });

                if (generateBtn) {
                    generateBtn.disabled = true;
                    generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>جاري الإنشاء...';
                }

                const linkId = Math.floor(100000 + Math.random() * 900000).toString();

                const customDomain = customDomainInput ? customDomainInput.value.trim() || 'turkify.com' : 'turkify.com';

                const paramName = linkType === 'series' ? 'halqat-alyawm-min-musalsal' : linkType;
                const newLink = `https://${customDomain}/?${paramName}=${encodeURIComponent(seriesName)}&id=${linkId}`;

                const user = auth.currentUser;

                const videoData = trailerSystem.getVideoDataForSave();

                const linkData = {
                    id: linkId,
                    seriesName: seriesName,
                    linkType: linkType,
                    originalUrl: originalUrl,
                    shortUrl: newLink,
                    customDomain: customDomain,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    userId: user ? user.uid : null,
                    clicks: 0,
                    socialTitle: socialTitle || `Turkify - ${getTypeName(linkType)} ${seriesName}`,
                    socialDescription: socialDescription || `شاهد ${seriesName} الآن على Turkify!`,
                    // Merged videoData directly here
                    ...videoData
                };

                if (linkType === 'series') {
                    linkData.totalEpisodes = totalEpisodes;
                    linkData.startingEpisode = startingEpisode;                    linkData.startDate = firebase.firestore.Timestamp.now();
                }

                await db.collection('links').doc(linkId).set(linkData);

                if (generatedLinkInput) generatedLinkInput.value = newLink;
                if (originalLinkDisplay) originalLinkDisplay.textContent = originalUrl;

                if (linkModal) {
                    const modal = new bootstrap.Modal(linkModal);
                    modal.show();
                }

                showNotification('success', 'تم إنشاء الرابط بنجاح!');

                if (seriesNameInput) seriesNameInput.value = '';
                if (originalUrlInput) originalUrlInput.value = '';
                if (totalEpisodesInput) totalEpisodesInput.value = '';
                if (startingEpisodeInput) startingEpisodeInput.value = '1';
                if (episodeCountWrapper) episodeCountWrapper.style.display = 'none';
                if (startingEpisodeWrapper) startingEpisodeWrapper.style.display = 'none';                if (socialTitleInput) socialTitleInput.value = '';
                if (socialDescriptionInput) socialDescriptionInput.value = '';
                if (socialImageInput) socialImageInput.value = '';
                if (trailerUrl) trailerUrl.value = ''; // Clear trailer URL
                if (trailerSystem) trailerSystem.hideTrailerPreview(); // Hide preview

                if (generateBtn) {
                    generateBtn.disabled = false;                    generateBtn.innerHTML = '<i class="fas fa-bolt me-2"></i>إنشاء الرابط';
                }

                loadLinks();
            } catch (error) {
                console.error('Error saving link:', error);
                showNotification('error', `فشل في حفظ الرابط: ${error.message}`);
                if (generateBtn) {
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = '<i class="fas fa-bolt me-2"></i>إنشاء الرابط';
                }
            }
        }

        // Wrapper for generateLink to include trailer validation
        let generateLink = async function() {
            if (trailerSystem && !trailerSystem.validateTrailerData()) {
                return;
            }
            await originalGenerateLink();
        };


        // Original updateLink function, now potentially wrapped
        async function originalUpdateLink() {
            if (seriesNameInput) seriesNameInput.classList.remove('is-invalid');
            if (originalUrlInput) originalUrlInput.classList.remove('is-invalid');
            if (episodeErrorDiv) episodeErrorDiv.style.display = 'none';

            const seriesName = seriesNameInput ? seriesNameInput.value.trim() : '';
            const originalUrl = originalUrlInput ? originalUrlInput.value.trim() : '';
            const socialTitle = socialTitleInput ? socialTitleInput.value.trim() : '';
            const socialDescription = socialDescriptionInput ? socialDescriptionInput.value.trim() : '';
            const linkType = linkTypeSelect ? linkTypeSelect.value : 'series';
            const totalEpisodes = totalEpisodesInput ? parseInt(totalEpisodesInput.value) || 0 : 0;
            const startingEpisode = startingEpisodeInput ? parseInt(startingEpisodeInput.value) || 1 : 1;

            if (!isValidUrl(originalUrl)) {
                if (originalUrlInput) originalUrlInput.classList.add('is-invalid');
                showNotification('error', 'الرجاء إدخال رابط صالح');
                return;
            }

            if (!seriesName || !isValidSeriesName(seriesName)) {
                if (seriesNameInput) seriesNameInput.classList.add('is-invalid');
                showNotification('error', 'الرجاء إدخال اسم سلسلة صالح');
                return;
            }

            if (linkType === 'series' && (!totalEpisodes || totalEpisodes < 1)) {
                if (episodeErrorDiv) episodeErrorDiv.style.display = 'block';
                showNotification('error', 'الرجاء إدخال عدد حلقات صحيح');
                return;
            }

            if (!currentEditingLinkId) {
                showNotification('error', 'لا يوجد رابط محدد للتحديث.');
                return;
            }

            try {                if (updateBtn) {
                    updateBtn.disabled = true;
                    updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>جاري الحفظ...';
                }

                const linkDoc = await db.collection('links').doc(currentEditingLinkId).get();

                if (!linkDoc.exists) {                    throw new Error('الرابط الذي تحاول تحديثه غير موجود.');
                }

                const videoData = trailerSystem.getVideoDataForSave();

                const updatedData = {
                    seriesName: seriesName,
                    originalUrl: originalUrl,
                    socialTitle: socialTitle,
                    socialDescription: socialDescription,
                    linkType: linkType,
                    // Merged videoData directly here
                    ...videoData                };

                if (linkType === 'series') {
                    updatedData.totalEpisodes = totalEpisodes;
                    updatedData.startingEpisode = startingEpisode;
                } else {                    updatedData.totalEpisodes = null;
                    updatedData.startingEpisode = null;
                }
                await db.collection('links').doc(currentEditingLinkId).update(updatedData);

                showNotification('success', 'تم تحديث الرابط بنجاح!');

                if (updateBtn) updateBtn.style.display = 'none';                if (generateBtn) generateBtn.style.display = 'block';

                if (seriesNameInput) seriesNameInput.value = '';
                if (originalUrlInput) originalUrlInput.value = '';
                if (totalEpisodesInput) totalEpisodesInput.value = '';
                if (startingEpisodeInput) startingEpisodeInput.value = '1';
                if (episodeCountWrapper) episodeCountWrapper.style.display = 'none';
                if (startingEpisodeWrapper) startingEpisodeWrapper.style.display = 'none';
                if (socialTitleInput) socialTitleInput.value = '';
                if (socialDescriptionInput) socialDescriptionInput.value = '';
                if (socialImageInput) socialImageInput.value = '';
                if (trailerUrl) trailerUrl.value = ''; // Clear trailer URL
                if (trailerSystem) trailerSystem.hideTrailerPreview(); // Hide preview

                currentEditingLinkId = null;

                if (updateBtn) {
                    updateBtn.disabled = false;
                    updateBtn.innerHTML = '<i class="fas fa-save me-2"></i>حفظ التغييرات';
                }

                loadLinks();
            } catch (error) {
                console.error('Error updating link:', error);
                showNotification('error', `فشل في تحديث الرابط: ${error.message}`);                if (updateBtn) {
                    updateBtn.disabled = false;
                    updateBtn.innerHTML = '<i class="fas fa-save me-2"></i>حفظ التغييرات';
                }
            }
        }

        // Wrapper for updateLink to include trailer validation
        let updateLink = async function() {
            if (trailerSystem && !trailerSystem.validateTrailerData()) {                return;
            }
            await originalUpdateLink();
        };

        // Edit link function (complete implementation)
        async function editLink(linkId) {
            setLoading(true);
            try {
                const linkDoc = await db.collection('links').doc(linkId).get();

                if (linkDoc.exists) {                    const linkData = linkDoc.data();

                    if (seriesNameInput) seriesNameInput.value = linkData.seriesName || '';                    if (originalUrlInput) originalUrlInput.value = linkData.originalUrl || '';
                    if (customDomainInput) customDomainInput.value = linkData.customDomain || 'turkify.com';                    if (linkTypeSelect) linkTypeSelect.value = linkData.linkType || 'series';
                    if (socialTitleInput) socialTitleInput.value = linkData.socialTitle || '';
                    if (socialDescriptionInput) socialDescriptionInput.value = linkData.socialDescription || '';

                    // Handle video/image fields based on link type
                    const isVideoContent = linkData.linkType === 'series' || linkData.linkType === 'movie';
                    if (isVideoContent) {
                        if (trailerUrl) trailerUrl.value = linkData.trailerUrl || '';
                        if (linkData.trailerUrl && trailerSystem) {
                            trailerSystem.validateAndPreviewTrailer(linkData.trailerUrl);
                        }
                        if (socialImageInput) socialImageInput.value = ''; // Clear social image if it's video content
                    } else {
                        if (socialImageInput) socialImageInput.value = linkData.socialImage || '';
                        if (trailerUrl) trailerUrl.value = ''; // Clear trailer URL if it's image content
                        if (trailerSystem) trailerSystem.hideTrailerPreview();
                    }

                    if (linkData.linkType === 'series') {
                        if (episodeCountWrapper) episodeCountWrapper.style.display = 'block';
                        if (startingEpisodeWrapper) startingEpisodeWrapper.style.display = 'block';
                        if (totalEpisodesInput) totalEpisodesInput.value = linkData.totalEpisodes || '';
                        if (startingEpisodeInput) startingEpisodeInput.value = linkData.startingEpisode || 1;
                    } else {
                        if (episodeCountWrapper) episodeCountWrapper.style.display = 'none';
                        if (startingEpisodeWrapper) startingEpisodeWrapper.style.display = 'none';
                    }

                    // Update content type based fields visibility (image/trailer fields)                    if (trailerSystem) trailerSystem.updateContentTypeBasedFields();

                    currentEditingLinkId = linkId;

                    if (updateBtn) updateBtn.style.display = 'block';
                    if (generateBtn) generateBtn.style.display = 'none';

                    window.location.hash = 'admin';
                    window.scrollTo(0, 0);

                    updateSocialPreview();
                } else {
                    showNotification('error', 'الرابط غير موجود.');
                }            } catch (error) {
                showNotification('error', `فشل في تحميل الرابط: ${error.message}`);
            } finally {
                setLoading(false);
            }
        }

        // Delete link function (complete implementation)
        async function deleteLink(linkId) {
            setLoading(true);
            try {
                await db.collection('links').doc(linkId).delete();
                showNotification('success', 'تم حذف الرابط بنجاح!');
                loadLinks();
            } catch (error) {
                console.error('Error deleting link:', error);
                showNotification('error', `فشل في حذف الرابط: ${error.message}`);
            } finally {
                setLoading(false);
            }
        }

        // Show confirmation modal (Bootstrap modal implementation)
        function showConfirmation(message, callback) {
            if (!confirmationModal || !confirmationMessage || !confirmActionBtn) {
                console.error('Confirmation modal elements not found.');
                if (confirm(message)) {
                    callback();
                }                return;
            }

            const modal = new bootstrap.Modal(confirmationModal);
            confirmationMessage.textContent = message;
            confirmActionBtn.onclick = function() {
                callback();
                modal.hide();
            };
            modal.show();
        }

        // Load links for admin panel
        async function loadLinks() {
            setLoading(true);
            if (linksTable) {
                linksTable.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center table-loader">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">جاري التحميل...</span>
                            </div>
                        </td>
                    </tr>
                `;
            }

            try {
                const user = auth.currentUser;
                if (!user) {
                    if (linksTable) {
                        linksTable.innerHTML = `
                            <tr>
                                <td colspan="7" class="text-center py-5">
                                    <div class="alert alert-info">
                                        يرجى تسجيل الدخول لعرض الروابط الخاصة بك
                                    </div>
                                </td>
                            </tr>
                        `;
                    }
                    return;
                }                const querySnapshot = await db.collection('links').where('userId', '==', user.uid).get();                if (querySnapshot.empty) {
                    if (linksTable) {
                        linksTable.innerHTML = `
                            <tr>
                                <td colspan="7" class="text-center py-5">
                                    لا توجد روابط. قم بإنشاء رابطك الأول!
                                </div>
                                </td>
                            </tr>
                        `;
                    }
                    return;                }

                let tableContent = '';
                querySnapshot.forEach(doc => {
                    const link = doc.data();

                    const typeBadge = `<span class="link-type-badge type-${link.linkType || 'series'}">${getTypeName(link.linkType)}</span>`;

                    tableContent += `
                        <tr>
                            <td>${link.id}</td>
                            <td>${link.seriesName}</td>
                            <td>${typeBadge}</td>
                            <td>
                                <a href="${link.shortUrl}" target="_blank" class="short-url">
                                    ${link.shortUrl}
                                </a>
                            </td>
                            <td>${link.createdAt ? formatFirestoreDateTime(link.createdAt) : 'N/A'}</td>
                            <td><span class="clicks-badge">${link.clicks}</span></td>
                            <td class="action-buttons">
                                <button class="btn btn-sm btn-outline-primary stats-btn" data-id="${link.id}" aria-label="عرض الإحصائيات">
                                    <i class="fas fa-chart-bar"></i>                                </button>
                                <button class="btn btn-sm btn-outline-info copy-btn" data-link="${link.shortUrl}" aria-label="نسخ الرابط">
                                    <i class="fas fa-copy"></i>
                                </button>                                <button class="btn btn-sm btn-outline-primary edit-btn" data-id="${link.id}" aria-label="تعديل الرابط">                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${link.id}" aria-label="حذف الرابط">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-success earnings-btn" data-id="${link.id}" aria-label="الإيرادات">                                    <i class="fas fa-dollar-sign"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });

                if (linksTable) linksTable.innerHTML = tableContent;

                if (linksTable) {
                    linksTable.querySelectorAll('.stats-btn').forEach(btn => {
                        btn.addEventListener('click', async function() {
                            const linkId = this.getAttribute('data-id');

                            if (!linkId) {
                                showNotification('error', 'معرف الرابط غير صالح');
                                return;
                            }

                            this.disabled = true;
                            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                            try {
                                await showLinkStats(linkId);
                            } catch (error) {
                                console.error('Error:', error);
                                showNotification('error', 'فشل في تحميل الإحصائيات');
                            } finally {
                                this.disabled = false;
                                this.innerHTML = '<i class="fas fa-chart-bar"></i>';
                            }
                        });
                    });

                    linksTable.querySelectorAll('.copy-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const linkUrl = this.getAttribute('data-link');
                            navigator.clipboard.writeText(linkUrl)
                                .then(() => showNotification('success', 'تم نسخ الرابط إلى الحافظة!'))
                                .catch(err => {
                                    console.error('Failed to copy link from table:', err);
                                    showNotification('error', 'فشل نسخ الرابط');
                                });
                        });
                    });

                    linksTable.querySelectorAll('.edit-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const linkId = this.getAttribute('data-id');
                            editLink(linkId);
                        });
                    });

                    linksTable.querySelectorAll('.delete-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const linkId = this.getAttribute('data-id');
                            showConfirmation('هل أنت متأكد من رغبتك في حذف هذا الرابط؟', () => {
                                deleteLink(linkId);
                            });
                        });
                    });

                    linksTable.querySelectorAll('.earnings-btn').forEach(btn => {
                        btn.addEventListener('click', async function() {
                            const linkId = this.getAttribute('data-id');

                            if (!linkId) {
                                showNotification('error', 'معرف الرابط غير صالح');
                                return;
                            }

                            this.disabled = true;
                            const originalHTML = this.innerHTML;
                            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                            try {
                                const visitsQuery = await db.collection('visits')
                                    .where('linkId', '==', linkId)
                                    .limit(1)
                                    .get();                                if (visitsQuery.empty) {
                                    showNotification('info', 'لا توجد زيارات كافية لحساب الأرباح بعد');
                                    return;
                                }

                                await showEarnings(linkId);
                            } catch (error) {                                console.error('Error loading earnings:', error);
                                showNotification('error', 'فشل في تحميل بيانات الأرباح: ' + error.message);
                            } finally {
                                this.disabled = false;                                this.innerHTML = originalHTML;
                            }
                        });
                    });
                }
            } catch (error) {
                console.error('Error loading links:', error);                if (linksTable) {
                    linksTable.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center py-5">
                                <div class="alert alert-danger">
                                    فشل في تحميل الروابط: ${error.message}
                                </div>
                            </td>
                        </tr>
                    `;
                }
            } finally {
                setLoading(false);
            }
        }

        // Handle redirection with proper content display
        async function handleRedirection(linkId) {
            hideAllPanels();
            if (redirectPanel) redirectPanel.style.display = 'block';
            if (contentCard) { // Ensure contentCard is visible
                contentCard.style.display = 'block';
                contentCard.style.visibility = 'visible';
            }

            if (redirectLoader) redirectLoader.style.display = 'block';
            if (redirectMessage) redirectMessage.textContent = 'جاري تحميل المحتوى...';

            try {
                const linkDoc = await db.collection('links').doc(linkId).get();

                if (!linkDoc.exists) {
                    throw new Error('الرابط غير موجود في قاعدة البيانات');
                }

                const linkData = linkDoc.data();
                const destinationUrl = linkData.originalUrl;

                // Populate basic data
                if (contentTitle) {
                    contentTitle.textContent = linkData.seriesName || 'غير محدد';
                    contentTitle.style.display = 'block';
                    contentTitle.style.visibility = 'visible';
                }

                if (contentType) {
                    contentType.textContent = getTypeName(linkData.linkType || 'series');
                    contentType.style.display = 'inline-block';
                    contentType.style.visibility = 'visible';
                }

                // Handle video or image display
                const isVideoContent = linkData.linkType === 'series' || linkData.linkType === 'movie';

                if (isVideoContent && linkData.trailerVideoId && trailerSystem) {
                    // Display YouTube video
                    const videoHtml = trailerSystem.createVideoElementForRedirect(
                        linkData.trailerVideoId,
                        linkData.seriesName
                    );

                    // Replace image with video
                    if (contentThumbnail && contentThumbnail.parentNode) {
                        const videoDiv = document.createElement('div');
                        videoDiv.innerHTML = videoHtml;
                        // Check if contentThumbnail is still an img or already replaced
                        const existingVideoElement = contentThumbnail.parentNode.querySelector('.content-video');
                        if (existingVideoElement) {                             contentThumbnail.parentNode.replaceChild(videoDiv.firstElementChild, existingVideoElement);
                        } else {
                            contentThumbnail.parentNode.replaceChild(videoDiv.firstElementChild, contentThumbnail);                        }
                    }                    console.log('تم عرض فيديو trailer للمحتوى:', linkData.seriesName);
                } else {
                    // Display regular image
                    const imageUrl = linkData.socialImage ||
                                    linkData.thumbnailUrl ||
                                    'https://via.placeholder.com/800x300/4A154B/FFFFFF?text=' +
                                    encodeURIComponent(linkData.seriesName || 'محتوى');

                    // If a video element was previously inserted, remove it and re-insert the image
                    const existingVideoElement = contentCard?.querySelector('.content-video');
                    if (existingVideoElement && contentThumbnail) {                        existingVideoElement.parentNode.replaceChild(contentThumbnail, existingVideoElement);
                    }

                    if (contentThumbnail) {
                        contentThumbnail.src = imageUrl;
                        contentThumbnail.alt = linkData.seriesName || 'صورة المحتوى';
                        contentThumbnail.style.display = 'block';
                        contentThumbnail.style.visibility = 'visible';
                        contentThumbnail.onerror = function() {
                            this.src = 'https://via.placeholder.com/800x300/4A154B/FFFFFF?text=' +
                                      encodeURIComponent('لا توجد صورة');                            console.log('Failed to load image, using fallback image.');
                        };
                    }
                }


                let episodeNum = 1;
                let showEpisodeInfo = false;

                if (linkData.linkType === 'series' && linkData.startingEpisode && linkData.startDate) {
                    const createdAt = linkData.startDate.toDate();
                    const now = new Date();

                    // Calculate difference considering a fixed timezone offset (e.g., +3 for Riyadh)
                    const timezoneOffset = 3; // Example: GMT+3
                    const nowUTC = new Date(now.getTime() + (now.getTimezoneOffset() * 60000));
                    const startUTC = new Date(createdAt.getTime() + (createdAt.getTimezoneOffset() * 60000));

                    nowUTC.setHours(nowUTC.getHours() + timezoneOffset);
                    startUTC.setHours(startUTC.getHours() + timezoneOffset);

                    const msPerDay = 24 * 60 * 60 * 1000;                    const diffDays = Math.floor((nowUTC - startUTC) / msPerDay);

                    episodeNum = linkData.startingEpisode + diffDays;

                    if (linkData.totalEpisodes && episodeNum > linkData.totalEpisodes) {
                        episodeNum = linkData.totalEpisodes;
                    }

                    showEpisodeInfo = true;
                    if (redirectMessage) {
                        redirectMessage.innerHTML = `سيتم توجيهك لمشاهدة حلقة اليوم <span class="highlight">${episodeNum}</span> من المسلسل:<br><span class="highlight">${linkData.seriesName}</span>`;
                    }
                } else {
                    if (redirectMessage) {
                        redirectMessage.innerHTML = `سيتم توجيهك إلى <span class="highlight">${getTypeName(linkData.linkType)}</span>:<br><span class="highlight">${linkData.seriesName}</span>`;
                    }
                }

                // Show episode info
                if (showEpisodeInfo && contentEpisode) {
                    contentEpisode.textContent = `الحلقة ${episodeNum}`;
                    contentEpisode.style.display = 'inline-block';
                    contentEpisode.style.visibility = 'visible';
                } else if (contentEpisode) {
                    contentEpisode.style.display = 'none';
                }

                // Display date
                if (contentDate) {
                    const today = new Date();
                    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                    contentDate.textContent = today.toLocaleDateString('ar-EG', options);
                    contentDate.style.display = 'inline-block';
                    contentDate.style.visibility = 'visible';
                }

                // Update description
                let description = '';
                if (linkData.linkType === 'series') {
                    try {
                        description = await generateEpisodeDescription(linkId, linkData.seriesName, episodeNum);
                    } catch (error) {
                        console.log('Failed to generate description, falling back:', error);
                        description = linkData.socialDescription || `شاهد الحلقة ${episodeNum} من ${linkData.seriesName}`;
                    }
                } else {
                    description = linkData.socialDescription || linkData.seriesName || 'لا يوجد وصف متاح';
                }

                if (contentDescription) {
                    contentDescription.textContent = description;
                    contentDescription.style.display = 'block';
                    contentDescription.style.visibility = 'visible';
                }

                if (contentViews) { // Re-added from previous version                    const views = linkData.clicks || 0;
                    contentViews.textContent = `${views.toLocaleString()} مشاهدة`;
                    contentViews.style.display = 'block';
                    contentViews.style.visibility = 'visible';
                }

                if (contentCreated && linkData.createdAt) { // Re-added from previous version
                    const createdDate = linkData.createdAt.toDate();
                    contentCreated.textContent = createdDate.toLocaleDateString('ar-EG');
                    contentCreated.style.display = 'block';
                    contentCreated.style.visibility = 'visible';
                }

                // Record visit
                recordVisit(linkId);
                if (redirectLoader) redirectLoader.style.display = 'none';

                // Redirect after 15 seconds
                setTimeout(() => {
                    window.location.href = destinationUrl;
                }, 15000);

            } catch (error) {
                console.error('خطأ في معالجة إعادة التوجيه:', error);
                if (redirectLoader) redirectLoader.style.display = 'none';
                if (redirectMessage) {
                    redirectMessage.innerHTML = `
                        <strong>خطأ!</strong> فشل في تحميل بيانات الرابط.<br>
                        <span class="text-danger">${error.message}</span>
                    `;
                }
                if (contentTitle) contentTitle.textContent = 'خطأ في تحميل المحتوى';
                if (contentDescription) contentDescription.textContent = `حدث خطأ: ${error.message}`;
                if (contentType) contentType.textContent = 'خطأ';
            }
        }        // --- Analytics & Charting Functions ---

        // Show link statistics
        async function showLinkStats(linkId) {
            setLoading(true);

            try {
                const linkDoc = await db.collection('links').doc(linkId).get();

                if (!linkDoc.exists) {
                    throw new Error('الرابط غير موجود');
                }

                const linkData = linkDoc.data();

                const visitsQuery = await db.collection('visits')
                    .where('linkId', '==', linkId)
                    .orderBy('timestamp', 'desc')
                    .get();

                const visits = visitsQuery.docs.map(doc => doc.data());
                const totalVisits = visits.length;

                const today = new Date();                const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                const todayVisits = visits.filter(visit => {
                    const visitDate = visit.timestamp.toDate();
                    return visitDate >= startOfDay;
                }).length;
                const countryCounts = {};
                visits.forEach(visit => {
                    countryCounts[visit.country] = (countryCounts[visit.country] || 0) + 1;
                });
                const topCountry = Object.keys(countryCounts).length > 0 ? Object.keys(countryCounts).reduce((a, b) =>
                    countryCounts[a] > countryCounts[b] ? a : b, 'غير محدد'
                ) : 'غير محدد';

                const deviceCounts = {};
                visits.forEach(visit => {
                    deviceCounts[visit.device] = (deviceCounts[visit.device] || 0) + 1;
                });
                const topDevice = Object.keys(deviceCounts).length > 0 ? Object.keys(deviceCounts).reduce((a, b) =>
                    deviceCounts[a] > deviceCounts[b] ? a : b, 'غير محدد'
                ) : 'غير محدد';

                if (statsLinkTitle) statsLinkTitle.textContent = linkData.seriesName || 'غير محدد';
                if (statsLinkUrl) {                    statsLinkUrl.textContent = linkData.shortUrl || 'غير متاح';
                    statsLinkUrl.href = linkData.shortUrl || '#';
                }
                if (totalVisitsElement) totalVisitsElement.textContent = totalVisits.toLocaleString();
                if (todayVisitsElement) todayVisitsElement.textContent = todayVisits.toLocaleString();
                if (topCountryElement) topCountryElement.textContent = topCountry;
                if (topDeviceElement) topDeviceElement.textContent = topDevice;

                createRealTimeCharts(visits);
                if (statsModal) {
                    const modal = new bootstrap.Modal(statsModal);
                    modal.show();
                }

            } catch (error) {
                console.error('Error loading stats:', error);
                showNotification('error', 'فشل في تحميل الإحصائيات: ' + error.message);
            } finally {
                setLoading(false);
            }
        }        // Create charts for stats
        function createRealTimeCharts(visits) {            Chart.getChart('visitsChart')?.destroy();
            Chart.getChart('geoChart')?.destroy();
            Chart.getChart('devicesChart')?.destroy();
            Chart.getChart('sourcesChart')?.destroy();

            const last7Days = [];
            const visitsByDay = {};

            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toLocaleDateString('ar-EG');
                last7Days.push(dateStr);
                visitsByDay[dateStr] = 0;
            }
            visits.forEach(visit => {
                const visitDate = visit.timestamp.toDate().toLocaleDateString('ar-EG');                if (visitsByDay.hasOwnProperty(visitDate)) {
                    visitsByDay[visitDate]++;                }
            });

            const visitsCtx = visitsChart ? visitsChart.getContext('2d') : null;            if (visitsCtx) {
                new Chart(visitsCtx, {
                    type: 'line',
                    data: {
                        labels: last7Days,
                        datasets: [{
                            label: 'الزيارات',
                            data: last7Days.map(date => visitsByDay[date]),
                            borderColor: '#4A154B',
                            backgroundColor: 'rgba(74, 21, 75, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, ticks: { stepSize: 1 } },
                            x: {
                                ticks: {                                    maxTicksLimit: 7
                                }
                            }
                        }
                    }
                });
            }

            const countryCounts = {};
            visits.forEach(visit => {
                countryCounts[visit.country] = (countryCounts[visit.country] || 0) + 1;
            });

            const topCountries = Object.entries(countryCounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);

            const geoCtx = geoChart ? geoChart.getContext('2d') : null;
            if (geoCtx && topCountries.length > 0) {
                new Chart(geoCtx, {
                    type: 'doughnut',
                    data: {
                        labels: topCountries.map(([country]) => country),
                        datasets: [{
                            data: topCountries.map(([,count]) => count),
                            backgroundColor: ['#4A154B', '#EF5A5F', '#2EC4B6', '#FF9F1C', '#6C757D']
                        }]
                    },
                    options: {
                        responsive: true,                        plugins: { legend: { position: 'bottom' } }
                    }
                });
            }

            const deviceCounts = {};
            visits.forEach(visit => {
                deviceCounts[visit.device] = (deviceCounts[visit.device] || 0) + 1;
            });

            const devicesCtx = devicesChart ? devicesChart.getContext('2d') : null;
            if (devicesCtx && Object.keys(deviceCounts).length > 0) {
                new Chart(devicesCtx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(deviceCounts),
                        datasets: [{
                            data: Object.values(deviceCounts),
                            backgroundColor: ['#4A154B', '#2EC4B6', '#EF5A5F', '#FF9F1C']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
            }

            const sourceCounts = {};
            visits.forEach(visit => {
                sourceCounts[visit.source] = (sourceCounts[visit.source] || 0) + 1;
            });

            const sourcesCtx = sourcesChart ? sourcesChart.getContext('2d') : null;
            if (sourcesCtx && Object.keys(sourceCounts).length > 0) {                new Chart(sourcesCtx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(sourceCounts),
                        datasets: [{
                            label: 'الزيارات',
                            data: Object.values(sourceCounts),
                            backgroundColor: '#4A154B'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                    }
                });
            }
        }

        // فلترة الأرباح حسب الفترة الزمنية
        function filterEarningsByTime(visits, timePeriod) {            const now = new Date();
            let startDate;

            switch(timePeriod) {
                case 'اليوم':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    break;
                case 'أسبوع':
                    startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'شهر':
                    startDate = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
                    break;
                case '3 أشهر':
                    startDate = new Date(now.getFullYear(), now.getMonth() - 3, now.getDate());
                    break;
                case 'سنة':
                    startDate = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());                    break;
                default:
                    startDate = new Date(0);
            }

            const filteredVisits = visits.filter(visit => {
                const visitDate = visit.timestamp.toDate();
                return visitDate >= startDate;
            });

            let arabVisits = 0;
            let foreignVisits = 0;

            filteredVisits.forEach(visit => {
                if (arabicCountries.includes(visit.country)) {
                    arabVisits++;
                } else {
                    foreignVisits++;
                }
            });

            const arabEarnings = (arabVisits / 1000) * 1.00;
            const foreignEarnings = (foreignVisits / 1000) * 3.00;
            const totalEarnings = arabEarnings + foreignEarnings;

            return {
                arabVisits,
                foreignVisits,
                arabEarnings,
                foreignEarnings,
                totalEarnings,
                totalVisits: arabVisits + foreignVisits
            };
        }

        // فحص صحة البيانات قبل حساب الأرباح
        function validateEarningsData(visits) {
            const validVisits = visits.filter(visit => {                return visit &&
                       visit.timestamp &&
                       visit.country &&                       typeof visit.country === 'string' &&
                       visit.linkId;
            });

            if (validVisits.length !== visits.length) {
                console.warn(`تم تجاهل ${visits.length - validVisits.length} زيارة لعدم اكتمال البيانات`);
            }

            return validVisits;
        }

        // إضافة معلومات مفيدة للمستخدم (currently logged to console)
        function generateEarningsReport(totalEarnings, arabVisits, foreignVisits) {
            const totalVisits = arabVisits + foreignVisits;            let report = `📊 تقرير الأرباح:\n`;
            report += `💰 إجمالي الأرباح: $${totalEarnings.toFixed(2)}\n`;
            report += `👥 إجمالي الزيارات: ${totalVisits.toLocaleString()}\n`;

            if (totalVisits > 0) {
                report += `🌍 الزيارات العربية: ${arabVisits} (${((arabVisits/totalVisits)*100).toFixed(1)}%)\n`;
                report += `🌎 الزيارات الأجنبية: ${foreignVisits} (${((foreignVisits/totalVisits)*100).toFixed(1)}%)\n`;

                if (foreignVisits < arabVisits) {
                    report += `\n💡 نصيحة: حاول الترويج في البلدان الأجنبية للحصول على أرباح أعلى!`;
                }            }

            return report;
        }

        // Show real earnings for a link
        async function showEarnings(linkId) {
            setLoading(true);
            currentEarningsLinkId = linkId;

            try {
                const linkDoc = await db.collection('links').doc(linkId).get();
                if (!linkDoc.exists) {
                    throw new Error('الرابط غير موجود');
                }                const linkData = linkDoc.data();

                const visitsQuery = await db.collection('visits')
                    .where('linkId', '==', linkId)
                    .orderBy('timestamp', 'desc')                    .get();

                const visits = visitsQuery.docs.map(doc => doc.data());

                const validVisits = validateEarningsData(visits);

                const allTimeEarningsData = filterEarningsByTime(validVisits, 'جميع الأوقات');

                if (earningsLinkTitle) earningsLinkTitle.textContent = linkData.seriesName || 'غير محدد';

                if (totalEarningsElement) totalEarningsElement.textContent = `$${allTimeEarningsData.totalEarnings.toFixed(2)}`;                if (totalImpressionsElement) totalImpressionsElement.textContent = allTimeEarningsData.totalVisits.toLocaleString();
                if (averageRPMElement) {
                    const averageRPM = allTimeEarningsData.totalVisits > 0 ? (allTimeEarningsData.totalEarnings / allTimeEarningsData.totalVisits) * 1000 : 0;
                    averageRPMElement.textContent = `$${averageRPM.toFixed(2)}`;
                }

                let todayArabVisits = 0;
                let todayForeignVisits = 0;
                const today = new Date();
                const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                validVisits.forEach(visit => {
                    const visitDate = visit.timestamp.toDate();
                    const isToday = visitDate >= startOfDay;
                    if (isToday) {
                        if (arabicCountries.includes(visit.country)) {
                            todayArabVisits++;
                        } else {
                            todayForeignVisits++;
                        }
                    }
                });
                const todayArabEarnings = (todayArabVisits / 1000) * 1.00;
                const todayForeignEarnings = (todayForeignVisits / 1000) * 3.00;
                const todayTotalEarnings = todayArabEarnings + todayForeignEarnings;
                if (todayEarningsElement) todayEarningsElement.textContent = `$${todayTotalEarnings.toFixed(2)}`;


                if (arabVisitsElement) arabVisitsElement.textContent = `${allTimeEarningsData.arabVisits.toLocaleString()} زيارة`;
                if (arabEarningsElement) arabEarningsElement.textContent = `$${allTimeEarningsData.arabEarnings.toFixed(2)}`;
                if (foreignVisitsElement) foreignVisitsElement.textContent = `${allTimeEarningsData.foreignVisits.toLocaleString()} زيارة`;
                if (foreignEarningsElement) foreignEarningsElement.textContent = `$${allTimeEarningsData.foreignEarnings.toFixed(2)}`;

                const arabPercentage = allTimeEarningsData.totalVisits > 0 ? (allTimeEarningsData.arabVisits / allTimeEarningsData.totalVisits) * 100 : 0;
                const foreignPercentage = allTimeEarningsData.totalVisits > 0 ? (allTimeEarningsData.foreignVisits / allTimeEarningsData.totalVisits) * 100 : 0;

                if (arabProgress) arabProgress.style.width = `${arabPercentage}%`;
                if (foreignProgress) foreignProgress.style.width = `${foreignPercentage}%`;                console.log(generateEarningsReport(allTimeEarningsData.totalEarnings, allTimeEarningsData.arabVisits, allTimeEarningsData.foreignVisits));

                await createEarningsChart(validVisits);                if (earningsModal) {
                    const modal = new bootstrap.Modal(earningsModal);
                    modal.show();
                    earningsModal.querySelectorAll('.time-btn').forEach(btn => {
                        btn.classList.remove('active');
                        if (btn.textContent === 'جميع الأوقات') {
                            btn.classList.add('active');
                        }
                    });
                }

            } catch (error) {
                console.error('Error loading earnings:', error);
                showNotification('error', 'فشل في تحميل بيانات الأرباح: ' + error.message);
            } finally {
                setLoading(false);
            }
        }

        // تحديث الأرباح مع الفلتر
        async function updateEarningsWithFilter(timePeriod) {
            if (!currentEarningsLinkId) return;

            try {
                setLoading(true);                const visitsQuery = await db.collection('visits')
                    .where('linkId', '==', currentEarningsLinkId)
                    .orderBy('timestamp', 'desc')
                    .get();

                const visits = visitsQuery.docs.map(doc => doc.data());
                const validVisits = validateEarningsData(visits);

                const filteredData = filterEarningsByTime(validVisits, timePeriod);

                if (totalEarningsElement) totalEarningsElement.textContent = `$${filteredData.totalEarnings.toFixed(2)}`;
                if (totalImpressionsElement) totalImpressionsElement.textContent = filteredData.totalVisits.toLocaleString();
                if (arabVisitsElement) arabVisitsElement.textContent = `${filteredData.arabVisits.toLocaleString()} زيارة`;
                if (arabEarningsElement) arabEarningsElement.textContent = `$${filteredData.arabEarnings.toFixed(2)}`;
                if (foreignVisitsElement) foreignVisitsElement.textContent = `${filteredData.foreignVisits.toLocaleString()} زيارة`;
                if (foreignEarningsElement) foreignEarningsElement.textContent = `$${filteredData.foreignEarnings.toFixed(2)}`;

                const arabPercentage = filteredData.totalVisits > 0 ? (filteredData.arabVisits / filteredData.totalVisits) * 100 : 0;
                const foreignPercentage = filteredData.totalVisits > 0 ? (filteredData.foreignVisits / filteredData.totalVisits) * 100 : 0;

                if (arabProgress) arabProgress.style.width = `${arabPercentage}%`;
                if (foreignProgress) foreignProgress.style.width = `${foreignPercentage}%`;                const averageRPM = filteredData.totalVisits > 0 ? (filteredData.totalEarnings / filteredData.totalVisits) * 1000 : 0;
                if (averageRPMElement) averageRPMElement.textContent = `$${averageRPM.toFixed(2)}`;

            } catch (error) {
                console.error('Error updating filtered earnings:', error);
                showNotification('error', 'فشل في تحديث البيانات المفلترة');
            } finally {
                setLoading(false);
            }
        }

        // Create real earnings chart
        async function createEarningsChart(visits) {
            Chart.getChart('earningsChart')?.destroy();

            const ctx = earningsChart ? earningsChart.getContext('2d') : null;
            if (!ctx) return;

            const last30DaysLabels = [];
            const earningsByDay = {};

            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const displayDate = date.toLocaleDateString('ar-EG', { month: 'short', day: 'numeric' });
                last30DaysLabels.push(displayDate);
                earningsByDay[dateStr] = { arab: 0, foreign: 0, total: 0 };
            }

            visits.forEach(visit => {
                const visitDate = visit.timestamp.toDate();
                const dateStr = visitDate.toISOString().split('T')[0];

                if (earningsByDay[dateStr]) {
                    if (arabicCountries.includes(visit.country)) {
                        earningsByDay[dateStr].arab += (1.00 / 1000);
                    } else {
                        earningsByDay[dateStr].foreign += (3.00 / 1000);
                    }
                    earningsByDay[dateStr].total = earningsByDay[dateStr].arab + earningsByDay[dateStr].foreign;
                }
            });

            const arabData = Object.values(earningsByDay).map(day => day.arab);
            const foreignData = Object.values(earningsByDay).map(day => day.foreign);
            const totalData = Object.values(earningsByDay).map(day => day.total);

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last30DaysLabels,
                    datasets: [
                        {
                            label: 'أرباح عربية ($1/1000)',
                            data: arabData,
                            borderColor: '#2EC4B6',
                            backgroundColor: 'rgba(46, 196, 182, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: false
                        },
                        {
                            label: 'أرباح أجنبية ($3/1000)',                            data: foreignData,
                            borderColor: '#4A154B',
                            backgroundColor: 'rgba(74, 21, 75, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: false
                        },
                        {
                            label: 'إجمالي الأرباح',
                            data: totalData,
                            borderColor: '#EF5A5F',
                            backgroundColor: 'rgba(239, 90, 95, 0.1)',
                            borderWidth: 3,                            tension: 0.3,
                            fill: true                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: $${context.parsed.y.toFixed(4)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toFixed(3);
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxTicksLimit: 10
                            }
                        }                    }
                }
            });
        }

        // Load live statistics (renamed from loadAnalytics for consistency)
        async function loadLiveStats() {
            try {
                const statsDoc = await db.collection('stats').doc('global').get();
                const stats = statsDoc.data() || {};

                if (totalLinksStat) totalLinksStat.textContent =
                    (stats.totalLinks || 25000).toLocaleString() + '+';

                if (totalClicksStat) totalClicksStat.textContent =
                    (stats.totalClicks || 1200000).toLocaleString() + '+';

                if (todayClicksStat) todayClicksStat.textContent =
                    (stats.todayClicks || 1245).toLocaleString();

                if (uptimeStat) uptimeStat.textContent =
                    (stats.uptime || 99.9).toFixed(1) + '%';
            } catch (error) {
                console.error('Error loading live stats:', error);
            }
        }


        // --- Firebase Authentication ---
        function initAuth() {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    if (userProfile) userProfile.style.display = 'flex';
                    if (authButtons) authButtons.style.display = 'none';

                    if (userPhoto) userPhoto.src = user.photoURL || 'https://via.placeholder.com/40';
                    if (userName) userName.textContent = user.displayName || 'مستخدم';

                    showNotification('success', `أهلاً بعودتك، ${user.displayName || 'مستخدم'}!`, 4000);

                    await setFirstUserAsAdmin(user);

                    if (window.location.hash === '#admin') {
                        showAdminPanel();
                    }

                    loadLiveStats();
                } else {
                    if (userProfile) userProfile.style.display = 'none';
                    if (authButtons) authButtons.style.display = 'block';

                    if (window.location.hash === '#admin') {
                        hideAllPanels();
                        showFeatures();                    }
                    adminOnlyElements.forEach(el => {
                        el.style.display = 'none';
                    });
                }
            });

            if (signInButton) {
                signInButton.addEventListener('click', async () => {
                    try {
                        const provider = new firebase.auth.GoogleAuthProvider();
                        const result = await auth.signInWithPopup(provider);
                        showNotification('success', `تم تسجيل دخولك بنجاح، أهلاً بك ${result.user.displayName || 'مستخدم'}!`);
                    } catch (error) {
                        showNotification('error', `فشل تسجيل الدخول: ${error.message}`);
                    }
                });
            }

            if (signOutButton) {
                signOutButton.addEventListener('click', () => {
                    auth.signOut();
                    showNotification('info', 'تم تسجيل خروجك بنجاح');
                });
            }        }

        // Set first user as admin
        async function setFirstUserAsAdmin(user) {
            const usersRef = db.collection('users');

            try {
                const usersSnapshot = await usersRef.get();

                if (usersSnapshot.empty) {
                    await usersRef.doc(user.uid).set({
                        uid: user.uid,
                        email: user.email,
                        displayName: user.displayName,
                        photoURL: user.photoURL,
                        isAdmin: true,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showNotification('success', 'تم تعيينك كمسؤول للمنصة!');
                    adminOnlyElements.forEach(el => {
                        el.style.display = 'block';
                    });
                } else {                    const userDoc = await usersRef.doc(user.uid).get();
                    if (userDoc.exists && userDoc.data().isAdmin) {
                        adminOnlyElements.forEach(el => {
                            el.style.display = 'block';                        });                    } else {
                        adminOnlyElements.forEach(el => {
                            el.style.display = 'none';
                        });
                    }
                }
            } catch (error) {
                console.error('Error setting admin:', error);
            }
        }

        // --- Smart Algorithms System ---
        class SmartAlgorithms {
            constructor() {
                this.algorithms = this.initializeAlgorithms();
                this.results = {};
                this.isRunning = false;
            }

            initializeAlgorithms() {
                return [
                    // مجموعة التحليلات (5 خوارزميات)                    {
                        id: 'user-behavior-analysis',
                        name: 'تحليل سلوك المستخدم',
                        category: 'analytics',
                        description: 'تحليل أنماط سلوك المستخدمين وتفضيلاتهم بناءً على تفاعلاتهم',                        complexity: 'متقدم',
                        enabled: false,
                        icon: 'fas fa-user-chart',
                        algorithm: this.userBehaviorAnalysis.bind(this)
                    },
                    {
                        id: 'click-prediction',
                        name: 'توقع النقرات',
                        category: 'prediction',
                        description: 'التنبؤ بعدد النقرات المتوقعة للروابط الجديدة بناءً على البيانات التاريخية',                        complexity: 'متقدم',
                        enabled: false,
                        icon: 'fas fa-mouse-pointer',
                        algorithm: this.clickPredictionAnalysis.bind(this)
                    },
                    {
                        id: 'optimal-timing',
                        name: 'تحليل الأوقات المثلى',
                        category: 'analytics',
                        description: 'تحديد أفضل أوقات النشر للحصول على أقصى تفاعل',
                        complexity: 'متوسط',
                        enabled: false,
                        icon: 'fas fa-clock',
                        algorithm: this.optimalTimingAnalysis.bind(this)
                    },
                    {
                        id: 'content-attraction',
                        name: 'تحليل جاذبية المحتوى',
                        category: 'analytics',
                        description: 'تقييم مدى جاذبية المحتوى وإمكانية انتشاره',                        complexity: 'متقدم',
                        enabled: false,
                        icon: 'fas fa-magnet',
                        algorithm: this.contentAttractionAnalysis.bind(this)                    },
                    {
                        id: 'geo-analysis',
                        name: 'التحليل الجغرافي المتقدم',
                        category: 'analytics',
                        description: 'تحليل متعمق للتوزيع الجغرافي وأنماط الزيارات حسب المناطق',
                        complexity: 'متقدم',
                        enabled: false,
                        icon: 'fas fa-globe',
                        algorithm: this.advancedGeoAnalysis.bind(this)
                    },

                    // مجموعة التنبؤ (3 خوارزميات)
                    {
                        id: 'trend-prediction',
                        name: 'التنبؤ بالاتجاهات',
                        category: 'prediction',
                        description: 'توقع الاتجاهات القادمة في استخدام الروابط والمحتوى',
                        complexity: 'خبير',
                        enabled: false,
                        icon: 'fas fa-chart-line',
                        algorithm: this.trendPrediction.bind(this)
                    },
                    {
                        id: 'revenue-prediction',
                        name: 'توقع الأرباح',
                        category: 'prediction',
                        description: 'التنبؤ بالأرباح المستقبلية بناءً على الأداء الحالي',
                        complexity: 'متقدم',
                        enabled: false,
                        icon: 'fas fa-dollar-sign',                        algorithm: this.revenuePrediction.bind(this)
                    },
                    {
                        id: 'peak-time-prediction',
                        name: 'توقع أوقات الذروة',
                        category: 'prediction',
                        description: 'التنبؤ بأوقات الذروة المستقبلية للزيارات',
                        complexity: 'متوسط',
                        enabled: false,
                        icon: 'fas fa-chart-area',
                        algorithm: this.peakTimePrediction.bind(this)
                    },

                    // مجموعة الأمان (3 خوارزميات)
                    {
                        id: 'bot-detection',
                        name: 'كشف البوتات',
                        category: 'security',
                        description: 'اكتشاف وفلترة الزيارات من البوتات والحسابات الوهمية',
                        complexity: 'متقدم',
                        enabled: false,
                        icon: 'fas fa-robot',
                        algorithm: this.botDetection.bind(this)
                    },
                    {
                        id: 'fraud-detection',
                        name: 'مكافحة الاحتيال',
                        category: 'security',
                        description: 'اكتشاف النقرات الاحتيالية والأنشطة المشبوهة',
                        complexity: 'خبير',
                        enabled: false,                        icon: 'fas fa-shield-alt',
                        algorithm: this.fraudDetection.bind(this)
                    },
                    {
                        id: 'link-protection',
                        name: 'حماية الروابط',
                        category: 'security',
                        description: 'حماية الروابط من الهجمات والاستخدام غير المصرح',
                        complexity: 'متقدم',
                        enabled: false,
                        icon: 'fas fa-lock',
                        algorithm: this.linkProtection.bind(this)
                    },

                    // مجموعة التحسين (4 خوارزميات)
                    {
                        id: 'redirect-optimization',
                        name: 'تحسين سرعة التوجيه',
                        category: 'optimization',
                        description: 'تحسين سرعة إعادة التوجيه وتقليل زمن الاستجابة',
                        complexity: 'متوسط',
                        enabled: false,
                        icon: 'fas fa-tachometer-alt',
                        algorithm: this.redirectOptimization.bind(this)
                    },
                    {
                        id: 'conversion-optimization',
                        name: 'تحسين معدل التحويل',
                        category: 'optimization',
                        description: 'تحسين معدل تحويل الزوار إلى نقرات فعلية',
                        complexity: 'متقدم',
                        enabled: false,
                        icon: 'fas fa-bullseye',
                        algorithm: this.conversionOptimization.bind(this)
                    },
                    {
                        id: 'auto-seo-optimization',
                        name: 'التحسين التلقائي للـ SEO',                        category: 'optimization',
                        description: 'تحسين تلقائي للعناوين والأوصاف لمحركات البحث',
                        complexity: 'متقدم',
                        enabled: false,
                        icon: 'fas fa-search',
                        algorithm: this.autoSEOOptimization.bind(this)
                    },
                    {
                        id: 'ai-recommendations',
                        name: 'التوصيات الذكية',
                        category: 'optimization',
                        description: 'نظام ذكي لتقديم توصيات شخصية للمستخدمين',
                        complexity: 'خبير',
                        enabled: false,
                        icon: 'fas fa-brain',
                        algorithm: this.aiRecommendations.bind(this)
                    }
                ];
            }

            // --- Placeholder Helper Methods for SmartAlgorithms (All implemented) ---

            analyzeClickPatterns(visits) {
                const patterns = {};                visits.forEach(visit => {
                    const hour = visit.timestamp.toDate().getHours();
                    patterns[hour] = (patterns[hour] || 0) + 1;                });
                return patterns;
            }
            analyzeInteractionTimes(visits) { console.log('analyzeInteractionTimes called'); return { peakHour: '18:00', bestDays: ['الجمعة'] }; }
            analyzeContentPreferences(visits, links) { console.log('analyzeContentPreferences called'); return { topCategory: 'مسلسل' }; }
            calculateBehaviorScore(clickPatterns, interactionTimes) {
                const consistency = this.calculateConsistency(clickPatterns);
                const engagement = this.calculateEngagement(interactionTimes);
                return Math.round((consistency + engagement) / 2);
            }
            generateBehaviorRecommendations(patterns, preferences) { console.log('generateBehaviorRecommendations called'); return ['نصيحة سلوك']; }
            calculateConsistency(clickPatterns) { console.log('calculateConsistency called'); return 80; } // Placeholder
            calculateEngagement(interactionTimes) { console.log('calculateEngagement called'); return 70; } // Placeholder


            analyzeTrends(historicalData) { console.log('analyzeTrends called'); return { averageGrowth: 5 }; }
            getTimeImpactFactor(createdAt) { console.log('getTimeImpactFactor called'); return 1.2; }
            getContentTypeImpactFactor(linkType) { console.log('getContentTypeImpactFactor called'); return 1.1; }
            getSeasonalityFactor() { console.log('getSeasonalityFactor called'); return 1.05; }
            calculatePredictedClicks(factors, trends) { console.log('calculatePredictedClicks called'); return { daily: 100, peakTime: 'المساء', growthRate: 5 }; }
            calculatePredictionConfidence(factors) { console.log('calculatePredictionConfidence called'); return 0.85; }
            generateClickTimeline(predictedClicks) { console.log('generateClickTimeline called'); return []; }

            analyzeHourlyDistribution(visits) { console.log('analyzeHourlyDistribution called'); return { peak: '20:00' }; }            analyzeDailyDistribution(visits) { console.log('analyzeDailyDistribution called'); return { peak: 'الجمعة' }; }
            analyzeWeeklyPatterns(visits) { console.log('analyzeWeeklyPatterns called'); return {}; }
            findOptimalTimeRange(hourlyData) { console.log('findOptimalTimeRange called'); return '19:00-22:00'; }
            findWorstTimes(hourlyData, dailyData) { console.log('findWorstTimes called'); return ['الصباح الباكر']; }
            calculateTimingScore(optimalTimes) { console.log('calculateTimingScore called'); return 80; }
            // Note: generateTimingRecommendations for optimal timing is different from AI recommendations
            generateTimingRecommendations(optimalTimes) { console.log('generateTimingRecommendations (optimal timing) called'); return ['نصيحة توقيت']; }

            analyzeTitleEffectiveness(links) { console.log('analyzeTitleEffectiveness called'); return {}; }
            analyzeDescriptionImpact(links) { console.log('analyzeDescriptionImpact called'); return {}; }
            analyzeImageInfluence(links) { console.log('analyzeImageInfluence called'); return { impact: 15 }; }
            analyzeContentTypePerformance(links, visits) { console.log('analyzeContentTypePerformance called'); return { best: 'مسلسل' }; }
            calculateAttractionScore(factors) { console.log('calculateAttractionScore called'); return 85; }
            analyzeAttractiveKeywords(links) { console.log('analyzeAttractiveKeywords called'); return { topKeyword: 'حصري', impact: 20 }; }
            generateContentImprovements(factors) { console.log('generateContentImprovements called'); return ['نصيحة محتوى']; }

            analyzeGeoDistribution(visits) { console.log('analyzeGeoDistribution called'); return { activeRegions: 5 }; }
            analyzeGeoPatterns(visits) { console.log('analyzeGeoPatterns called'); return {}; }
            analyzeGeoConversions(visits) { console.log('analyzeGeoConversions called'); return { topCountry: 'السعودية', topRate: 5.2 }; }
            predictEmergingMarkets(distribution, patterns) { console.log('predictEmergingMarkets called'); return { top: 'مصر' }; }
            calculateGeoScore(distribution, conversions) { console.log('calculateGeoScore called'); return 90; }

            prepareTimeSeriesData(historicalData) { console.log('prepareTimeSeriesData called'); return []; }
            analyzeTrendPatterns(timeSeriesData) { console.log('analyzeTrendPatterns called'); return {}; }
            predictFutureTrends(trends, timeSeriesData) { console.log('predictFutureTrends called'); return { growthRate: 10, spikeChance: 30 }; }
            classifyTrends(futureTrends) { console.log('classifyTrends called'); return { overall: 'صاعد' }; }
            calculateTrendConfidence(trends) { console.log('calculateTrendConfidence called'); return 0.9; }

            calculateHistoricalRevenue(visits) { console.log('calculateHistoricalRevenue called'); return {}; }
            analyzeRevenuePatterns(revenueData) { console.log('analyzeRevenuePatterns called'); return {}; }
            predictFutureRevenue(revenuePatterns, revenueData) { console.log('predictFutureRevenue called'); return { nextMonth: 500, growthRate: 8 }; }
            analyzeRevenueFactors(visits, revenueData) { console.log('analyzeRevenueFactors called'); return { topSource: 'فيسبوك' }; }
            analyzeTimePatterns(visits) { console.log('analyzeTimePatterns called'); return {}; }
            predictPeakTimes(timePatterns) { console.log('predictPeakTimes called'); return { next: { time: '21:00', intensity: 'عالية' }, preparationTime: '20:00' }; }
            analyzePeakIntensity(timePatterns, visits) { console.log('analyzePeakIntensity called'); return 'متوسطة'; }
            // Note: generatePeakTimeRecommendations for peak time prediction is handled by the general timing recommendations above.

            analyzeBotPatterns(visits) { console.log('analyzeBotPatterns called'); return { commonPattern: 'زيارات سريعة' }; }
            detectSuspiciousBehavior(visits) { console.log('detectSuspiciousBehavior called'); return []; }
            classifyVisits(visits, botPatterns) { console.log('classifyVisits called'); return { bots: [], humanPercentage: 95 }; }
            generateBotProtectionRecommendations(botPatterns) { console.log('generateBotProtectionRecommendations called'); return ['نصيحة بوت']; }

            detectFraudulentClicks(visits) { console.log('detectFraudulentClicks called'); return []; }
            analyzeFraudPatterns(visits, links) { console.log('analyzeFraudPatterns called'); return { topSources: ['VPN'] }; }
            calculateRiskScores(visits, fraudPatterns) { console.log('calculateRiskScores called'); return { overall: 'متوسط' }; }
            generateFraudProtection(fraudPatterns) { console.log('generateFraudProtection called'); return { level: 'أساسي' }; }

            analyzeLinkThreats(visits, links) { console.log('analyzeLinkThreats called'); return { count: 0 }; }
            generateProtectionMechanisms(threats) { console.log('generateProtectionMechanisms called'); return { level: 'متوسط', protectedCount: 0 }; }
            implementSecurityMonitoring(links) { console.log('implementSecurityMonitoring called'); return {}; }
            calculateSecurityScore(threats, protection) { console.log('calculateSecurityScore called'); return 88; }            analyzeResponseTimes(redirectData) { console.log('analyzeResponseTimes called'); return { average: 50 }; }
            optimizeRedirectPaths(redirectData) { console.log('optimizeRedirectPaths called'); return { improvement: 10 }; }
            optimizeCaching(redirectData) { console.log('optimizeCaching called'); return { savings: 5 }; }
            calculateSpeedImprovement(responseAnalysis, optimizedPaths) { console.log('calculateSpeedImprovement called'); return 10; }

            analyzeConversionRates(visits, conversions) { console.log('analyzeConversionRates called'); return { rate: 2.5 }; }
            identifyOptimizationPoints(conversionAnalysis) { console.log('identifyOptimizationPoints called'); return { top: { name: 'زر النقر' } }; }
            generateConversionImprovements(optimizationPoints) { console.log('generateConversionImprovements called'); return { potentialIncrease: 5 }; }
            calculatePotentialGains(improvements) { console.log('calculatePotentialGains called'); return 100; }

            // Placeholder helper methods for AI Recommendations (Specific to AI context)
            analyzeSEOStatus(links) { console.log('analyzeSEOStatus called'); return { score: 70, missingTitle: 0 }; }
            generateAutoSEOImprovements(seoAnalysis) { console.log('generateAutoSEOImprovements called'); return { count: 5, suggestions: [] }; }
            optimizeKeywords(links) { console.log('optimizeKeywords called'); return { topKeyword: 'حصري', impact: 15 }; }
            calculateSEOScore(seoAnalysis, autoImprovements) { console.log('calculateSEOScore called'); return 80; }

            createUserProfile(user, visits, links) { console.log('createUserProfile called'); return { user: user.uid, preferences: ['مسلسل', 'أكشن'] }; }
            generatePersonalizedRecommendations(userProfile) { console.log('generatePersonalizedRecommendations called'); return { successRate: 75, items: ['link1', 'link2'] }; }
            generateContentRecommendations(userProfile, links) { console.log('generateContentRecommendations called'); return { idealType: 'مسلسل', topContent: 'مسلسل تركي' }; }
            // This is the AI-specific timing recommendation, distinct from optimalTimingAnalysis's version
            generateTimingRecommendations(userProfile, visits) { console.log('generateTimingRecommendations (AI) called'); return { optimal: '21:00', strategy: 'نشر تدريجي' }; }
            calculateRecommendationConfidence(userProfile) { console.log('calculateRecommendationConfidence called'); return 92; }


            // 🔍 خوارزمية تحليل سلوك المستخدم
            async userBehaviorAnalysis(data) {
                const visits = data.visits || [];                const links = data.links || [];

                const clickPatterns = this.analyzeClickPatterns(visits);
                const interactionTimes = this.analyzeInteractionTimes(visits);
                const contentPreferences = this.analyzeContentPreferences(visits, links);

                return {
                    score: this.calculateBehaviorScore(clickPatterns, interactionTimes),
                    patterns: clickPatterns,
                    preferences: contentPreferences,
                    recommendations: this.generateBehaviorRecommendations(clickPatterns, contentPreferences),
                    insights: [
                        `المستخدمون يفضلون النقر في الساعة ${interactionTimes.peakHour}`,
                        `معدل التفاعل الأعلى في أيام ${interactionTimes.bestDays.join('، ')}`,
                        `نوع المحتوى المفضل: ${contentPreferences.topCategory}`
                    ]
                };
            }

            // 📈 خوارزمية توقع النقرات
            async clickPredictionAnalysis(data) {
                const historicalData = data.visits || [];
                const linkData = data.currentLink || {};

                const trends = this.analyzeTrends(historicalData);

                const factors = {
                    timeOfDay: this.getTimeImpactFactor(linkData.createdAt),
                    contentType: this.getContentTypeImpactFactor(linkData.linkType),
                    seasonality: this.getSeasonalityFactor(),
                    historicalPerformance: trends.averageGrowth
                };

                const predictedClicks = this.calculatePredictedClicks(factors, trends);

                return {
                    prediction: predictedClicks,
                    confidence: this.calculatePredictionConfidence(factors),
                    factors: factors,
                    timeline: this.generateClickTimeline(predictedClicks),
                    insights: [
                        `متوقع ${predictedClicks.daily} نقرة يومياً`,
                        `أفضل أداء متوقع في ${predictedClicks.peakTime}`,
                        `معدل النمو المتوقع: ${predictedClicks.growthRate}%`
                    ]
                };
            }

            // ⏰ خوارزمية تحليل الأوقات المثلى
            async optimalTimingAnalysis(data) {
                const visits = data.visits || [];

                const hourlyData = this.analyzeHourlyDistribution(visits);
                const dailyData = this.analyzeDailyDistribution(visits);
                const weeklyPatterns = this.analyzeWeeklyPatterns(visits);

                const optimalTimes = {
                    bestHour: hourlyData.peak,
                    bestDay: dailyData.peak,
                    bestTimeRange: this.findOptimalTimeRange(hourlyData),
                    avoidTimes: this.findWorstTimes(hourlyData, dailyData)
                };

                return {
                    optimal: optimalTimes,
                    distribution: { hourly: hourlyData, daily: dailyData, weekly: weeklyPatterns },
                    score: this.calculateTimingScore(optimalTimes),
                    recommendations: this.generateTimingRecommendations(optimalTimes), // This calls the general timing recommendations                    insights: [
                        `أفضل وقت للنشر: ${optimalTimes.bestDay} الساعة ${optimalTimes.bestHour}`,
                        `تجنب النشر في: ${optimalTimes.avoidTimes.join('، ')}`,
                        `معدل النجاح في الأوقات المثلى: ${85}%`
                    ]
                };
            }

            // 🧲 خوارزمية تحليل جاذبية المحتوى            async contentAttractionAnalysis(data) {
                const links = data.links || [];
                const visits = data.visits || [];

                const attractionFactors = {
                    titleEffectiveness: this.analyzeTitleEffectiveness(links),
                    descriptionImpact: this.analyzeDescriptionImpact(links),
                    imageInfluence: this.analyzeImageInfluence(links),
                    contentTypePerformance: this.analyzeContentTypePerformance(links, visits)                };                const attractionScore = this.calculateAttractionScore(attractionFactors);

                const keywordAnalysis = this.analyzeAttractiveKeywords(links);

                return {
                    score: attractionScore,                    factors: attractionFactors,                    keywords: keywordAnalysis,
                    improvements: this.generateContentImprovements(attractionFactors),
                    insights: [
                        `العناوين التي تحتوي على "${keywordAnalysis.topKeyword}" تحصل على نقرات أكثر بـ${keywordAnalysis.impact}%`,
                        `المحتوى من نوع ${attractionFactors.contentTypePerformance.best} الأكثر جاذبية`,
                        `الصور تزيد النقرات بنسبة ${attractionFactors.imageInfluence.impact}%`
                    ]
                };
            }

            // 🌍 خوارزمية التحليل الجغرافي المتقدم
            async advancedGeoAnalysis(data) {                const visits = data.visits || [];                const geoDistribution = this.analyzeGeoDistribution(visits);
                const geoPatterns = this.analyzeGeoPatterns(visits);
                const geoConversions = this.analyzeGeoConversions(visits);

                const emergingMarkets = this.predictEmergingMarkets(geoDistribution, geoPatterns);

                return {
                    distribution: geoDistribution,
                    patterns: geoPatterns,
                    conversions: geoConversions,
                    emerging: emergingMarkets,
                    score: this.calculateGeoScore(geoDistribution, geoConversions),
                    insights: [
                        `أعلى معدل تحويل في: ${geoConversions.topCountry} (${geoConversions.topRate}%)`,
                        `السوق الناشئ الأكثر واعدية: ${emergingMarkets.top}`,
                        `التوزيع المتوازن عبر ${geoDistribution.activeRegions} منطقة`
                    ]
                };            }

            // 📊 خوارزمية التنبؤ بالاتجاهات
            async trendPrediction(data) {
                const historicalData = data.visits || [];
                const timeSeriesData = this.prepareTimeSeriesData(historicalData);

                const trends = this.analyzeTrendPatterns(timeSeriesData);

                const futureTrends = this.predictFutureTrends(trends, timeSeriesData);                const trendClassification = this.classifyTrends(futureTrends);

                return {
                    current: trends,
                    predictions: futureTrends,
                    classification: trendClassification,
                    confidence: this.calculateTrendConfidence(trends),
                    insights: [                        `الاتجاه العام: ${trendClassification.overall}`,
                        `توقع نمو بنسبة ${futureTrends.growthRate}% في الشهر القادم`,
                        `احتمالية حدوث قفزة في النشاط: ${futureTrends.spikeChance}%`
                    ]
                };
            }

            // 💰 خوارزمية توقع الأرباح
            async revenuePrediction(data) {
                const visits = data.visits || [];
                const revenueData = this.calculateHistoricalRevenue(visits);

                const revenuePatterns = this.analyzeRevenuePatterns(revenueData);

                const futurePredictions = this.predictFutureRevenue(revenuePatterns, revenueData);

                const revenueFactors = this.analyzeRevenueFactors(visits, revenueData);

                return {
                    historical: revenueData,
                    patterns: revenuePatterns,
                    predictions: futurePredictions,
                    factors: revenueFactors,
                    insights: [
                        `الإيرادات المتوقعة للشهر القادم: $${futurePredictions.nextMonth.toFixed(2)}`,
                        `أفضل مصدر للإيرادات: ${revenueFactors.topSource}`,                        `معدل نمو الإيرادات المتوقع: ${futurePredictions.growthRate}%`
                    ]
                };
            }

            // 🕒 خوارزمية توقع أوقات الذروة
            async peakTimePrediction(data) {
                const visits = data.visits || [];
                const timePatterns = this.analyzeTimePatterns(visits);

                const peakPredictions = this.predictPeakTimes(timePatterns);                const peakIntensity = this.analyzePeakIntensity(timePatterns, visits);

                return {
                    patterns: timePatterns,
                    predictions: peakPredictions,
                    intensity: peakIntensity,
                    recommendations: this.generatePeakTimeRecommendations(peakPredictions),
                    insights: [
                        `الذروة القادمة متوقعة في: ${peakPredictions.next.time}`,
                        `شدة الذروة المتوقعة: ${peakPredictions.next.intensity}`,
                        `أفضل وقت للاستعداد: ${peakPredictions.preparationTime}`
                    ]
                };
            }

            // 🤖 خوارزمية كشف البوتات
            async botDetection(data) {
                const visits = data.visits || [];

                const botPatterns = this.analyzeBotPatterns(visits);

                const suspiciousBehavior = this.detectSuspiciousBehavior(visits);

                const visitClassification = this.classifyVisits(visits, botPatterns);

                return {
                    detected: visitClassification.bots,
                    suspicious: suspiciousBehavior,
                    patterns: botPatterns,
                    cleanRate: visitClassification.humanPercentage,
                    recommendations: this.generateBotProtectionRecommendations(botPatterns),
                    insights: [
                        `تم اكتشاف ${visitClassification.bots.length} بوت محتمل`,
                        `معدل الزيارات النظيفة: ${visitClassification.humanPercentage}%`,
                        `أكثر أنماط البوتات شيوعاً: ${botPatterns.commonPattern}`
                    ]
                };
            }

            // 🛡️ خوارزمية مكافحة الاحتيال
            async fraudDetection(data) {
                const visits = data.visits || [];
                const links = data.links || [];
                const fraudulentClicks = this.detectFraudulentClicks(visits);

                const fraudPatterns = this.analyzeFraudPatterns(visits, links);

                const riskScores = this.calculateRiskScores(visits, fraudPatterns);

                return {
                    detected: fraudulentClicks,
                    patterns: fraudPatterns,
                    risks: riskScores,
                    protection: this.generateFraudProtection(fraudPatterns),
                    insights: [                        `تم اكتشاف ${fraudulentClicks.length} نقرة احتيالية محتملة`,
                        `مستوى المخاطر الحالي: ${riskScores.overall}`,
                        `أكثر مصادر الاحتيال: ${fraudPatterns.topSources.join('، ')}`
                    ]
                };
            }

            // 🔒 خوارزمية حماية الروابط
            async linkProtection(data) {
                const links = data.links || [];
                const visits = data.visits || [];

                const threats = this.analyzeLinkThreats(visits, links);

                const protection = this.generateProtectionMechanisms(threats);

                const securityMonitoring = this.implementSecurityMonitoring(links);

                return {
                    threats: threats,
                    protection: protection,
                    monitoring: securityMonitoring,
                    score: this.calculateSecurityScore(threats, protection),                    insights: [
                        `تم رصد ${threats.count} تهديد محتمل`,
                        `مستوى الحماية: ${protection.level}`,
                        `الروابط المحمية: ${protection.protectedCount}/${links.length}`
                    ]
                };
            }

            // ⚡ خوارزمية تحسين سرعة التوجيه
            async redirectOptimization(data) {
                const redirectData = data.redirects || [];

                const responseAnalysis = this.analyzeResponseTimes(redirectData);

                const optimizedPaths = this.optimizeRedirectPaths(redirectData);

                const cacheOptimization = this.optimizeCaching(redirectData);

                return {
                    current: responseAnalysis,
                    optimized: optimizedPaths,
                    caching: cacheOptimization,
                    improvement: this.calculateSpeedImprovement(responseAnalysis, optimizedPaths),                    insights: [                        `تحسن في السرعة بنسبة ${optimizedPaths.improvement}%`,
                        `متوسط وقت التوجيه: ${responseAnalysis.average}ms`,
                        `توفير في البيانات: ${cacheOptimization.savings}%`
                    ]
                };
            }

            // 🎯 خوارزمية تحسين معدل التحويل
            async conversionOptimization(data) {
                const visits = data.visits || [];
                const conversions = data.conversions || [];

                const conversionAnalysis = this.analyzeConversionRates(visits, conversions);

                const optimizationPoints = this.identifyOptimizationPoints(conversionAnalysis);

                const improvements = this.generateConversionImprovements(optimizationPoints);

                return {
                    current: conversionAnalysis,
                    opportunities: optimizationPoints,
                    improvements: improvements,
                    potential: this.calculatePotentialGains(improvements),                    insights: [
                        `معدل التحويل الحالي: ${conversionAnalysis.rate}%`,
                        `إمكانية التحسين: +${improvements.potentialIncrease}%`,
                        `أهم نقطة للتحسين: ${optimizationPoints.top.name}`
                    ]
                };
            }

            // 🔍 خوارزمية التحسين التلقائي للـ SEO
            async autoSEOOptimization(data) {
                const links = data.links || [];

                const seoAnalysis = this.analyzeSEOStatus(links);

                const autoImprovements = this.generateAutoSEOImprovements(seoAnalysis);

                const keywordOptimization = this.optimizeKeywords(links);

                return {
                    current: seoAnalysis,
                    improvements: autoImprovements,
                    keywords: keywordOptimization,
                    score: this.calculateSEOScore(seoAnalysis, autoImprovements),
                    insights: [
                        `نقاط SEO الحالية: ${seoAnalysis.score}/100`,
                        `تم تحسين ${autoImprovements.count} عنصر تلقائياً`,
                 `أهم كلمة مفتاحية: ${keywordOptimization.topKeyword}`
                    ]
                };
            }

            // 🧠 خوارزمية التوصيات الذكية
            async aiRecommendations(data) {
                const user = data.user || {};
                const visits = data.visits || [];
                const links = data.links || [];

                const userProfile = this.createUserProfile(user, visits, links);

                const personalizedRecommendations = this.generatePersonalizedRecommendations(userProfile);                const contentRecommendations = this.generateContentRecommendations(userProfile, links);

                const timingRecommendations = this.generateTimingRecommendations(userProfile, visits); // This calls the AI-specific timing recommendations

                return {
                    profile: userProfile,
                    personal: personalizedRecommendations,
                    content: contentRecommendations,
                    timing: timingRecommendations,
                    confidence: this.calculateRecommendationConfidence(userProfile),
                    insights: [
                        `نوع المحتوى المثالي: ${contentRecommendations.idealType}`,
                        `أفضل وقت للنشر: ${timingRecommendations.optimal}`,
                        `معدل النجاح المتوقع: ${personalizedRecommendations.successRate}%`
                    ]
                };
            }

            // تشغيل جميع الخوارزميات (SmartAlgorithms method)
            async runAllAlgorithms() {
                if (this.isRunning) return;

                this.isRunning = true;                this.results = {};

                try {
                    const data = await this.collectData();

                    const enabledAlgorithms = this.algorithms.filter(alg => alg.enabled);

                    for (let algorithm of enabledAlgorithms) {
                        try {
                            algorithmsUI.updateAlgorithmStatus(algorithm.id, 'running'); // Use algorithmsUI to update UI
                            algorithmsUI.showProgress(algorithm.id, true); // Show progress bar                            const result = await algorithm.algorithm.call(this, data);
                            this.results[algorithm.id] = {
                                ...result,
                                timestamp: new Date(),
                                status: 'complete'
                            };                            algorithmsUI.updateAlgorithmStatus(algorithm.id, 'complete');
                            algorithmsUI.showAlgorithmResult(algorithm.id, result); // Update card with result
                        } catch (error) {
                            console.error(`Algorithm ${algorithm.id} failed:`, error);
                            this.results[algorithm.id] = {
                                error: error.message,
                                status: 'error',
                                timestamp: new Date()
                            };
                            algorithmsUI.updateAlgorithmStatus(algorithm.id, 'error');
                            showNotification('error', `فشل في تشغيل ${algorithm.name}: ${error.message}`);
                        } finally {                            algorithmsUI.showProgress(algorithm.id, false); // Hide progress bar
                        }
                    }

                    // Display all results after all algorithms run
                    algorithmsUI.displayAllResults();
                    algorithmsUI.updateSystemStatus(); // Update global status after completion

                } catch (error) {
                    console.error('Failed to run algorithms:', error);
                    showNotification('error', 'فشل في جمع البيانات لتشغيل الخوارزميات: ' + error.message);
                } finally {
                    this.isRunning = false;
                }
            }

            async collectData() {
                const user = auth.currentUser;
                if (!user) throw new Error('المستخدم غير مسجل');

                const [linksSnapshot, visitsSnapshot] = await Promise.all([
                    db.collection('links').where('userId', '==', user.uid).get(),                    db.collection('visits').orderBy('timestamp', 'desc').limit(1000).get()
                ]);

                return {
                    user: user,
                    links: linksSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()})),
                    visits: visitsSnapshot.docs.map(doc => doc.data()),
                    redirects: [], // Placeholder for redirects data
                    conversions: [] // Placeholder for conversions data
                };
            }
        }

        // تهيئة نظام الخوارزميات
        const smartAlgorithms = new SmartAlgorithms();


        // 🎬 نظام معالجة فيديو Trailer للمسلسلات والأفلام
        class TrailerVideoSystem {
            constructor() {
                this.init();
            }

            init() {
                this.setupContentTypeHandler();
                this.setupTrailerUrlHandler();
                // Initial update based on current content type (important for edit mode)
                this.updateContentTypeBasedFields();
            }

            // معالج تغيير نوع المحتوى
            setupContentTypeHandler() {
                const contentTypeSelect = document.getElementById('linkType');
                if (contentTypeSelect) {
                    contentTypeSelect.addEventListener('change', () => {
                        this.updateContentTypeBasedFields();
                    });
                }
            }

            // معالج رابط الفيديو
            setupTrailerUrlHandler() {
                const trailerUrlInput = document.getElementById('trailerUrl');
                if (trailerUrlInput) {
                    trailerUrlInput.addEventListener('input', (e) => {                        this.handleTrailerUrlChange(e.target.value);
                    });

                    trailerUrlInput.addEventListener('blur', (e) => {
                        this.validateAndPreviewTrailer(e.target.value);                    });
                }
            }

            // تحديث الحقول حسب نوع المحتوى
            updateContentTypeBasedFields() {
                const contentType = document.getElementById('linkType')?.value;
                const imageFieldDiv = document.getElementById('imageField');
                const trailerFieldDiv = document.getElementById('trailerField');
                const socialImageInput = document.getElementById('socialImage'); // Get the actual input

                if (!imageFieldDiv || !trailerFieldDiv || !socialImageInput || !trailerUrl) return; // Ensure all elements exist

                // عرض حقل الفيديو للمسلسلات والأفلام فقط
                if (contentType === 'series' || contentType === 'movie') {
                    imageFieldDiv.style.display = 'none';
                    trailerFieldDiv.style.display = 'block';

                    // إضافة التحقق المطلوب
                    trailerUrl.setAttribute('required', 'true');
                    socialImageInput.removeAttribute('required'); // Should not be required if trailer is
                } else {
                    imageFieldDiv.style.display = 'block';
                    trailerFieldDiv.style.display = 'none';

                    // إزالة التحقق
                    trailerUrl.removeAttribute('required');
                    // socialImageInput.setAttribute('required', 'true'); // Only make socialImage required if it makes sense for other types
                    socialImageInput.removeAttribute('required'); // Remove for now to avoid conflicts if not always needed

                    // إخفاء المعاينة
                    this.hideTrailerPreview();
                }

                // تحديث معاينة السوشيال ميديا
                this.updateSocialMediaPreview();
            }

            // معالجة تغيير رابط الفيديو
            handleTrailerUrlChange(url) {
                if (url.length > 10) { // A basic check to avoid too many API calls on short input
                    this.validateAndPreviewTrailer(url);
                } else {
                    this.hideTrailerPreview();
                    if (trailerUrl) trailerUrl.classList.remove('is-invalid'); // Clear invalid state
                }
            }

            // التحقق من صحة رابط يوتيوب ومعاينته
            validateAndPreviewTrailer(url) {
                const videoId = this.extractYouTubeVideoId(url);

                if (videoId) {
                    this.showTrailerPreview(videoId);
                    this.updateSocialMediaPreview(videoId);

                    // إزالة حالة الخطأ
                    if (trailerUrl) trailerUrl.classList.remove('is-invalid');
                } else if (url.trim() !== '') { // Only show error if URL is not empty and invalid
                    // إظهار حالة الخطأ
                    if (trailerUrl) trailerUrl.classList.add('is-invalid');
                    this.hideTrailerPreview();
                    showNotification('error', 'رابط يوتيوب غير صالح');
                } else {
                     if (trailerUrl) trailerUrl.classList.remove('is-invalid'); // Clear if empty
                     this.hideTrailerPreview();
                }
            }

            // استخراج معرف الفيديو من رابط يوتيوب
            extractYouTubeVideoId(url) {
                const patterns = [
                    /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/, // More robust pattern
                ];

                for (let pattern of patterns) {
                    const match = url.match(pattern);
                    if (match && match[1].length === 11) return match[1]; // Ensure 11-char ID
                }
                return null;
            }

            // إظهار معاينة الفيديو
            showTrailerPreview(videoId) {
                if (trailerPreview && trailerFrame) {
                    const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=0&controls=1&rel=0&modestbranding=1`;
                    trailerFrame.src = embedUrl;
                    trailerPreview.style.display = 'block';
                }
            }

            // إخفاء معاينة الفيديو
            hideTrailerPreview() {
                if (trailerPreview && trailerFrame) {
                    trailerPreview.style.display = 'none';
                    trailerFrame.src = '';
                }
            }

            // تحديث معاينة السوشيال ميديا
            updateSocialMediaPreview(videoId = null) {
                const previewImage = document.getElementById('previewImage');
                if (!previewImage) return;

                const contentType = document.getElementById('linkType')?.value;

                if ((contentType === 'series' || contentType === 'movie') && videoId) {
                    // استخدام thumbnail يوتيوب كصورة معاينة
                    const thumbnailUrl = `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`;
                    previewImage.src = thumbnailUrl;
                } else {
                    // العودة للصورة الافتراضية
                    const socialImage = document.getElementById('socialImage')?.value;
                    previewImage.src = socialImage || 'https://via.placeholder.com/500x300/4A154B/FFFFFF?text=صورة+المحتوى';
                }
            }

            // إنشاء رابط فيديو للصفحة
            createVideoElementForRedirect(videoId, title = '') {
                return `
                    <div class="content-video">
                        <iframe
                            src="https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&controls=1&rel=0&modestbranding=1&start=0"
                            title="${title}"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            allowfullscreen>
                        </iframe>
                        <div class="trailer-badge">Trailer</div>
                        <div class="autoplay-indicator">
                            <i class="fas fa-play"></i> تشغيل تلقائي
                        </div>
                    </div>
                `;
            }

            // التحقق من صحة البيانات قبل الحفظ
            validateTrailerData() {
                const contentType = document.getElementById('linkType')?.value;

                if (contentType === 'series' || contentType === 'movie') {
                    const trailerUrlValue = document.getElementById('trailerUrl')?.value;

                    if (!trailerUrlValue || !this.extractYouTubeVideoId(trailerUrlValue)) {
                        showNotification('error', 'رابط يوتيوب مطلوب ويجب أن يكون صالحاً للمسلسلات والأفلام');
                        if (trailerUrl) trailerUrl.classList.add('is-invalid');
                        return false;
                    }
                     if (trailerUrl) trailerUrl.classList.remove('is-invalid'); // Clear if valid
                }

                return true;
            }            // الحصول على بيانات الفيديو للحفظ
            getVideoDataForSave() {
                const contentType = document.getElementById('linkType')?.value;

                if (contentType === 'series' || contentType === 'movie') {
                    const trailerUrlValue = document.getElementById('trailerUrl')?.value;
                    const videoId = this.extractYouTubeVideoId(trailerUrlValue);

                    return {
                        hasTrailer: true,
                        trailerUrl: trailerUrlValue || null,
                        trailerVideoId: videoId,
                        thumbnailUrl: videoId ? `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg` : null
                    };
                }

                return {
                    hasTrailer: false,
                    trailerUrl: null,
                    trailerVideoId: null,
                    thumbnailUrl: null
                };
            }
        }

        // إنشاء نسخة من النظام
        const trailerSystem = new TrailerVideoSystem();


        // 🎮 نظام التحكم والعرض للخوارزميات الذكية
        class AlgorithmsUIController {
            constructor(smartAlgorithms) {
                this.algorithms = smartAlgorithms;
                this.currentCategory = 'all';
                this.init();
            }

            init() {
                this.renderAlgorithmsGrid();                this.setupEventListeners();
                this.updateSystemStatus();
            }

            // عرض شبكة الخوارزميات
            renderAlgorithmsGrid() {
                const grid = document.getElementById('algorithmsGrid');
                if (!grid) return;

                const filteredAlgorithms = this.currentCategory === 'all'
                    ? this.algorithms.algorithms
                    : this.algorithms.algorithms.filter(alg => alg.category === this.currentCategory);

                grid.innerHTML = filteredAlgorithms.map(algorithm => `
                    <div class="algorithm-card" data-category="${algorithm.category}">
                        <div class="algorithm-header">
                            <h5 class="algorithm-title">
                                <i class="${algorithm.icon}"></i>
                                ${algorithm.name}
                            </h5>
                            <span class="algorithm-category category-${algorithm.category}">
                                ${this.getCategoryName(algorithm.category)}
                            </span>
                        </div>

                        <p class="algorithm-description">${algorithm.description}</p>

                        <div class="algorithm-stats">
                            <div class="algorithm-stat">
                                <span class="algorithm-stat-value">${algorithm.complexity}</span>
                                <span class="algorithm-stat-label">التعقيد</span>
                            </div>
                            <div class="algorithm-stat">
                                <span class="algorithm-stat-value" id="status-${algorithm.id}">متوقف</span>
                                <span class="algorithm-stat-label">الحالة</span>
                            </div>
                            <div class="algorithm-stat">
                                <span class="algorithm-stat-value" id="score-${algorithm.id}">--</span>
                                <span class="algorithm-stat-label">النتيجة</span>
                            </div>
                        </div>

                        <div class="algorithm-progress" id="progress-${algorithm.id}" style="display: none;">
                            <div class="algorithm-progress-bar" style="width: 0%"></div>
                        </div>                        <div class="algorithm-controls">
                            <button class="btn btn-sm btn-primary" onclick="algorithmsUI.runSingleAlgorithm('${algorithm.id}')">
                                <i class="fas fa-play"></i> تشغيل
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="algorithmsUI.showAlgorithmDetails('${algorithm.id}')">
                                <i class="fas fa-info-circle"></i> التفاصيل
                            </button>
                            <div class="algorithm-switch">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="switch-${algorithm.id}"
                                           ${algorithm.enabled ? 'checked' : ''}
                                           onchange="algorithmsUI.toggleAlgorithm('${algorithm.id}')">
                                    <label class="form-check-label" for="switch-${algorithm.id}">
                                        <span class="algorithm-status status-${algorithm.enabled ? 'complete' : 'idle'}"></span>
                                    </label>
                                </div>
                            </div>
                        </div>                    </div>
                `).join('');
            }

            // إعداد معالجات الأحداث
            setupEventListeners() {
                if (runAllAlgorithmsBtn) {
                    runAllAlgorithmsBtn.addEventListener('click', async () => {
                        await this.runAllAlgorithms();
                    });
                }

                if (algorithmReportBtn) {
                    algorithmReportBtn.addEventListener('click', () => {
                        this.generatePerformanceReport();
                    });
                }

                if (masterAlgorithmSwitch) {
                    masterAlgorithmSwitch.addEventListener('change', (e) => {
                        this.toggleAllAlgorithms(e.target.checked);
                    });                }

                document.querySelectorAll('.algorithm-category-filter button').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const category = e.target.dataset.category;
                        if (category) {
                            this.filterByCategory(category);
                        }
                    });
                });
            }

            // تشغيل خوارزمية واحدة
            async runSingleAlgorithm(algorithmId) {                const algorithm = this.algorithms.algorithms.find(alg => alg.id === algorithmId);
                if (!algorithm) return;

                try {
                    this.updateAlgorithmStatus(algorithmId, 'running');                    this.showProgress(algorithmId, true);

                    const data = await this.algorithms.collectData();

                    const result = await algorithm.algorithm.call(this.algorithms, data);

                    this.algorithms.results[algorithmId] = {
                        ...result,
                        timestamp: new Date(),
                        status: 'complete'
                    };

                    this.updateAlgorithmStatus(algorithmId, 'complete');
                    this.showAlgorithmResult(algorithmId, result);

                } catch (error) {
                    console.error(`Algorithm ${algorithmId} failed:`, error);
                    this.updateAlgorithmStatus(algorithmId, 'error');
                    showNotification('error', `فشل في تشغيل ${algorithm.name}: ${error.message}`);
                } finally {
                    this.showProgress(algorithmId, false);
                    this.updateSystemStatus(); // Update status after single run
                }
            }

            // تشغيل جميع الخوارزميات
            async runAllAlgorithms() {
                const enabledAlgorithms = this.algorithms.algorithms.filter(alg => alg.enabled);                if (enabledAlgorithms.length === 0) {
                    showNotification('info', 'الرجاء تفعيل خوارزمية واحدة على الأقل');
                    return;
                }

                showNotification('info', `بدء تشغيل ${enabledAlgorithms.length} خوارزمية...`);

                try {
                    await this.algorithms.runAllAlgorithms(); // This calls the SmartAlgorithms' runAllAlgorithms
                    showNotification('success', 'تم تشغيل جميع الخوارزميات بنجاح!');
                } catch (error) {
                    showNotification('error', 'حدث خطأ في تشغيل الخوارزميات: ' + error.message);                }

                this.updateSystemStatus();
            }

            // تفعيل/إلغاء تفعيل خوارزمية
            toggleAlgorithm(algorithmId) {
                const algorithm = this.algorithms.algorithms.find(alg => alg.id === algorithmId);
                if (algorithm) {
                    algorithm.enabled = !algorithm.enabled;
                    this.updateSystemStatus();
                    // Update the status indicator on the card immediately
                    const statusIndicator = document.querySelector(`#switch-${algorithmId} + label .algorithm-status`);
                    if (statusIndicator) {
                        statusIndicator.className = `algorithm-status status-${algorithm.enabled ? 'complete' : 'idle'}`;                    }
                }
            }

            // تفعيل/إلغاء تفعيل جميع الخوارزميات
            toggleAllAlgorithms(enabled) {
                this.algorithms.algorithms.forEach(algorithm => {                    algorithm.enabled = enabled;
                    const switchElement = document.getElementById(`switch-${algorithm.id}`);
                    if (switchElement) {
                        switchElement.checked = enabled;                        const statusIndicator = document.querySelector(`#switch-${algorithm.id} + label .algorithm-status`);
                        if (statusIndicator) {
                            statusIndicator.className = `algorithm-status status-${enabled ? 'complete' : 'idle'}`;
                        }
                    }
                });
                this.updateSystemStatus();
                showNotification('info', enabled ? 'تم تفعيل جميع الخوارزميات' : 'تم إلغاء تفعيل جميع الخوارزميات');
            }

            // فلترة حسب الفئة
            filterByCategory(category) {
                this.currentCategory = category;

                document.querySelectorAll('.algorithm-category-filter button').forEach(btn => {                    btn.classList.remove('active');
                });
                const activeBtn = document.querySelector(`.algorithm-category-filter button[data-category="${category}"]`);
                if (activeBtn) {
                    activeBtn.classList.add('active');
                }

                this.renderAlgorithmsGrid();
            }

            // تحديث حالة الخوارزمية
            updateAlgorithmStatus(algorithmId, status) {
                const statusElement = document.getElementById(`status-${algorithmId}`);
                if (statusElement) {
                    const statusTexts = {
                        'idle': 'متوقف',
                        'running': 'قيد التشغيل',
                        'complete': 'مكتمل',
                        'error': 'خطأ'
                    };
                    statusElement.textContent = statusTexts[status] || status;
                    statusElement.className = `algorithm-stat-value status-${status}`;
                }

                const indicator = document.querySelector(`#switch-${algorithmId} + label .algorithm-status`);
                if (indicator) {
                    indicator.className = `algorithm-status status-${status}`;
                }
            }

            // إظهار التقدم
            showProgress(algorithmId, show) {
                const progressElement = document.getElementById(`progress-${algorithmId}`);
                if (progressElement) {
                    progressElement.style.display = show ? 'block' : 'none';
                    if (show) {
                        this.animateProgress(algorithmId);
                    }
                }
            }

            // تحريك شريط التقدم
            animateProgress(algorithmId) {
                const progressBar = document.querySelector(`#progress-${algorithmId} .algorithm-progress-bar`);
                if (!progressBar) return;                let width = 0;
                const interval = setInterval(() => {
                    width += Math.random() * 10;
                    if (width > 90) width = 90;
                    progressBar.style.width = width + '%';

                    const result = this.algorithms.results[algorithmId];
                    if (result && result.status === 'complete') {
                        progressBar.style.width = '100%';
                        clearInterval(interval);
                    }
                }, 200);
            }

            // عرض نتيجة خوارزمية
            showAlgorithmResult(algorithmId, result) {
                const algorithm = this.algorithms.algorithms.find(alg => alg.id === algorithmId);

                const scoreElement = document.getElementById(`score-${algorithmId}`);
                if (scoreElement) {
                    scoreElement.textContent = result.score !== undefined && result.score !== null ? result.score : '✓';
                }

                this.addResultToDisplay(algorithm, result);

                showNotification('success', `تم تشغيل ${algorithm.name} بنجاح`);
            }

            // إضافة نتيجة للعرض
            addResultToDisplay(algorithm, result) {
                const resultsContainer = document.getElementById('algorithmResults');
                if (!resultsContainer) return;

                if (resultsContainer.querySelector('.text-muted')) {
                    resultsContainer.innerHTML = '';
                }

                const resultHTML = `
                    <div class="algorithm-result-item" data-algorithm="${algorithm.id}">
                        <div class="algorithm-result-title">
                            <i class="${algorithm.icon} me-2"></i>
                            ${algorithm.name}
                        </div>
                        <div class="algorithm-result-value">
                            ${result.score !== undefined && result.score !== null ? `النتيجة: ${result.score}` : 'تم التشغيل بنجاح'}
                        </div>
                        <div class="algorithm-result-description">
                            ${result.insights ? result.insights.join(' • ') : 'تم معالجة البيانات وإنتاج النتائج'}
                        </div>
                        <small class="text-muted">
                            <i class="fas fa-clock me-1"></i>
                            ${new Date().toLocaleTimeString('ar-EG')}
                        </small>
                    </div>
                `;

                resultsContainer.insertAdjacentHTML('afterbegin', resultHTML);
            }

            // عرض جميع النتائج
            displayAllResults() {
                const resultsContainer = document.getElementById('algorithmResults');
                if (!resultsContainer) return;

                resultsContainer.innerHTML = '';

                Object.entries(this.algorithms.results).forEach(([algorithmId, result]) => {
                    const algorithm = this.algorithms.algorithms.find(alg => alg.id === algorithmId);                    if (algorithm && result.status === 'complete') {
                        this.addResultToDisplay(algorithm, result);
                    }
                });
            }

            // تحديث حالة النظام
            updateSystemStatus() {
                const totalAlgorithms = this.algorithms.algorithms.length;
                const activeAlgorithms = this.algorithms.algorithms.filter(alg => alg.enabled).length;
                const completedAlgorithms = Object.keys(this.algorithms.results).filter(id => this.algorithms.results[id].status === 'complete').length;


                if (activeAlgorithmsCount) activeAlgorithmsCount.textContent = `${activeAlgorithms}/${totalAlgorithms}`;

                const performance = activeAlgorithms > 0 ? Math.round((completedAlgorithms / activeAlgorithms) * 100) : 0;
                if (performanceRate) performanceRate.textContent = `${performance}%`;

                if (lastAlgorithmUpdate) lastAlgorithmUpdate.textContent = new Date().toLocaleTimeString('ar-EG');
            }

            // إظهار تفاصيل الخوارزمية
            showAlgorithmDetails(algorithmId) {
                const algorithm = this.algorithms.algorithms.find(alg => alg.id === algorithmId);
                const result = this.algorithms.results[algorithmId];

                const modalContent = `
                    <div class="modal fade" id="algorithmDetailsModal" tabindex="-1" aria-labelledby="algorithmDetailsModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="algorithmDetailsModalLabel">
                                        <i class="${algorithm.icon} me-2"></i>
                                        ${algorithm.name}                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">                                        <div class="col-md-6">
                                            <h6>معلومات الخوارزمية:</h6>
                                            <ul class="list-unstyled">
                                                <li><strong>الفئة:</strong> ${this.getCategoryName(algorithm.category)}</li>
                                                <li><strong>التعقيد:</strong> ${algorithm.complexity}</li>
                                                <li><strong>الحالة:</strong> ${algorithm.enabled ? 'مفعل' : 'معطل'}</li>
                                            </ul>
                                            <h6>الوصف:</h6>
                                            <p>${algorithm.description}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>النتائج:</h6>
                                            ${result ? `
                                                <div class="alert alert-${result.status === 'error' ? 'danger' : 'success'}">
                                                    <strong>آخر تشغيل:</strong> ${result.timestamp.toLocaleString('ar-EG')}<br>
                                                    ${result.insights ? `<strong>الرؤى:</strong><br>${result.insights.join('<br>')}` : ''}
                                                    ${result.error ? `<strong>خطأ:</strong> ${result.error}` : ''}
                                                </div>
                                            ` : '<p class="text-muted">لم يتم تشغيل الخوارزمية بعد</p>'}
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-primary" onclick="algorithmsUI.runSingleAlgorithm('${algorithmId}')">
                                        <i class="fas fa-play me-2"></i>تشغيل الآن
                                    </button>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('algorithmDetailsModal')?.remove();

                document.body.insertAdjacentHTML('beforeend', modalContent);

                new bootstrap.Modal(document.getElementById('algorithmDetailsModal')).show();
            }

            // إنتاج تقرير الأداء
            generatePerformanceReport() {
                const report = {
                    totalAlgorithms: this.algorithms.algorithms.length,
                    activeAlgorithms: this.algorithms.algorithms.filter(alg => alg.enabled).length,
                    completedRuns: Object.keys(this.algorithms.results).filter(id => this.algorithms.results[id].status === 'complete').length,
                    successRate: this.calculateSuccessRate(),
                    averageRunTime: this.calculateAverageRunTime(),
                    categories: this.getCategoryBreakdown()
                };                this.showPerformanceReport(report);
            }

            // عرض تقرير الأداء
            showPerformanceReport(report) {
                const modalContent = `
                    <div class="modal fade" id="performanceReportModal" tabindex="-1" aria-labelledby="performanceReportModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="performanceReportModalLabel">                                        <i class="fas fa-chart-line me-2"></i>
                                        تقرير أداء الخوارزميات
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="stats-card">
                                                <div class="stats-number">${report.totalAlgorithms}</div>
                                                <div class="stats-label">إجمالي الخوارزميات</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">                                            <div class="stats-card">
                                                <div class="stats-number">${report.activeAlgorithms}</div>
                                                <div class="stats-label">الخوارزميات المفعلة</div>                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <div class="stats-card">                                                <div class="stats-number">${report.successRate}%</div>
                                                <div class="stats-label">معدل النجاح</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="stats-card">
                                                <div class="stats-number">${report.completedRuns}</div>
                                                <div class="stats-label">عدد التشغيلات</div>
                                            </div>
                                        </div>
                                    </div>
                                    <h6 class="mt-4">التوزيع حسب الفئات:</h6>
                                    ${Object.entries(report.categories).map(([category, count]) => `
                                        <div class="d-flex justify-content-between">
                                            <span>${this.getCategoryName(category)}:</span>
                                            <span class="badge bg-primary">${count}</span>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="modal-footer">                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalContent);                new bootstrap.Modal(document.getElementById('performanceReportModal')).show();
            }

            // دوال مساعدة
            getCategoryName(category) {
                const names = {
                    'analytics': 'تحليلات',
                    'prediction': 'تنبؤات',
                    'security': 'أمان',
                    'optimization': 'تحسين'
                };
                return names[category] || category;
            }

            calculateSuccessRate() {                const total = Object.keys(this.algorithms.results).length;
                const successful = Object.values(this.algorithms.results).filter(r => r.status === 'complete').length;
                return total > 0 ? Math.round((successful / total) * 100) : 0;
            }

            calculateAverageRunTime() {
                return '2.3s'; // Placeholder
            }

            getCategoryBreakdown() {
                const breakdown = {};
                this.algorithms.algorithms.forEach(alg => {
                    breakdown[alg.category] = (breakdown[alg.category] || 0) + 1;
                });
                return breakdown;
            }
        }

        // تهيئة نظام الخوارزميات والواجهة
        const algorithmsUI = new AlgorithmsUIController(smartAlgorithms);


        // 📁 نظام استيراد الروابط بالجملة
        class BulkLinkImporter {
            constructor() {
                this.currentStep = 1;
                this.selectedContentType = '';
                this.selectedDomain = 'turkify.netlify.app'; // Default domain
                this.uploadedFile = null;
                this.parsedData = [];
                this.validatedData = [];
                this.processingCancelled = false;
                this.results = {
                    successful: [],
                    failed: [],
                    total: 0
                };
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.updateStepDisplay(); // Initial display setup
            }

            setupEventListeners() {
                // Step 1: Content Type Selection
                if (bulkContentType) {
                    bulkContentType.addEventListener('change', (e) => {
                        this.selectedContentType = e.target.value;
                        if (nextToStep2) nextToStep2.disabled = !this.selectedContentType;
                    });
                }
                

                if (nextToStep2) {
                    nextToStep2.addEventListener('click', () => {
                        this.goToStep(2);
                    });
                }

                // New: Domain selection
                if (bulkDomainInput) {
                    bulkDomainInput.addEventListener('input', (e) => {
                        this.selectedDomain = e.target.value.trim();                    });
                }


                // Step 2: File Upload
                this.setupFileUpload();
                if (downloadTemplate) {
                    downloadTemplate.addEventListener('click', () => {
                        this.downloadTemplate();
                    });
                }
                if (backToStep1) {
                    backToStep1.addEventListener('click', () => {
                        this.goToStep(1);
                    });
                }
                if (nextToStep3) {
                    nextToStep3.addEventListener('click', () => {
                        this.processFile();
                    });
                }

                // Step 3: Data Preview
                if (backToStep2) {
                    backToStep2.addEventListener('click', () => {
                        this.goToStep(2);
                    });
                }
                if (startBulkImport) {
                    startBulkImport.addEventListener('click', () => {
                        this.startBulkProcessing();
                    });
                }

                // Step 4: Processing
                if (cancelImport) {
                    cancelImport.addEventListener('click', () => {
                        this.cancelProcessing();
                    });
                }
                if (viewResults) {
                    viewResults.addEventListener('click', () => {
                        this.goToStep(5);
                    });                }

                // Step 5: Results
                if (exportResults) {
                    exportResults.addEventListener('click', () => {
                        this.exportResults();
                    });
                }
                if (startNewImport) {
                    startNewImport.addEventListener('click', () => {
                        this.resetImporter();
                    });
                }
            }

            setupFileUpload() {
                if (!bulkFileInput || !fileUploadArea || !selectFileBtn || !removeFileBtn) {
                    console.warn('Bulk file upload DOM elements not found.');
                    return;
                }

                // Click to select file
                selectFileBtn.addEventListener('click', () => {
                    bulkFileInput.click();
                });

                fileUploadArea.addEventListener('click', () => {
                    bulkFileInput.click();
                });

                // File input change
                bulkFileInput.addEventListener('change', (e) => {
                    this.handleFileSelect(e.target.files[0]);
                });

                // Drag and drop
                fileUploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    fileUploadArea.classList.add('dragover');
                });

                fileUploadArea.addEventListener('dragleave', () => {
                    fileUploadArea.classList.remove('dragover');
                });

                fileUploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    fileUploadArea.classList.remove('dragover');
                    const file = e.dataTransfer.files[0];
                    this.handleFileSelect(file);
                });

                // Remove file
                removeFileBtn.addEventListener('click', () => {
                    this.removeFile();
                });
            }

            handleFileSelect(file) {
                if (!file) return;

                // Validate file type
                const validTypes = ['.csv', '.xlsx', '.xls'];
                const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
                
                if (!validTypes.includes(fileExtension)) {
                    showNotification('error', 'نوع الملف غير مدعوم. يرجى رفع ملف CSV أو Excel');
                    return;
                }

                // Validate file size (max 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    showNotification('error', 'حجم الملف كبير جداً. الحد الأقصى 10 ميجابايت');
                    return;
                }

                this.uploadedFile = file;
                this.displayFileInfo(file);
                if (nextToStep3) nextToStep3.disabled = false;
            }

            displayFileInfo(file) {
                if (fileName) fileName.textContent = file.name;
                if (fileSize) fileSize.textContent = this.formatFileSize(file.size);
                if (fileInfo) fileInfo.style.display = 'block';
            }

            removeFile() {
                this.uploadedFile = null;
                if (fileInfo) fileInfo.style.display = 'none';
                if (bulkFileInput) bulkFileInput.value = '';
                if (nextToStep3) nextToStep3.disabled = true;
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            updateStepDisplay() {
                // Hide all steps
                document.querySelectorAll('.bulk-step').forEach(el => {
                    el.classList.remove('active');
                });

                // Show target step
                const targetStep = document.getElementById(`step${this.currentStep}`);
                if (targetStep) targetStep.classList.add('active');

                // Disable next button for step 1 if no content type selected
                if (this.currentStep === 1 && nextToStep2) {
                    nextToStep2.disabled = !this.selectedContentType;
                }                // Disable next button for step 2 if no file selected
                if (this.currentStep === 2 && nextToStep3) {
                    nextToStep3.disabled = !this.uploadedFile;
                }
                // Disable start button for step 3 if no valid rows
                if (this.currentStep === 3 && startBulkImport) {
                    startBulkImport.disabled = this.validatedData.filter(row => row.isValid).length === 0;
                }
                // Hide view results and cancel for processing step until finished
                if (this.currentStep === 4) {
                    if (viewResults) viewResults.style.display = 'none';
                    if (cancelImport) cancelImport.style.display = 'block';
                }
            }

            goToStep(step) {
                this.currentStep = step;
                this.updateStepDisplay();

                // Update template info when going to step 2
                if (step === 2) {
                    this.updateTemplateInfo();
                }
            }

            updateTemplateInfo() {
                // Use global getTypeName function
                const typeName = getTypeName(this.selectedContentType);
                if (templateInfo) {
                    templateInfo.innerHTML = 
                        `قالب ${typeName} - يحتوي على الحقول المطلوبة لهذا النوع من المحتوى`;
                }
            }

            // تحميل قالب CSV حسب نوع المحتوى
            downloadTemplate() {
                const templates = {
                    'series': {
                        headers: ['name', 'originalUrl', 'totalEpisodes', 'startingEpisode', 'socialTitle', 'socialDescription', 'youtubeTrailer'],
                        sample: ['مسلسل رائع', 'https://example.com/episode1', '20', '1', 'عنوان جذاب', 'وصف شيق للمسلسل', 'https://youtube.com/watch?v=abc123']
                    },
                    'movie': {
                        headers: ['name', 'originalUrl', 'socialTitle', 'socialDescription', 'youtubeTrailer'],
                        sample: ['فيلم مثير', 'https://example.com/movie1', 'عنوان جذاب', 'وصف شيق للفيلم', 'https://youtube.com/watch?v=xyz789']
                    },
                    'match': {
                        headers: ['name', 'originalUrl', 'socialTitle', 'socialDescription', 'socialImage'],
                        sample: ['مباراة كلاسيكية', 'https://example.com/match1', 'مباراة العصر', 'مباراة مثيرة ومشوقة', 'https://example.com/image.jpg']
                    },
                    'recipe': {
                        headers: ['name', 'originalUrl', 'socialTitle', 'socialDescription', 'socialImage'],
                        sample: ['وصفة لذيذة', 'https://example.com/recipe1', 'طبق شهي', 'وصفة سهلة ولذيذة', 'https://example.com/food.jpg']
                    },
                    'game': {                        headers: ['name', 'originalUrl', 'socialTitle', 'socialDescription', 'socialImage'],
                        sample: ['لعبة ممتعة', 'https://example.com/game1', 'لعبة رائعة', 'لعبة مسلية وممتعة', 'https://example.com/game.jpg']
                    },
                    'app': {
                        headers: ['name', 'originalUrl', 'socialTitle', 'socialDescription', 'socialImage'],
                        sample: ['تطبيق مفيد', 'https://example.com/app1', 'تطبيق عملي', 'تطبيق يساعدك في حياتك', 'https://example.com/app.jpg']
                    },
                    'channel': {
                        headers: ['name', 'originalUrl', 'socialTitle', 'socialDescription', 'socialImage'],
                        sample: ['قناة رائعة', 'https://example.com/channel1', 'قناة مميزة', 'محتوى رائع ومفيد', 'https://example.com/channel.jpg']
                    },
                    'reels': {
                        headers: ['name', 'originalUrl', 'socialTitle', 'socialDescription', 'socialImage'],
                        sample: ['ريل مضحك', 'https://example.com/reel1', 'محتوى ممتع', 'ريل مسلي وممتع', 'https://example.com/reel.jpg']
                    }
                };

                const template = templates[this.selectedContentType];
                if (!template) {
                    showNotification('error', 'اختر نوع المحتوى أولاً');
                    return;
                }

                // إنشاء محتوى CSV
                const csvContent = [
                    template.headers.join(','),
                    template.sample.join(',')
                ].join('\n');

                // تحميل الملف
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `template_${this.selectedContentType}_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                
                showNotification('success', 'تم تحميل القالب بنجاح!');
            }

            // معالجة الملف المرفوع
            async processFile() {
                if (!this.uploadedFile) return;

                try {
                    const fileExtension = this.uploadedFile.name.split('.').pop().toLowerCase();
                    
                    if (fileExtension === 'csv') {
                        await this.parseCSV();
                    } else if (['xlsx', 'xls'].includes(fileExtension)) {
                        await this.parseExcel();
                    }

                    this.validateData();
                    this.displayPreview();
                    this.goToStep(3);

                } catch (error) {
                    console.error('Error processing file:', error);
                    showNotification('error', 'فشل في معالجة الملف: ' + error.message);                }
            }

            // تحليل ملف CSV
            async parseCSV() {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const csv = e.target.result;
                            const lines = csv.split('\n').filter(line => line.trim());
                            
                            if (lines.length < 2) {
                                reject(new Error('الملف فارغ أو لا يحتوي على بيانات كافية'));
                                return;
                            }

                            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                            const rows = lines.slice(1).map(line => {
                                const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
                                const row = {};
                                headers.forEach((header, index) => {
                                    row[header] = values[index] || '';
                                });
                                return row;
                            });

                            this.parsedData = rows;
                            resolve();
                        } catch (error) {
                            reject(error);
                        }
                    };
                    reader.onerror = () => reject(new Error('فشل في قراءة الملف'));
                    reader.readAsText(this.uploadedFile, 'utf-8');
                });
            }

            // تحليل ملف Excel
            async parseExcel() {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            // هنا يمكن استخدام مكتبة XLSX لتحليل Excel
                            // للبساطة، سنظهر رسالة أن المستخدم يحول إلى CSV
                            reject(new Error('يرجى تحويل ملف Excel إلى CSV أولاً'));
                        } catch (error) {
                            reject(error);
                        }
                    };
                    reader.readAsArrayBuffer(this.uploadedFile);
                });
            }

            // التحقق من صحة البيانات
            validateData() {
                this.validatedData = [];
                let validCount = 0;
                let errorCount = 0;

                this.parsedData.forEach((row, index) => {
                    const validation = this.validateRow(row, index + 1);
                    this.validatedData.push({
                        ...row,
                        isValid: validation.isValid,
                        errors: validation.errors,
                        rowNumber: index + 1
                    });

                    if (validation.isValid) {
                        validCount++;
                    } else {
                        errorCount++;
                    }
                });

                // تحديث ملخص البيانات
                if (totalRows) totalRows.textContent = this.parsedData.length;
                if (validRows) validRows.textContent = validCount;
                if (errorRows) errorRows.textContent = errorCount;
                
                // تقدير وقت المعالجة (1 ثانية لكل 10 روابط)
                const estimatedMinutes = Math.ceil(validCount / 10 / 60) || 1;
                if (estimatedTime) estimatedTime.textContent = `${estimatedMinutes} دقيقة`;

                // تمكين زر البدء إذا كان هناك صفوف صحيحة
                if (startBulkImport) startBulkImport.disabled = validCount === 0;
            }

            // التحقق من صف واحد
            validateRow(row, rowNumber) {
                const errors = [];
                let isValid = true;

                // فحص الحقول المطلوبة
                if (!row.name || row.name.trim() === '') {
                    errors.push('اسم المحتوى مطلوب');
                    isValid = false;
                }

                if (!row.originalUrl || !isValidUrl(row.originalUrl)) { // Use global isValidUrl
                    errors.push('الرابط الأصلي غير صالح');
                    isValid = false;
                }

                // فحص خاص بالمسلسلات
                if (this.selectedContentType === 'series') {
                    if (!row.totalEpisodes || isNaN(row.totalEpisodes) || parseInt(row.totalEpisodes) < 1) {
                        errors.push('عدد الحلقات يجب أن يكون رقم صحيح أكبر من 0');
                        isValid = false;
                    }

                    if (!row.startingEpisode || isNaN(row.startingEpisode) || parseInt(row.startingEpisode) < 1) {
                        errors.push('رقم الحلقة الابتدائية يجب أن يكون رقم صحيح أكبر من 0');
                        isValid = false;
                    }
                }

                // فحص رابط يوتيوب إذا كان موجود
                if (row.youtubeTrailer && !isValidYouTubeUrl(row.youtubeTrailer)) { // Use global isValidYouTubeUrl
                    errors.push('رابط يوتيوب غير صالح');
                    isValid = false;
                }

                return { isValid, errors };
            }

            // عرض معاينة البيانات
            displayPreview() {
                if (!previewTable) return;
                const thead = previewTable.querySelector('thead');
                const tbody = previewTable.querySelector('tbody');

                // إنشاء رأس الجدول
                const headers = Object.keys(this.parsedData[0] || {});
                thead.innerHTML = `
                    <tr>
                        <th>الصف</th>
                        <th>الحالة</th>
                        ${headers.map(h => `<th>${h}</th>`).join('')}
                    </tr>
                `;

                // إنشاء صفوف البيانات (أول 10 صفوف للمعاينة)
                const previewData = this.validatedData.slice(0, 10);
                tbody.innerHTML = previewData.map(row => `
                    <tr class="${row.isValid ? 'table-success' : 'table-danger'}">
                        <td>${row.rowNumber}</td>
                        <td>
                            ${row.isValid 
                                ? '<i class="fas fa-check text-success"></i>' 
                                : `<i class="fas fa-times text-danger" title="${row.errors.join(', ')}"></i>`
                            }
                        </td>
                        ${headers.map(h => `<td>${row[h] || ''}</td>`).join('')}
                    </tr>
                `).join('');                if (this.validatedData.length > 10) {
                    tbody.innerHTML += `
                        <tr>
                            <td colspan="${headers.length + 2}" class="text-center text-muted">                                ... و ${this.validatedData.length - 10} صف إضافي
                            </td>
                        </tr>
                    `;
                }
            }

            // بدء المعالجة المجمعة
            async startBulkProcessing() {
                this.goToStep(4);
                this.processingCancelled = false;
                this.results = { successful: [], failed: [], total: 0 };

                const validRows = this.validatedData.filter(row => row.isValid);
                const total = validRows.length;

                this.addToLog('بدء معالجة ' + total + ' رابط...', 'info');

                let processed = 0;
                let failed = 0;
                let skipped = 0;

                for (let i = 0; i < validRows.length; i++) {
                    if (this.processingCancelled) {
                        this.addToLog('تم إيقاف المعالجة بواسطة المستخدم', 'warning');
                        break;
                    }

                    const row = validRows[i];
                    
                    try {
                        this.addToLog(`معالجة الصف ${row.rowNumber}: ${row.name}`, 'info');
                        
                        const result = await this.createSingleLink(row);
                        
                        if (result.success) {
                            this.results.successful.push({
                                ...row,
                                shortUrl: result.shortUrl,
                                linkId: result.linkId
                            });
                            processed++;
                            this.addToLog(`✅ تم إنشاء رابط: ${row.name}`, 'success');
                        } else {
                            this.results.failed.push({
                                ...row,
                                error: result.error
                            });
                            failed++;
                            this.addToLog(`❌ فشل في إنشاء رابط: ${row.name} - ${result.error}`, 'error');
                        }

                    } catch (error) {
                        this.results.failed.push({
                            ...row,
                            error: error.message
                        });
                        failed++;
                        this.addToLog(`❌ خطأ في الصف ${row.rowNumber}: ${error.message}`, 'error');
                    }

                    // تحديث شريط التقدم
                    const progress = Math.round(((i + 1) / total) * 100);
                    this.updateProgress(progress, processed, skipped, failed);

                    // إضافة تأخير قصير لتجنب إرهاق Firebase
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                this.results.total = total;
                this.addToLog(`اكتملت المعالجة! نجح: ${processed}, فشل: ${failed}`, 'info');
                
                if (viewResults) viewResults.style.display = 'block';
                if (cancelImport) cancelImport.style.display = 'none';
            }

            // إنشاء رابط واحد
            async createSingleLink(row) {
                try {
                    const user = auth.currentUser;
                    if (!user) {
                        throw new Error('المستخدم غير مسجل');
                    }

                    // توليد معرف فريد
                    const linkId = Math.floor(100000 + Math.random() * 900000).toString();

                    // تحديد تنسيق الرابط حسب النوع
                    const paramName = this.selectedContentType === 'series' ? 
                        'halqat-alyawm-min-musalsal' : this.selectedContentType;

                    const shortUrl = `https://${this.selectedDomain}/?${paramName}=${encodeURIComponent(row.name)}&id=${linkId}`;

                    // Handle socialImage vs youtubeTrailer for thumbnail
                    let socialImage = row.socialImage || null;
                    let thumbnailUrl = null;
                    let trailerVideoId = null;

                    if (row.youtubeTrailer && isValidYouTubeUrl(row.youtubeTrailer)) {
                        trailerVideoId = trailerSystem.extractYouTubeVideoId(row.youtubeTrailer);
                        thumbnailUrl = trailerVideoId ? `https://img.youtube.com/vi/${trailerVideoId}/maxresdefault.jpg` : null;
                        socialImage = null; // Clear socialImage if trailer is present
                    } else if (row.socialImage && isValidUrl(row.socialImage)) {
                        socialImage = row.socialImage;                    } else {
                        // Fallback to placeholder if neither valid image nor trailer
                        socialImage = `https://via.placeholder.com/1200x630/4A154B/FFFFFF?text=${encodeURIComponent(row.name)}`;
                    }


                    // إعداد بيانات الرابط
                    const linkData = {
                        id: linkId,
                        seriesName: row.name,
                        linkType: this.selectedContentType,
                        originalUrl: row.originalUrl,
                        shortUrl: shortUrl,
                        customDomain: this.selectedDomain,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        userId: user.uid,
                        clicks: 0,
                        socialTitle: row.socialTitle || `${row.name} - Turkify Pro`,
                        socialDescription: row.socialDescription || `شاهد ${row.name} الآن!`,
                        socialImage: socialImage,
                        hasTrailer: !!trailerVideoId,
                        trailerUrl: row.youtubeTrailer || null,
                        trailerVideoId: trailerVideoId,
                        thumbnailUrl: thumbnailUrl,                        bulkImported: true,
                        importDate: new Date()
                    };

                    // إضافة حقول خاصة بالمسلسلات
                    if (this.selectedContentType === 'series') {
                        linkData.totalEpisodes = parseInt(row.totalEpisodes) || 0; // Ensure number
                        linkData.startingEpisode = parseInt(row.startingEpisode) || 1; // Ensure number
                        linkData.startDate = firebase.firestore.Timestamp.now();
                    }

                    // حفظ في Firebase
                    await db.collection('links').doc(linkId).set(linkData);

                    return {
                        success: true,
                        shortUrl: shortUrl,
                        linkId: linkId
                    };

                } catch (error) {
                    return {
                        success: false,
                        error: error.message
                    };
                }
            }            updateProgress(percent, processed, skipped, failed) {
                if (importProgress) importProgress.style.width = percent + '%';
                if (progressPercent) progressPercent.textContent = percent + '%';                if (progressText) progressText.textContent = 
                    `معالجة الروابط... (${processed + failed}/${this.results.total})`;
                
                if (processedCount) processedCount.textContent = processed;
                if (skippedCount) skippedCount.textContent = skipped;
                if (failedCount) failedCount.textContent = failed;
            }

            addToLog(message, type = 'info') {
                if (!processingLog) return;
                const timestamp = new Date().toLocaleTimeString('ar-EG');
                
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry ${type}`;                logEntry.textContent = `[${timestamp}] ${message}`;
                
                processingLog.appendChild(logEntry);
                processingLog.scrollTop = processingLog.scrollHeight;
            }

            cancelProcessing() {                this.processingCancelled = true;
                this.addToLog('إيقاف المعالجة...', 'warning');
            }

            resetImporter() {
                this.currentStep = 1;
                this.selectedContentType = '';
                this.uploadedFile = null;
                this.parsedData = [];
                this.validatedData = [];
                this.processingCancelled = false;
                this.results = { successful: [], failed: [], total: 0 };
                
                // إعادة تعيين النموذج
                if (bulkContentType) bulkContentType.value = '';
                if (bulkDomainInput) bulkDomainInput.value = 'turkify.netlify.app'; // Reset to default
                this.removeFile();
                
                this.goToStep(1);
                showNotification('info', 'تم إعادة تعيين النظام');
            }

            exportResults() {
                const results = {
                    summary: {
                        total: this.results.total,
                        successful: this.results.successful.length,
                        failed: this.results.failed.length,
                        date: new Date().toISOString()
                    },
                    successful: this.results.successful,
                    failed: this.results.failed
                };

                const blob = new Blob([JSON.stringify(results, null, 2)], 
                    { type: 'application/json' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `bulk-import-results-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                showNotification('success', 'تم تصدير النتائج بنجاح!');
            }
        }

        // تهيئة نظام الاستيراد
        let bulkImporter;


        // --- Event Listeners and Initial Page Load ---

        document.addEventListener('DOMContentLoaded', function() {
            initPage();
            initAuth();
            updateSocialPreview();

            if (generateBtn) generateBtn.addEventListener('click', generateLink);
            if (updateBtn) updateBtn.addEventListener('click', updateLink);
            if (copyLinkBtn) copyLinkBtn.addEventListener('click', copyToClipboard);

            if (backToHomeBtn) backToHomeBtn.addEventListener('click', () => { window.location.href = '/#features'; });

            if (linkTypeSelect) {
                linkTypeSelect.addEventListener('change', function() {
                    if (this.value === 'series') {
                        if (episodeCountWrapper) episodeCountWrapper.style.display = 'block';
                        if (startingEpisodeWrapper) startingEpisodeWrapper.style.display = 'block';                    } else {
                        if (episodeCountWrapper) episodeCountWrapper.style.display = 'none';
                        if (startingEpisodeWrapper) startingEpisodeWrapper.style.display = 'none';
                    }
                    if (trailerSystem) trailerSystem.updateContentTypeBasedFields(); // Update trailer/image fields visibility
                });
            }

            if (earningsModal) {
                earningsModal.addEventListener('click', function(e) {
                    if (e.target.classList.contains('time-btn')) {
                        earningsModal.querySelectorAll('.time-btn').forEach(btn => {
                            btn.classList.remove('active');                        });
                        e.target.classList.add('active');
                        const timePeriod = e.target.textContent;                        updateEarningsWithFilter(timePeriod);
                    }
                });
            }

            if (shareLinkBtn) {
                shareLinkBtn.addEventListener('click', function() {
                    if (!generatedLinkInput) {
                        showNotification('error', 'الرابط غير متاح للمشاركة.');
                        return;
                    }
                    const link = generatedLinkInput.value;

                    if (navigator.share) {
                        navigator.share({
                            title: 'رابط قصير من Turkify Pro',
                            text: 'تحقق من هذا الرابط القصير الذي أنشأته باستخدام Turkify Pro',
                            url: link
                        }).then(() => {
                            showNotification('success', 'تم مشاركة الرابط بنجاح!');
                        }).catch(error => {
                            console.error('Error sharing:', error);
                            copyToClipboard();
                            showNotification('info', 'فشل المشاركة، تم نسخ الرابط إلى الحافظة');
                        });
                    } else {
                        copyToClipboard();
                        showNotification('success', 'تم نسخ الرابط إلى الحافظة');
                    }
                });
            }            if (viewAnalyticsBtn) {
                viewAnalyticsBtn.addEventListener('click', function() {
                    if (linkModal) {
                        const modalInstance = bootstrap.Modal.getInstance(linkModal);
                        if (modalInstance) modalInstance.hide();
                    }
                    window.location.hash = 'analytics';
                    updateActiveNavLink('analytics'); // Use new function
                    showAnalytics();
                    window.scrollTo(0, 0);
                });
            }

            if (socialTitleInput) socialTitleInput.addEventListener('input', updateSocialPreview);
            if (socialDescriptionInput) socialDescriptionInput.addEventListener('input', updateSocialPreview);
            if (socialImageInput) socialImageInput.addEventListener('input', updateSocialPreview);
            if (customDomainInput) customDomainInput.addEventListener('input', updateSocialPreview);

            if (adminLink) {
                adminLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.location.hash = 'admin';
                    updateActiveNavLink('admin'); // Use new function
                    if (auth.currentUser) {
                        showAdminPanel();
                    } else {
                        showFeatures();
                    }
                    window.scrollTo(0, 0);
                });
            }

            if (statsLink) {
                statsLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.location.hash = 'analytics';
                    updateActiveNavLink('analytics'); // Use new function
                    showAnalytics();
                    window.scrollTo(0, 0);
                });
            }

            if (featuresLink) {
                featuresLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.location.hash = 'features';
                    updateActiveNavLink('features'); // Use new function
                    showFeatures();
                    window.scrollTo(0, 0);
                });
            }

            if (homeLink) {
                homeLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.location.hash = '';
                    updateActiveNavLink('features'); // Home generally points to features
                    showFeatures();
                    window.scrollTo(0, 0);
                });
            }
            // New: Algorithms nav link dynamic creation and event listener
            const algorithmsLinkLi = document.createElement('li');
            algorithmsLinkLi.className = 'nav-item admin-only';            algorithmsLinkLi.innerHTML = `
                <a class="nav-link nav-link-modern" href="#algorithms" id="algorithmsLink" aria-label="Smart Algorithms">
                    <i class="fas fa-brain nav-icon"></i>
                    <span class="nav-text">الخوارزميات الذكية</span>
                    <span class="nav-badge" style="background: linear-gradient(135deg, #6a11cb, #2575fc);">AI</span>
                </a>
            `;

            const navList = document.querySelector('.navbar-nav');
            if (navList) {
                const featuresLi = navList.querySelector('#featuresLink')?.parentNode;
                if (featuresLi) {
                    navList.insertBefore(algorithmsLinkLi, featuresLi);
                } else {
                    navList.appendChild(algorithmsLinkLi);
                }
            }

            // Event listener for the dynamically created algorithms link
            const algorithmsNavLink = document.getElementById('algorithmsLink');
            if (algorithmsNavLink) {
                algorithmsNavLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.location.hash = 'algorithms';
                    showAlgorithms();
                    updateActiveNavLink('algorithms');
                    window.scrollTo(0, 0);
                });
            }

            // New: Bulk Import nav link dynamic creation and event listener
            const bulkImportLinkLi = document.createElement('li');
            bulkImportLinkLi.className = 'nav-item admin-only';
            bulkImportLinkLi.innerHTML = `
                <a class="nav-link nav-link-modern" href="#bulk-import" id="bulkImportLink" aria-label="Bulk Import">
                    <i class="fas fa-file-import nav-icon"></i>
                    <span class="nav-text">استيراد الروابط</span>
                    <span class="nav-badge" style="background: linear-gradient(135deg, #FF6B6B, #FFCD6B);">جديد</span>
                </a>
            `;

            if (navList) {
                // Insert after the algorithms link, or before features if algorithms not found
                const algorithmsLi = navList.querySelector('#algorithmsLink')?.parentNode;
                const featuresLi = navList.querySelector('#featuresLink')?.parentNode;

                if (algorithmsLi && featuresLi) {
                    navList.insertBefore(bulkImportLinkLi, featuresLi); // Insert before features, which is after algorithms
                } else if (featuresLi) {
                     navList.insertBefore(bulkImportLinkLi, featuresLi); // If no algorithms link, insert before features
                } else {
                    navList.appendChild(bulkImportLinkLi); // Fallback to append
                }
            }

            // Event listener for the dynamically created bulk import link
            const bulkImportNavLink = document.getElementById('bulkImportLink');
            if (bulkImportNavLink) {
                bulkImportNavLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.location.hash = 'bulk-import';
                    showBulkImportPanel();
                    updateActiveNavLink('bulk-import');
                    window.scrollTo(0, 0);
                });
            }            checkFirebaseConnection();

            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList' || mutation.type === 'attributes') {
                        const contentElements = [
                            'contentCard',
                            'contentThumbnail',
                            'contentTitle',
                            'contentDescription',
                            'contentType',
                            'contentMeta',                            'contentEpisode',
                            'contentDate'
                        ];

                        contentElements.forEach(id => {
                            const element = document.getElementById(id);
                            if (element && element.style.display === 'none') {
                                if (element.tagName === 'IMG') {
                                    element.style.display = 'block';
                                } else if (element.id === 'contentMeta') {
                                    element.style.display = 'flex';
                                } else {
                                    element.style.display = 'block';
                                }
                                element.style.visibility = 'visible';
                                element.style.opacity = '1';
                            }
                        });
                    }
                });
            });

            observer.observe(document.body, {
                childList: true,
                subtree: true,
                attributes: true,
                attributeFilter: ['style', 'class']
            });

            console.log('تم تفعيل مراقب عرض المحتوى');

            function periodicVisibilityCheck() {
                const urlParams = new URLSearchParams(window.location.search);
                const linkId = urlParams.get('id');

                if (linkId) {
                    const checkInterval = setInterval(() => {
                        showContentCard();

                        const thumbnail = document.getElementById('contentThumbnail');
                        if (thumbnail && !thumbnail.src.includes('placeholder')) {
                            ensureImageVisibility(thumbnail);
                        }

                        setTimeout(() => {
                            clearInterval(checkInterval);
                        }, 10000);
                    }, 1000);
                }
            }

            periodicVisibilityCheck();

            // Ensure trailerSystem fields are correctly displayed on initial load
            setTimeout(() => {
                if (trailerSystem) {
                    trailerSystem.updateContentTypeBasedFields();
                }
            }, 100); // Small delay to ensure DOM is fully ready

            // Initialize bulk importer system
            bulkImporter = new BulkLinkImporter();
        });

        window.addEventListener('hashchange', initPage);

    </script>        
</body>
</html>