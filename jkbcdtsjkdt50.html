<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="منصة متقدمة لإدارة الروابط مع تحليلات ونطاقات مخصصة وميزات متطورة">
    <meta name="keywords" content="تقصير الروابط, إدارة الروابط, تحليلات, تسويق رقمي">
    <title>Turkify Pro - منصة متقدمة لإدارة الروابط</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
:root {
    /* Consolidated color variables */
    --primary-purple: #4A154B;
    --secondary-red: #EF5A5F;
    --accent-teal: #2EC4B6;
    --light-gray: #f8f9fa;
    --dark-gray: #343a40;
    --gradient-purple: linear-gradient(90deg, #4A154B 0%, #5d1d63 100%);
    --gradient-red: linear-gradient(90deg, #EF5A5F 0%, #e94348 100%);
    --gradient-teal: linear-gradient(90deg, #2EC4B6 0%, #20bfa9 100%);
}

/* Base styles */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Tajawal', sans-serif;
}

body {
    background: linear-gradient(135deg, var(--light-gray) 0%, #eef2f5 100%);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    color: #333;
    line-height: 1.8;
}

/* Components */
.navbar {
    background: var(--gradient-purple);
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    padding: 0.8rem 0;
}

.card {
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    margin-bottom: 30px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    overflow: hidden;
    background: white;
}

.card:hover {
    transform: translateY(-8px);
    box-shadow: 0 15px 40px rgba(0,0,0,0.15);
}

.btn {
    border: none;
    padding: 0.8rem 1.8rem;
    font-weight: 500;
    border-radius: 12px;
    transition: all 0.3s ease;
}

.btn-primary {
    background: var(--gradient-purple);
    color: white;
}

.btn-danger {
    background: var(--gradient-red);
    color: white;
}

/* Loader & Notifications */
.loader {
    border: 4px solid rgba(0, 0, 0, 0.1);
    border-top: 4px solid var(--accent-teal);
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin: 30px auto;
    display: none;
}

.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 25px;
    border-radius: 12px;
    color: white;
    font-weight: 500;
    z-index: 1000;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    transform: translateX(200%);
    transition: transform 0.4s ease;
    display: none;
}

/* Stats & Analytics */
.stat-card, .stats-card {
    text-align: center;
    padding: 25px 20px;
    border-radius: 16px;
    background: white;
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    transition: all 0.3s ease;
    margin-bottom: 20px;
}

.stat-number {
    font-size: 2.8rem;
    font-weight: 700;
    background: linear-gradient(90deg, var(--primary-purple) 0%, var(--accent-teal) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin: 10px 0;
}

/* Tables */
.table th {
    background: var(--gradient-purple);
    color: white;
    font-weight: 500;
    padding: 1.1rem 1.5rem;
}

/* Animations */
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@keyframes progress {
    0% { width: 100%; }
    100% { width: 0%; }
}

/* Accessibility improvements */
.btn:focus, .form-control:focus, 
.form-select:focus, .nav-link:focus {
    outline: 3px solid rgba(46, 196, 182, 0.5);
    outline-offset: 2px;
    box-shadow: 0 0 0 0.25rem rgba(46, 196, 182, 0.2);
}

/* RTL Support */
[dir="rtl"] .nav-link,
[dir="rtl"] .logo,
[dir="rtl"] .action-buttons .btn {
    padding-right: 0;
    padding-left: 1rem;
}

[dir="rtl"] .link-card {
    border-left: none;
    border-right: 4px solid var(--accent-teal);
}

[dir="rtl"] .link-card:hover {
    border-right: 4px solid var(--secondary-red);
}

/* Media Queries (Optimized and Consolidated) */
@media (max-width: 1199px) {
    .hero-section {
        padding: 80px 0 60px;
    }
    .redirect-thumbnail {
        height: 300px;
    }
}

@media (max-width: 991px) {
    .navbar-nav {
        margin-top: 15px;
    }
    .auth-section {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid rgba(255,255,255,0.1);
    }
    .stat-number {
        font-size: 2.2rem;
    }
}

@media (max-width: 768px) {
    .hero-section {
        padding: 70px 0 50px;
        border-radius: 0 0 20px 20px;
    }
    .content-thumbnail {
        height: 250px;
    }
    .content-title {
        font-size: 1.5rem;
    }
    .table th, .table td {
        padding: 0.75rem;
        font-size: 0.9rem;
    }
    .redirect-container {
        padding: 30px 20px;
        margin: 40px 20px;
    }
    .algorithms-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 576px) {
    .hero-section {
        padding: 50px 0 30px;
    }
    .content-thumbnail {
        height: 200px;
    }
    .stat-number {
        font-size: 2rem;
    }
    .table th, .table td {
        padding: 0.5rem;
        font-size: 0.8rem;
    }
    .btn {
        padding: 0.6rem 1.2rem;
        width: 100%;
        margin-bottom: 10px;
    }
    .action-buttons .btn {
        margin-right: 5px;
        padding: 0.4rem 0.8rem;
    }
}
</style>
<body>
    <!-- Notification System -->
    <div class="notification success" id="successNotification" role="status" aria-live="polite">
        <div>تم إنشاء الرابط بنجاح!</div>
        <div class="progress-bar"><div class="progress"></div></div>
    </div>
    
    <div class="notification error" id="errorNotification" role="alert" aria-live="assertive">
        <div>الرجاء ملء جميع الحقول المطلوبة</div>
        <div class="progress-bar"><div class="progress"></div></div>
    </div>
    
    <div class="notification info" id="welcomeNotification" role="status" aria-live="polite">
        <div>أهلاً بعودتك، <span id="userName"></span>!</div>
        <div class="progress-bar"><div class="progress"></div></div>
    </div>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand logo" href="/">
                <div class="logo-icon" aria-hidden="true">
                    <i class="fas fa-link"></i>
                </div>
                Turk<span>ify</span> Pro
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent" 
                    aria-controls="navbarContent" aria-expanded="false" aria-label="تبديل التنقل">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="#home" id="homeLink" aria-label="الرئيسية">
                            <i class="fas fa-home me-1" aria-hidden="true"></i> الرئيسية
                        </a>
                    </li>
                    <li class="nav-item admin-only">
                        <a class="nav-link" href="#admin" id="adminLink" aria-label="لوحة التحكم">
                            <i class="fas fa-cog me-1" aria-hidden="true"></i> لوحة التحكم
                        </a>
                    </li>
                    <li class="nav-item admin-only">
                        <a class="nav-link" href="#analytics" id="statsLink" aria-label="التحليلات">
                            <i class="fas fa-chart-bar me-1" aria-hidden="true"></i> التحليلات
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#features" id="featuresLink" aria-label="الميزات">
                            <i class="fas fa-star me-1" aria-hidden="true"></i> الميزات
                        </a>
                    </li>
                    <li class="nav-item user-only" style="display: none;">
                        <a class="nav-link nav-link-modern" href="#bulk-import" id="bulkImportLink" aria-label="استيراد بالجملة">
                            <i class="fas fa-upload nav-icon" aria-hidden="true"></i>
                            <span class="nav-text">استيراد بالجملة</span>
                            <span class="nav-badge" style="background: #ff6b35;">BULK</span>
                        </a>
                    </li>
                </ul>
                
                <div class="d-flex align-items-center auth-section">
                    <div id="authButtons">
                        <button class="btn btn-outline-light" id="signInButton" aria-label="تسجيل الدخول باستخدام Google">
                            <i class="fab fa-google me-2" aria-hidden="true"></i>تسجيل الدخول
                        </button>
                    </div>
                    <div id="userProfile" style="display: none; margin-right: 15px;">
                        <img src="" alt="صورة المستخدم" id="userPhoto" class="rounded-circle me-2" 
                             style="width: 40px; height: 40px; object-fit: cover;">
                        <button class="btn btn-outline-light" id="signOutButton" aria-label="تسجيل الخروج">
                            <i class="fas fa-sign-out-alt me-1" aria-hidden="true"></i>تسجيل الخروج
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero-section" id="home">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-6">
                    <h1 class="display-4 fw-bold mb-4">منصة متقدمة لإدارة الروابط</h1>
                    <p class="lead mb-5">أنشئ، تتبع، وطور روابطك باستخدام تحليلات قوية وميزات متطورة</p>
                    <div class="d-flex flex-wrap gap-3 hero-buttons">
                        <a href="#admin" class="btn btn-light btn-lg px-4 py-3 rounded-pill fw-bold" role="button" aria-label="البدء الآن">
                            <i class="fas fa-rocket me-2" aria-hidden="true"></i>ابدأ الآن
                        </a>
                    </div>
                </div>
                <div class="col-lg-6 text-center d-none d-lg-block">
                    <div class="position-relative">
                        <div class="card p-4 mx-auto" style="max-width: 400px; transform: rotate(3deg);">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h3 class="mb-0">تحليلات الروابط</h3>
                                    <span class="clicks-badge">+24%</span>
                                </div>
                                <div class="mb-4" style="height: 200px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.1); border-radius: 8px;">
                                    <i class="fas fa-chart-line fa-3x" aria-hidden="true"></i>
                                </div>
                                <div class="d-flex justify-content-around">
                                    <div>
                                        <div class="fw-bold">1.2K</div>
                                        <small>نقرات</small>
                                    </div>
                                    <div>
                                        <div class="fw-bold">78%</div>
                                        <small>تفاعل</small>
                                    </div>
                                    <div>
                                        <div class="fw-bold">42</div>
                                        <small>روابط</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="platform-stats mt-5">
                <div class="row">
                    <div class="col-md-3 col-6">
                        <div class="platform-stat">
                            <h3 id="totalLinksStat">25K+</h3>
                            <p>روابط تم إنشاؤها</p>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="platform-stat">
                            <h3 id="totalClicksStat">1.2M+</h3>
                            <p>إجمالي النقرات</p>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="platform-stat">
                            <h3 id="uptimeStat">99.9%</h3>
                            <p>وقت التشغيل</p>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="platform-stat">
                            <h3 id="todayClicksStat">1,245</h3>
                            <p>نقرات اليوم</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <div class="container my-5 pt-5">
        <!-- Admin Panel -->
        <section id="admin">
            <div id="adminPanel" class="admin-only">
                <div class="row">
                    <div class="col-lg-8 mx-auto">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-plus-circle me-2" aria-hidden="true"></i>إنشاء رابط قصير جديد
                            </div>
                            <div class="card-body">
                                <div class="mb-4">
                                    <label class="form-label fw-bold">اسم السلسلة *</label>
                                    <input type="text" class="form-control" id="seriesName" placeholder="أدخل اسم السلسلة" aria-label="اسم السلسلة" aria-required="true">
                                    <div class="invalid-feedback" id="nameError">الرجاء إدخال اسم سلسلة صالح (أحرف، أرقام، ومسافات فقط)</div>
                                </div>
                                <div class="mb-4">
                                    <label class="form-label fw-bold">نوع المحتوى *</label>
                                    <select class="form-select" id="linkType" aria-label="نوع المحتوى" aria-required="true">
                                        <option value="series">مسلسل</option>
                                        <option value="movie">فيلم</option>
                                        <option value="match">مباراة</option>
                                        <option value="recipe">وصفة</option>
                                        <option value="game">لعبة</option>
                                        <option value="app">تطبيق</option>
                                        <option value="channel">قناة</option>
                                        <option value="reels">ريلز</option>
                                    </select>
                                </div>
                                
                                <!-- حقل عدد الحلقات -->
                                <div class="mb-4" id="episodeCountWrapper" style="display: none;">
                                    <label class="form-label fw-bold">عدد حلقات المسلسل *</label>
                                    <input type="number" class="form-control" id="totalEpisodes" placeholder="مثلاً 10" aria-label="عدد حلقات المسلسل" aria-required="true">
                                    <div class="invalid-feedback" id="episodeError">الرجاء إدخال عدد حلقات صحيح</div>
                                </div>
                                
                                <!-- حقل رقم الحلقة الابتدائية -->
                                <div class="mb-4" id="startingEpisodeWrapper" style="display: none;">
                                    <label class="form-label fw-bold">رقم الحلقة الابتدائية *</label>
                                    <input type="number" class="form-control" id="startingEpisode" placeholder="مثلاً 1" min="1" value="1" aria-label="رقم الحلقة الابتدائية" aria-required="true">
                                    <div class="form-text">رقم الحلقة التي سيبدأ منها العد التلقائي اليومي</div>
                                </div>
                                
                                <div class="mb-4">
                                    <label class="form-label fw-bold">الرابط الأصلي *</label>
                                    <input type="url" class="form-control" id="originalUrl" placeholder="https://example.com" aria-label="الرابط الأصلي" aria-required="true">
                                    <div class="invalid-feedback" id="urlError">الرجاء إدخال رابط صالح</div>
                                </div>
                                
                                <div class="mb-4">
                                    <label class="form-label fw-bold">نطاق مخصص (مميز)</label>
                                    <input type="text" class="form-control" id="customDomain" placeholder="yourdomain.com" value="turkify.com" aria-label="النطاق المخصص">
                                </div>
                                
                                <div class="mb-4">
                                    <label class="form-label fw-bold">عنوان معاينة السوشيال ميديا</label>
                                    <input type="text" class="form-control" id="socialTitle" placeholder="عنوان جذاب للمحتوى" aria-label="عنوان معاينة السوشيال ميديا">
                                </div>
                                
                                <div class="mb-4">
                                    <label class="form-label fw-bold">وصف معاينة السوشيال ميديا</label>
                                    <textarea class="form-control" id="socialDescription" rows="3" placeholder="وصف جذاب للمحتوى يجذب الزوار" aria-label="وصف معاينة السوشيال ميديا"></textarea>
                                </div>
                                
                                <div class="mb-4">
                                    <div id="imageField">
                                        <label class="form-label fw-bold">صورة معاينة السوشيال ميديا (URL)</label>
                                        <input type="url" class="form-control" id="socialImage" placeholder="https://example.com/image.jpg" aria-label="صورة معاينة السوشيال ميديا">
                                        <div class="form-text">استخدم صورة جذابة لجذب المزيد من النقرات</div>
                                    </div>
                                    
                                    <div id="trailerField" style="display: none;">
                                        <label class="form-label fw-bold">رابط Trailer من يوتيوب <span class="text-danger">*</span></label>
                                        <input type="url" class="form-control" id="trailerUrl" placeholder="https://www.youtube.com/watch?v=VIDEO_ID" aria-label="رابط Trailer من يوتيوب" aria-required="true">
                                        <div class="form-text">
                                            <i class="fab fa-youtube text-danger me-1" aria-hidden="true"></i>
                                            سيتم عرض الفيديو تلقائياً في صفحة إعادة التوجيه
                                        </div>
                                        
                                        <!-- معاينة الفيديو -->
                                        <div id="trailerPreview" class="trailer-preview mt-3" style="display: none;">
                                            <h6><i class="fas fa-eye me-2" aria-hidden="true"></i>معاينة الفيديو:</h6>
                                            <div class="video-container">
                                                <iframe id="trailerFrame" width="100%" height="200" frameborder="0" allowfullscreen title="معاينة الفيديو"></iframe>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-grid">
                                    <button id="generateBtn" class="btn btn-primary btn-lg py-3 fw-bold" aria-label="إنشاء الرابط">
                                        <i class="fas fa-bolt me-2" aria-hidden="true"></i>إنشاء الرابط
                                    </button>
                                    <button id="updateBtn" class="btn btn-success btn-lg py-3 fw-bold mt-2" style="display: none;" aria-label="حفظ التغييرات">
                                        <i class="fas fa-save me-2" aria-hidden="true"></i>حفظ التغييرات
                                    </button>
                                </div>
                                
                                <div class="mt-4">
                                    <h5>معاينة منشور السوشيال ميديا</h5>
                                    <div class="social-preview">
                                        <img src="https://via.placeholder.com/500x300/4A154B/FFFFFF?text=صورة+المحتوى" id="previewImage" class="social-preview-img" alt="معاينة صورة المحتوى">
                                        <h5 id="previewTitle">عنوان المحتوى</h5>
                                        <p id="previewDescription">وصف المحتوى الذي سيظهر على منصات التواصل الاجتماعي</p>
                                        <small id="previewDomain">turkify.com</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Bulk Import Section -->
                <div class="row mt-5">
                    <div class="col-12">
                        <div class="card bulk-import-card">
                            <div class="card-header">
                                <i class="fas fa-upload me-2" aria-hidden="true"></i>استيراد الروابط بالجملة
                                <span class="badge bg-success ms-2">جديد</span>
                            </div>
                            <div class="card-body">
                                <!-- Step 1: Content Type Selection -->
                                <div class="bulk-step active" id="step1">
                                    <h5 class="step-title">
                                        <span class="step-number">1</span>
                                        اختر نوع المحتوى
                                    </h5>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">نوع المحتوى *</label>
                                            <select class="form-select form-select-lg" id="bulkContentType" aria-label="نوع المحتوى للاستيراد الجماعي" aria-required="true">
                                                <option value="">-- اختر نوع المحتوى --</option>
                                                <option value="series">مسلسل</option>
                                                <option value="movie">فيلم</option>
                                                <option value="match">مباراة</option>
                                                <option value="recipe">وصفة</option>
                                                <option value="game">لعبة</option>
                                                <option value="app">تطبيق</option>
                                                <option value="channel">قناة</option>
                                                <option value="reels">ريلز</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">النطاق المستخدم</label>
                                            <select class="form-select form-select-lg" id="bulkDomain" aria-label="النطاق المستخدم للاستيراد الجماعي">
                                                <option value="turkify.netlify.app">turkify.netlify.app (الافتراضي)</option>
                                                <option value="turkii.netlify.app">turkii.netlify.app (مخصص)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="mt-4">
                                        <button class="btn btn-primary btn-lg" id="nextToStep2" disabled aria-label="المتابعة للخطوة التالية">
                                            <i class="fas fa-arrow-right me-2" aria-hidden="true"></i>المتابعة للخطوة التالية
                                        </button>
                                    </div>
                                </div>

                                <!-- Step 2: File Upload -->
                                <div class="bulk-step" id="step2">
                                    <h5 class="step-title">
                                        <span class="step-number">2</span>
                                        رفع ملف البيانات
                                    </h5>
                                    
                                    <!-- Template Download -->
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2" aria-hidden="true"></i>
                                        <strong>تحميل قالب CSV:</strong>
                                        <button class="btn btn-sm btn-outline-info ms-2" id="downloadTemplate" aria-label="تحميل القالب">
                                            <i class="fas fa-download me-1" aria-hidden="true"></i>تحميل القالب
                                        </button>
                                        <div class="mt-2">
                                            <small id="templateInfo">اختر نوع المحتوى أولاً لتحميل القالب المناسب</small>
                                        </div>
                                    </div>

                                    <!-- File Upload Area -->
                                    <div class="file-upload-area" id="fileUploadArea">
                                        <div class="upload-placeholder">
                                            <i class="fas fa-cloud-upload-alt fa-3x mb-3" aria-hidden="true"></i>
                                            <h5>اسحب وأفلت الملف هنا</h5>
                                            <p>أو انقر لاختيار ملف CSV أو Excel</p>
                                            <input type="file" id="bulkFileInput" accept=".csv,.xlsx,.xls" hidden>
                                            <button class="btn btn-outline-primary" id="selectFileBtn" aria-label="اختر ملف">
                                                <i class="fas fa-folder-open me-2" aria-hidden="true"></i>اختر ملف
                                            </button>
                                        </div>
                                    </div>

                                    <!-- File Info -->
                                    <div class="file-info mt-3" id="fileInfo" style="display: none;">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <i class="fas fa-file me-2" aria-hidden="true"></i>
                                                <span id="fileName">--</span>
                                                <span class="badge bg-secondary ms-2" id="fileSize">--</span>
                                            </div>
                                            <button class="btn btn-sm btn-outline-danger" id="removeFile" aria-label="إزالة الملف">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <div class="mt-4">
                                        <button class="btn btn-secondary me-2" id="backToStep1" aria-label="العودة للخطوة السابقة">
                                            <i class="fas fa-arrow-left me-2" aria-hidden="true"></i>العودة
                                        </button>
                                        <button class="btn btn-primary btn-lg" id="nextToStep3" disabled aria-label="المتابعة لمعاينة البيانات">
                                            <i class="fas fa-arrow-right me-2" aria-hidden="true"></i>معاينة البيانات
                                        </button>
                                    </div>
                                </div>

                                <!-- Step 3: Data Preview -->
                                <div class="bulk-step" id="step3">
                                    <h5 class="step-title">
                                        <span class="step-number">3</span>
                                        معاينة البيانات
                                    </h5>
                                    
                                    <div class="data-summary mb-4" id="dataSummary">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="summary-card">
                                                    <div class="summary-number" id="totalRows">0</div>
                                                    <div class="summary-label">إجمالي الصفوف</div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="summary-card">
                                                    <div class="summary-number text-success" id="validRows">0</div>
                                                    <div class="summary-label">صفوف صحيحة</div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="summary-card">
                                                    <div class="summary-number text-warning" id="errorRows">0</div>
                                                    <div class="summary-label">صفوف بها أخطاء</div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="summary-card">
                                                    <div class="summary-number text-info" id="estimatedTime">--</div>
                                                    <div class="summary-label">وقت المعالجة المتوقع</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="data-preview" id="dataPreview">
                                        <div class="table-responsive">
                                            <table class="table table-striped" id="previewTable">
                                                <thead></thead>
                                                <tbody></tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="mt-4">
                                        <button class="btn btn-secondary me-2" id="backToStep2" aria-label="العودة للخطوة السابقة">
                                            <i class="fas fa-arrow-left me-2" aria-hidden="true"></i>العودة
                                        </button>
                                        <button class="btn btn-success btn-lg" id="startBulkImport" disabled aria-label="بدء الاستيراد">
                                            <i class="fas fa-rocket me-2" aria-hidden="true"></i>بدء الاستيراد
                                        </button>
                                    </div>
                                </div>

                                <!-- Step 4: Processing -->
                                <div class="bulk-step" id="step4">
                                    <h5 class="step-title">
                                        <span class="step-number">4</span>
                                        معالجة البيانات
                                    </h5>
                                    
                                    <div class="processing-status">
                                        <div class="progress-container">
                                            <div class="progress mb-3">
                                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                                     id="importProgress" style="width: 0%"></div>
                                            </div>
                                            <div class="progress-info">
                                                <span id="progressText">جاري البدء...</span>
                                                <span id="progressPercent" class="float-end">0%</span>
                                            </div>
                                        </div>

                                        <div class="processing-details mt-4">
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <div class="processing-stat">
                                                        <div class="stat-value text-success" id="processedCount">0</div>
                                                        <div class="stat-label">تم المعالجة</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="processing-stat">
                                                        <div class="stat-value text-warning" id="skippedCount">0</div>
                                                        <div class="stat-label">تم التخطي</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="processing-stat">
                                                        <div class="stat-value text-danger" id="failedCount">0</div>
                                                        <div class="stat-label">فشل</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="processing-log mt-4">
                                            <h6>سجل المعالجة:</h6>
                                            <div class="log-container" id="processingLog">
                                                <div class="log-entry">انتظار بدء المعالجة...</div>
                                            </div>
                                        </div>

                                        <div class="mt-4">
                                            <button class="btn btn-danger me-2" id="cancelImport" aria-label="إيقاف المعالجة">
                                                <i class="fas fa-stop me-2" aria-hidden="true"></i>إيقاف المعالجة
                                            </button>
                                            <button class="btn btn-primary" id="viewResults" style="display: none;" aria-label="عرض النتائج">
                                                <i class="fas fa-eye me-2" aria-hidden="true"></i>عرض النتائج
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Step 5: Results -->
                                <div class="bulk-step" id="step5">
                                    <h5 class="step-title">
                                        <span class="step-number">5</span>
                                        نتائج الاستيراد
                                    </h5>
                                    
                                    <div class="results-summary mb-4" id="resultsSummary">
                                        <!-- ستملأ بـ JavaScript -->
                                    </div>

                                    <div class="results-details">
                                        <ul class="nav nav-tabs" id="resultsTab">
                                            <li class="nav-item">
                                                <a class="nav-link active" href="#successfulLinks" data-bs-toggle="tab" aria-label="الروابط الناجحة">
                                                    الروابط الناجحة <span class="badge bg-success" id="successBadge">0</span>
                                                </a>
                                            </li>
                                            <li class="nav-item">
                                                <a class="nav-link" href="#failedLinks" data-bs-toggle="tab" aria-label="الروابط الفاشلة">
                                                    الروابط الفاشلة <span class="badge bg-danger" id="failedBadge">0</span>
                                                </a>
                                            </li>
                                        </ul>
                                        
                                        <div class="tab-content mt-3">
                                            <div class="tab-pane active" id="successfulLinks">
                                                <div class="table-responsive">
                                                    <table class="table table-success table-striped">
                                                        <thead>
                                                            <tr>
                                                                <th>اسم المحتوى</th>
                                                                <th>الرابط القصير</th>
                                                                <th>الإجراءات</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="successfulLinksBody"></tbody>
                                                    </table>
                                                </div>
                                            </div>
                                            <div class="tab-pane" id="failedLinks">
                                                <div class="table-responsive">
                                                    <table class="table table-danger table-striped">
                                                        <thead>
                                                            <tr>
                                                                <th>اسم المحتوى</th>
                                                                <th>سبب الفشل</th>
                                                                <th>الإجراءات</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="failedLinksBody"></tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mt-4">
                                        <button class="btn btn-outline-primary me-2" id="exportResults" aria-label="تصدير النتائج">
                                            <i class="fas fa-download me-2" aria-hidden="true"></i>تصدير النتائج
                                        </button>
                                        <button class="btn btn-success" id="startNewImport" aria-label="بدء استيراد جديد">
                                            <i class="fas fa-plus me-2" aria-hidden="true"></i>استيراد جديد
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Link Management -->
        <div class="row mt-5">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-list me-2" aria-hidden="true"></i>الروابط المدارة
                        </div>
                        <div class="d-flex">
                            <div class="input-group me-2" style="max-width: 300px;">
                                <input type="text" class="form-control" placeholder="بحث في الروابط..." id="searchLinks" aria-label="بحث في الروابط">
                                <button class="btn btn-primary" id="searchButton" aria-label="بحث">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <select class="form-select" id="sortLinks" style="max-width: 150px;" aria-label="ترتيب الروابط">
                                <option value="newest">الأحدث أولاً</option>
                                <option value="clicks">الأكثر نقرات</option>
                                <option value="name">حسب الاسم</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th scope="col">المعرف</th>
                                        <th scope="col">اسم السلسلة</th>
                                        <th scope="col">النوع</th>
                                        <th scope="col">الرابط القصير</th>
                                        <th scope="col">تاريخ الإنشاء</th>
                                        <th scope="col">النقرات</th>
                                        <th scope="col">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="linksTable">
                                    <tr>
                                        <td colspan="7" class="text-center table-loader">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">جاري التحميل...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <nav class="mt-4" aria-label="ترقيم الصفحات">
                            <ul class="pagination justify-content-center">
                                <li class="page-item disabled">
                                    <a class="page-link" href="#" tabindex="-1" aria-disabled="true">السابق</a>
                                </li>
                                <li class="page-item active"><a class="page-link" href="#" aria-current="page">1</a></li>
                                <li class="page-item"><a class="page-link" href="#">2</a></li>
                                <li class="page-item"><a class="page-link" href="#">3</a></li>
                                <li class="page-item">
                                    <a class="page-link" href="#">التالي</a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Analytics Dashboard -->
    <section id="analytics">
        <div id="analyticsPanel" style="display: none;">
            <div class="row">
                <div class="col-12 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-chart-line me-2" aria-hidden="true"></i>نظرة عامة على أداء الروابط
                        </div>
                        <div class="card-body">
                            <div class="analytics-filter">
                                <h6>تصفية التحليلات:</h6>
                                <div class="filter-group">
                                    <button class="filter-btn active">الكل</button>
                                    <button class="filter-btn">اليوم</button>
                                    <button class="filter-btn">أسبوع</button>
                                    <button class="filter-btn">شهر</button>
                                    <button class="filter-btn">3 أشهر</button>
                                    <button class="filter-btn">6 أشهر</button>
                                    <button class="filter-btn">سنة</button>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-3 col-6 mb-4">
                                    <div class="stat-card">
                                        <div class="stat-number" id="totalLinks">24</div>
                                        <div class="stat-label">إجمالي الروابط</div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6 mb-4">
                                    <div class="stat-card">
                                        <div class="stat-number" id="totalClicks">1,842</div>
                                        <div class="stat-label">إجمالي النقرات</div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6 mb-4">
                                    <div class="stat-card">
                                        <div class="stat-number" id="todayClicks">56</div>
                                        <div class="stat-label">نقرات اليوم</div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6 mb-4">
                                    <div class="stat-card">
                                        <div class="stat-number" id="popularLink">78%</div>
                                        <div class="stat-label">معدل التفاعل</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-5">
                                <h5 class="mb-4">النقرات مع مرور الوقت</h5>
                                <div id="clicksChartPlaceholder" style="height: 300px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border-radius: 12px;">
                                    <i class="fas fa-chart-bar fa-3x text-muted" aria-hidden="true"></i>
                                </div>
                            </div>
                            
                            <div class="row mt-5">
                                <div class="col-md-6 mb-4">
                                    <h5 class="mb-4">أفضل الروابط أداءً</h5>
                                    <div class="list-group">
                                        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" aria-label="رابط تخفيضات الصيف">
                                            <div>
                                                <div class="fw-bold">تخفيضات الصيف</div>
                                                <small class="text-muted">https://turkify.com/s/389472</small>
                                            </div>
                                            <span class="clicks-badge">142 نقرات</span>
                                        </a>
                                        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" aria-label="رابط عرض خاص">
                                            <div>
                                                <div class="fw-bold">عرض خاص</div>
                                                <small class="text-muted">https://turkify.com/s/734516</small>
                                            </div>
                                            <span class="clicks-badge">128 نقرات</span>
                                        </a>
                                        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" aria-label="رابط منتجات جديدة">
                                            <div>
                                                <div class="fw-bold">منتجات جديدة</div>
                                                <small class="text-muted">https://turkify.com/s/562891</small>
                                            </div>
                                            <span class="clicks-badge">89 نقرات</span>
                                        </a>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-4">
                                    <h5 class="mb-4">التوزيع الجغرافي</h5>
                                    <div class="stats-card">
                                        <div class="d-flex align-items-center mb-3">
                                            <img src="https://flagcdn.com/sa.svg" loading="lazy" class="country-flag" alt="علم السعودية">
                                            <div class="fw-bold">السعودية</div>
                                            <div class="ms-auto">42%</div>
                                        </div>
                                        <div class="d-flex align-items-center mb-3">
                                            <img src="https://flagcdn.com/ae.svg" loading="lazy" class="country-flag" alt="علم الإمارات">
                                            <div class="fw-bold">الإمارات</div>
                                            <div class="ms-auto">18%</div>
                                        </div>
                                        <div class="d-flex align-items-center mb-3">
                                            <img src="https://flagcdn.com/eg.svg" loading="lazy" class="country-flag" alt="علم مصر">
                                            <div class="fw-bold">مصر</div>
                                            <div class="ms-auto">12%</div>
                                        </div>
                                        <div class="d-flex align-items-center">
                                            <img src="https://flagcdn.com/qa.svg" loading="lazy" class="country-flag" alt="علم قطر">
                                            <div class="fw-bold">قطر</div>
                                            <div class="ms-auto">8%</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-4">
                                <div class="col-md-6 mb-4">
                                    <h5 class="mb-4">أنواع الأجهزة</h5>
                                    <div class="stats-card">
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="device-badge device-mobile"><i class="fas fa-mobile-alt me-2" aria-hidden="true"></i>جوال</div>
                                            <div class="ms-auto">58%</div>
                                        </div>
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="device-badge device-desktop"><i class="fas fa-desktop me-2" aria-hidden="true"></i>كمبيوتر</div>
                                            <div class="ms-auto">32%</div>
                                        </div>
                                        <div class="d-flex align-items-center">
                                            <div class="device-badge device-tablet"><i class="fas fa-tablet-alt me-2" aria-hidden="true"></i>تابلت</div>
                                            <div class="ms-auto">10%</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-4">
                                    <h5 class="mb-4">مصادر الزيارات</h5>
                                    <div class="stats-card">
                                        <div class="d-flex align-items-center mb-3">
                                            <i class="fab fa-facebook me-3" style="color: #3b5998;" aria-hidden="true"></i>
                                            <div class="fw-bold">فيسبوك</div>
                                            <div class="ms-auto">38%</div>
                                        </div>
                                        <div class="d-flex align-items-center mb-3">
                                            <i class="fab fa-twitter me-3" style="color: #1da1f2;" aria-hidden="true"></i>
                                            <div class="fw-bold">تويتر</div>
                                            <div class="ms-auto">22%</div>
                                        </div>
                                        <div class="d-flex align-items-center mb-3">
                                            <i class="fab fa-instagram me-3" style="color: #e1306c;" aria-hidden="true"></i>
                                            <div class="fw-bold">إنستغرام</div>
                                            <div class="ms-auto">18%</div>
                                        </div>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-envelope me-3" style="color: #ea4335;" aria-hidden="true"></i>
                                            <div class="fw-bold">البريد الإلكتروني</div>
                                            <div class="ms-auto">12%</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Features Section -->
    <section id="features">
        <div id="featuresPanel">
            <div class="row mb-5">
                <div class="col-12 text-center">
                    <h2 class="display-5 fw-bold mb-3">ميزات متقدمة</h2>
                    <p class="lead mb-5">كل ما تحتاجه لإنشاء وإدارة وتتبع روابطك</p>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        <div class="card-body text-center p-4">
                            <div class="feature-icon" aria-hidden="true">
                                <i class="fas fa-link"></i>
                            </div>
                            <h4 class="mb-3">تنسيق رابط مخصص</h4>
                            <p>أنشئ روابط بالتنسيق: https://series-name.com/épisode-today-XXXXXX</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        <div class="card-body text-center p-4">
                            <div class="feature-icon" aria-hidden="true">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <h4 class="mb-3">تحليلات متقدمة</h4>
                            <p>تتبع النقرات والمواقع والأجهزة ومقاييس التفاعل في الوقت الفعلي.</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        <div class="card-body text-center p-4">
                            <div class="feature-icon" aria-hidden="true">
                                <i class="fas fa-database"></i>
                            </div>
                            <h4 class="mb-3">تخزين سحابي</h4>
                            <p>استخدم Firebase Firestore لتخزين البيانات وإدارة الروابط بسهولة.</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        <div class="card-body text-center p-4">
                            <div class="feature-icon" aria-hidden="true">
                                <i class="fas fa-redo"></i>
                            </div>
                            <h4 class="mb-3">إعادة توجيه فورية</h4>
                            <p>أعد توجيه المستخدمين فورًا مع القدرة على تتبع الإحصائيات.</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        <div class="card-body text-center p-4">
                            <div class="feature-icon" aria-hidden="true">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <h4 class="mb-3">حماية متقدمة</h4>
                            <p>استخدم reCAPTCHA v3 لمنع الإساءة وحماية المنصة.</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        <div class="card-body text-center p-4">
                            <div class="feature-icon" aria-hidden="true">
                                <i class="fas fa-mobile-alt"></i>
                            </div>
                            <h4 class="mb-3">تصميم متجاوب</h4>
                            <p>واجهة مستخدم تعمل بشكل مثالي على جميع الأجهزة والمقاسات.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-5">
                <div class="col-12 text-center">
                    <h2 class="display-5 fw-bold mb-3">ميزات مميزة - مجاناً لك!</h2>
                    <p class="lead mb-5">ميزات احترافية مدفوعة في منصات أخرى، متاحة مجانًا على Turkify</p>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-4 mb-4">
                    <div class="card h-100 border-2 border-primary">
                        <div class="card-body text-center p-4">
                            <div class="feature-icon" aria-hidden="true">
                                <i class="fas fa-globe"></i>
                            </div>
                            <h4 class="mb-3">نطاقات مخصصة</h4>
                            <p>استخدم نطاقك الخاص لإنشاء روابط قصيرة مميزة.</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-4">
                    <div class="card h-100 border-2 border-primary">
                        <div class="card-body text-center p-4">
                            <div class="feature-icon" aria-hidden="true">
                                <i class="fas fa-lock"></i>
                            </div>
                            <h4 class="mb-3">حماية بكلمة مرور</h4>
                            <p>أضف طبقة إضافية من الأمان لروابطك الحساسة.</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-4">
                    <div class="card h-100 border-2 border-primary">
                        <div class="card-body text-center p-4">
                            <div class="feature-icon" aria-hidden="true">
                                <i class="fas fa-hourglass-half"></i>
                            </div>
                            <h4 class="mb-3">انتهاء الروابط</h4>
                            <p>حدد تواريخ انتهاء للروابط المؤقتة.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Redirect Panel -->
    <div id="redirectPanel" class="redirect-container" style="display: none;">
        <!-- بطاقة المحتوى المحدثة -->
        <div class="content-card" id="contentCard" style="display: block;">
            <!-- صورة المحتوى -->
            <div class="content-image-container">
                <img id="contentThumbnail" 
                     src="https://via.placeholder.com/800x300/4A154B/FFFFFF?text=جاري+التحميل..." 
                     class="content-thumbnail" 
                     alt="صورة المحتوى" 
                     style="display: block; visibility: visible;"
                     onerror="this.src='https://via.placeholder.com/800x300/4A154B/FFFFFF?text=لا+توجد+صورة';">
            </div>
            
            <!-- معلومات المحتوى -->
            <div class="content-info" style="display: block; visibility: visible;">
                <!-- معلومات أساسية -->
                <div class="content-meta" style="display: flex; visibility: visible;">
                    <span id="contentType" class="content-type" style="display: inline-block;">مسلسل</span>
                    <span id="contentEpisode" class="content-episode" style="display: none;">الحلقة 1</span>
                    <span id="contentDate" class="content-date" style="display: none;">اليوم</span>
                </div>
                
                <!-- عنوان المحتوى -->
                <h2 id="contentTitle" class="content-title" style="display: block; visibility: visible;">
                    اسم المسلسل
                </h2>
                
                <!-- وصف المحتوى -->
                <p id="contentDescription" class="content-description" style="display: block; visibility: visible;">
                    وصف المسلسل وأحداث الحلقة الحالية
                </p>
                
                <!-- معلومات إضافية -->
                <div class="content-stats" style="display: flex; gap: 20px; margin-top: 15px;">
                    <div class="stat-item">
                        <i class="fas fa-eye text-muted" aria-hidden="true"></i>
                        <span id="contentViews" class="ms-2">0 مشاهدة</span>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-calendar text-muted" aria-hidden="true"></i>
                        <span id="contentCreated" class="ms-2">اليوم</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="redirect-text" id="redirectText">
            <span id="redirectMessage">يتم توجيهك الآن</span>
        </div>
        
        <div class="loader" id="redirectLoader"></div>
        <div class="security-text">
            <p><i class="fas fa-shield-alt me-2" aria-hidden="true"></i>اتصالك آمن ومشفّر</p>
            <p><i class="fas fa-bolt me-2" aria-hidden="true"></i>مدعوم من منصة Turkify Pro لإدارة الروابط</p>
        </div>
        <button class="btn btn-primary redirect-btn" id="manualRedirectBtn" style="display: none;" aria-label="المتابعة إلى الوجهة">
            <i class="fas fa-arrow-right me-2" aria-hidden="true"></i>المتابعة إلى الوجهة
        </button>
    </div>
    
    <!-- Link Generated Modal -->
    <div class="modal fade" id="linkModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-check-circle me-2" aria-hidden="true"></i>تم إنشاء الرابط بنجاح!</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <p class="mb-1">رابطك القصير الجديد:</p>
                        <div class="input-group">
                            <input type="text" class="form-control form-control-lg" id="generatedLink" readonly aria-label="الرابط القصير">
                            <button class="btn btn-primary" id="copyLinkBtn" aria-label="نسخ الرابط">
                                <i class="fas fa-copy me-1" aria-hidden="true"></i>نسخ
                            </button>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2" aria-hidden="true"></i>
                        سيقوم هذا الرابط بإعادة التوجيه إلى: <span id="originalLinkDisplay" class="fw-bold"></span>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-4">
                        <button class="btn btn-outline-primary" id="viewAnalyticsBtn" aria-label="عرض التحليلات">
                            <i class="fas fa-chart-bar me-1" aria-hidden="true"></i>عرض التحليلات
                        </button>
                        <button class="btn btn-outline-success" id="shareLinkBtn" aria-label="مشاركة الرابط">
                            <i class="fas fa-share-alt me-1" aria-hidden="true"></i>مشارة الرابط
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="إغلاق">إغلاق</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2 text-warning" aria-hidden="true"></i>تأكيد العملية</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
                </div>
                <div class="modal-body">
                    <p id="confirmationMessage">هل أنت متأكد من رغبتك في حذف هذا الرابط؟</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-danger" id="confirmActionBtn">تأكيد</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Stats Modal -->
    <div class="modal fade" id="statsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-chart-bar me-2" aria-hidden="true"></i>تحليلات الرابط</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
                </div>
                <div class="modal-body">
                    <div class="stats-modal-content">
                        <div class="stats-header">
                            <h4 id="statsLinkTitle" class="stats-title">تحليلات الرابط</h4>
                            <p class="text-muted">
                                الرابط القصير: <a id="statsLinkUrl" href="#" target="_blank" class="text-decoration-none">تحميل الرابط</a>
                            </p>
                            <div class="time-filter">
                                <button class="time-btn active">اليوم</button>
                                <button class="time-btn">أسبوع</button>
                                <button class="time-btn">شهر</button>
                                <button class="time-btn">3 أشهر</button>
                                <button class="time-btn">سنة</button>
                            </div>
                        </div>
                        
                        <div class="stats-grid">
                            <div class="stats-card">
                                <div class="stats-card-title"><i class="fas fa-users" aria-hidden="true"></i> إجمالي الزيارات</div>
                                <div class="stats-number" id="totalVisits">1,842</div>
                            </div>
                            <div class="stats-card">
                                <div class="stats-card-title"><i class="fas fa-mouse-pointer" aria-hidden="true"></i> النقرات اليوم</div>
                                <div class="stats-number" id="todayVisits">56</div>
                            </div>
                            <div class="stats-card">
                                <div class="stats-card-title"><i class="fas fa-map-marker-alt" aria-hidden="true"></i> البلد الأكثر زيارة</div>
                                <div class="stats-number" id="topCountry">السعودية</div>
                            </div>
                            <div class="stats-card">
                                <div class="stats-card-title"><i class="fas fa-desktop" aria-hidden="true"></i> الجهاز الأكثر استخداماً</div>
                                <div class="stats-number" id="topDevice">الهاتف</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Global Loader -->
    <div class="global-loader" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.7); z-index: 2000; justify-content: center; align-items: center;">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">جاري التحميل...</span>
        </div>
    </div>
    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.google.com/recaptcha/api.js?render=6LesFYErAAAAAOpY8Pbc0furepnxPt0WyJorH5Qw">
    </script>
    <script>
    // Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyC5VmidRUmMF6W3vvl44zznScS1gn2GHn0",
  authDomain: "turkify-redirect.firebaseapp.com",
  projectId: "turkify-redirect",
  storageBucket: "turkify-redirect.appspot.com",
  messagingSenderId: "986441766029",
  appId: "1:986441766029:web:dd6a13879306472e43bec4"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// --- Global State Variables ---
let currentEditingLinkId = null;
let currentEarningsLinkId = null;

// --- Cached DOM Elements ---
const domElements = {
  // Panels
  adminPanel: document.getElementById('adminPanel'),
  analyticsPanel: document.getElementById('analyticsPanel'),
  redirectPanel: document.getElementById('redirectPanel'),
  featuresPanel: document.getElementById('featuresPanel'),
  algorithmsPanel: document.getElementById('algorithmsPanel'),
  bulkImportPanel: document.getElementById('bulkImportPanel'),
  
  // Tables
  linksTable: document.getElementById('linksTable'),
  
  // Authentication
  signInButton: document.getElementById('signInButton'),
  signOutButton: document.getElementById('signOutButton'),
  userProfile: document.getElementById('userProfile'),
  userPhoto: document.getElementById('userPhoto'),
  userName: document.getElementById('userName'),
  authButtons: document.getElementById('authButtons'),
  
  // Navigation
  navLinks: document.querySelectorAll('.nav-link'),
  adminOnlyElements: document.querySelectorAll('.admin-only'),
  
  // Loaders
  globalLoader: document.querySelector('.global-loader'),
  redirectLoader: document.getElementById('redirectLoader'),
  
  // Link Generation
  generateBtn: document.getElementById('generateBtn'),
  updateBtn: document.getElementById('updateBtn'),
  redirectText: document.getElementById('redirectText'),
  redirectMessage: document.getElementById('redirectMessage'),
  backToHomeBtn: document.getElementById('backToHomeBtn'),
  
  // Content Card
  contentCard: document.getElementById('contentCard'),
  contentThumbnail: document.getElementById('contentThumbnail'),
  contentType: document.getElementById('contentType'),
  contentEpisode: document.getElementById('contentEpisode'),
  contentDate: document.getElementById('contentDate'),
  contentTitle: document.getElementById('contentTitle'),
  contentDescription: document.getElementById('contentDescription'),
  contentViews: document.getElementById('contentViews'),
  contentCreated: document.getElementById('contentCreated'),
  contentMeta: document.getElementById('contentMeta'),
  
  // Notifications
  successNotification: document.getElementById('successNotification'),
  errorNotification: document.getElementById('errorNotification'),
  
  // Link Form
  seriesNameInput: document.getElementById('seriesName'),
  originalUrlInput: document.getElementById('originalUrl'),
  socialTitleInput: document.getElementById('socialTitle'),
  socialDescriptionInput: document.getElementById('socialDescription'),
  socialImageInput: document.getElementById('socialImage'),
  linkTypeSelect: document.getElementById('linkType'),
  totalEpisodesInput: document.getElementById('totalEpisodes'),
  startingEpisodeInput: document.getElementById('startingEpisode'),
  episodeErrorDiv: document.getElementById('episodeError'),
  customDomainInput: document.getElementById('customDomain'),
  generatedLinkInput: document.getElementById('generatedLink'),
  originalLinkDisplay: document.getElementById('originalLinkDisplay'),
  linkModal: document.getElementById('linkModal'),
  episodeCountWrapper: document.getElementById('episodeCountWrapper'),
  startingEpisodeWrapper: document.getElementById('startingEpisodeWrapper'),
  copyLinkBtn: document.getElementById('copyLinkBtn'),
  shareLinkBtn: document.getElementById('shareLinkBtn'),
  viewAnalyticsBtn: document.getElementById('viewAnalyticsBtn'),
  
  // Preview
  previewTitle: document.getElementById('previewTitle'),
  previewDescription: document.getElementById('previewDescription'),
  previewImage: document.getElementById('previewImage'),
  previewDomain: document.getElementById('previewDomain'),
  
  // Stats Modal
  statsModal: document.getElementById('statsModal'),
  statsLinkTitle: document.getElementById('statsLinkTitle'),
  statsLinkUrl: document.getElementById('statsLinkUrl'),
  totalVisitsElement: document.getElementById('totalVisits'),
  todayVisitsElement: document.getElementById('todayVisits'),
  topCountryElement: document.getElementById('topCountry'),
  topDeviceElement: document.getElementById('topDevice'),
  visitsChart: document.getElementById('visitsChart'),
  geoChart: document.getElementById('geoChart'),
  devicesChart: document.getElementById('devicesChart'),
  sourcesChart: document.getElementById('sourcesChart'),
  
  // Earnings Modal
  earningsModal: document.getElementById('earningsModal'),
  earningsLinkTitle: document.getElementById('earningsLinkTitle'),
  totalEarningsElement: document.getElementById('totalEarnings'),
  totalImpressionsElement: document.getElementById('totalImpressions'),
  averageRPMElement: document.getElementById('averageRPM'),
  todayEarningsElement: document.getElementById('todayEarnings'),
  arabVisitsElement: document.getElementById('arabVisits'),
  arabEarningsElement: document.getElementById('arabEarnings'),
  foreignVisitsElement: document.getElementById('foreignVisits'),
  foreignEarningsElement: document.getElementById('foreignEarnings'),
  arabProgress: document.getElementById('arabProgress'),
  foreignProgress: document.getElementById('foreignProgress'),
  earningsChart: document.getElementById('earningsChart'),
  
  // Global Stats
  totalLinksStat: document.getElementById('totalLinksStat'),
  totalClicksStat: document.getElementById('totalClicksStat'),
  todayClicksStat: document.getElementById('todayClicksStat'),
  uptimeStat: document.getElementById('uptimeStat'),
  
  // Confirmation Modal
  confirmationModal: document.getElementById('confirmationModal'),
  confirmationMessage: document.getElementById('confirmationMessage'),
  confirmActionBtn: document.getElementById('confirmActionBtn'),
  
  // Algorithms
  runAllAlgorithmsBtn: document.getElementById('runAllAlgorithms'),
  algorithmReportBtn: document.getElementById('algorithmReport'),
  masterAlgorithmSwitch: document.getElementById('masterAlgorithmSwitch'),
  activeAlgorithmsCount: document.getElementById('activeAlgorithmsCount'),
  performanceRate: document.getElementById('performanceRate'),
  lastAlgorithmUpdate: document.getElementById('lastAlgorithmUpdate'),
  algorithmResults: document.getElementById('algorithmResults'),
  
  // Trailer System
  trailerUrl: document.getElementById('trailerUrl'),
  trailerField: document.getElementById('trailerField'),
  imageField: document.getElementById('imageField'),
  trailerPreview: document.getElementById('trailerPreview'),
  trailerFrame: document.getElementById('trailerFrame'),
  
  // Bulk Import
  bulkContentType: document.getElementById('bulkContentType'),
  nextToStep2: document.getElementById('nextToStep2'),
  bulkFileInput: document.getElementById('bulkFileInput'),
  fileUploadArea: document.getElementById('fileUploadArea'),
  selectFileBtn: document.getElementById('selectFileBtn'),
  removeFileBtn: document.getElementById('removeFile'),
  downloadTemplate: document.getElementById('downloadTemplate'),
  backToStep1: document.getElementById('backToStep1'),
  nextToStep3: document.getElementById('nextToStep3'),
  backToStep2: document.getElementById('backToStep2'),
  startBulkImport: document.getElementById('startBulkImport'),
  cancelImport: document.getElementById('cancelImport'),
  viewResults: document.getElementById('viewResults'),
  exportResults: document.getElementById('exportResults'),
  startNewImport: document.getElementById('startNewImport'),
  fileName: document.getElementById('fileName'),
  fileSize: document.getElementById('fileSize'),
  fileInfo: document.getElementById('fileInfo'),
  templateInfo: document.getElementById('templateInfo'),
  totalRows: document.getElementById('totalRows'),
  validRows: document.getElementById('validRows'),
  errorRows: document.getElementById('errorRows'),
  estimatedTime: document.getElementById('estimatedTime'),
  previewTable: document.getElementById('previewTable'),
  importProgress: document.getElementById('importProgress'),
  progressPercent: document.getElementById('progressPercent'),
  progressText: document.getElementById('progressText'),
  processedCount: document.getElementById('processedCount'),
  skippedCount: document.getElementById('skippedCount'),
  failedCount: document.getElementById('failedCount'),
  processingLog: document.getElementById('processingLog'),
  bulkImportLink: document.getElementById('bulkImportLink'),
  bulkDomainInput: document.getElementById('bulkDomain')
};

// --- Constants ---
const arabicCountries = [
  'السعودية', 'الإمارات', 'مصر', 'العراق', 'الأردن', 'لبنان',
  'سوريا', 'الكويت', 'قطر', 'البحرين', 'عمان', 'اليمن',
  'المغرب', 'الجزائر', 'تونس', 'ليبيا', 'السودان', 'الصومال',
  'موريتانيا', 'جيبوتي', 'جزر القمر', 'فلسطين',
  'Saudi Arabia', 'United Arab Emirates', 'Egypt', 'Iraq',
  'Jordan', 'Lebanon', 'Syria', 'Kuwait', 'Qatar', 'Bahrain',
  'Oman', 'Yemen', 'Morocco', 'Algeria', 'Tunisia', 'Libya',
  'Sudan', 'Somalia', 'Mauritania', 'Djibouti', 'Comoros', 'Palestine'
];

// --- Helper Functions ---

/**
 * Checks Firebase connection status
 * @returns {boolean} True if Firebase is available
 */
function checkFirebaseConnection() {
  if (!firebase || !firebase.firestore) {
    showNotification('error', 'خطأ في الاتصال بقاعدة البيانات');
    return false;
  }
  return true;
}

/**
 * Sets global loading state
 * @param {boolean} show - Whether to show loader
 */
function setLoading(show) {
  if (domElements.globalLoader) {
    domElements.globalLoader.classList.toggle('visible', show);
  }
}

/**
 * Formats Firestore timestamp to localized string
 * @param {object} timestamp - Firestore timestamp
 * @returns {string} Formatted date string
 */
function formatFirestoreDateTime(timestamp) {
  if (!timestamp || !timestamp.toDate) return 'N/A';
  
  const date = timestamp.toDate();
  return date.toLocaleString('ar-EG', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
}

/**
 * Shows notification with animation
 * @param {string} type - 'success' or 'error'
 * @param {string} message - Notification content
 * @param {number} duration - Display duration in ms (default: 3000)
 */
function showNotification(type, message, duration = 3000) {
  const notification = domElements[`${type}Notification`];
  if (!notification) return;

  const messageEl = notification.querySelector('div:first-child');
  if (messageEl) messageEl.textContent = message;

  notification.classList.add('visible');
  
  setTimeout(() => {
    notification.classList.remove('visible');
  }, duration);
}

/**
 * Copies text to clipboard with visual feedback
 * @param {string} text - Text to copy
 */
function copyToClipboard(text) {
  if (!text) {
    showNotification('error', 'لا يوجد نص للنسخ');
    return;
  }

  navigator.clipboard.writeText(text)
    .then(() => {
      showNotification('success', 'تم النسخ إلى الحافظة!');
      if (domElements.copyLinkBtn) {
        domElements.copyLinkBtn.innerHTML = '<i class="fas fa-check me-1"></i>تم النسخ!';
        setTimeout(() => {
          domElements.copyLinkBtn.innerHTML = '<i class="fas fa-copy me-1"></i>نسخ';
        }, 2000);
      }
    })
    .catch(err => {
      console.error('فشل النسخ:', err);
      showNotification('error', 'فشل النسخ إلى الحافظة');
    });
}

/**
 * Validates URL format
 * @param {string} url - URL to validate
 * @returns {boolean} True if valid URL
 */
function isValidUrl(url) {
  try {
    new URL(url);
    return true;
  } catch {
    return false;
  }
}

/**
 * Validates YouTube URL format
 * @param {string} url - YouTube URL
 * @returns {boolean} True if valid YouTube URL
 */
function isValidYouTubeUrl(url) {
  const youtubeRegex = /^(https?:\/\/)?(www\.)?(youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)[a-zA-Z0-9_-]{11}.*$/;
  return youtubeRegex.test(url);
}

/**
 * Validates series name format
 * @param {string} name - Series name
 * @returns {boolean} True if valid name
 */
function isValidSeriesName(name) {
  const regex = /^[\p{Script=Arabic}\w\s\-_]+$/u;
  return regex.test(name);
}

/**
 * Gets content type name in Arabic
 * @param {string} type - Content type
 * @returns {string} Localized type name
 */
function getTypeName(type) {
  const types = {
    'series': 'مسلسل',
    'movie': 'فيلم',
    'match': 'مباراة',
    'recipe': 'وصفة',
    'game': 'لعبة',
    'app': 'تطبيق',
    'channel': 'قناة',
    'reels': 'ريلز'
  };
  return types[type] || 'غير محدد';
}

// --- UI Functions ---

/**
 * Shows all content card elements
 */
function showContentCard() {
  const elements = [
    domElements.contentCard,
    domElements.contentThumbnail,
    domElements.contentType,
    domElements.contentTitle,
    domElements.contentDescription,
    domElements.contentMeta
  ];

  elements.forEach(element => {
    if (element) element.classList.add('visible');
  });
}

/**
 * Updates social media preview
 */
function updateSocialPreview() {
  const title = domElements.socialTitleInput?.value.trim() || 'عنوان المحتوى';
  const description = domElements.socialDescriptionInput?.value.trim() || 'وصف المحتوى';
  const domain = domElements.customDomainInput?.value.trim() || 'turkify.com';

  if (domElements.previewTitle) domElements.previewTitle.textContent = title;
  if (domElements.previewDescription) domElements.previewDescription.textContent = description;
  if (domElements.previewDomain) domElements.previewDomain.textContent = domain;

  // Handle image preview
  if (domElements.socialImageInput?.value) {
    domElements.previewImage.src = domElements.socialImageInput.value;
  }
}

/**
 * Hides all panels
 */
function hideAllPanels() {
  const panels = [
    domElements.adminPanel,
    domElements.analyticsPanel,
    domElements.redirectPanel,
    domElements.featuresPanel,
    domElements.algorithmsPanel,
    domElements.bulkImportPanel
  ];

  panels.forEach(panel => {
    if (panel) panel.classList.remove('visible');
  });
}

/**
 * Highlights active navigation item
 */
function highlightActiveNav() {
  const hash = window.location.hash.substring(1);
  const target = hash || 'features';
  
  domElements.navLinks.forEach(link => {
    const linkHash = link.getAttribute('href').substring(1);
    link.classList.toggle('nav-active', linkHash === target);
  });
}

// ... (Additional modularized functions for analytics, link management, etc.)

// --- Initialization ---
document.addEventListener('DOMContentLoaded', () => {
  // Initialize modules
  initAuth();
  initLinkSystem();
  initAnalyticsSystem();
  initAlgorithmsSystem();
  initBulkImportSystem();
  
  // Set up event listeners
  setupEventListeners();
  
  // Initial page setup
  initPage();
});

window.addEventListener('hashchange', initPage);
// --- Link Management System ---

/**
 * Initializes link management system
 */
function initLinkSystem() {
  // Setup form event listeners
  if (domElements.generateBtn) {
    domElements.generateBtn.addEventListener('click', handleGenerateLink);
  }
  
  if (domElements.updateBtn) {
    domElements.updateBtn.addEventListener('click', handleUpdateLink);
  }
  
  if (domElements.copyLinkBtn) {
    domElements.copyLinkBtn.addEventListener('click', () => {
      if (domElements.generatedLinkInput?.value) {
        copyToClipboard(domElements.generatedLinkInput.value);
      }
    });
  }
  
  // Setup link type change handler
  if (domElements.linkTypeSelect) {
    domElements.linkTypeSelect.addEventListener('change', handleLinkTypeChange);
  }
}

/**
 * Handles link type change event
 */
function handleLinkTypeChange() {
  const isSeries = this.value === 'series';
  
  if (domElements.episodeCountWrapper) {
    domElements.episodeCountWrapper.classList.toggle('d-none', !isSeries);
  }
  
  if (domElements.startingEpisodeWrapper) {
    domElements.startingEpisodeWrapper.classList.toggle('d-none', !isSeries);
  }
  
  // Update trailer system visibility
  if (trailerSystem) {
    trailerSystem.updateContentTypeBasedFields();
  }
}

/**
 * Validates link form data
 * @returns {object} Validated form data or null if invalid
 */
function validateLinkForm() {
  const formData = {
    seriesName: domElements.seriesNameInput?.value.trim() || '',
    originalUrl: domElements.originalUrlInput?.value.trim() || '',
    linkType: domElements.linkTypeSelect?.value || 'series',
    totalEpisodes: parseInt(domElements.totalEpisodesInput?.value) || 0,
    startingEpisode: parseInt(domElements.startingEpisodeInput?.value) || 1,
    socialTitle: domElements.socialTitleInput?.value.trim() || '',
    socialDescription: domElements.socialDescriptionInput?.value.trim() || '',
    customDomain: domElements.customDomainInput?.value.trim() || 'turkify.com',
    trailerUrl: domElements.trailerUrl?.value.trim() || ''
  };

  // Validate URL
  if (!isValidUrl(formData.originalUrl)) {
    domElements.originalUrlInput?.classList.add('is-invalid');
    showNotification('error', 'الرجاء إدخال رابط صالح');
    return null;
  }

  // Validate series name
  if (!formData.seriesName || !isValidSeriesName(formData.seriesName)) {
    domElements.seriesNameInput?.classList.add('is-invalid');
    showNotification('error', 'الرجاء إدخال اسم سلسلة صالح');
    return null;
  }

  // Validate series-specific fields
  if (formData.linkType === 'series' && formData.totalEpisodes < 1) {
    domElements.episodeErrorDiv?.classList.remove('d-none');
    showNotification('error', 'الرجاء إدخال عدد حلقات صحيح');
    return null;
  }

  // Validate trailer if needed
  if (formData.linkType === 'series' || formData.linkType === 'movie') {
    if (!isValidYouTubeUrl(formData.trailerUrl)) {
      domElements.trailerUrl?.classList.add('is-invalid');
      showNotification('error', 'رابط يوتيوب مطلوب ويجب أن يكون صالحاً');
      return null;
    }
  }

  return formData;
}

/**
 * Handles link generation
 */
async function handleGenerateLink() {
  const formData = validateLinkForm();
  if (!formData) return;

  try {
    // Set loading state
    toggleButtonState(domElements.generateBtn, true, 'جاري الإنشاء...');
    
    // Generate unique link ID
    const linkId = Math.floor(100000 + Math.random() * 900000).toString();
    
    // Create short URL
    const paramName = formData.linkType === 'series' ? 
      'halqat-alyawm-min-musalsal' : formData.linkType;
    const shortUrl = `https://${formData.customDomain}/?${paramName}=${encodeURIComponent(formData.seriesName)}&id=${linkId}`;
    
    // Create link data
    const linkData = {
      id: linkId,
      seriesName: formData.seriesName,
      linkType: formData.linkType,
      originalUrl: formData.originalUrl,
      shortUrl: shortUrl,
      customDomain: formData.customDomain,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      userId: auth.currentUser?.uid || null,
      clicks: 0,
      socialTitle: formData.socialTitle || `Turkify - ${getTypeName(formData.linkType)} ${formData.seriesName}`,
      socialDescription: formData.socialDescription || `شاهد ${formData.seriesName} الآن على Turkify!`,
      ...trailerSystem.getVideoDataForSave()
    };
    
    // Add series-specific data
    if (formData.linkType === 'series') {
      linkData.totalEpisodes = formData.totalEpisodes;
      linkData.startingEpisode = formData.startingEpisode;
      linkData.startDate = firebase.firestore.Timestamp.now();
    }
    
    // Save to Firestore
    await db.collection('links').doc(linkId).set(linkData);
    
    // Update UI
    if (domElements.generatedLinkInput) {
      domElements.generatedLinkInput.value = shortUrl;
    }
    
    if (domElements.originalLinkDisplay) {
      domElements.originalLinkDisplay.textContent = formData.originalUrl;
    }
    
    // Show success
    showNotification('success', 'تم إنشاء الرابط بنجاح!');
    showLinkModal();
    
    // Reset form
    resetLinkForm();
    
    // Reload links
    loadLinks();
  } catch (error) {
    console.error('Error saving link:', error);
    showNotification('error', `فشل في حفظ الرابط: ${error.message}`);
  } finally {
    toggleButtonState(domElements.generateBtn, false, 'إنشاء الرابط');
  }
}

/**
 * Shows link modal
 */
function showLinkModal() {
  if (domElements.linkModal) {
    const modal = new bootstrap.Modal(domElements.linkModal);
    modal.show();
  }
}

/**
 * Resets link form
 */
function resetLinkForm() {
  const fields = [
    domElements.seriesNameInput,
    domElements.originalUrlInput,
    domElements.totalEpisodesInput,
    domElements.startingEpisodeInput,
    domElements.socialTitleInput,
    domElements.socialDescriptionInput,
    domElements.socialImageInput,
    domElements.trailerUrl
  ];
  
  fields.forEach(field => {
    if (field) field.value = '';
  });
  
  // Hide episode fields
  if (domElements.episodeCountWrapper) {
    domElements.episodeCountWrapper.classList.add('d-none');
  }
  
  if (domElements.startingEpisodeWrapper) {
    domElements.startingEpisodeWrapper.classList.add('d-none');
  }
  
  // Hide trailer preview
  if (trailerSystem) {
    trailerSystem.hideTrailerPreview();
  }
  
  // Reset edit state
  currentEditingLinkId = null;
  
  if (domElements.updateBtn) {
    domElements.updateBtn.classList.add('d-none');
  }
  
  if (domElements.generateBtn) {
    domElements.generateBtn.classList.remove('d-none');
  }
}

/**
 * Handles link update
 */
async function handleUpdateLink() {
  if (!currentEditingLinkId) return;
  
  const formData = validateLinkForm();
  if (!formData) return;

  try {
    // Set loading state
    toggleButtonState(domElements.updateBtn, true, 'جاري الحفظ...');
    
    // Prepare update data
    const updateData = {
      seriesName: formData.seriesName,
      originalUrl: formData.originalUrl,
      socialTitle: formData.socialTitle,
      socialDescription: formData.socialDescription,
      linkType: formData.linkType,
      ...trailerSystem.getVideoDataForSave()
    };
    
    // Add/remove series data
    if (formData.linkType === 'series') {
      updateData.totalEpisodes = formData.totalEpisodes;
      updateData.startingEpisode = formData.startingEpisode;
    } else {
      updateData.totalEpisodes = firebase.firestore.FieldValue.delete();
      updateData.startingEpisode = firebase.firestore.FieldValue.delete();
    }
    
    // Update in Firestore
    await db.collection('links').doc(currentEditingLinkId).update(updateData);
    
    // Show success
    showNotification('success', 'تم تحديث الرابط بنجاح!');
    
    // Reset form
    resetLinkForm();
    
    // Reload links
    loadLinks();
  } catch (error) {
    console.error('Error updating link:', error);
    showNotification('error', `فشل في تحديث الرابط: ${error.message}`);
  } finally {
    toggleButtonState(domElements.updateBtn, false, 'حفظ التغييرات');
  }
}

/**
 * Toggles button state
 * @param {HTMLElement} button - Button element
 * @param {boolean} isLoading - Loading state
 * @param {string} text - Button text
 */
function toggleButtonState(button, isLoading, text) {
  if (!button) return;
  
  button.disabled = isLoading;
  button.innerHTML = isLoading 
    ? '<i class="fas fa-spinner fa-spin me-2"></i>' + text
    : text;
}

// --- Analytics System ---

/**
 * Initializes analytics system
 */
function initAnalyticsSystem() {
  // Setup earnings filter handler
  if (domElements.earningsModal) {
    domElements.earningsModal.addEventListener('click', handleEarningsFilter);
  }
}

/**
 * Handles earnings filter selection
 * @param {Event} e - Click event
 */
function handleEarningsFilter(e) {
  if (e.target.classList.contains('time-btn')) {
    // Update active button
    domElements.earningsModal.querySelectorAll('.time-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    e.target.classList.add('active');
    
    // Apply filter
    const timePeriod = e.target.textContent;
    updateEarningsWithFilter(timePeriod);
  }
}

/**
 * Loads and displays links in admin panel
 */
async function loadLinks() {
  setLoading(true);
  
  try {
    const user = auth.currentUser;
    if (!user) {
      showLinksTableMessage('يرجى تسجيل الدخول لعرض الروابط الخاصة بك', 'info');
      return;
    }
    
    // Fetch links
    const querySnapshot = await db.collection('links')
      .where('userId', '==', user.uid)
      .orderBy('createdAt', 'desc')
      .get();
    
    if (querySnapshot.empty) {
      showLinksTableMessage('لا توجد روابط. قم بإنشاء رابطك الأول!');
      return;
    }
    
    // Render links table
    renderLinksTable(querySnapshot.docs);
  } catch (error) {
    console.error('Error loading links:', error);
    showLinksTableMessage(`فشل في تحميل الروابط: ${error.message}`, 'error');
  } finally {
    setLoading(false);
  }
}

/**
 * Shows message in links table
 * @param {string} message - Message to display
 * @param {string} type - Message type (info, error)
 */
function showLinksTableMessage(message, type = 'info') {
  if (!domElements.linksTable) return;
  
  const alertClass = type === 'error' ? 'alert-danger' : 'alert-info';
  domElements.linksTable.innerHTML = `
    <tr>
      <td colspan="7" class="text-center py-5">
        <div class="alert ${alertClass}">
          ${message}
        </div>
      </td>
    </tr>
  `;
}

/**
 * Renders links table
 * @param {Array} linkDocs - Firestore document snapshots
 */
function renderLinksTable(linkDocs) {
  if (!domElements.linksTable) return;
  
  domElements.linksTable.innerHTML = linkDocs.map(doc => {
    const link = doc.data();
    const typeName = getTypeName(link.linkType);
    const createdAt = formatFirestoreDateTime(link.createdAt);
    
    return `
      <tr>
        <td>${link.id}</td>
        <td>${link.seriesName}</td>
        <td><span class="link-type-badge type-${link.linkType}">${typeName}</span></td>
        <td>
          <a href="${link.shortUrl}" target="_blank" class="short-url">
            ${link.shortUrl}
          </a>
        </td>
        <td>${createdAt}</td>
        <td><span class="clicks-badge">${link.clicks}</span></td>
        <td class="action-buttons">
          <button class="btn btn-sm btn-outline-primary stats-btn" data-id="${link.id}">
            <i class="fas fa-chart-bar"></i>
          </button>
          <button class="btn btn-sm btn-outline-info copy-btn" data-link="${link.shortUrl}">
            <i class="fas fa-copy"></i>
          </button>
          <button class="btn btn-sm btn-outline-primary edit-btn" data-id="${link.id}">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${link.id}">
            <i class="fas fa-trash"></i>
          </button>
          <button class="btn btn-sm btn-outline-success earnings-btn" data-id="${link.id}">
            <i class="fas fa-dollar-sign"></i>
          </button>
        </td>
      </tr>
    `;
  }).join('');
  
  // Add event listeners
  addLinksTableEventListeners();
}

/**
 * Adds event listeners to links table
 */
function addLinksTableEventListeners() {
  if (!domElements.linksTable) return;
  
  // Stats button
  domElements.linksTable.querySelectorAll('.stats-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const linkId = btn.dataset.id;
      toggleButtonState(btn, true, '<i class="fas fa-spinner fa-spin"></i>');
      try {
        await showLinkStats(linkId);
      } catch (error) {
        showNotification('error', 'فشل في تحميل الإحصائيات');
      } finally {
        toggleButtonState(btn, false, '<i class="fas fa-chart-bar"></i>');
      }
    });
  });
  
  // Copy button
  domElements.linksTable.querySelectorAll('.copy-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      copyToClipboard(btn.dataset.link);
    });
  });
  
  // Edit button
  domElements.linksTable.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      editLink(btn.dataset.id);
    });
  });
  
  // Delete button
  domElements.linksTable.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      showDeleteConfirmation(btn.dataset.id);
    });
  });
  
  // Earnings button
  domElements.linksTable.querySelectorAll('.earnings-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const linkId = btn.dataset.id;
      toggleButtonState(btn, true, '<i class="fas fa-spinner fa-spin"></i>');
      try {
        await showEarnings(linkId);
      } catch (error) {
        showNotification('error', 'فشل في تحميل بيانات الأرباح');
      } finally {
        toggleButtonState(btn, false, '<i class="fas fa-dollar-sign"></i>');
      }
    });
  });
}

/**
 * Shows delete confirmation
 * @param {string} linkId - ID of link to delete
 */
function showDeleteConfirmation(linkId) {
  if (!domElements.confirmationModal) return;
  
  domElements.confirmationMessage.textContent = 
    'هل أنت متأكد من رغبتك في حذف هذا الرابط؟';
  
  domElements.confirmActionBtn.onclick = async () => {
    try {
      setLoading(true);
      await db.collection('links').doc(linkId).delete();
      showNotification('success', 'تم حذف الرابط بنجاح!');
      loadLinks();
    } catch (error) {
      showNotification('error', `فشل في حذف الرابط: ${error.message}`);
    } finally {
      setLoading(false);
      
      // Hide modal
      const modal = bootstrap.Modal.getInstance(domElements.confirmationModal);
      if (modal) modal.hide();
    }
  };
  
  // Show modal
  new bootstrap.Modal(domElements.confirmationModal).show();
}

// ... (Additional systems and functions would follow this pattern)

// --- Initialization ---
document.addEventListener('DOMContentLoaded', () => {
  // Initialize systems
  initAuthSystem();
  initLinkSystem();
  initAnalyticsSystem();
  initAlgorithmsSystem();
  initBulkImportSystem();
  
  // Set up event listeners
  setupEventListeners();
  
  // Initial page setup
  initPage();
});

window.addEventListener('hashchange', initPage);

// --- Authentication System ---

/**
 * Initializes authentication system
 */
function initAuthSystem() {
  // Listen for auth state changes
  auth.onAuthStateChanged(handleAuthStateChange);
  
  // Setup sign in button
  if (domElements.signInButton) {
    domElements.signInButton.addEventListener('click', signInWithGoogle);
  }
  
  // Setup sign out button
  if (domElements.signOutButton) {
    domElements.signOutButton.addEventListener('click', signOut);
  }
}

/**
 * Handles authentication state changes
 * @param {object} user - Firebase user object
 */
async function handleAuthStateChange(user) {
  if (user) {
    // User is signed in
    showUserProfile(user);
    await setFirstUserAsAdmin(user);
    showNotification('success', `أهلاً بعودتك، ${user.displayName || 'مستخدم'}!`, 4000);
    
    // Show admin panel if on admin page
    if (window.location.hash === '#admin') {
      showAdminPanel();
    }
    
    // Load global stats
    loadLiveStats();
  } else {
    // User is signed out
    hideUserProfile();
    
    // Redirect from admin page if signed out
    if (window.location.hash === '#admin') {
      showFeatures();
    }
  }
}

/**
 * Shows user profile
 * @param {object} user - Firebase user object
 */
function showUserProfile(user) {
  if (domElements.userProfile) {
    domElements.userProfile.classList.remove('d-none');
  }
  
  if (domElements.authButtons) {
    domElements.authButtons.classList.add('d-none');
  }
  
  if (domElements.userPhoto) {
    domElements.userPhoto.src = user.photoURL || 'https://via.placeholder.com/40';
  }
  
  if (domElements.userName) {
    domElements.userName.textContent = user.displayName || 'مستخدم';
  }
  
  // Show admin-only elements
  domElements.adminOnlyElements.forEach(el => {
    el.classList.remove('d-none');
  });
}

/**
 * Hides user profile
 */
function hideUserProfile() {
  if (domElements.userProfile) {
    domElements.userProfile.classList.add('d-none');
  }
  
  if (domElements.authButtons) {
    domElements.authButtons.classList.remove('d-none');
  }
  
  // Hide admin-only elements
  domElements.adminOnlyElements.forEach(el => {
    el.classList.add('d-none');
  });
}

/**
 * Signs in with Google
 */
async function signInWithGoogle() {
  try {
    const provider = new firebase.auth.GoogleAuthProvider();
    const result = await auth.signInWithPopup(provider);
    showNotification('success', `تم تسجيل دخولك بنجاح، أهلاً بك ${result.user.displayName || 'مستخدم'}!`);
  } catch (error) {
    console.error('Sign-in error:', error);
    showNotification('error', `فشل تسجيل الدخول: ${error.message}`);
  }
}

/**
 * Signs out user
 */
async function signOut() {
  try {
    await auth.signOut();
    showNotification('info', 'تم تسجيل خروجك بنجاح');
  } catch (error) {
    console.error('Sign-out error:', error);
    showNotification('error', 'فشل تسجيل الخروج');
  }
}

/**
 * Sets first user as admin
 * @param {object} user - Firebase user object
 */
async function setFirstUserAsAdmin(user) {
  try {
    const usersRef = db.collection('users');
    const usersSnapshot = await usersRef.get();
    
    if (usersSnapshot.empty) {
      await usersRef.doc(user.uid).set({
        uid: user.uid,
        email: user.email,
        displayName: user.displayName,
        photoURL: user.photoURL,
        isAdmin: true,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      showNotification('success', 'تم تعيينك كمسؤول للمنصة!');
    }
  } catch (error) {
    console.error('Error setting admin:', error);
  }
}

// --- Analytics System ---

/**
 * Shows link statistics
 * @param {string} linkId - ID of the link
 */
async function showLinkStats(linkId) {
  setLoading(true);
  
  try {
    // Fetch link data
    const linkDoc = await db.collection('links').doc(linkId).get();
    if (!linkDoc.exists) {
      throw new Error('الرابط غير موجود');
    }
    const linkData = linkDoc.data();
    
    // Fetch visits data
    const visitsQuery = await db.collection('visits')
      .where('linkId', '==', linkId)
      .orderBy('timestamp', 'desc')
      .get();
    
    const visits = visitsQuery.docs.map(doc => doc.data());
    
    // Update stats modal
    updateStatsModal(linkData, visits);
    
    // Create charts
    createVisitCharts(visits);
    
    // Show modal
    if (domElements.statsModal) {
      new bootstrap.Modal(domElements.statsModal).show();
    }
  } catch (error) {
    console.error('Error loading stats:', error);
    showNotification('error', `فشل في تحميل الإحصائيات: ${error.message}`);
  } finally {
    setLoading(false);
  }
}

/**
 * Updates stats modal with data
 * @param {object} linkData - Link data
 * @param {Array} visits - Array of visit objects
 */
function updateStatsModal(linkData, visits) {
  const totalVisits = visits.length;
  
  // Calculate today's visits
  const today = new Date();
  const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
  const todayVisits = visits.filter(visit => {
    const visitDate = visit.timestamp.toDate();
    return visitDate >= startOfDay;
  }).length;
  
  // Calculate top country
  const countryCounts = {};
  visits.forEach(visit => {
    countryCounts[visit.country] = (countryCounts[visit.country] || 0) + 1;
  });
  
  const topCountry = Object.keys(countryCounts).length > 0 ? 
    Object.keys(countryCounts).reduce((a, b) => 
      countryCounts[a] > countryCounts[b] ? a : b
    ) : 'غير محدد';
  
  // Calculate top device
  const deviceCounts = {};
  visits.forEach(visit => {
    deviceCounts[visit.device] = (deviceCounts[visit.device] || 0) + 1;
  });
  
  const topDevice = Object.keys(deviceCounts).length > 0 ? 
    Object.keys(deviceCounts).reduce((a, b) => 
      deviceCounts[a] > countryCounts[b] ? a : b
    ) : 'غير محدد';
  
  // Update DOM elements
  if (domElements.statsLinkTitle) {
    domElements.statsLinkTitle.textContent = linkData.seriesName || 'غير محدد';
  }
  
  if (domElements.statsLinkUrl) {
    domElements.statsLinkUrl.textContent = linkData.shortUrl || 'غير متاح';
    domElements.statsLinkUrl.href = linkData.shortUrl || '#';
  }
  
  if (domElements.totalVisitsElement) {
    domElements.totalVisitsElement.textContent = totalVisits.toLocaleString();
  }
  
  if (domElements.todayVisitsElement) {
    domElements.todayVisitsElement.textContent = todayVisits.toLocaleString();
  }
  
  if (domElements.topCountryElement) {
    domElements.topCountryElement.textContent = topCountry;
  }
  
  if (domElements.topDeviceElement) {
    domElements.topDeviceElement.textContent = topDevice;
  }
}

/**
 * Creates visit analytics charts
 * @param {Array} visits - Array of visit objects
 */
function createVisitCharts(visits) {
  // Destroy existing charts
  [domElements.visitsChart, domElements.geoChart, 
   domElements.devicesChart, domElements.sourcesChart].forEach(chart => {
    if (chart) {
      const chartInstance = Chart.getChart(chart);
      if (chartInstance) chartInstance.destroy();
    }
  });
  
  // Create visits over time chart
  createVisitsOverTimeChart(visits);
  
  // Create geographic distribution chart
  createGeoDistributionChart(visits);
  
  // Create device breakdown chart
  createDeviceBreakdownChart(visits);
  
  // Create traffic sources chart
  createTrafficSourcesChart(visits);
}

/**
 * Creates visits over time chart
 * @param {Array} visits - Array of visit objects
 */
function createVisitsOverTimeChart(visits) {
  if (!domElements.visitsChart) return;
  
  const ctx = domElements.visitsChart.getContext('2d');
  const last7Days = getLast7Days();
  const visitsByDay = {};
  
  // Initialize visits count for each day
  last7Days.forEach(date => {
    visitsByDay[date] = 0;
  });
  
  // Count visits per day
  visits.forEach(visit => {
    const visitDate = visit.timestamp.toDate().toLocaleDateString('ar-EG');
    if (visitsByDay.hasOwnProperty(visitDate)) {
      visitsByDay[visitDate]++;
    }
  });
  
  // Create chart
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: last7Days,
      datasets: [{
        label: 'الزيارات',
        data: last7Days.map(date => visitsByDay[date]),
        borderColor: '#4A154B',
        backgroundColor: 'rgba(74, 21, 75, 0.1)',
        borderWidth: 2,
        tension: 0.3,
        fill: true
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, ticks: { stepSize: 1 } },
        x: { ticks: { maxTicksLimit: 7 } }
      }
    }
  });
}

/**
 * Gets last 7 days in Arabic format
 * @returns {Array} Array of date strings
 */
function getLast7Days() {
  const dates = [];
  for (let i = 6; i >= 0; i--) {
    const date = new Date();
    date.setDate(date.getDate() - i);
    dates.push(date.toLocaleDateString('ar-EG'));
  }
  return dates;
}

// ... (Other chart creation functions would follow similar patterns)

// --- Earnings System ---

/**
 * Shows earnings for a link
 * @param {string} linkId - ID of the link
 */
async function showEarnings(linkId) {
  setLoading(true);
  currentEarningsLinkId = linkId;
  
  try {
    // Fetch link data
    const linkDoc = await db.collection('links').doc(linkId).get();
    if (!linkDoc.exists) {
      throw new Error('الرابط غير موجود');
    }
    const linkData = linkDoc.data();
    
    // Fetch visits data
    const visitsQuery = await db.collection('visits')
      .where('linkId', '==', linkId)
      .orderBy('timestamp', 'desc')
      .get();
    
    const visits = visitsQuery.docs.map(doc => doc.data());
    
    // Calculate earnings
    const earningsData = calculateEarnings(visits);
    
    // Update earnings modal
    updateEarningsModal(linkData, earningsData);
    
    // Create earnings chart
    createEarningsChart(visits);
    
    // Show modal
    if (domElements.earningsModal) {
      new bootstrap.Modal(domElements.earningsModal).show();
    }
  } catch (error) {
    console.error('Error loading earnings:', error);
    showNotification('error', `فشل في تحميل بيانات الأرباح: ${error.message}`);
  } finally {
    setLoading(false);
  }
}

/**
 * Calculates earnings from visits
 * @param {Array} visits - Array of visit objects
 * @returns {object} Earnings data
 */
function calculateEarnings(visits) {
  const arabVisits = visits.filter(visit => 
    arabicCountries.includes(visit.country)
  ).length;
  
  const foreignVisits = visits.length - arabVisits;
  
  const arabEarnings = (arabVisits / 1000) * 1.00;
  const foreignEarnings = (foreignVisits / 1000) * 3.00;
  const totalEarnings = arabEarnings + foreignEarnings;
  
  return {
    arabVisits,
    foreignVisits,
    arabEarnings,
    foreignEarnings,
    totalEarnings
  };
}

// --- Page Initialization ---

/**
 * Initializes the page based on URL
 */
function initPage() {
  // Highlight active nav item
  highlightActiveNav();
  
  // Handle link redirection if ID is present
  const urlParams = new URLSearchParams(window.location.search);
  const linkId = urlParams.get('id');
  
  if (linkId) {
    handleRedirection(linkId);
    return;
  }
  
  // Handle panel based on hash
  const hash = window.location.hash.substring(1);
  
  switch(hash) {
    case 'admin':
      if (auth.currentUser) {
        showAdminPanel();
      } else {
        showFeatures();
      }
      break;
    case 'analytics':
      showAnalytics();
      break;
    case 'algorithms':
      showAlgorithms();
      break;
    case 'bulk-import':
      showBulkImportPanel();
      break;
    case 'features':
      showFeatures();
      break;
    default:
      showFeatures();
  }
}

/**
 * Shows admin panel
 */
function showAdminPanel() {
  hideAllPanels();
  if (domElements.adminPanel) {
    domElements.adminPanel.classList.add('visible');
    loadLinks();
  }
}

/**
 * Shows analytics panel
 */
function showAnalytics() {
  hideAllPanels();
  if (domElements.analyticsPanel) {
    domElements.analyticsPanel.classList.add('visible');
    loadLiveStats();
  }
}

/**
 * Shows features panel
 */
function showFeatures() {
  hideAllPanels();
  if (domElements.featuresPanel) {
    domElements.featuresPanel.classList.add('visible');
  }
}

/**
 * Shows algorithms panel
 */
function showAlgorithms() {
  hideAllPanels();
  if (domElements.algorithmsPanel) {
    domElements.algorithmsPanel.classList.add('visible');
  }
}

/**
 * Shows bulk import panel
 */
function showBulkImportPanel() {
  hideAllPanels();
  if (domElements.bulkImportPanel) {
    domElements.bulkImportPanel.classList.add('visible');
  }
}

// --- Live Stats ---

/**
 * Loads live statistics
 */
async function loadLiveStats() {
  try {
    const statsDoc = await db.collection('stats').doc('global').get();
    const stats = statsDoc.data() || {};
    
    if (domElements.totalLinksStat) {
      domElements.totalLinksStat.textContent = 
        (stats.totalLinks || 25000).toLocaleString() + '+';
    }
    
    if (domElements.totalClicksStat) {
      domElements.totalClicksStat.textContent = 
        (stats.totalClicks || 1200000).toLocaleString() + '+';
    }
    
    if (domElements.todayClicksStat) {
      domElements.todayClicksStat.textContent = 
        (stats.todayClicks || 1245).toLocaleString();
    }
    
    if (domElements.uptimeStat) {
      domElements.uptimeStat.textContent = 
        (stats.uptime || 99.9).toFixed(1) + '%';
    }
  } catch (error) {
    console.error('Error loading live stats:', error);
  }
}

// --- Event Listeners ---

/**
 * Sets up event listeners
 */
function setupEventListeners() {
  // Navigation
  setupNavigationListeners();
  
  // Link sharing
  if (domElements.shareLinkBtn) {
    domElements.shareLinkBtn.addEventListener('click', handleShareLink);
  }
  
  // Preview updates
  if (domElements.socialTitleInput) {
    domElements.socialTitleInput.addEventListener('input', updateSocialPreview);
  }
  
  if (domElements.socialDescriptionInput) {
    domElements.socialDescriptionInput.addEventListener('input', updateSocialPreview);
  }
  
  if (domElements.socialImageInput) {
    domElements.socialImageInput.addEventListener('input', updateSocialPreview);
  }
  
  if (domElements.customDomainInput) {
    domElements.customDomainInput.addEventListener('input', updateSocialPreview);
  }
  
  // Back to home button
  if (domElements.backToHomeBtn) {
    domElements.backToHomeBtn.addEventListener('click', () => {
      window.location.href = '/#features';
    });
  }
}

/**
 * Sets up navigation listeners
 */
function setupNavigationListeners() {
  const navItems = {
    adminLink: showAdminPanel,
    statsLink: showAnalytics,
    featuresLink: showFeatures,
    homeLink: showFeatures,
    algorithmsLink: showAlgorithms,
    bulkImportLink: showBulkImportPanel
  };
  
  Object.entries(navItems).forEach(([id, handler]) => {
    const element = document.getElementById(id);
    if (element) {
      element.addEventListener('click', (e) => {
        e.preventDefault();
        handler();
        window.scrollTo(0, 0);
      });
    }
  });
}

/**
 * Handles link sharing
 */
function handleShareLink() {
  if (!domElements.generatedLinkInput?.value) {
    showNotification('error', 'الرابط غير متاح للمشاركة.');
    return;
  }
  
  const link = domElements.generatedLinkInput.value;
  
  if (navigator.share) {
    navigator.share({
      title: 'رابط قصير من Turkify Pro',
      text: 'تحقق من هذا الرابط القصير الذي أنشأته باستخدام Turkify Pro',
      url: link
    }).then(() => {
      showNotification('success', 'تم مشاركة الرابط بنجاح!');
    }).catch(() => {
      copyToClipboard(link);
      showNotification('info', 'فشل المشاركة، تم نسخ الرابط إلى الحافظة');
    });
  } else {
    copyToClipboard(link);
    showNotification('success', 'تم نسخ الرابط إلى الحافظة');
  }
}

// --- Final Initialization ---
document.addEventListener('DOMContentLoaded', () => {
  // Initialize systems
  initAuthSystem();
  initLinkSystem();
  initAnalyticsSystem();
  
  // Initialize algorithms and bulk import if elements exist
  if (domElements.algorithmsPanel) {
    initAlgorithmsSystem();
  }
  
  if (domElements.bulkImportPanel) {
    initBulkImportSystem();
  }
  
  // Set up event listeners
  setupEventListeners();
  
  // Initialize trailer system
  if (domElements.trailerUrl) {
    trailerSystem = new TrailerVideoSystem();
  }
  
  // Initial page setup
  initPage();
});

window.addEventListener('hashchange', initPage);
</script>
</body>
</html>